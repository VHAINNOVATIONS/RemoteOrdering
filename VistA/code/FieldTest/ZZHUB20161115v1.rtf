{\rtf1\ansi\ansicpg1252\deff0\nouicompat\deflang1033{\fonttbl{\f0\fnil\fcharset0 Calibri;}}
{\*\generator Riched20 6.3.9600}\viewkind4\uc1 
\pard\sl240\slmult1\f0\fs22\lang9 KIDS Distribution saved on Nov 15, 2016@16:00:03\par
fix for xindex and reports\par
**KIDS**:ZZTEST 1.0^\par
\par
**INSTALL NAME**\par
ZZTEST 1.0\par
"BLD",19,0)\par
ZZTEST 1.0^MOBILE SCHEDULING APPLICATIONS^0^3161115^n\par
"BLD",19,1,0)\par
^^1^1^3160906^\par
"BLD",19,1,1,0)\par
Remote ordering Hub\par
"BLD",19,4,0)\par
^9.64PA^^\par
"BLD",19,6.3)\par
26\par
"BLD",19,"INID")\par
^n\par
"BLD",19,"INIT")\par
\par
"BLD",19,"KRN",0)\par
^9.67PA^779.2^20\par
"BLD",19,"KRN",.4,0)\par
.4\par
"BLD",19,"KRN",.401,0)\par
.401\par
"BLD",19,"KRN",.402,0)\par
.402\par
"BLD",19,"KRN",.403,0)\par
.403\par
"BLD",19,"KRN",.5,0)\par
.5\par
"BLD",19,"KRN",.84,0)\par
.84\par
"BLD",19,"KRN",3.6,0)\par
3.6\par
"BLD",19,"KRN",3.8,0)\par
3.8\par
"BLD",19,"KRN",9.2,0)\par
9.2\par
"BLD",19,"KRN",9.8,0)\par
9.8\par
"BLD",19,"KRN",9.8,"NM",0)\par
^9.68A^15^15\par
"BLD",19,"KRN",9.8,"NM",1,0)\par
AHMLDOL^^0^B50526692\par
"BLD",19,"KRN",9.8,"NM",2,0)\par
AHMLDOL1^^0^B74955905\par
"BLD",19,"KRN",9.8,"NM",3,0)\par
AHMLDOL2^^0^B261484687\par
"BLD",19,"KRN",9.8,"NM",4,0)\par
AHMLDOL3^^0^B46093181\par
"BLD",19,"KRN",9.8,"NM",5,0)\par
AHMLDOL4^^0^B55894995\par
"BLD",19,"KRN",9.8,"NM",6,0)\par
AHMLDOL5^^0^B60471622\par
"BLD",19,"KRN",9.8,"NM",7,0)\par
AHMLDOL6^^0^B111336362\par
"BLD",19,"KRN",9.8,"NM",8,0)\par
AHMLDOL7^^0^B289743908\par
"BLD",19,"KRN",9.8,"NM",9,0)\par
AHMLDOR^^0^B14346987\par
"BLD",19,"KRN",9.8,"NM",10,0)\par
AHMLDOR1^^0^B226327375\par
"BLD",19,"KRN",9.8,"NM",11,0)\par
AHMLDOR2^^0^B97217147\par
"BLD",19,"KRN",9.8,"NM",12,0)\par
AHMLDOR3^^0^B207339876\par
"BLD",19,"KRN",9.8,"NM",13,0)\par
AHMLDOLO^^0^B10264219\par
"BLD",19,"KRN",9.8,"NM",14,0)\par
AHMLDOP1^^0^B117690250\par
"BLD",19,"KRN",9.8,"NM",15,0)\par
AHMLDOP2^^0^B169259843\par
"BLD",19,"KRN",9.8,"NM","B","AHMLDOL",1)\par
\par
"BLD",19,"KRN",9.8,"NM","B","AHMLDOL1",2)\par
\par
"BLD",19,"KRN",9.8,"NM","B","AHMLDOL2",3)\par
\par
"BLD",19,"KRN",9.8,"NM","B","AHMLDOL3",4)\par
\par
"BLD",19,"KRN",9.8,"NM","B","AHMLDOL4",5)\par
\par
"BLD",19,"KRN",9.8,"NM","B","AHMLDOL5",6)\par
\par
"BLD",19,"KRN",9.8,"NM","B","AHMLDOL6",7)\par
\par
"BLD",19,"KRN",9.8,"NM","B","AHMLDOL7",8)\par
\par
"BLD",19,"KRN",9.8,"NM","B","AHMLDOLO",13)\par
\par
"BLD",19,"KRN",9.8,"NM","B","AHMLDOP1",14)\par
\par
"BLD",19,"KRN",9.8,"NM","B","AHMLDOP2",15)\par
\par
"BLD",19,"KRN",9.8,"NM","B","AHMLDOR",9)\par
\par
"BLD",19,"KRN",9.8,"NM","B","AHMLDOR1",10)\par
\par
"BLD",19,"KRN",9.8,"NM","B","AHMLDOR2",11)\par
\par
"BLD",19,"KRN",9.8,"NM","B","AHMLDOR3",12)\par
\par
"BLD",19,"KRN",19,0)\par
19\par
"BLD",19,"KRN",19,"NM",0)\par
^9.68A^^0\par
"BLD",19,"KRN",19.1,0)\par
19.1\par
"BLD",19,"KRN",101,0)\par
101\par
"BLD",19,"KRN",101,"NM",0)\par
^9.68A^20^19\par
"BLD",19,"KRN",101,"NM",1,0)\par
LA7V 565 ORM-O01 EVENT^^0\par
"BLD",19,"KRN",101,"NM",2,0)\par
LA7V 565 ORM-O01 SUBS^^0\par
"BLD",19,"KRN",101,"NM",3,0)\par
LA7V 659 ORM-O01 EVENT^^0\par
"BLD",19,"KRN",101,"NM",4,0)\par
LA7V 659 ORM-O01 SUBS^^0\par
"BLD",19,"KRN",101,"NM",5,0)\par
LA7V 565 REMOTE ORM-O01 EVENT^^0\par
"BLD",19,"KRN",101,"NM",6,0)\par
LA7V 565 REMOTE ORM-O01 SUBS^^0\par
"BLD",19,"KRN",101,"NM",7,0)\par
LA7V 659 REMOTE ORM-O01 EVENT^^0\par
"BLD",19,"KRN",101,"NM",8,0)\par
LA7V 659 REMOTE ORM-O01 SUBS^^0\par
"BLD",19,"KRN",101,"NM",9,0)\par
LR EVSEND CPRS^^0\par
"BLD",19,"KRN",101,"NM",10,0)\par
LR EVSEND REMTE^^0\par
"BLD",19,"KRN",101,"NM",11,0)\par
RA 565 ORM-O01 EVENT^^0\par
"BLD",19,"KRN",101,"NM",12,0)\par
RA 565 ORM-O01 SUBS^^0\par
"BLD",19,"KRN",101,"NM",13,0)\par
RA 565 REMOTE ORM-O01 EVENT^^0\par
"BLD",19,"KRN",101,"NM",14,0)\par
RA 565 REMOTE ORM-O01 SUBS^^0\par
"BLD",19,"KRN",101,"NM",15,0)\par
RA 659 ORM-O01 EVENT^^0\par
"BLD",19,"KRN",101,"NM",16,0)\par
RA 659 ORM-O01 SUBS^^0\par
"BLD",19,"KRN",101,"NM",17,0)\par
RA 659 REMOTE ORM-O01 EVENT^^0\par
"BLD",19,"KRN",101,"NM",18,0)\par
RA 659 REMOTE ORM-O01 SUBS^^0\par
"BLD",19,"KRN",101,"NM",20,0)\par
RA EVSEND RMTE^^0\par
"BLD",19,"KRN",101,"NM","B","LA7V 565 ORM-O01 EVENT",1)\par
\par
"BLD",19,"KRN",101,"NM","B","LA7V 565 ORM-O01 SUBS",2)\par
\par
"BLD",19,"KRN",101,"NM","B","LA7V 565 REMOTE ORM-O01 EVENT",5)\par
\par
"BLD",19,"KRN",101,"NM","B","LA7V 565 REMOTE ORM-O01 SUBS",6)\par
\par
"BLD",19,"KRN",101,"NM","B","LA7V 659 ORM-O01 EVENT",3)\par
\par
"BLD",19,"KRN",101,"NM","B","LA7V 659 ORM-O01 SUBS",4)\par
\par
"BLD",19,"KRN",101,"NM","B","LA7V 659 REMOTE ORM-O01 EVENT",7)\par
\par
"BLD",19,"KRN",101,"NM","B","LA7V 659 REMOTE ORM-O01 SUBS",8)\par
\par
"BLD",19,"KRN",101,"NM","B","LR EVSEND CPRS",9)\par
\par
"BLD",19,"KRN",101,"NM","B","LR EVSEND REMTE",10)\par
\par
"BLD",19,"KRN",101,"NM","B","RA 565 ORM-O01 EVENT",11)\par
\par
"BLD",19,"KRN",101,"NM","B","RA 565 ORM-O01 SUBS",12)\par
\par
"BLD",19,"KRN",101,"NM","B","RA 565 REMOTE ORM-O01 EVENT",13)\par
\par
"BLD",19,"KRN",101,"NM","B","RA 565 REMOTE ORM-O01 SUBS",14)\par
\par
"BLD",19,"KRN",101,"NM","B","RA 659 ORM-O01 EVENT",15)\par
\par
"BLD",19,"KRN",101,"NM","B","RA 659 ORM-O01 SUBS",16)\par
\par
"BLD",19,"KRN",101,"NM","B","RA 659 REMOTE ORM-O01 EVENT",17)\par
\par
"BLD",19,"KRN",101,"NM","B","RA 659 REMOTE ORM-O01 SUBS",18)\par
\par
"BLD",19,"KRN",101,"NM","B","RA EVSEND RMTE",20)\par
\par
"BLD",19,"KRN",409.61,0)\par
409.61\par
"BLD",19,"KRN",771,0)\par
771\par
"BLD",19,"KRN",771,"NM",0)\par
^9.68A^12^12\par
"BLD",19,"KRN",771,"NM",1,0)\par
LA7V 500 CLIENT^^0\par
"BLD",19,"KRN",771,"NM",2,0)\par
LA7V 565 CLIENT^^0\par
"BLD",19,"KRN",771,"NM",3,0)\par
LA7V 659 CLIENT^^0\par
"BLD",19,"KRN",771,"NM",4,0)\par
LA7V HOST 500^^0\par
"BLD",19,"KRN",771,"NM",5,0)\par
LA7V HOST 565^^0\par
"BLD",19,"KRN",771,"NM",6,0)\par
LA7V HOST 659^^0\par
"BLD",19,"KRN",771,"NM",7,0)\par
RA 500 CLIENT^^0\par
"BLD",19,"KRN",771,"NM",8,0)\par
RA 565 CLIENT^^0\par
"BLD",19,"KRN",771,"NM",9,0)\par
RA 659 CLIENT^^0\par
"BLD",19,"KRN",771,"NM",10,0)\par
RA HOST 500^^0\par
"BLD",19,"KRN",771,"NM",11,0)\par
RA HOST 565^^0\par
"BLD",19,"KRN",771,"NM",12,0)\par
RA HOST 659^^0\par
"BLD",19,"KRN",771,"NM","B","LA7V 500 CLIENT",1)\par
\par
"BLD",19,"KRN",771,"NM","B","LA7V 565 CLIENT",2)\par
\par
"BLD",19,"KRN",771,"NM","B","LA7V 659 CLIENT",3)\par
\par
"BLD",19,"KRN",771,"NM","B","LA7V HOST 500",4)\par
\par
"BLD",19,"KRN",771,"NM","B","LA7V HOST 565",5)\par
\par
"BLD",19,"KRN",771,"NM","B","LA7V HOST 659",6)\par
\par
"BLD",19,"KRN",771,"NM","B","RA 500 CLIENT",7)\par
\par
"BLD",19,"KRN",771,"NM","B","RA 565 CLIENT",8)\par
\par
"BLD",19,"KRN",771,"NM","B","RA 659 CLIENT",9)\par
\par
"BLD",19,"KRN",771,"NM","B","RA HOST 500",10)\par
\par
"BLD",19,"KRN",771,"NM","B","RA HOST 565",11)\par
\par
"BLD",19,"KRN",771,"NM","B","RA HOST 659",12)\par
\par
"BLD",19,"KRN",779.2,0)\par
779.2\par
"BLD",19,"KRN",870,0)\par
870\par
"BLD",19,"KRN",870,"NM",0)\par
^9.68A^4^4\par
"BLD",19,"KRN",870,"NM",1,0)\par
LA7RMTE1^^0\par
"BLD",19,"KRN",870,"NM",2,0)\par
LA7RMTE2^^0\par
"BLD",19,"KRN",870,"NM",3,0)\par
LA7RMTE3^^0\par
"BLD",19,"KRN",870,"NM",4,0)\par
HUB1^^0\par
"BLD",19,"KRN",870,"NM","B","HUB1",4)\par
\par
"BLD",19,"KRN",870,"NM","B","LA7RMTE1",1)\par
\par
"BLD",19,"KRN",870,"NM","B","LA7RMTE2",2)\par
\par
"BLD",19,"KRN",870,"NM","B","LA7RMTE3",3)\par
\par
"BLD",19,"KRN",8989.51,0)\par
8989.51\par
"BLD",19,"KRN",8989.51,"NM",0)\par
^9.68A^^\par
"BLD",19,"KRN",8989.52,0)\par
8989.52\par
"BLD",19,"KRN",8989.52,"NM",0)\par
^9.68A^^\par
"BLD",19,"KRN",8994,0)\par
8994\par
"BLD",19,"KRN",8994,"NM",0)\par
^9.68A^^0\par
"BLD",19,"KRN","B",.4,.4)\par
\par
"BLD",19,"KRN","B",.401,.401)\par
\par
"BLD",19,"KRN","B",.402,.402)\par
\par
"BLD",19,"KRN","B",.403,.403)\par
\par
"BLD",19,"KRN","B",.5,.5)\par
\par
"BLD",19,"KRN","B",.84,.84)\par
\par
"BLD",19,"KRN","B",3.6,3.6)\par
\par
"BLD",19,"KRN","B",3.8,3.8)\par
\par
"BLD",19,"KRN","B",9.2,9.2)\par
\par
"BLD",19,"KRN","B",9.8,9.8)\par
\par
"BLD",19,"KRN","B",19,19)\par
\par
"BLD",19,"KRN","B",19.1,19.1)\par
\par
"BLD",19,"KRN","B",101,101)\par
\par
"BLD",19,"KRN","B",409.61,409.61)\par
\par
"BLD",19,"KRN","B",771,771)\par
\par
"BLD",19,"KRN","B",779.2,779.2)\par
\par
"BLD",19,"KRN","B",870,870)\par
\par
"BLD",19,"KRN","B",8989.51,8989.51)\par
\par
"BLD",19,"KRN","B",8989.52,8989.52)\par
\par
"BLD",19,"KRN","B",8994,8994)\par
\par
"BLD",19,"QDEF")\par
^^^^NO^^^^NO^^NO\par
"BLD",19,"QUES",0)\par
^9.62^^\par
"BLD",19,"REQB",0)\par
^9.611^^\par
"KRN",101,6177,-1)\par
0^10\par
"KRN",101,6177,0)\par
LR EVSEND REMTE^REMOTE ORDERING PROTOCOL^^A^^^^^^^^\par
"KRN",101,6177,15)\par
K HLA("HLS")\par
"KRN",101,6177,20)\par
I $G(REMOTE)'=1,$D(XQORMSG) D EN^AHMLDOLO(.XQORMSG)\par
"KRN",101,6177,99)\par
64236,62030\par
"KRN",101,6181,-1)\par
0^9\par
"KRN",101,6181,0)\par
LR EVSEND CPRS^VISTA TO CPRS^^A^^^^^^^^\par
"KRN",101,6181,15)\par
K HLA("HLS")\par
"KRN",101,6181,20)\par
I $G(REMOTE)'=1,$D(XQORMSG) D EN^AHMLDOLO("",.XQORMSG)\par
"KRN",101,6181,99)\par
64236,62030\par
"KRN",101,6181,770)\par
^^^^^^^^^2.4^\par
"KRN",101,6187,-1)\par
0^1\par
"KRN",101,6187,0)\par
LA7V 565 ORM-O01 EVENT^REMOTE SENDING PROTOCOL^^E^^^^^^^^\par
"KRN",101,6187,99)\par
64236,62030\par
"KRN",101,6187,770)\par
LA7V HOST 500^^ORM^O01^^^^AL^NE^2.4^\par
"KRN",101,6187,773)\par
1^1^0\par
"KRN",101,6187,775,0)\par
^101.0775PA^1^1\par
"KRN",101,6187,775,1,0)\par
6188\par
"KRN",101,6187,775,1,"^")\par
LA7V 565 ORM-O01 SUBS\par
"KRN",101,6188,-1)\par
0^2\par
"KRN",101,6188,0)\par
LA7V 565 ORM-O01 SUBS^REMOTE SUBSCRIBER^^S^^^^^^^^\par
"KRN",101,6188,99)\par
64236,62030\par
"KRN",101,6188,770)\par
^LA7V 565 CLIENT^^^^^LA7RMTE1^AL^NE^2.4^\par
"KRN",101,6188,773)\par
1^1^0\par
"KRN",101,6189,-1)\par
0^3\par
"KRN",101,6189,0)\par
LA7V 659 ORM-O01 EVENT^REMOTE SENDING PROTOCOL^^E^^^^^^^^\par
"KRN",101,6189,99)\par
64236,62030\par
"KRN",101,6189,770)\par
LA7V HOST 500^^ORM^O01^^^^AL^NE^2.4^\par
"KRN",101,6189,773)\par
1^1^0\par
"KRN",101,6189,775,0)\par
^101.0775PA^1^1\par
"KRN",101,6189,775,1,0)\par
6190\par
"KRN",101,6189,775,1,"^")\par
LA7V 659 ORM-O01 SUBS\par
"KRN",101,6190,-1)\par
0^4\par
"KRN",101,6190,0)\par
LA7V 659 ORM-O01 SUBS^REMOTE SUBSCRIBER^^S^^^^^^^^\par
"KRN",101,6190,99)\par
64236,62030\par
"KRN",101,6190,770)\par
^LA7V 659 CLIENT^^^^^LA7RMTE2^AL^NE^2.4^\par
"KRN",101,6190,773)\par
1^1^0\par
"KRN",101,6193,-1)\par
0^5\par
"KRN",101,6193,0)\par
LA7V 565 REMOTE ORM-O01 EVENT^Incoming messages from remote order spoke^^E^^^^^^^^\par
"KRN",101,6193,99)\par
64236,62030\par
"KRN",101,6193,770)\par
LA7V HOST 565^^ORM^O01^49^^^NE^NE^2.4^\par
"KRN",101,6193,775,0)\par
^101.0775PA^1^1\par
"KRN",101,6193,775,1,0)\par
6194\par
"KRN",101,6193,775,1,"^")\par
LA7V 565 REMOTE ORM-O01 SUBS\par
"KRN",101,6194,-1)\par
0^6\par
"KRN",101,6194,0)\par
LA7V 565 REMOTE ORM-O01 SUBS^Incoming mesages from the remote spoke^^S^^^^^^^^\par
"KRN",101,6194,99)\par
64236,62030\par
"KRN",101,6194,770)\par
^LA7V 500 CLIENT^^O01^^^^NE^NE^2.4^\par
"KRN",101,6194,771)\par
D EN^AHMLDOL\par
"KRN",101,6194,773)\par
0^0^0\par
"KRN",101,6195,-1)\par
0^7\par
"KRN",101,6195,0)\par
LA7V 659 REMOTE ORM-O01 EVENT^SPOKE2 TO HUB^^E^^^^^^^^\par
"KRN",101,6195,99)\par
64236,62030\par
"KRN",101,6195,770)\par
LA7V HOST 659^^ORM^O01^49^^^AL^NE^2.4^\par
"KRN",101,6195,775,0)\par
^101.0775PA^1^1\par
"KRN",101,6196,-1)\par
0^8\par
"KRN",101,6196,0)\par
LA7V 659 REMOTE ORM-O01 SUBS^SPOKE2 TO HUB^^S^^^^^^^^\par
"KRN",101,6196,99)\par
64236,62030\par
"KRN",101,6196,770)\par
^LA7V 500 CLIENT^^O01^^^^AL^NE^2.4^ACK\par
"KRN",101,6196,771)\par
D EN^AHMLDOL\par
"KRN",101,6196,773)\par
0^0^0\par
"KRN",101,6199,-1)\par
0^20\par
"KRN",101,6199,0)\par
RA EVSEND RMTE^RAD OERR => VISTA^^A^^^^^^^^\par
"KRN",101,6199,15)\par
K HLA("HLS")\par
"KRN",101,6199,20)\par
I $G(REMOTE)'=1,$D(XQORMSG) D EN^AHMLDOLO(.XQORMSG)\par
"KRN",101,6199,99)\par
64236,62030\par
"KRN",101,6200,-1)\par
0^11\par
"KRN",101,6200,0)\par
RA 565 ORM-O01 EVENT^REMOTE RAD SEND PROTOCOL^^E^^^^^^^^\par
"KRN",101,6200,99)\par
64236,62030\par
"KRN",101,6200,770)\par
RA HOST 500^^ORM^O01^^^^NE^NE^2.4^\par
"KRN",101,6200,773)\par
1^1^0\par
"KRN",101,6200,775,0)\par
^101.0775PA^1^1\par
"KRN",101,6200,775,1,0)\par
6201\par
"KRN",101,6200,775,1,"^")\par
RA 565 ORM-O01 SUBS\par
"KRN",101,6201,-1)\par
0^12\par
"KRN",101,6201,0)\par
RA 565 ORM-O01 SUBS^RAD REMOTE SUBSCRIBER^^S^^^^^^^^\par
"KRN",101,6201,99)\par
64236,62030\par
"KRN",101,6201,770)\par
^RA 565 CLIENT^^^^^LA7RMTE1^NE^NE^2.4^\par
"KRN",101,6201,773)\par
1^1^0\par
"KRN",101,6202,-1)\par
0^15\par
"KRN",101,6202,0)\par
RA 659 ORM-O01 EVENT^REMOTE RAD SEND^^E^^^^^^^^\par
"KRN",101,6202,99)\par
64236,62030\par
"KRN",101,6202,770)\par
RA HOST 500^^ORM^O01^^^^NE^NE^2.4^\par
"KRN",101,6202,773)\par
1^1^0\par
"KRN",101,6202,775,0)\par
^101.0775PA^1^1\par
"KRN",101,6202,775,1,0)\par
6203\par
"KRN",101,6202,775,1,"^")\par
RA 659 ORM-O01 SUBS\par
"KRN",101,6203,-1)\par
0^16\par
"KRN",101,6203,0)\par
RA 659 ORM-O01 SUBS^HUB TO SPOKE RAD ORDER^^S^^^^^^^^\par
"KRN",101,6203,99)\par
64236,62030\par
"KRN",101,6203,770)\par
^RA 659 CLIENT^^^^^LA7RMTE2^NE^NE^2.4^\par
"KRN",101,6203,773)\par
1^1^0\par
"KRN",101,6204,-1)\par
0^18\par
"KRN",101,6204,0)\par
RA 659 REMOTE ORM-O01 SUBS^SPOKE2 RAD TO HUB^^S^^^^^^^^\par
"KRN",101,6204,99)\par
64236,62030\par
"KRN",101,6204,770)\par
^RA 500 CLIENT^^O01^^^^NE^NE^2.4^ACK\par
"KRN",101,6204,771)\par
D EN^AHMLDOR\par
"KRN",101,6204,773)\par
0^0^0\par
"KRN",101,6205,-1)\par
0^17\par
"KRN",101,6205,0)\par
RA 659 REMOTE ORM-O01 EVENT^RAD SPOKE2 TO HUB^^E^^^^^^^^\par
"KRN",101,6205,99)\par
64236,62030\par
"KRN",101,6205,770)\par
RA HOST 659^^ORM^O01^49^^^NE^NE^2.4^\par
"KRN",101,6205,773)\par
0^0^0\par
"KRN",101,6205,775,0)\par
^101.0775PA^1^1\par
"KRN",101,6205,775,1,0)\par
6204\par
"KRN",101,6205,775,1,"^")\par
RA 659 REMOTE ORM-O01 SUBS\par
"KRN",101,6206,-1)\par
0^13\par
"KRN",101,6206,0)\par
RA 565 REMOTE ORM-O01 EVENT^RAD SPOKE1 TO HUB^^E^^^^^^^^\par
"KRN",101,6206,99)\par
64236,62030\par
"KRN",101,6206,770)\par
RA HOST 565^^ORM^O01^49^^^NE^NE^2.4^\par
"KRN",101,6206,773)\par
0^0^0\par
"KRN",101,6206,775,0)\par
^101.0775PA^1^1\par
"KRN",101,6206,775,1,0)\par
6207\par
"KRN",101,6206,775,1,"^")\par
RA 565 REMOTE ORM-O01 SUBS\par
"KRN",101,6207,-1)\par
0^14\par
"KRN",101,6207,0)\par
RA 565 REMOTE ORM-O01 SUBS^RAD SPOKE1 TO HUB^^S^^^^^^^^\par
"KRN",101,6207,99)\par
64236,62030\par
"KRN",101,6207,770)\par
^RA 500 CLIENT^^O01^^^^NE^NE^2.4^ACK\par
"KRN",101,6207,771)\par
D EN^AHMLDOR\par
"KRN",101,6207,773)\par
0^0^0\par
"KRN",771,36,-1)\par
0^4\par
"KRN",771,36,0)\par
LA7V HOST 500^a^500^^^^USA\par
"KRN",771,36,"EC")\par
^~\\&\par
"KRN",771,36,"FS")\par
|\par
"KRN",771,248,-1)\par
0^6\par
"KRN",771,248,0)\par
LA7V HOST 659^a^659\par
"KRN",771,248,"EC")\par
^~\\&\par
"KRN",771,248,"FS")\par
|\par
"KRN",771,249,-1)\par
0^5\par
"KRN",771,249,0)\par
LA7V HOST 565^a^565\par
"KRN",771,249,"EC")\par
^~\\&\par
"KRN",771,249,"FS")\par
|\par
"KRN",771,256,-1)\par
0^2\par
"KRN",771,256,0)\par
LA7V 565 CLIENT^a^565^^^^USA\par
"KRN",771,256,"EC")\par
^~\\&\par
"KRN",771,256,"FS")\par
|\par
"KRN",771,257,-1)\par
0^3\par
"KRN",771,257,0)\par
LA7V 659 CLIENT^a^659^^^^USA\par
"KRN",771,257,"EC")\par
^~\\&\par
"KRN",771,257,"FS")\par
|\par
"KRN",771,258,-1)\par
0^1\par
"KRN",771,258,0)\par
LA7V 500 CLIENT^a^500^^^^USA\par
"KRN",771,258,"EC")\par
^~\\&\par
"KRN",771,258,"FS")\par
|\par
"KRN",771,259,-1)\par
0^10\par
"KRN",771,259,0)\par
RA HOST 500^a^500^^^^USA\par
"KRN",771,259,"EC")\par
^~\\&\par
"KRN",771,259,"FS")\par
|\par
"KRN",771,260,-1)\par
0^8\par
"KRN",771,260,0)\par
RA 565 CLIENT^a^565^^^^USA\par
"KRN",771,260,"EC")\par
^~\\&\par
"KRN",771,260,"FS")\par
|\par
"KRN",771,261,-1)\par
0^9\par
"KRN",771,261,0)\par
RA 659 CLIENT^a^659^^^^USA\par
"KRN",771,261,"EC")\par
^~\\&\par
"KRN",771,261,"FS")\par
|\par
"KRN",771,262,-1)\par
0^7\par
"KRN",771,262,0)\par
RA 500 CLIENT^a^500^^^^USA\par
"KRN",771,262,"EC")\par
^~\\&\par
"KRN",771,262,"FS")\par
|\par
"KRN",771,263,-1)\par
0^12\par
"KRN",771,263,0)\par
RA HOST 659^a^659^^^^USA\par
"KRN",771,263,"EC")\par
^~\\&\par
"KRN",771,263,"FS")\par
|\par
"KRN",771,264,-1)\par
0^11\par
"KRN",771,264,0)\par
RA HOST 565^a^565^^^^USA\par
"KRN",771,264,"EC")\par
^~\\&\par
"KRN",771,264,"FS")\par
|\par
"KRN",870,148,-1)\par
0^1\par
"KRN",870,148,0)\par
LA7RMTE1^^TCP^^^^^^^^^^^^^^^^^^10\par
"KRN",870,148,200)\par
^^^^^11^28\par
"KRN",870,148,400)\par
54.236.141.114^5026^C^N^^^^^\par
"KRN",870,149,-1)\par
0^2\par
"KRN",870,149,0)\par
LA7RMTE2^^TCP^^^^^^^^^^^^^^^^^^10\par
"KRN",870,149,200)\par
^^^^^11^28\par
"KRN",870,149,400)\par
^5026^C^N^^^^^\par
"KRN",870,150,-1)\par
0^4\par
"KRN",870,150,0)\par
HUB1^^TCP^^^^^^^^^^^^^^^^^^10\par
"KRN",870,150,200)\par
^5^245^40^120^^^^^I\par
"KRN",870,150,400)\par
^5026^S^Y^^^^5027^\par
"KRN",870,151,-1)\par
0^3\par
"KRN",870,151,0)\par
LA7RMTE3^^TCP^^^^^^^^^^^^^^^^^^10\par
"KRN",870,151,200)\par
^^^^^11^28\par
"KRN",870,151,400)\par
^5026^C^N^^^^^\par
"MBREQ")\par
0\par
"ORD",13,870)\par
870;13;1;;HLLL^XPDTA1;;HLLLE^XPDIA1;;;HLLLDEL^XPDIA1(%)\par
"ORD",13,870,0)\par
HL LOGICAL LINK\par
"ORD",14,771)\par
771;14;;;HLAP^XPDTA1;HLAPF1^XPDIA1;HLAPE1^XPDIA1;HLAPF2^XPDIA1;;HLAPDEL^XPDIA1(%)\par
"ORD",14,771,0)\par
HL7 APPLICATION PARAMETER\par
"ORD",15,101)\par
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA\par
"ORD",15,101,0)\par
PROTOCOL\par
"PKG",576,-1)\par
1^1\par
"PKG",576,0)\par
MOBILE SCHEDULING APPLICATIONS^MBAA^MOBILE SCHEDULING APPLICATIONS SUITE\par
"PKG",576,5)\par
OIT-PD\par
"PKG",576,7)\par
^^I\par
"PKG",576,22,0)\par
^9.49I^1^1\par
"PKG",576,22,1,0)\par
1.0^3161115^3161114^10000000232\par
"PKG",576,22,1,1,0)\par
^^1^1^3161115\par
"PKG",576,22,1,1,1,0)\par
Remote ordering Hub\par
"PKG",576,"DEV")\par
MHED/PD\par
"PKG",576,"VERSION")\par
1.0\par
"QUES","XPF1",0)\par
Y\par
"QUES","XPF1","??")\par
^D REP^XPDH\par
"QUES","XPF1","A")\par
Shall I write over your |FLAG| File\par
"QUES","XPF1","B")\par
YES\par
"QUES","XPF1","M")\par
D XPF1^XPDIQ\par
"QUES","XPF2",0)\par
Y\par
"QUES","XPF2","??")\par
^D DTA^XPDH\par
"QUES","XPF2","A")\par
Want my data |FLAG| yours\par
"QUES","XPF2","B")\par
YES\par
"QUES","XPF2","M")\par
D XPF2^XPDIQ\par
"QUES","XPI1",0)\par
YO\par
"QUES","XPI1","??")\par
^D INHIBIT^XPDH\par
"QUES","XPI1","A")\par
Want KIDS to INHIBIT LOGONs during the install\par
"QUES","XPI1","B")\par
NO\par
"QUES","XPI1","M")\par
D XPI1^XPDIQ\par
"QUES","XPM1",0)\par
PO^VA(200,:EM\par
"QUES","XPM1","??")\par
^D MG^XPDH\par
"QUES","XPM1","A")\par
Enter the Coordinator for Mail Group '|FLAG|'\par
"QUES","XPM1","B")\par
\par
"QUES","XPM1","M")\par
D XPM1^XPDIQ\par
"QUES","XPO1",0)\par
Y\par
"QUES","XPO1","??")\par
^D MENU^XPDH\par
"QUES","XPO1","A")\par
Want KIDS to Rebuild Menu Trees Upon Completion of Install\par
"QUES","XPO1","B")\par
NO\par
"QUES","XPO1","M")\par
D XPO1^XPDIQ\par
"QUES","XPZ1",0)\par
Y\par
"QUES","XPZ1","??")\par
^D OPT^XPDH\par
"QUES","XPZ1","A")\par
Want to DISABLE Scheduled Options, Menu Options, and Protocols\par
"QUES","XPZ1","B")\par
NO\par
"QUES","XPZ1","M")\par
D XPZ1^XPDIQ\par
"QUES","XPZ2",0)\par
Y\par
"QUES","XPZ2","??")\par
^D RTN^XPDH\par
"QUES","XPZ2","A")\par
Want to MOVE routines to other CPUs\par
"QUES","XPZ2","B")\par
NO\par
"QUES","XPZ2","M")\par
D XPZ2^XPDIQ\par
"RTN")\par
15\par
"RTN","AHMLDOL")\par
0^1^B50526692\par
"RTN","AHMLDOL",1,0)\par
AHMLDOL ;;LEIDOS/TCK - REMOTE ORDER - INCOMING ; 10/16/16 8:36pm\par
"RTN","AHMLDOL",2,0)\par
 ;;1.0;REMOTE ORDERS;;OCT 1,2016;Build 26\par
"RTN","AHMLDOL",3,0)\par
 ; Reference to UNESC^ORHLESC supported by IA #4922\par
"RTN","AHMLDOL",4,0)\par
 ;; TEST\par
"RTN","AHMLDOL",5,0)\par
 ;\par
"RTN","AHMLDOL",6,0)\par
EN ;\par
"RTN","AHMLDOL",7,0)\par
 ; Entry point for INCOMING ORDERS FROM A HOST FACILITY\par
"RTN","AHMLDOL",8,0)\par
 N I,D1,D2,D3,D4,D5,TYPE\par
"RTN","AHMLDOL",9,0)\par
 S (D1,D2,D3,D4,D5,TYPE)="",C=0  ;Initialize variables\par
"RTN","AHMLDOL",10,0)\par
 I $G(HLMTIEN)'>0 S LROROUT(1)="0^No Results Array Received" Q\par
"RTN","AHMLDOL",11,0)\par
 S HLMA="",HLMA=$O(^HLMA("B",HLMTIEN,HLMA))\par
"RTN","AHMLDOL",12,0)\par
 Q:$G(HLMA)'>0\par
"RTN","AHMLDOL",13,0)\par
 Q:'$D(^HLMA(HLMA,0))\par
"RTN","AHMLDOL",14,0)\par
 Q:'$D(^HLMA(HLMA,"MSH"))\par
"RTN","AHMLDOL",15,0)\par
 I $P(^HLMA(HLMA,"MSH",1,0),"|",3)["LA7V" S TYPE="LAB"\par
"RTN","AHMLDOL",16,0)\par
 I $P(^HLMA(HLMA,"MSH",1,0),"|",3)["RA" S TYPE="RAD"\par
"RTN","AHMLDOL",17,0)\par
 S LOC=+$P(^HLMA(HLMA,"MSH",1,0),"|",4)\par
"RTN","AHMLDOL",18,0)\par
 M ^TMP("RMTE",1)=^HLMA(HLMA,"MSH",1,0)\par
"RTN","AHMLDOL",19,0)\par
 S I=0 F  S I=$O(^HL(772,HLMTIEN,"IN",I)) Q:I=""  D\par
"RTN","AHMLDOL",20,0)\par
 .S C=$G(I)+1\par
"RTN","AHMLDOL",21,0)\par
 .S ^TMP("RMTE",C)=^HL(772,HLMTIEN,"IN",I,0)\par
"RTN","AHMLDOL",22,0)\par
 M REC=^TMP("RMTE")\par
"RTN","AHMLDOL",23,0)\par
 Q:'$D(REC)\par
"RTN","AHMLDOL",24,0)\par
 D EN^AHMLDOL1(.REC,TYPE,LOC)\par
"RTN","AHMLDOL",25,0)\par
 K REC,HLMTIEN,^TMP("RMTE"),HLMA,LOC,DONE\par
"RTN","AHMLDOL",26,0)\par
 Q\par
"RTN","AHMLDOL",27,0)\par
 ;\par
"RTN","AHMLDOL",28,0)\par
TEST(LROROUT,HLMTIEN) ;\par
"RTN","AHMLDOL",29,0)\par
 D EN\par
"RTN","AHMLDOL",30,0)\par
 Q\par
"RTN","AHMLDOL",31,0)\par
 ;\par
"RTN","AHMLDOL",32,0)\par
GTDOM(R) ;\par
"RTN","AHMLDOL",33,0)\par
 N NME,INST,CNT\par
"RTN","AHMLDOL",34,0)\par
 S (DOM,INST,R)="",CNT=0\par
"RTN","AHMLDOL",35,0)\par
 Q:'$D(^DIC(4,"E"))\par
"RTN","AHMLDOL",36,0)\par
 S INST="" F  S INST=$O(^DIC(4,"E",INST)) Q:INST=""  D\par
"RTN","AHMLDOL",37,0)\par
 .S NME=$$GET1^DIQ(4,INST,.01,"E")\par
"RTN","AHMLDOL",38,0)\par
 .S CNT=$G(CNT)+1\par
"RTN","AHMLDOL",39,0)\par
 .S R(CNT)=INST_"^"_NME\par
"RTN","AHMLDOL",40,0)\par
 Q\par
"RTN","AHMLDOL",41,0)\par
 ;\par
"RTN","AHMLDOL",42,0)\par
DC(REC,ORID,ORVP,ORNP,ORL,REAS,DCORIG,ISNEWORD) ;\par
"RTN","AHMLDOL",43,0)\par
 D PROXY^RAHBIN2(.DUZ,.DUZNME)\par
"RTN","AHMLDOL",44,0)\par
 S ORNP=DUZ\par
"RTN","AHMLDOL",45,0)\par
 S REMOTE=1\par
"RTN","AHMLDOL",46,0)\par
 N FLG,FLAG,LRSEND,LRODT,LRSN,LRSEND,ORN,LRIEN,LRFILE,LRAA,LRAN,LRAD\par
"RTN","AHMLDOL",47,0)\par
 S (FLG,FLAG)=0,(LRAA,LRAN,LRAD)=""\par
"RTN","AHMLDOL",48,0)\par
 S (DCORIG,ISNEWORD)=0\par
"RTN","AHMLDOL",49,0)\par
 S ORDNUM=+ORID\par
"RTN","AHMLDOL",50,0)\par
 S FILE=100,ORIEN=ORDNUM_","\par
"RTN","AHMLDOL",51,0)\par
 I $$GET1^DIQ(FILE,ORIEN,31,"I") D  Q:FLG\par
"RTN","AHMLDOL",52,0)\par
 .I $$GET1^DIQ(FILE,ORIEN,5,"I")=1 S NDE=$O(^OR(100,ORDNUM,8,9999),-1),REC(1)=ORDNUM_";"_NDE_"^RS" S FLG=1 Q\par
"RTN","AHMLDOL",53,0)\par
 Q:FLG\par
"RTN","AHMLDOL",54,0)\par
 S STATUS=$$GET1^DIQ(100,ORDNUM_",",5,"I")\par
"RTN","AHMLDOL",55,0)\par
 S PTYPE=$$GET1^DIQ(100,ORDNUM_",",12),PTYPE=$E(PTYPE,1,3)\par
"RTN","AHMLDOL",56,0)\par
 I PTYPE'["RAD" D\par
"RTN","AHMLDOL",57,0)\par
 .I STATUS=2 D  Q\par
"RTN","AHMLDOL",58,0)\par
 ..S REC(1)="Warning: Not cancelled. Lab order is already completed."\par
"RTN","AHMLDOL",59,0)\par
 .I $G(ACT)="DC" D\par
"RTN","AHMLDOL",60,0)\par
 ..I $G(REAS)'="" S REASIEN="",REASIEN=$O(^ORD(100.03,"B",REAS,REASIEN))\par
"RTN","AHMLDOL",61,0)\par
 ..I $G(REASIEN)>0 S REAS=REASIEN\par
"RTN","AHMLDOL",62,0)\par
 .S LRFILE=100,LRIEN=ORDNUM_","\par
"RTN","AHMLDOL",63,0)\par
 .S LRDATA=$$GET1^DIQ(LRFILE,LRIEN,33,"I") I LRDATA="" Q\par
"RTN","AHMLDOL",64,0)\par
 .S LRORD=$P(LRDATA,";"),LRODT=$P(LRDATA,";",2),LRSND=$P(LRDATA,";",3)\par
"RTN","AHMLDOL",65,0)\par
 .Q:$G(LRORD)=""\par
"RTN","AHMLDOL",66,0)\par
 .Q:$G(LRODT)=""\par
"RTN","AHMLDOL",67,0)\par
 .Q:$G(LRSND)=""\par
"RTN","AHMLDOL",68,0)\par
 .I '$D(^LRO(69,LRODT,1,LRSND)) Q\par
"RTN","AHMLDOL",69,0)\par
 .I '$D(^LRO(69,LRODT,1,LRSND,2)) Q\par
"RTN","AHMLDOL",70,0)\par
 .S LRSEND=0 F  S LRSEND=$O(^LRO(69,LRODT,1,LRSND,2,LRSEND)) Q:LRSEND'?.N  D\par
"RTN","AHMLDOL",71,0)\par
 ..S ORN=$P(^LRO(69,LRODT,1,LRSND,2,LRSEND,0),U,7)\par
"RTN","AHMLDOL",72,0)\par
 ..I ORN=ORDNUM D\par
"RTN","AHMLDOL",73,0)\par
 ...S LRSN=LRSND,LRI=LRSEND,ORIFN=ORN\par
"RTN","AHMLDOL",74,0)\par
 ...S LRTEST=$P(^LRO(69,LRODT,1,LRSND,2,LRSEND,0),U)\par
"RTN","AHMLDOL",75,0)\par
 ...S LRSS=$$GET1^DIQ(60,LRTEST,4,"I")\par
"RTN","AHMLDOL",76,0)\par
 ...S LIEN=LRSN_","_LRODT_","\par
"RTN","AHMLDOL",77,0)\par
 ...S LRDFN=$$GET1^DIQ(69.01,LIEN,.01,"I")\par
"RTN","AHMLDOL",78,0)\par
 ...S PNM=$$GET1^DIQ(2,ORVP,.01,"I"),LRDPF=2\par
"RTN","AHMLDOL",79,0)\par
 ...S LRAA=$P(^LRO(69,LRODT,1,LRSND,2,LRSEND,0),U,4)\par
"RTN","AHMLDOL",80,0)\par
 ...S LRAD=$P(^LRO(69,LRODT,1,LRSND,2,LRSEND,0),U,3)\par
"RTN","AHMLDOL",81,0)\par
 ...S LRAN=$P(^LRO(69,LRODT,1,LRSND,2,LRSEND,0),U,5)\par
"RTN","AHMLDOL",82,0)\par
 .I ACT="OC" S FLAG=1\par
"RTN","AHMLDOL",83,0)\par
 .I LRAA'="",LRAD'="",LRAN'="" S FLAG=1\par
"RTN","AHMLDOL",84,0)\par
 I PTYPE["RAD" D\par
"RTN","AHMLDOL",85,0)\par
 .I STATUS=2 D  Q\par
"RTN","AHMLDOL",86,0)\par
 ..S REC(1)="Warning: Not cancelled. Rad order is already completed."\par
"RTN","AHMLDOL",87,0)\par
 .I $G(ACT)="DC" D\par
"RTN","AHMLDOL",88,0)\par
 ..I $G(REAS)'="" S REASIEN="",REASIEN=$O(^ORD(100.03,"B",REAS,REASIEN))\par
"RTN","AHMLDOL",89,0)\par
 ..I $G(REASIEN)>0 S REAS=REASIEN\par
"RTN","AHMLDOL",90,0)\par
 .I STATUS'=5 D  Q\par
"RTN","AHMLDOL",91,0)\par
 ..K RADFDA,ERRMSG,RAONUM,EXMSTA,NOW\par
"RTN","AHMLDOL",92,0)\par
 ..N RADTI,RACNI\par
"RTN","AHMLDOL",93,0)\par
 ..S FILE=100,RAIEN=ORDNUM_","\par
"RTN","AHMLDOL",94,0)\par
 ..S RAOIFN=$$GET1^DIQ(FILE,RAIEN,33,"I") I RAOIFN="" D\par
"RTN","AHMLDOL",95,0)\par
 ...S JVOROUT(1)="-1^Error: Case number does not exist in the order file." Q\par
"RTN","AHMLDOL",96,0)\par
 ..S RAOSTS=1,RAOREA=25,RADFN=ORVP\par
"RTN","AHMLDOL",97,0)\par
 ..S RADTI=$O(^RADPT("AO",RAOIFN,RADFN,""))\par
"RTN","AHMLDOL",98,0)\par
 ..S RACNI=$O(^RADPT("AO",RAOIFN,RADFN,RADTI,""))\par
"RTN","AHMLDOL",99,0)\par
 ..D ^RAORDU\par
"RTN","AHMLDOL",100,0)\par
 ..;Ensure Rad Order file is updated to discontinue\par
"RTN","AHMLDOL",101,0)\par
 ..D NOW^%DTC S NOW=% K %\par
"RTN","AHMLDOL",102,0)\par
 ..S RADFDA(75.1,RAOIFN_",",5)=1  ;4076;0 was an invalid code, use 1=DC\par
"RTN","AHMLDOL",103,0)\par
 ..S RADFDA(75.1,RAOIFN_",",18)=NOW\par
"RTN","AHMLDOL",104,0)\par
 ..D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOL",105,0)\par
 ..S DIE="^OR(100,",DA=+ORID,DR="65////"_REAS_";" D ^DIE K DIE,DA\par
"RTN","AHMLDOL",106,0)\par
 ..;Must have proper status number for RADPT status\par
"RTN","AHMLDOL",107,0)\par
 ..S PROC=$$GET1^DIQ(75.1,RAOIFN,2,"I")\par
"RTN","AHMLDOL",108,0)\par
 ..S STATUS="CANCELLED"\par
"RTN","AHMLDOL",109,0)\par
 ..S EXMSTA=$$GETSTA^RAHBIN2(PROC,STATUS)\par
"RTN","AHMLDOL",110,0)\par
 ..D X7005^RADD3(RADFN,RADTI,RACNI,1,"",EXMSTA,$G(ORNP))\par
"RTN","AHMLDOL",111,0)\par
 ..S $P(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0),U,3)=EXMSTA\par
"RTN","AHMLDOL",112,0)\par
 ..S REC(1)=ORDNUM_"^RS",FLAG=1\par
"RTN","AHMLDOL",113,0)\par
 ..;PACS msg - for Cancel - needs RAEID,RADFN,RADTI,RACNI defined\par
"RTN","AHMLDOL",114,0)\par
 ..S RAEID=$O(^ORD(101,"B","RA CANCEL 2.3",0))\par
"RTN","AHMLDOL",115,0)\par
 ..D EN^RAHLR\par
"RTN","AHMLDOL",116,0)\par
 I 'FLAG D\par
"RTN","AHMLDOL",117,0)\par
 .D DC^ORWDXA(.REC,ORID,ORNP,ORL,REAS,DCORIG,ISNEWORD)\par
"RTN","AHMLDOL",118,0)\par
 .D BLDSND^AHMLDOL1(.REC,.ORWREC)\par
"RTN","AHMLDOL",119,0)\par
 .K REC S ES="AA",ORWLST=""\par
"RTN","AHMLDOL",120,0)\par
 .D SEND^ORWDX(.ORWLST,ORVP,ORNP,ORL,ES,.ORWREC)\par
"RTN","AHMLDOL",121,0)\par
 .M REC=ORWLST K ORWLST\par
"RTN","AHMLDOL",122,0)\par
 I PTYPE'="RAD",REAS'?.N D\par
"RTN","AHMLDOL",123,0)\par
 .N DEF,R,PKG,X,OK\par
"RTN","AHMLDOL",124,0)\par
 .S PKG=$O(^DIC(9.4,"B","LAB SERVICE",0))\par
"RTN","AHMLDOL",125,0)\par
 .S DEF=$P($G(^LAB(69.9,1,"OR")),"^",2)\par
"RTN","AHMLDOL",126,0)\par
 .S X=$$DC^ORX1(DEF,+$G(REQ),PKG,"Cancellation Reason"),LRNATURE=$S(X:"^^^"_$P(X,"^",1,2)_"^99ORR",1:-1)\par
"RTN","AHMLDOL",127,0)\par
 .S LRSN=LRSND\par
"RTN","AHMLDOL",128,0)\par
 .S LRTNM=$$GET1^DIQ(60,LRTEST,.01,"I")\par
"RTN","AHMLDOL",129,0)\par
 .S LRCCOM=$G(REAS)\par
"RTN","AHMLDOL",130,0)\par
 .S LRCCOM=$P(LRCCOM,"*",1,2)\par
"RTN","AHMLDOL",131,0)\par
 .S ORIFN=ORN,LRTSTS=LRTEST\par
"RTN","AHMLDOL",132,0)\par
 .D ^LRPARAM\par
"RTN","AHMLDOL",133,0)\par
 .;Call LRTSTOUT to update file 69, 68 and 63\par
"RTN","AHMLDOL",134,0)\par
 .D SET^LRTSTOUT\par
"RTN","AHMLDOL",135,0)\par
 I '$D(REC(1)) S REC(1)=ORID_"^RS"\par
"RTN","AHMLDOL",136,0)\par
 Q\par
"RTN","AHMLDOL",137,0)\par
 ;\par
"RTN","AHMLDOL",138,0)\par
CAN69(LRTEST,ORIFN,LRODT,LRSND,LRSEND) ;\par
"RTN","AHMLDOL",139,0)\par
 S LRNOW=$$NOW^XLFDT\par
"RTN","AHMLDOL",140,0)\par
 I $G(REMOTE)=1 D\par
"RTN","AHMLDOL",141,0)\par
 .N II,JVACC,JVDT,JVXREF,LRDFN,LRIDT,LRMSTATI,LRSTATUS,LRI\par
"RTN","AHMLDOL",142,0)\par
 .S X=1+$O(^LRO(69,LRODT,1,LRSND,2,LRSEND,1.1,"A"),-1),X(1)=$P($G(^(0)),U,4)\par
"RTN","AHMLDOL",143,0)\par
 .S LRNATURE="SERVICE CORRECTION",LRNOW=$$NOW^XLFDT\par
"RTN","AHMLDOL",144,0)\par
 .S LRCCOM="SERVICE CORRECTION.",LRSTATUS="",LRMSTATI="OC"\par
"RTN","AHMLDOL",145,0)\par
 .S ^LRO(69,LRODT,1,LRSND,2,LRSEND,1.1,0)="^^"_X_"^"_X(1)_"^"_DT\par
"RTN","AHMLDOL",146,0)\par
 .I $G(ORIFN),$D(II) D NEW^LR7OB1(LRODT,LRSND,$S($G(LRMSTATI)=""!($G(LRMSTATI)=1):"OC",1:"SC"),$G(LRNATURE),.II,LRSTATUS)\par
"RTN","AHMLDOL",147,0)\par
 .S $P(^LRO(69,LRODT,1,LRSND,2,LRSEND,0),"^",9)="CA",$P(^(0),U,10)="L",$P(^(0),U,11)=$G(ORNP)\par
"RTN","AHMLDOL",148,0)\par
 .S:$D(^LRO(69,LRODT,1,LRSND,"PCE")) ^LRO(69,"AE",DUZ,LRODT,LRSND,LRSEND)=""\par
"RTN","AHMLDOL",149,0)\par
 ;DELETE MANAGEMENT REPORT CROSS REFERENCES\par
"RTN","AHMLDOL",150,0)\par
 ;S LRAD=$P($G(^LRO(69,LRODT,1,LRSND,2,LRSEND,0)),"^",3)\par
"RTN","AHMLDOL",151,0)\par
 ;S LRAA=$P($G(^LRO(69,LRODT,1,LRSND,2,LRSEND,0)),"^",4)\par
"RTN","AHMLDOL",152,0)\par
 ;S LRAN=$P($G(^LRO(69,LRODT,1,LRSND,2,LRSEND,0)),"^",5)\par
"RTN","AHMLDOL",153,0)\par
 S ORID=ORIFN\par
"RTN","AHMLDOL",154,0)\par
 D DLTRPT(ORID,LRAA,LRAD,LRAN,LRODT,LRSND)\par
"RTN","AHMLDOL",155,0)\par
 Q\par
"RTN","AHMLDOL",156,0)\par
 ;\par
"RTN","AHMLDOL",157,0)\par
DLTRPT(ORID,LRAA,LRAD,LRAN,LRODT,LRSND) ;\par
"RTN","AHMLDOL",158,0)\par
 ;IF LRAA IS NOT DEFINED, ORDER NOT ACCESSIONED SO QUIT\par
"RTN","AHMLDOL",159,0)\par
 I $G(LRAA)="" S JVOROUT(1)=ORIFN_";"_2_"^"_"RS" Q\par
"RTN","AHMLDOL",160,0)\par
 S LRDFN=$P($G(^LRO(68,LRAA,1,LRAD,1,LRAN,0)),"^")\par
"RTN","AHMLDOL",161,0)\par
 S JVACC=^LRO(68,LRAA,1,LRAD,1,LRAN,.2)\par
"RTN","AHMLDOL",162,0)\par
 S LRIDT=$P($G(^LRO(68,LRAA,1,LRAD,1,LRAN,3)),"^",5)\par
"RTN","AHMLDOL",163,0)\par
 Q:$G(JVACC)=""\par
"RTN","AHMLDOL",164,0)\par
 ;CHECK IF FILE 68 EXISTS FOR THIS RECORD, DELETE FILE 63.\par
"RTN","AHMLDOL",165,0)\par
 I $G(LRAA)>0 S SUCCESS=0 D CAN63(LRAA,LRAD,LRAN,LRDFN,LRSS,LRTEST,.SUCCESS)\par
"RTN","AHMLDOL",166,0)\par
 I $G(SUCCESS)>0 S REC(1)=ORID_"^RS"\par
"RTN","AHMLDOL",167,0)\par
 I $G(SUCCESS)'>0 S REC(1)="-1^Error: Discontinue failed." Q\par
"RTN","AHMLDOL",168,0)\par
 Q\par
"RTN","AHMLDOL",169,0)\par
 ;\par
"RTN","AHMLDOL",170,0)\par
CAN63(LRAA,LRAD,LRAN,LRDFN,LRSS,LRTEST,SUCCESS) ;\par
"RTN","AHMLDOL",171,0)\par
 N JV,LRI\par
"RTN","AHMLDOL",172,0)\par
 S JVIENS=LRAN_","_LRAD_","_LRAA_",",LRFILE=68.02\par
"RTN","AHMLDOL",173,0)\par
 S INVDT=$$GET1^DIQ(LRFILE,JVIENS,13.5,"I"),LRI=INVDT\par
"RTN","AHMLDOL",174,0)\par
 S JVIENS=LRTEST_","_LRAN_","_LRAD_","_LRAA_",",LRFILE=68.04\par
"RTN","AHMLDOL",175,0)\par
 S JVFDA(4,LRFILE,JVIENS,4)=$$NOW^XLFDT\par
"RTN","AHMLDOL",176,0)\par
 D UPDATE^DIE("","JVFDA(4)","JVIENS","JVMSG")\par
"RTN","AHMLDOL",177,0)\par
 S TEST=$$GET1^DIQ(60,LRTEST,.01)\par
"RTN","AHMLDOL",178,0)\par
 S PFMBY=$$GET1^DIQ(200,DUZ,.01)\par
"RTN","AHMLDOL",179,0)\par
 S TEXT="*"_$G(TEST)_" Not Performed: "_$$FMTE^XLFDT(LRNOW,"1FMZ")_" by "_$G(PFMBY)\par
"RTN","AHMLDOL",180,0)\par
 S LRFILE=$S(LRSS="CH":63.041,LRSS="MI":63.051,1:0)\par
"RTN","AHMLDOL",181,0)\par
 S FDA(2,LRFILE,"+2,"_INVDT_","_LRDFN_",",.01)=TEXT\par
"RTN","AHMLDOL",182,0)\par
 D UPDATE^DIE("","FDA(2)","","LRERR(2)")\par
"RTN","AHMLDOL",183,0)\par
 K FDA(1),LRDIE(1)\par
"RTN","AHMLDOL",184,0)\par
 D CLEAN^DILF\par
"RTN","AHMLDOL",185,0)\par
 Q\par
"RTN","AHMLDOL",186,0)\par
 ;\par
"RTN","AHMLDOL1")\par
0^2^B74955905\par
"RTN","AHMLDOL1",1,0)\par
AHMLDOL1 ;LEIDOS/TCK; REMOTE ORDERING; 12/14/15 6:09pm ; 10/16/16 8:37pm\par
"RTN","AHMLDOL1",2,0)\par
 ;;1.0;Remote orders;;JAN 1, 2016;Build 26\par
"RTN","AHMLDOL1",3,0)\par
 ;--------------------------------------------------------------------\par
"RTN","AHMLDOL1",4,0)\par
EN(REC,TYPE,LOC) ;\par
"RTN","AHMLDOL1",5,0)\par
 ;\par
"RTN","AHMLDOL1",6,0)\par
 K ORD,OR,OLDOR,ORNUM\par
"RTN","AHMLDOL1",7,0)\par
 Q:'$D(REC)\par
"RTN","AHMLDOL1",8,0)\par
 S ACT=""\par
"RTN","AHMLDOL1",9,0)\par
 D ACTION(.REC,.ACT,.ORN)\par
"RTN","AHMLDOL1",10,0)\par
 I ACT="AE" D MAIL(.REC) Q\par
"RTN","AHMLDOL1",11,0)\par
 D GTDATA(.REC,.ORVP,.ORNP,.ORL,.DLG,.ORDG,.ORIT,.ORIFN,.REAS,TYPE)\par
"RTN","AHMLDOL1",12,0)\par
 I ACT="NW" Q\par
"RTN","AHMLDOL1",13,0)\par
 I (ACT["OC")!(ACT["CA")!(ACT["DC") D\par
"RTN","AHMLDOL1",14,0)\par
 .S ORID=$G(ORIFN),(DCORIG,ISNEWORD)=0\par
"RTN","AHMLDOL1",15,0)\par
 .I ORID'="" D\par
"RTN","AHMLDOL1",16,0)\par
 ..S ORL=+$$GET1^DIQ(100,ORID,6,"I")\par
"RTN","AHMLDOL1",17,0)\par
 ..I ORID'[";" S ORID=ORID_";1"\par
"RTN","AHMLDOL1",18,0)\par
 ..D DC^AHMLDOL(.REC,ORID,ORVP,ORNP,ORL,REAS,DCORIG,ISNEWORD)\par
"RTN","AHMLDOL1",19,0)\par
 I ACT["SC" D EN^AHMLDOL2(.JVOROUT,.REC) ;ACCESSION MESSAGE FROM SPOKE\par
"RTN","AHMLDOL1",20,0)\par
 I ACT["RE" D EN^AHMLDOL2(.JVOROUT,.REC)  ;FILE RESULTS FROM SPOKE\par
"RTN","AHMLDOL1",21,0)\par
 D END\par
"RTN","AHMLDOL1",22,0)\par
 ;\par
"RTN","AHMLDOL1",23,0)\par
 Q\par
"RTN","AHMLDOL1",24,0)\par
 ;-----------------------------------------------------------------------\par
"RTN","AHMLDOL1",25,0)\par
MAIL(REC) ; Send email if AE received.\par
"RTN","AHMLDOL1",26,0)\par
 ;\par
"RTN","AHMLDOL1",27,0)\par
 ;   Input: REC - HL(772 data\par
"RTN","AHMLDOL1",28,0)\par
 ;\par
"RTN","AHMLDOL1",29,0)\par
 ;  Output: Email\par
"RTN","AHMLDOL1",30,0)\par
 ;\par
"RTN","AHMLDOL1",31,0)\par
 K ^XTMP("LRHB",$J)\par
"RTN","AHMLDOL1",32,0)\par
 ;\par
"RTN","AHMLDOL1",33,0)\par
 N ERRMSG,I,OLORD,PLAB\par
"RTN","AHMLDOL1",34,0)\par
 ;\par
"RTN","AHMLDOL1",35,0)\par
 S (ERRMSG,J,PLAB)="",I=0\par
"RTN","AHMLDOL1",36,0)\par
 ;\par
"RTN","AHMLDOL1",37,0)\par
 F  S J=$O(REC(J)) Q:J=""  D  Q:ERRMSG]""\par
"RTN","AHMLDOL1",38,0)\par
 .I $P(REC(J),"|")="MSH" S PLAB=$P(REC(J),"|",4)      ; performing lab\par
"RTN","AHMLDOL1",39,0)\par
 .I $P(REC(J),"|")="MSA" D  Q\par
"RTN","AHMLDOL1",40,0)\par
 ..S ERRMSG=$P(REC(J),"|",4),OLORD=$P(REC(J),"|",5)   ; error text & order number\par
"RTN","AHMLDOL1",41,0)\par
 ;\par
"RTN","AHMLDOL1",42,0)\par
 S I=I+1,^XTMP("LRHB",$J,I)="   Order#: "_OLORD_"  Performing Lab: "\par
"RTN","AHMLDOL1",43,0)\par
 S ^XTMP("LRHB",$J,I)=^XTMP("LRHB",$J,1)_$$GET1^DIQ(4,PLAB,.01)\par
"RTN","AHMLDOL1",44,0)\par
 S I=I+1,^XTMP("LRHB",$J,I)="  Patient: "_$$GET1^DIQ(100,OLORD,.02)\par
"RTN","AHMLDOL1",45,0)\par
 S I=I+1,^XTMP("LRHB",$J,I)=" Provider: "_$$GET1^DIQ(100,OLORD,1)\par
"RTN","AHMLDOL1",46,0)\par
 S TEST=$G(^OR(100,OLORD,4.5,1,1))\par
"RTN","AHMLDOL1",47,0)\par
 S I=I+1,^XTMP("LRHB",$J,I)="Orderable: "_$$GET1^DIQ(101.43,TEST,.01)\par
"RTN","AHMLDOL1",48,0)\par
 S I=I+1,^XTMP("LRHB",$J,I)=$TR($J(" ",60)," ","-")\par
"RTN","AHMLDOL1",49,0)\par
 S I=I+1,^XTMP("LRHB",$J,I)="Application error: "_ERRMSG\par
"RTN","AHMLDOL1",50,0)\par
 S XMSUB="Application Error Received"\par
"RTN","AHMLDOL1",51,0)\par
 S XMY("G.REMOTE_ORDERS_AE_ALERTS")=""\par
"RTN","AHMLDOL1",52,0)\par
 D ^XMD\par
"RTN","AHMLDOL1",53,0)\par
 ;\par
"RTN","AHMLDOL1",54,0)\par
 K ^XTMP("LRHB",$J)\par
"RTN","AHMLDOL1",55,0)\par
 ;\par
"RTN","AHMLDOL1",56,0)\par
 Q\par
"RTN","AHMLDOL1",57,0)\par
 ;-----------------------------------------------------------------------\par
"RTN","AHMLDOL1",58,0)\par
UPDTOR(OR,ORNP) ;\par
"RTN","AHMLDOL1",59,0)\par
 ;\par
"RTN","AHMLDOL1",60,0)\par
 Q:$G(OR)'>0\par
"RTN","AHMLDOL1",61,0)\par
 S ORD=+OR\par
"RTN","AHMLDOL1",62,0)\par
 S LRIENS=1_","_ORD_","\par
"RTN","AHMLDOL1",63,0)\par
 S LRFDA(1,100.008,LRIENS,13)=ORNP\par
"RTN","AHMLDOL1",64,0)\par
 D UPDATE^DIE("","LRFDA(1)","LRMSG")\par
"RTN","AHMLDOL1",65,0)\par
 ;\par
"RTN","AHMLDOL1",66,0)\par
 Q\par
"RTN","AHMLDOL1",67,0)\par
 ;-----------------------------------------------------------------------\par
"RTN","AHMLDOL1",68,0)\par
BLDXRF(ORNUM,NWOR) ;\par
"RTN","AHMLDOL1",69,0)\par
 ;\par
"RTN","AHMLDOL1",70,0)\par
 I '$D(^XTMP(TYPE)) D SETZERO(TYPE)\par
"RTN","AHMLDOL1",71,0)\par
 Q:'$D(^XTMP(TYPE))\par
"RTN","AHMLDOL1",72,0)\par
 I $D(^XTMP(TYPE)) D\par
"RTN","AHMLDOL1",73,0)\par
 .S ^XTMP(TYPE,+ORNUM)=+ORD\par
"RTN","AHMLDOL1",74,0)\par
 .S ^XTMP(TYPE,"B",+ORD)=+ORNUM\par
"RTN","AHMLDOL1",75,0)\par
 .S ^XTMP(TYPE,"CNT")=$G(^XTMP(TYPE,"CNT"))+1\par
"RTN","AHMLDOL1",76,0)\par
 ;\par
"RTN","AHMLDOL1",77,0)\par
 Q\par
"RTN","AHMLDOL1",78,0)\par
 ;-----------------------------------------------------------------------\par
"RTN","AHMLDOL1",79,0)\par
SETZERO(TYPE) ;\par
"RTN","AHMLDOL1",80,0)\par
 ;\par
"RTN","AHMLDOL1",81,0)\par
 D NOW^%DTC S X1=$P(%,".",1),X2=365,Y=X1 D C^%DTC\par
"RTN","AHMLDOL1",82,0)\par
 S ^XTMP(TYPE,0)=X_"^"_Y_" OR XREF FOR REMOTE ORDER"\par
"RTN","AHMLDOL1",83,0)\par
 S ^XTMP(TYPE,0,"CNT")=0\par
"RTN","AHMLDOL1",84,0)\par
 ;\par
"RTN","AHMLDOL1",85,0)\par
 Q\par
"RTN","AHMLDOL1",86,0)\par
 ;-----------------------------------------------------------------------\par
"RTN","AHMLDOL1",87,0)\par
ACTION(REC,ACT,ORN) ;\par
"RTN","AHMLDOL1",88,0)\par
 ;\par
"RTN","AHMLDOL1",89,0)\par
 N I,STOP\par
"RTN","AHMLDOL1",90,0)\par
 ;\par
"RTN","AHMLDOL1",91,0)\par
 S (ACT,I)="",STOP=0\par
"RTN","AHMLDOL1",92,0)\par
 ;\par
"RTN","AHMLDOL1",93,0)\par
 F  S I=$O(REC(I)) Q:I=""  S MSGTYP=$P(REC(I),"|") D  Q:STOP\par
"RTN","AHMLDOL1",94,0)\par
 .;\par
"RTN","AHMLDOL1",95,0)\par
 .I MSGTYP="ORC" D  Q\par
"RTN","AHMLDOL1",96,0)\par
 ..S ORN=+$P(REC(I),"|",3),ACT=$P(REC(I),"|",2),STOP=1\par
"RTN","AHMLDOL1",97,0)\par
 .;\par
"RTN","AHMLDOL1",98,0)\par
 .I MSGTYP="MSA" D  Q\par
"RTN","AHMLDOL1",99,0)\par
 ..S ORN="",ACT=$P(REC(I),"|",2),STOP=1   ;[not sure about ORN???]\par
"RTN","AHMLDOL1",100,0)\par
 ;\par
"RTN","AHMLDOL1",101,0)\par
 Q\par
"RTN","AHMLDOL1",102,0)\par
 ;-----------------------------------------------------------------------\par
"RTN","AHMLDOL1",103,0)\par
BLDSND(REC,ORWREC,ORNUM) ;\par
"RTN","AHMLDOL1",104,0)\par
 Q:'$D(REC(1))\par
"RTN","AHMLDOL1",105,0)\par
 S ORNUM=$P(REC(1),"^")\par
"RTN","AHMLDOL1",106,0)\par
 S ORNUM=$E(ORNUM,2,99)\par
"RTN","AHMLDOL1",107,0)\par
 S ORWREC(1)=ORNUM_"^"_1_"^"_1_"^"_"E"\par
"RTN","AHMLDOL1",108,0)\par
 ;\par
"RTN","AHMLDOL1",109,0)\par
 Q\par
"RTN","AHMLDOL1",110,0)\par
 ;-----------------------------------------------------------------------\par
"RTN","AHMLDOL1",111,0)\par
GTDATA(REC,ORVP,ORNP,ORL,DLG,ORDG,ORIT,ORIFN,REAS,TYPE) ;\par
"RTN","AHMLDOL1",112,0)\par
 ;\par
"RTN","AHMLDOL1",113,0)\par
 N I,CNT,QUIT\par
"RTN","AHMLDOL1",114,0)\par
 S (ORVP,ORNP,ORL,DLG,ORDG,ORIT,ORIFN)="",QUIT=0\par
"RTN","AHMLDOL1",115,0)\par
 I TYPE="LAB" S DLG="LR OTHER LAB TESTS"\par
"RTN","AHMLDOL1",116,0)\par
 I TYPE="RAD" S DLG="RA OERR EXAM"\par
"RTN","AHMLDOL1",117,0)\par
 S ORIT=$O(^ORD(101.41,"AB",DLG,0))\par
"RTN","AHMLDOL1",118,0)\par
 S ORDG=$O(^ORD(100.98,"B",TYPE,0))\par
"RTN","AHMLDOL1",119,0)\par
 S I="" F  S I=$O(REC(I)) Q:I=""  D\par
"RTN","AHMLDOL1",120,0)\par
 .S MSGNDE=REC(I),MSGTYP=$P($G(MSGNDE),"|")\par
"RTN","AHMLDOL1",121,0)\par
 .Q:MSGTYP=""\par
"RTN","AHMLDOL1",122,0)\par
 .Q:MSGTYP["BHS"\par
"RTN","AHMLDOL1",123,0)\par
 .I MSGTYP["MSH",$P(MSGNDE,"|",9)="ORR" Q\par
"RTN","AHMLDOL1",124,0)\par
 .I MSGTYP["PID" D\par
"RTN","AHMLDOL1",125,0)\par
 ..S ORVP=$P(MSGNDE,"|",3)\par
"RTN","AHMLDOL1",126,0)\par
 ..I $G(ORVP)'>0 S ORVP=$P(MSGNDE,"|",4)\par
"RTN","AHMLDOL1",127,0)\par
 ..I ORVP["-" S ORVP=+$P(ORVP,"-",2)\par
"RTN","AHMLDOL1",128,0)\par
 ..I $G(ORVP)>0 S ORVPNME=$$GET1^DIQ(2,ORVP,.01,"E")\par
"RTN","AHMLDOL1",129,0)\par
 ..;S ORVPNME=$P(MSGNDE,"|",6)\par
"RTN","AHMLDOL1",130,0)\par
 ..I $D(^DPT("B",ORVPNME)) D\par
"RTN","AHMLDOL1",131,0)\par
 ...S ORVP="",ORVP=$O(^DPT("B",ORVPNME,ORVP))\par
"RTN","AHMLDOL1",132,0)\par
 .I MSGTYP["PV1" D\par
"RTN","AHMLDOL1",133,0)\par
 ..S ORL=$P(REC(I),"|",4)\par
"RTN","AHMLDOL1",134,0)\par
 .I TYPE="LAB" D\par
"RTN","AHMLDOL1",135,0)\par
 ..I MSGTYP["ORC" D\par
"RTN","AHMLDOL1",136,0)\par
 ...S ST=$P(REC(I),"|",2)\par
"RTN","AHMLDOL1",137,0)\par
 ...S ORIFN=+$P(MSGNDE,"|",3)\par
"RTN","AHMLDOL1",138,0)\par
 ...S ORNP=$P(MSGNDE,"|",13)\par
"RTN","AHMLDOL1",139,0)\par
 ...D PROXY^RAHBIN2(.ORNP,.ORNPNME)\par
"RTN","AHMLDOL1",140,0)\par
 ...;S ORNPNME=$P($P(MSGNDE,"|",13),"^",2,3)\par
"RTN","AHMLDOL1",141,0)\par
 ...;I ORNPNME["^" S ORNPNME=$TR(ORNPNME,"^",",")\par
"RTN","AHMLDOL1",142,0)\par
 ...;I $D(^VA(200,"B",ORNPNME)) D\par
"RTN","AHMLDOL1",143,0)\par
 ....;S ORNP="",ORNP=$O(^VA(200,"B",ORNPNME,ORNP))\par
"RTN","AHMLDOL1",144,0)\par
 ...S COL=$P($P(MSGNDE,"|",8),"^",4)\par
"RTN","AHMLDOL1",145,0)\par
 ...S COL=$$HL7TFM^XLFDT(COL,"L")\par
"RTN","AHMLDOL1",146,0)\par
 ...I $P(COL,".",2)="" S COL="TODAY"\par
"RTN","AHMLDOL1",147,0)\par
 ...S COLLECTIONDATETIME=COL\par
"RTN","AHMLDOL1",148,0)\par
 ...S START=COLLECTIONDATETIME\par
"RTN","AHMLDOL1",149,0)\par
 ...I $G(ST)="CA" S REAS=$P($P(MSGNDE,"|",17),"^",4),ST=""\par
"RTN","AHMLDOL1",150,0)\par
 ..I MSGTYP["NTE",ST="OC" S ST="" D\par
"RTN","AHMLDOL1",151,0)\par
 ...S LRCCOM=$P(REC(I),"|",4),LRCCOM=$P(LRCCOM,":",2,4)\par
"RTN","AHMLDOL1",152,0)\par
 ...S REAS=LRCCOM\par
"RTN","AHMLDOL1",153,0)\par
 ..I MSGTYP["OBR" D  Q:QUIT\par
"RTN","AHMLDOL1",154,0)\par
 ...S OBRNDE=REC(I)\par
"RTN","AHMLDOL1",155,0)\par
 ...S TSTNDE=$P(OBRNDE,"|",5)\par
"RTN","AHMLDOL1",156,0)\par
 ...I TSTNDE'="" S TSTNME=$P(TSTNDE,"^",5)\par
"RTN","AHMLDOL1",157,0)\par
 ...I TSTNME="" S REC(1)="-1^ERR: LAB TEST NOT FOUND",QUIT=1 Q\par
"RTN","AHMLDOL1",158,0)\par
 ...I '$D(^LAB(60,"B",TSTNME)) S REC(1)="-1^ERR: LAB TEST NOT FOUND",QUIT=1 Q\par
"RTN","AHMLDOL1",159,0)\par
 ...S LABTEST="",LABTEST=$O(^LAB(60,"B",TSTNME,LABTEST))\par
"RTN","AHMLDOL1",160,0)\par
 ...I LABTEST="" S REC(1)="-1^ERR: LAB TEST NOT FOUND",QUIT=1 Q\par
"RTN","AHMLDOL1",161,0)\par
 ...S SAMPLE=$P(OBRNDE,"|",16),SAMPLE=+$P(SAMPLE,"^",4)\par
"RTN","AHMLDOL1",162,0)\par
 ...S SPECIMEN=$P(OBRNDE,"|",16),SPECIMEN=$P(SPECIMEN,";",4)\par
"RTN","AHMLDOL1",163,0)\par
 ...S COLLECTEDBY="SP",HOWOFTEN=28\par
"RTN","AHMLDOL1",164,0)\par
 ...S URG=$P($P(OBRNDE,"|",28),"^",6),URGENCY=$P(URG,";",2)\par
"RTN","AHMLDOL1",165,0)\par
 ...S LOC=565\par
"RTN","AHMLDOL1",166,0)\par
 ...S LOCNME=$$GET1^DIQ(4,LOC,.01,"E")\par
"RTN","AHMLDOL1",167,0)\par
 ...;S COMMENT="**ORDER ORIGINATED IN "_LOCNME_"**"\par
"RTN","AHMLDOL1",168,0)\par
 .I TYPE="RAD" D\par
"RTN","AHMLDOL1",169,0)\par
 ..I MSGTYP["ORC" D\par
"RTN","AHMLDOL1",170,0)\par
 ...S ORIFN=$P(MSGNDE,"|",3)\par
"RTN","AHMLDOL1",171,0)\par
 ...S USR="" D PROXY^RAHBIN2(.USR,.USRNME)\par
"RTN","AHMLDOL1",172,0)\par
 ...;S USRNME="PROXY,PROVIDER"\par
"RTN","AHMLDOL1",173,0)\par
 ...;I $D(^VA(200,"B",USRNME)) D\par
"RTN","AHMLDOL1",174,0)\par
 ....;S USR="",USR=$O(^VA(200,"B",USRNME,USR))\par
"RTN","AHMLDOL1",175,0)\par
 ...I $G(USR)>0 S $P(REC(I),"|",11)=USR_"^"_USRNME\par
"RTN","AHMLDOL1",176,0)\par
 ...S ORNP=$P(MSGNDE,"|",13) D PROXY^RAHBIN2(.ORNP,.ORNPNME)\par
"RTN","AHMLDOL1",177,0)\par
 ...;S ORNPNME=$P($P(MSGNDE,"|",13),"^",2,3)\par
"RTN","AHMLDOL1",178,0)\par
 ...;I ORNPNME["^" S ORNPNME=$TR(ORNPNME,"^",",")\par
"RTN","AHMLDOL1",179,0)\par
 ...;I $D(^VA(200,"B",ORNPNME)) D\par
"RTN","AHMLDOL1",180,0)\par
 ....;S ORNP="",ORNP=$O(^VA(200,"B",ORNPNME,ORNP))\par
"RTN","AHMLDOL1",181,0)\par
 ...S $P(REC(I),"|",13)=ORNP_"^"_ORNPNME\par
"RTN","AHMLDOL1",182,0)\par
 ...;S DTDSIRED=$P(MSGNDE,"|",16)\par
"RTN","AHMLDOL1",183,0)\par
 ...;S URG=$P($P(MSGNDE,"|",8),"^",6)\par
"RTN","AHMLDOL1",184,0)\par
 ...;I $G(URG)'="" S URIEN="",URIEN=$O(^ORD(101.42,"C",URG,URIEN))\par
"RTN","AHMLDOL1",185,0)\par
 ...;I $G(URIEN)'="" S URG=URIEN\par
"RTN","AHMLDOL1",186,0)\par
 ...S REAS=$P($P(MSGNDE,"|",17),"^",4)\par
"RTN","AHMLDOL1",187,0)\par
 ...I REAS="" S REAS=$P($P(MSGNDE,"|",17),"^",5)\par
"RTN","AHMLDOL1",188,0)\par
 ...I REAS?.N S REAS=$$GET1^DIQ(75.2,REAS,.01,"E")\par
"RTN","AHMLDOL1",189,0)\par
 ...;I REAS="" S REAS=$P($P(MSGNDE,"|",17),"^",5)\par
"RTN","AHMLDOL1",190,0)\par
 Q\par
"RTN","AHMLDOL1",191,0)\par
 ;--------------------------------------------------------------------\par
"RTN","AHMLDOL1",192,0)\par
LAB ;\par
"RTN","AHMLDOL1",193,0)\par
 N DA,NDE,TMP,CTYP,CTYPE,OI,JVORD,D,UR,HL,HO\par
"RTN","AHMLDOL1",194,0)\par
 S ERR=0,(OI,OR)=""\par
"RTN","AHMLDOL1",195,0)\par
 Q:$G(ORIT)'>0\par
"RTN","AHMLDOL1",196,0)\par
 K ORDIALOG D BLDARY(ORIT,.OR,.ORT)\par
"RTN","AHMLDOL1",197,0)\par
 K ORDIALOG ;M ORDIALOG=ORD K ORD\par
"RTN","AHMLDOL1",198,0)\par
 S VAL="" F  S VAL=$O(ORT(VAL)) Q:VAL=""!(ERR)  D\par
"RTN","AHMLDOL1",199,0)\par
 .S (CTYP,CTYPE)=""\par
"RTN","AHMLDOL1",200,0)\par
 .S STRG=VAL\par
"RTN","AHMLDOL1",201,0)\par
 .I $TR(STRG," ")="LABTEST" S NN="",NN=$O(ORT(STRG,"")),ORDIALOG(NN,1)="" D\par
"RTN","AHMLDOL1",202,0)\par
 ..Q:$G(LABTEST)'>0\par
"RTN","AHMLDOL1",203,0)\par
 ..S TST=LABTEST_";99LRT"\par
"RTN","AHMLDOL1",204,0)\par
 ..D GETOINUM^ORWDCN32(.OI,TST)\par
"RTN","AHMLDOL1",205,0)\par
 ..I $G(OI)="" S ERR=1,LSTN=LSTN+1,REC(LSTN)="Error: Laboratory order number is missing or invalid." Q\par
"RTN","AHMLDOL1",206,0)\par
 ..S ORDIALOG(NN,1)=$G(OI)\par
"RTN","AHMLDOL1",207,0)\par
 ..K ORT(STRG)\par
"RTN","AHMLDOL1",208,0)\par
 .;I $TR(STRG," ")="COLLECTIONDATE/TIME" S STRG=$TR(STRG,"/","")\par
"RTN","AHMLDOL1",209,0)\par
 .I $TR(STRG," ")="COLLECTIONDATE/TIME" S NN="",NN=$O(ORT(STRG,"")),ORDIALOG(NN,1)="" D\par
"RTN","AHMLDOL1",210,0)\par
 ..S ORDIALOG(NN,1)=$G(START)\par
"RTN","AHMLDOL1",211,0)\par
 ..K ORT(STRG)\par
"RTN","AHMLDOL1",212,0)\par
 .;I $TR(STRG," ")="COMMENTS" S NN="",NN=$O(ORT(STRG,"")),ORDIALOG(NN,1)="" D\par
"RTN","AHMLDOL1",213,0)\par
 ..;S ORDIALOG(NN,1)=COMMENT ;I COMMENT'="" D BLDWP(NN,COMMENT)\par
"RTN","AHMLDOL1",214,0)\par
 .I $TR(STRG," ")="COLLECTEDBY" S NN="",NN=$O(ORT(STRG,"")),ORDIALOG(NN,1)="" D\par
"RTN","AHMLDOL1",215,0)\par
 ..S ORDIALOG(NN,1)="SP"\par
"RTN","AHMLDOL1",216,0)\par
 .I $TR(STRG," ")="HOWOFTEN" S NN="",NN=$O(ORT(STRG,"")),ORDIALOG(NN,1)="" D\par
"RTN","AHMLDOL1",217,0)\par
 ..S ORDIALOG(NN,1)=28\par
"RTN","AHMLDOL1",218,0)\par
 ..K ORT(STRG)\par
"RTN","AHMLDOL1",219,0)\par
 .I $TR(STRG," ")="SPECIMEN" S NN="",NN=$O(ORT(STRG,"")),ORDIALOG(NN,1)="" D\par
"RTN","AHMLDOL1",220,0)\par
 ..S ORDIALOG(NN,1)=SAMPLE\par
"RTN","AHMLDOL1",221,0)\par
 ..K ORT(STRG)\par
"RTN","AHMLDOL1",222,0)\par
 .I $TR(STRG," ")="COLLECTIONSAMPLE" S NN="",NN=$O(ORT(STRG,"")),ORDIALOG(NN,1)="" D\par
"RTN","AHMLDOL1",223,0)\par
 ..S ORDIALOG(NN,1)=SPECIMEN\par
"RTN","AHMLDOL1",224,0)\par
 ..K ORT(STRG)\par
"RTN","AHMLDOL1",225,0)\par
 .I $TR(STRG," ")="URGENCY" S NN="",NN=$O(ORT(STRG,"")),ORDIALOG(NN,1)="" D\par
"RTN","AHMLDOL1",226,0)\par
 ..S ORDIALOG(NN,1)=$G(URGENCY)\par
"RTN","AHMLDOL1",227,0)\par
 ..K ORT(STRG)\par
"RTN","AHMLDOL1",228,0)\par
 .I $TR(STRG," ")="LOCATION" S NN="",NN=$O(ORT(STRG,"")),ORDIALOG(NN,1)="" D\par
"RTN","AHMLDOL1",229,0)\par
 ..S ORDIALOG(NN,1)=$G(LOCNME)\par
"RTN","AHMLDOL1",230,0)\par
 ;\par
"RTN","AHMLDOL1",231,0)\par
 Q\par
"RTN","AHMLDOL1",232,0)\par
 ;-----------------------------------------------------------------------\par
"RTN","AHMLDOL1",233,0)\par
BLDWP(NN,COMMENT) ;\par
"RTN","AHMLDOL1",234,0)\par
 N I\par
"RTN","AHMLDOL1",235,0)\par
 F I=1:1:$L(COMMENT,$C(10)) D\par
"RTN","AHMLDOL1",236,0)\par
 .S ORDIALOG("WP",NDE,1,I,0)=$P(COMMENT,$C(10),I)\par
"RTN","AHMLDOL1",237,0)\par
 .S ORDIALOG(NDE,1)="ORDIALOG(""WP"","_NDE_",1)"\par
"RTN","AHMLDOL1",238,0)\par
 Q\par
"RTN","AHMLDOL1",239,0)\par
 ;--------------------------------------------------------------------\par
"RTN","AHMLDOL1",240,0)\par
BLDARY(ORIT,OR,ORT) ;\par
"RTN","AHMLDOL1",241,0)\par
 Q:$G(ORIT)'>0\par
"RTN","AHMLDOL1",242,0)\par
 N TXT,TMP,NM\par
"RTN","AHMLDOL1",243,0)\par
 D GETDLG^ORCD(ORIT)\par
"RTN","AHMLDOL1",244,0)\par
 S TXT="" F  S TXT=$O(ORDIALOG("B",TXT)) Q:TXT=""  D\par
"RTN","AHMLDOL1",245,0)\par
 .S TMP=$TR(TXT," "),ORDT("B",TMP)=ORDIALOG("B",TXT)\par
"RTN","AHMLDOL1",246,0)\par
 S TXT="" F  S TXT=$O(ORDT("B",TXT)) Q:TXT=""  D\par
"RTN","AHMLDOL1",247,0)\par
 .I $D(ORDT("B",$TR(TXT," "))) S NM=$P($G(ORDT("B",$TR(TXT," "))),U,2)\par
"RTN","AHMLDOL1",248,0)\par
 .S ORD(NM,1)="" S ORD(NM,1)=ORDT("B",TXT) S ORT(TXT,NM)="" S ORT(TXT,NM)=ORD(NM,1)\par
"RTN","AHMLDOL1",249,0)\par
 ;\par
"RTN","AHMLDOL1",250,0)\par
 Q\par
"RTN","AHMLDOL1",251,0)\par
 ;-----------------------------------------------------------------------\par
"RTN","AHMLDOL1",252,0)\par
END ;\par
"RTN","AHMLDOL1",253,0)\par
 ;\par
"RTN","AHMLDOL1",254,0)\par
 K REC,MSG,MSGNDE,MSGTYP\par
"RTN","AHMLDOL1",255,0)\par
 ;\par
"RTN","AHMLDOL1",256,0)\par
 Q\par
"RTN","AHMLDOL2")\par
0^3^B261484687\par
"RTN","AHMLDOL2",1,0)\par
AHMLDOL2 ;SAIC/TCK- Orders Portability - Laboratory Results - main driver ; 10/16/16 8:38pm\par
"RTN","AHMLDOL2",2,0)\par
 ;;1.0;Orders Portability;;March 1, 2010;Build 26\par
"RTN","AHMLDOL2",3,0)\par
 ;\par
"RTN","AHMLDOL2",4,0)\par
 Q\par
"RTN","AHMLDOL2",5,0)\par
 ;\par
"RTN","AHMLDOL2",6,0)\par
EN(JVOROUT,REC) ;\par
"RTN","AHMLDOL2",7,0)\par
 K JVOROUT\par
"RTN","AHMLDOL2",8,0)\par
 S D1="|",D2="^"\par
"RTN","AHMLDOL2",9,0)\par
 S U=$G(D1)\par
"RTN","AHMLDOL2",10,0)\par
 ;D DBG\par
"RTN","AHMLDOL2",11,0)\par
 ;I '$D(REC) S JVOROUT(1)="-1^Error: No Results Array Received" Q\par
"RTN","AHMLDOL2",12,0)\par
 ;\par
"RTN","AHMLDOL2",13,0)\par
 N HLARY,ORC1,ORC5,XMT,XME\par
"RTN","AHMLDOL2",14,0)\par
 N JVNCNT S JVNCNT=1 ; counter for JVOROUT\par
"RTN","AHMLDOL2",15,0)\par
 D PARSE\par
"RTN","AHMLDOL2",16,0)\par
 ;\par
"RTN","AHMLDOL2",17,0)\par
MAIN ;  main driver for laboratory results\par
"RTN","AHMLDOL2",18,0)\par
 ;\par
"RTN","AHMLDOL2",19,0)\par
 N X,Y,Z\par
"RTN","AHMLDOL2",20,0)\par
 ; Cancellation\par
"RTN","AHMLDOL2",21,0)\par
 ; Accession\par
"RTN","AHMLDOL2",22,0)\par
 I ORC1="SC",ORC5="SC" D\par
"RTN","AHMLDOL2",23,0)\par
 . D ACC ; Tom's Stuff\par
"RTN","AHMLDOL2",24,0)\par
 ; Results\par
"RTN","AHMLDOL2",25,0)\par
 I ORC1="RE",ORC5="CM" D\par
"RTN","AHMLDOL2",26,0)\par
 . N OK S OK=1\par
"RTN","AHMLDOL2",27,0)\par
 . D RSLT^AHMLDOL6 Q:'OK  ; parse HL7 message and set variable file results\par
"RTN","AHMLDOL2",28,0)\par
 ;\par
"RTN","AHMLDOL2",29,0)\par
 I $G(DBKIND)["O" D DBGOUT ; capture JVOROUT\par
"RTN","AHMLDOL2",30,0)\par
 D END\par
"RTN","AHMLDOL2",31,0)\par
 QUIT\par
"RTN","AHMLDOL2",32,0)\par
 K JVOROUT\par
"RTN","AHMLDOL2",33,0)\par
 ;\par
"RTN","AHMLDOL2",34,0)\par
PARSE ;\par
"RTN","AHMLDOL2",35,0)\par
 N JVCNT,FLG,XT,XC,OBRCT,OBXCT\par
"RTN","AHMLDOL2",36,0)\par
 ;\par
"RTN","AHMLDOL2",37,0)\par
 S JVCNT="",FLG=0\par
"RTN","AHMLDOL2",38,0)\par
 F  S JVCNT=$O(REC(JVCNT)) Q:JVCNT=""  D  Q:FLG=2\par
"RTN","AHMLDOL2",39,0)\par
 . S XT=$P(REC(JVCNT),D1,1) Q:XT=""\par
"RTN","AHMLDOL2",40,0)\par
 . S XC=$G(HLARY(XT))+1,HLARY(XT)=XC\par
"RTN","AHMLDOL2",41,0)\par
 . S HLARY(XT,XC)=$P(REC(JVCNT),D1,2,999)\par
"RTN","AHMLDOL2",42,0)\par
 ;   set some basic variables:\par
"RTN","AHMLDOL2",43,0)\par
 ; Next line looks like dead code.\par
"RTN","AHMLDOL2",44,0)\par
 S X=HLARY("MSH",1),X=$P(X,D1,8),XMT=$P(X,D1,1),XME=$P(X,D1,2)\par
"RTN","AHMLDOL2",45,0)\par
 S MSHSEG=HLARY("MSH",1),PIDSEG=$G(HLARY("PID",1)),ORCSEG=$G(HLARY("ORC",1))\par
"RTN","AHMLDOL2",46,0)\par
 S ORC1=$P(HLARY("ORC",1),D1,1),ORC5=$P(HLARY("ORC",1),D1,5)\par
"RTN","AHMLDOL2",47,0)\par
 ;  create array HLOBX of ordered OBR and OBX segments.\par
"RTN","AHMLDOL2",48,0)\par
 S JVCNT="",FLG=0,OBRCT=0,OBXCT=0\par
"RTN","AHMLDOL2",49,0)\par
 F  S JVCNT=$O(REC(JVCNT)) Q:JVCNT=""  D  ;\par
"RTN","AHMLDOL2",50,0)\par
 . S XT=$P(REC(JVCNT),D1,1) Q:XT=""\par
"RTN","AHMLDOL2",51,0)\par
 . S XC=$G(HLARY(XT))+1,HLARY(XT)=XC\par
"RTN","AHMLDOL2",52,0)\par
 . I XT="OBR" S OBRCT=OBRCT+1,OBXCT=0\par
"RTN","AHMLDOL2",53,0)\par
 . I XT="OBR" S HLOBX(OBRCT)=$P(REC(JVCNT),D1,2,999)\par
"RTN","AHMLDOL2",54,0)\par
 . I XT="OBX" S OBXCT=OBXCT+1,HLOBX(OBRCT,OBXCT)=$P(REC(JVCNT),D1,2,999)\par
"RTN","AHMLDOL2",55,0)\par
 Q\par
"RTN","AHMLDOL2",56,0)\par
 ;\par
"RTN","AHMLDOL2",57,0)\par
CHKORID(ID) ;Checks to see if order number sent exists in VistA.\par
"RTN","AHMLDOL2",58,0)\par
 I '$D(ID) S ID=0 Q ID\par
"RTN","AHMLDOL2",59,0)\par
 S LRFILE=100,LRIEN=ID_","\par
"RTN","AHMLDOL2",60,0)\par
 S ID=$$GET1^DIQ(LRFILE,LRIEN,.01,"I") I ID="" S ID=0\par
"RTN","AHMLDOL2",61,0)\par
 Q ID\par
"RTN","AHMLDOL2",62,0)\par
 ;\par
"RTN","AHMLDOL2",63,0)\par
ACC ;\par
"RTN","AHMLDOL2",64,0)\par
 M ^XTMP("REC")=REC\par
"RTN","AHMLDOL2",65,0)\par
 N LRADD,ORNM,ID\par
"RTN","AHMLDOL2",66,0)\par
 S PNLTST=0\par
"RTN","AHMLDOL2",67,0)\par
 S (LRADD,ORNM,LRURG,IFN,I,ACCN)=""\par
"RTN","AHMLDOL2",68,0)\par
 K DIR,JVOROUT,LRACC\par
"RTN","AHMLDOL2",69,0)\par
 S LRPARAM="^^^",(ST,LRACC)=0\par
"RTN","AHMLDOL2",70,0)\par
 I $D(LROESTAT) D:$P(LRPARAM,D1,14) ^LRCAPV I $G(LREND) K LRLONG,LRPANEL Q\par
"RTN","AHMLDOL2",71,0)\par
 S (LRODT,X,DT)=$$DT^XLFDT(),LRODT0=$$FMTE^XLFDT(DT,5)\par
"RTN","AHMLDOL2",72,0)\par
 I '$D(^LRO(69,DT,1,0)) S ^LRO(69,DT,0)=DT,^LRO(69,DT,1,0)="^69.01PA^^",^LRO(69,"B",DT,DT)=""\par
"RTN","AHMLDOL2",73,0)\par
 S X="T-7",%DT="" D ^%DT S LRTM7=+Y\par
"RTN","AHMLDOL2",74,0)\par
 K DIC,LRSNDD,LRSN,LRODT,DA\par
"RTN","AHMLDOL2",75,0)\par
 ; Capture DMIS number from HL7 message\par
"RTN","AHMLDOL2",76,0)\par
 ;S ID=$P($G(HLARY("OBR",1)),D1,34)\par
"RTN","AHMLDOL2",77,0)\par
 ;S DMIS=$P(ID,D2,4)\par
"RTN","AHMLDOL2",78,0)\par
 ;S LBTECH=$P(ID,D2,1),LBTECH=+LBTECH\par
"RTN","AHMLDOL2",79,0)\par
 ; Clinical order number ORDNM from ORC-2\par
"RTN","AHMLDOL2",80,0)\par
 ;S ORDPROV=$P($G(HLARY("ORC",1)),D1,12),ORDPROV=+ORDPROV\par
"RTN","AHMLDOL2",81,0)\par
 S ORNP="" D PROXY^RAHBIN2(.ORNP,.ORNPNME)\par
"RTN","AHMLDOL2",82,0)\par
 S ORDNM=""\par
"RTN","AHMLDOL2",83,0)\par
 S ORDNM=$P(HLARY("ORC",1),D1,2),ORDNM=+ORDNM\par
"RTN","AHMLDOL2",84,0)\par
 ;D CHKDUP(ORDNM)\par
"RTN","AHMLDOL2",85,0)\par
 ; Remote site RSITE from ORC-13\par
"RTN","AHMLDOL2",86,0)\par
 S X=HLARY("ORC",1),RSITE=$P($G(X),D1,13) K X\par
"RTN","AHMLDOL2",87,0)\par
 I RSITE="" S RSITE=0\par
"RTN","AHMLDOL2",88,0)\par
 I RSITE S SITE=$$GET1^DIQ(4,RSITE,.01,"E")\par
"RTN","AHMLDOL2",89,0)\par
 ; Local site SITE taken from current user\par
"RTN","AHMLDOL2",90,0)\par
 ;S SITE=DUZ(2)\par
"RTN","AHMLDOL2",91,0)\par
 I ORDNM="" S JVOROUT(1)="-1^Error: No Lab order number not found in HL7 message" Q\par
"RTN","AHMLDOL2",92,0)\par
 S LRFILE=100,LRIEN=ORDNM_","\par
"RTN","AHMLDOL2",93,0)\par
 ;S ORDNM=$$GET1^DIQ(LRFILE,LRIEN,.01,"I"),ORDNM=+ORDNM\par
"RTN","AHMLDOL2",94,0)\par
 I ORDNM="" S JVOROUT(1)="-1^Error: No Lab order number not found in HL7 message" Q\par
"RTN","AHMLDOL2",95,0)\par
 ; Get location and provider for discontinue if needed\par
"RTN","AHMLDOL2",96,0)\par
 S REAS=5\par
"RTN","AHMLDOL2",97,0)\par
 S ORVP=+$$GET1^DIQ(LRFILE,LRIEN,.02,"I")\par
"RTN","AHMLDOL2",98,0)\par
 S ORL=+$$GET1^DIQ(LRFILE,LRIEN,6,"I")\par
"RTN","AHMLDOL2",99,0)\par
 S ORNP=$$GET1^DIQ(LRFILE,LRIEN,1,"I")\par
"RTN","AHMLDOL2",100,0)\par
 D PROXY^RAHBIN2(.ORNP,.ORNPNME)\par
"RTN","AHMLDOL2",101,0)\par
 ; Node 4 of record in Order file (100) has three pieces:\par
"RTN","AHMLDOL2",102,0)\par
 ; Lab Order number LRORD, Order date LRODT, Accession send number LRSND\par
"RTN","AHMLDOL2",103,0)\par
 ; LRODT and LRSND access entry in Lab Order file (69)\par
"RTN","AHMLDOL2",104,0)\par
 S LRFILE=100,LRIEN=ORDNM_",",FOUND=0\par
"RTN","AHMLDOL2",105,0)\par
 S LRDATA=$$GET1^DIQ(LRFILE,LRIEN,33,"I")\par
"RTN","AHMLDOL2",106,0)\par
 I LRDATA'[";" S JVOROUT(1)="-1^Error: Node 4 of ^OR(100,ORDNM) does not exist" Q\par
"RTN","AHMLDOL2",107,0)\par
 S LRORD=$P(LRDATA,";"),LRODT=$P(LRDATA,";",2),LRSND=$P(LRDATA,";",3)\par
"RTN","AHMLDOL2",108,0)\par
 S D="C",DIC="^LRO(69,",DIC(0)="D",X=LRORD D IX^DIC\par
"RTN","AHMLDOL2",109,0)\par
 I Y<0 S JVOROUT(1)="-1^Error: Order number not found in VistA" Q\par
"RTN","AHMLDOL2",110,0)\par
 S X=HLARY("OBR",1) D\par
"RTN","AHMLDOL2",111,0)\par
 .S LRTST=$P($P(X,D1,4),D2)\par
"RTN","AHMLDOL2",112,0)\par
 .I LRTST["."!(LRTST="") S LRTST=$P($P(X,D1,4),D2,4)\par
"RTN","AHMLDOL2",113,0)\par
 .S LRSD("RUID")=$P(X,D1,20)\par
"RTN","AHMLDOL2",114,0)\par
 .S JVTST=LRTST\par
"RTN","AHMLDOL2",115,0)\par
 I $E(LRSD("RUID"),1,2)?.A S ACCN=LRSD("RUID"),LRSD("RUID")=$P(X,D1,21)\par
"RTN","AHMLDOL2",116,0)\par
 I LRADD="A",ACCN'="" S UID=$TR(LRSD("RUID")," ","")\par
"RTN","AHMLDOL2",117,0)\par
 I $P(X,D1,46)'="" S JVTST=$P($P(X,D1,46),D2),PNLTST=LRTST\par
"RTN","AHMLDOL2",118,0)\par
 ; Lab test number LRTST from OBR.4.1\par
"RTN","AHMLDOL2",119,0)\par
 ; Accesses entry in Lab Test file (60)\par
"RTN","AHMLDOL2",120,0)\par
 S %DT="EP",X=$E(DT,2,3) D ^%DT S LRAD=Y\par
"RTN","AHMLDOL2",121,0)\par
 K %DT\par
"RTN","AHMLDOL2",122,0)\par
 S P2="L"\par
"RTN","AHMLDOL2",123,0)\par
 S LRSTATUS="C",%DT("B")=""\par
"RTN","AHMLDOL2",124,0)\par
 ; Collection date/time LRCDT from OBR-7\par
"RTN","AHMLDOL2",125,0)\par
 S LRCDT="",LRCDT=$P(HLARY("OBR",1),D1,7)\par
"RTN","AHMLDOL2",126,0)\par
 S LRNT="",LRNT=$$NOW^XLFDT\par
"RTN","AHMLDOL2",127,0)\par
 I LRCDT="" S JVOROUT(1)="-1^Error: Collection DATE/TIME is not in HL7 message" Q\par
"RTN","AHMLDOL2",128,0)\par
 I LRCDT["-" D\par
"RTN","AHMLDOL2",129,0)\par
 .I $E(LRCDT,9,12)="0000" S LRCDT=$E(LRCDT,1,8)\par
"RTN","AHMLDOL2",130,0)\par
 S P3="",LRCDT=$$HL7TFM^XLFDT(LRCDT,P2,P3)\par
"RTN","AHMLDOL2",131,0)\par
 I $G(LRCDT)<1 S JVOROUT(1)="-1^Error: Collection Date/Time missing or invalid" Q\par
"RTN","AHMLDOL2",132,0)\par
 ; Update Collection Date and Time in the Order file, (#100)\par
"RTN","AHMLDOL2",133,0)\par
 S JVCDT=LRCDT\par
"RTN","AHMLDOL2",134,0)\par
 S LRFILE=100,LRIEN=ORDNM_",",LRFDA(1,LRFILE,LRIEN,21)=LRCDT\par
"RTN","AHMLDOL2",135,0)\par
 D UPDATE^DIE("","LRFDA(1)","LRIENS","LRMSG")\par
"RTN","AHMLDOL2",136,0)\par
 S LRTIM=$P($P(HLARY("ORC",1),D1,7),D2,4),LRUN=$P($G(LRCDT),D1,2)\par
"RTN","AHMLDOL2",137,0)\par
 S P2="L",P3="",LRTIM=$$HL7TFM^XLFDT(LRTIM,P2,P3)\par
"RTN","AHMLDOL2",138,0)\par
 S LRSN(LRSND)=LRSND,LRSN=LRSND\par
"RTN","AHMLDOL2",139,0)\par
 I '$D(^LRO(69,LRODT,1,LRSN,1)) S ^LRO(69,LRODT,1,LRSN,1)="^^^^^^^^^^"\par
"RTN","AHMLDOL2",140,0)\par
 ; GETACC entry point finds matching Accession\par
"RTN","AHMLDOL2",141,0)\par
 S LRFILE=69.01,LRIEN=LRSND_","_LRODT_","\par
"RTN","AHMLDOL2",142,0)\par
 S COLST=$$GET1^DIQ(LRFILE,LRIEN,13,"I")\par
"RTN","AHMLDOL2",143,0)\par
 ; Check if this is an ATA\par
"RTN","AHMLDOL2",144,0)\par
 S JVODT=LRODT\par
"RTN","AHMLDOL2",145,0)\par
 ;IF DIFFERENT LAB ORDER #, SET LRADD TO "A"\par
"RTN","AHMLDOL2",146,0)\par
 ;I $G(LRADD)'="A" D CHKATA(LRSD("RUID"),LRORD,.LRADD)\par
"RTN","AHMLDOL2",147,0)\par
 ;I $G(LRADD)="A" D  Q\par
"RTN","AHMLDOL2",148,0)\par
 .;I $G(UID)'>0 S UID=$G(LRSD("RUID"))\par
"RTN","AHMLDOL2",149,0)\par
 .;I '$D(^LRO(68,"C",UID)),ACCN'="" D\par
"RTN","AHMLDOL2",150,0)\par
 ..;D GTVAUID^LRBHIN3(ACCN,.UID)\par
"RTN","AHMLDOL2",151,0)\par
 .I LRSD("RUID")'=UID S LRSD("RUID")=UID\par
"RTN","AHMLDOL2",152,0)\par
 .;D CHKATA(UID,LRORD,.LRFLG)\par
"RTN","AHMLDOL2",153,0)\par
 .I $G(LRFLG)="A" D\par
"RTN","AHMLDOL2",154,0)\par
 ..S JVOD=1,XQY0="JV VISTALINK USER",(DCORIG,ISNEWORD)=0\par
"RTN","AHMLDOL2",155,0)\par
 ..S ORDNM=ORDNM_";1",REAS="OTHER CANCEL REASON"\par
"RTN","AHMLDOL2",156,0)\par
 ..D DC^JVORD(.REC,ORDNM,ORVP,ORNP,ORL,REAS,DCORIG,ISNEWORD)\par
"RTN","AHMLDOL2",157,0)\par
 .;S JVOD=1,(JVAA,JVAD,JVAN)=""\par
"RTN","AHMLDOL2",158,0)\par
 .;D EN^JVHLLR3(LRSD("RUID"),LRTST,.JVAA,.JVAD,.JVAN,.ORNM)\par
"RTN","AHMLDOL2",159,0)\par
 .;S LRACC=^LRO(68,JVAA,1,JVAD,1,JVAN,.2)\par
"RTN","AHMLDOL2",160,0)\par
 .;S JVSN=$P(^LRO(68,JVAA,1,JVAD,1,JVAN,0),U,5)\par
"RTN","AHMLDOL2",161,0)\par
 .;S LIEN=JVAN_","_JVAD_","_JVAA_","\par
"RTN","AHMLDOL2",162,0)\par
 .;S JVODT=$$GET1^DIQ(68.02,LIEN,3,"I")\par
"RTN","AHMLDOL2",163,0)\par
 .;S JVSND="",JVSND=$O(^LRO(69,JVODT,1,JVSN,2,"B",JVTST,JVSND))\par
"RTN","AHMLDOL2",164,0)\par
 .;S ORNM=$P(^LRO(69,JVODT,1,JVSN,2,JVSND,0),U,7)\par
"RTN","AHMLDOL2",165,0)\par
 .;S JVOROUT(1)=ORNM_";1^"_LRACC_"^"_LRSD("RUID")_"^RS"\par
"RTN","AHMLDOL2",166,0)\par
 .;K LRSND,DA,JVAA,JVAD,JVAN,JVSN,JVSND,JVODT,LRDATA,HLARY,REC\par
"RTN","AHMLDOL2",167,0)\par
 ; Accession the order on the VA side\par
"RTN","AHMLDOL2",168,0)\par
 I $G(LRADD)'="A" D\par
"RTN","AHMLDOL2",169,0)\par
 .S DA=LRSND D LROE2\par
"RTN","AHMLDOL2",170,0)\par
 .K LRAA D Q15 S LRSND=LRSN K LRSN\par
"RTN","AHMLDOL2",171,0)\par
 S LRACC=0,LRSEND=""\par
"RTN","AHMLDOL2",172,0)\par
 I JVTST S LRTST=JVTST\par
"RTN","AHMLDOL2",173,0)\par
 S LRACC=$$GETACC(ORDNM,LRODT,LRORD,.LRSND,LRTST) I LRACC=0 S JVOROUT(1)="1^Error: This order did not accession properly" Q\par
"RTN","AHMLDOL2",174,0)\par
 ; DODUID entry point will update Files 68 (Accession), 69 (Lab Orders)to record the CHCS Accession number.\par
"RTN","AHMLDOL2",175,0)\par
 ;I $D(LRSD) D DODUID(RSITE,LRODT,LRSND,.LRSEND,.LRUID)\par
"RTN","AHMLDOL2",176,0)\par
 ;add code to stop overwriting the UID with the Vista accession #\par
"RTN","AHMLDOL2",177,0)\par
 I $D(LRSD) D DODUID(RSITE,LRODT,LRSND,.LRSEND,.LRUID)\par
"RTN","AHMLDOL2",178,0)\par
 .;I $E(LRSD("RUID"),1,2)?.A D\par
"RTN","AHMLDOL2",179,0)\par
 ..;if the Vista acc # is the same as the UID, do not file but get the correct UID to return in the JVOROUT reference variable.\par
"RTN","AHMLDOL2",180,0)\par
 ..;S LRFIL=69.03,LRIEN=LRSEND_","_LRSND_","_LRODT_","\par
"RTN","AHMLDOL2",181,0)\par
 ..;S LRSD("RUID")=$$GET1^DIQ(LRFIL,LRIEN,13,"I")\par
"RTN","AHMLDOL2",182,0)\par
 ;I ST S DUZ(2)=TMPDUZ\par
"RTN","AHMLDOL2",183,0)\par
 ;FILE THE LAB TECH\par
"RTN","AHMLDOL2",184,0)\par
 I $G(LBTECH)>0,$G(LRORD)>0 D\par
"RTN","AHMLDOL2",185,0)\par
 .S LRFILE=69.03,LRIEN=LRSEND_","_LRSND_","_LRODT_","\par
"RTN","AHMLDOL2",186,0)\par
 .S LRAD=$$GET1^DIQ(LRFILE,LRIEN,2,"I")\par
"RTN","AHMLDOL2",187,0)\par
 .S LRAA=$$GET1^DIQ(LRFILE,LRIEN,3,"I")\par
"RTN","AHMLDOL2",188,0)\par
 .S LRAN=$$GET1^DIQ(LRFILE,LRIEN,4,"I")\par
"RTN","AHMLDOL2",189,0)\par
 .S LRFILE=68.04,LRIEN=LRTST_","_LRAN_","_LRAD_","_LRAA_","\par
"RTN","AHMLDOL2",190,0)\par
 .S LRFDA(4,LRFILE,LRIEN,3)=$G(LBTECH)\par
"RTN","AHMLDOL2",191,0)\par
 .D UPDATE^DIE("","LRFDA(4)","LRIENS","LRMSG")\par
"RTN","AHMLDOL2",192,0)\par
 S JVOROUT(1)=ORDNM_";1^"_LRACC_"^"_LRSD("RUID")_"^RS"\par
"RTN","AHMLDOL2",193,0)\par
 S JVOROUT(2)=""\par
"RTN","AHMLDOL2",194,0)\par
 ;D RSORST(LRORD)\par
"RTN","AHMLDOL2",195,0)\par
 K LRSND,DA,LRODT,LRORD,LRDATA,HLARY,REC\par
"RTN","AHMLDOL2",196,0)\par
 Q\par
"RTN","AHMLDOL2",197,0)\par
 ;\par
"RTN","AHMLDOL2",198,0)\par
CHKATA(DODID,LBORD,LRADD) ;\par
"RTN","AHMLDOL2",199,0)\par
 N LRAA,LRAD,LRAN,LRIEN,LRORD\par
"RTN","AHMLDOL2",200,0)\par
 S (LRAA,LRAD,LRAN,LRADD)=""\par
"RTN","AHMLDOL2",201,0)\par
 I '$D(^LRO(68,"C",DODID)) Q\par
"RTN","AHMLDOL2",202,0)\par
 S LRAA=$O(^LRO(68,"C",DODID,LRAA)) I LRAA="" Q\par
"RTN","AHMLDOL2",203,0)\par
 S LRAD=$O(^LRO(68,"C",DODID,LRAA,LRAD)) I LRAD="" Q\par
"RTN","AHMLDOL2",204,0)\par
 S LRAN=$O(^LRO(68,"C",DODID,LRAA,LRAD,LRAN)) I LRAN="" Q\par
"RTN","AHMLDOL2",205,0)\par
 S LRIEN=LRAN_","_LRAD_","_LRAA_","\par
"RTN","AHMLDOL2",206,0)\par
 S LRORD=$$GET1^DIQ(68.02,LRIEN,14,"I")\par
"RTN","AHMLDOL2",207,0)\par
 I LRORD'=LBORD S LRADD="A"\par
"RTN","AHMLDOL2",208,0)\par
 Q\par
"RTN","AHMLDOL2",209,0)\par
 ;\par
"RTN","AHMLDOL2",210,0)\par
DODUID(RSITE,LRODT,LRSND,LRSEND,LRUID) ;STORE CHCS ACCESSION NUMBER\par
"RTN","AHMLDOL2",211,0)\par
 S FLAG=0\par
"RTN","AHMLDOL2",212,0)\par
 ; Type of test LRSS from Lab Test file (60).  Expect SP, CY, AP, or AU.\par
"RTN","AHMLDOL2",213,0)\par
 S LRFILE=60,LRIEN=LRTST_",",LRSS=$$GET1^DIQ(LRFILE,LRIEN,4,"I")\par
"RTN","AHMLDOL2",214,0)\par
 S SITE=DUZ(2)\par
"RTN","AHMLDOL2",215,0)\par
 I SITE="" S JVOROUT="-1^Error: Could not find accession number." Q\par
"RTN","AHMLDOL2",216,0)\par
 ; Accession area LRAA taken from Lab Test file (60)\par
"RTN","AHMLDOL2",217,0)\par
 I LRAA="" S LRFILE=60.11,LRIEN=SITE_","_LRTST_",",LRAA=$$GET1^DIQ(LRFILE,LRIEN,1,"I")\par
"RTN","AHMLDOL2",218,0)\par
 ;GET LRAD, LRAN FROM ACCESSION FILE (68) entry matching Lab Test\par
"RTN","AHMLDOL2",219,0)\par
 I $G(LRSEND)="" D\par
"RTN","AHMLDOL2",220,0)\par
 .S LRSEND=0 F  S LRSEND=$O(^LRO(69,LRODT,1,LRSND,2,LRSEND)) Q:LRSEND'?.N  D  Q:FLAG\par
"RTN","AHMLDOL2",221,0)\par
 ..S LRFILE=69.03,LRIEN=LRSEND_","_LRSND_","_LRODT_","\par
"RTN","AHMLDOL2",222,0)\par
 ..S LT=$$GET1^DIQ(LRFILE,LRIEN,.01,"I") I LT=LRTST D\par
"RTN","AHMLDOL2",223,0)\par
 ...S X=$$GET1^DIQ(LRFILE,LRIEN,14)\par
"RTN","AHMLDOL2",224,0)\par
 ...I X="" S LRUID=$$GET1^DIQ(LRFILE,LRIEN,13)\par
"RTN","AHMLDOL2",225,0)\par
 ...S LRAD=$$GET1^DIQ(LRFILE,LRIEN,2,"I")\par
"RTN","AHMLDOL2",226,0)\par
 ...S LRAN=$$GET1^DIQ(LRFILE,LRIEN,4,"I"),FLAG=1\par
"RTN","AHMLDOL2",227,0)\par
 ; Update Accession file (68)\par
"RTN","AHMLDOL2",228,0)\par
 I $G(LRUID)="" D\par
"RTN","AHMLDOL2",229,0)\par
 .S X=$$GET1^DIQ(69.03,LRSEND_","_LRSND_","_LRODT_",",14)\par
"RTN","AHMLDOL2",230,0)\par
 .I X="" S X=$$GET1^DIQ(69.03,LRSEND_","_LRSND_","_LRODT_",",13)\par
"RTN","AHMLDOL2",231,0)\par
 .I X'="" S LRUID=X\par
"RTN","AHMLDOL2",232,0)\par
 S LRRSITE("RSITE")=RSITE,LRRSITE("RPSITE")=500\par
"RTN","AHMLDOL2",233,0)\par
 S DR="16////"_LRSD("RUID")_";16.1////"_+$G(LRRSITE("RSITE"))_";16.2////"_+$G(LRRSITE("RPSITE"))_";16.3////"_$G(LRUID)_";16.4////"_LRSD("RUID")\par
"RTN","AHMLDOL2",234,0)\par
 S DA=LRAN,DA(1)=LRAD,DA(2)=LRAA,DIE="^LRO(68,"_DA(2)_",1,"_DA(1)_",1,",DLAYGO=68\par
"RTN","AHMLDOL2",235,0)\par
 D ^DIE\par
"RTN","AHMLDOL2",236,0)\par
 ; Update Lab Order file (69)\par
"RTN","AHMLDOL2",237,0)\par
 S DLAYGO=69\par
"RTN","AHMLDOL2",238,0)\par
 S DA=LRSEND,DA(1)=LRSND,DA(2)=LRODT,DIC="^LRO(69,"_DA(2)_",1,"_DA(1)_",2,"\par
"RTN","AHMLDOL2",239,0)\par
 S DIE=DIC,DR="13////"_$G(LRSD("RUID"))_";14////"_$G(LRRSITE("RSITE"))_";15////"_$G(LRRSITE("RPSITE"))_";16////"_$G(LRUID)_";17////"_$G(LRSD("RUID"))\par
"RTN","AHMLDOL2",240,0)\par
 D ^DIE\par
"RTN","AHMLDOL2",241,0)\par
 ; Update Lab data file (63)\par
"RTN","AHMLDOL2",242,0)\par
 S LRFILE=69.01,LRIEN=LRSND_","_LRODT_","\par
"RTN","AHMLDOL2",243,0)\par
 S LRDFN=$$GET1^DIQ(LRFILE,LRIEN,.01,"I")\par
"RTN","AHMLDOL2",244,0)\par
 S LRFILE=68.02,LRIEN=LRAN_","_LRAD_","_LRAA_","\par
"RTN","AHMLDOL2",245,0)\par
 S LRIDT=$$GET1^DIQ(LRFILE,LRIEN,13.5,"I")\par
"RTN","AHMLDOL2",246,0)\par
 S LRFILE=63.04\par
"RTN","AHMLDOL2",247,0)\par
 I LRSS="MI" S LRFILE=63.05\par
"RTN","AHMLDOL2",248,0)\par
 S LRIEN=LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL2",249,0)\par
 S LRFDA(LRFILE,LRIEN,.31)=$G(LRSD("RUID"))\par
"RTN","AHMLDOL2",250,0)\par
 S LRFDA(LRFILE,LRIEN,.32)=$G(LRRSITE("RSITE"))\par
"RTN","AHMLDOL2",251,0)\par
 S LRFDA(LRFILE,LRIEN,.33)=$G(LRRSITE("RPSITE"))\par
"RTN","AHMLDOL2",252,0)\par
 S LRFDA(LRFILE,LRIEN,.34)=$G(LRUID)\par
"RTN","AHMLDOL2",253,0)\par
 S LRFDA(LRFILE,LRIEN,.342)=$G(LRSD("LRUID"))\par
"RTN","AHMLDOL2",254,0)\par
 D FILE^DIE("","LRFDA") K LRFDA,LRFILE,LRIEN\par
"RTN","AHMLDOL2",255,0)\par
 Q\par
"RTN","AHMLDOL2",256,0)\par
 ;\par
"RTN","AHMLDOL2",257,0)\par
GETACC(ORDNM,LRODT,LRORD,LRSND,LRTST) ; Get Accession\par
"RTN","AHMLDOL2",258,0)\par
 N FLG\par
"RTN","AHMLDOL2",259,0)\par
 S (FLG,LRACC)=0\par
"RTN","AHMLDOL2",260,0)\par
 S LRFILE=69.01,LRIEN=LRSND_","_LRODT_","\par
"RTN","AHMLDOL2",261,0)\par
 I $$GET1^DIQ(LRFILE,LRIEN,.001,"I")'=LRSND S JVOROUT(1)="-1^Error: Laborder does not exist." Q LRACC\par
"RTN","AHMLDOL2",262,0)\par
 S COMB=$$GET1^DIQ(LRFILE,LRIEN,22,"I")\par
"RTN","AHMLDOL2",263,0)\par
 ; If this order was merged into another Lab Order, get new LRSND and LRSEND\par
"RTN","AHMLDOL2",264,0)\par
 S COMB=$P(COMB,"/",1)\par
"RTN","AHMLDOL2",265,0)\par
 I COMB D GETLRSND(ORDNM,LRODT,COMB,.LRSND,.LRSEND,.FLG)\par
"RTN","AHMLDOL2",266,0)\par
 ; Loop over Lab Order entries to match Clinical Order number\par
"RTN","AHMLDOL2",267,0)\par
 I '$G(LRSEND) D\par
"RTN","AHMLDOL2",268,0)\par
 .S LRFILE=69.03\par
"RTN","AHMLDOL2",269,0)\par
 .S LRSEND="",LRSEND=$O(^LRO(69,LRODT,1,LRSND,2,"B",LRTST,LRSEND))\par
"RTN","AHMLDOL2",270,0)\par
 .Q:$D(LRSEND)\par
"RTN","AHMLDOL2",271,0)\par
 .S LRSEND=0 F  S LRSEND=$O(^LRO(69,LRODT,1,LRSND,2,LRSEND)) Q:'LRSEND  D  Q:FLG\par
"RTN","AHMLDOL2",272,0)\par
 ..S LRIEN=LRSEND_","_LRSND_","_LRODT_","\par
"RTN","AHMLDOL2",273,0)\par
 ..S ORN=$$GET1^DIQ(LRFILE,LRIEN,6,"I") I ORN=ORDNM S FLG=1 Q\par
"RTN","AHMLDOL2",274,0)\par
 I COMB="" S FLG=1\par
"RTN","AHMLDOL2",275,0)\par
 I 'FLG S JVOROUT(1)="-1^Error: Lab test could not be found for this order." Q\par
"RTN","AHMLDOL2",276,0)\par
 ; Accession area LRAA taken from matching entry if test has been accessioned\par
"RTN","AHMLDOL2",277,0)\par
 S LRFILE=69.03,LRIEN=LRSEND_","_LRSND_","_LRODT_","\par
"RTN","AHMLDOL2",278,0)\par
 S LRURG=$$GET1^DIQ(LRFILE,LRIEN,1,"I")\par
"RTN","AHMLDOL2",279,0)\par
 S LRAD=$$GET1^DIQ(LRFILE,LRIEN,2,"I")\par
"RTN","AHMLDOL2",280,0)\par
 S LRAN=$$GET1^DIQ(LRFILE,LRIEN,4,"I")\par
"RTN","AHMLDOL2",281,0)\par
 S LRAA=$$GET1^DIQ(LRFILE,LRIEN,3,"I")\par
"RTN","AHMLDOL2",282,0)\par
 I LRAA="" D\par
"RTN","AHMLDOL2",283,0)\par
 .S SITE=DUZ(2)\par
"RTN","AHMLDOL2",284,0)\par
 .I SITE="" S JVOROUT="-1^Error: Could not find accession number." Q\par
"RTN","AHMLDOL2",285,0)\par
 .; If  Accession Area not in File 69 entry, take from File 60\par
"RTN","AHMLDOL2",286,0)\par
 .S LRFILE=60.11,LRIEN=SITE_","_LRTST_",",LRAA=$$GET1^DIQ(LRFILE,LRIEN,1,"I")\par
"RTN","AHMLDOL2",287,0)\par
 ; Get Accession date LRAD from File 69 entry, subnode 0 or 2\par
"RTN","AHMLDOL2",288,0)\par
 I LRAD="" D\par
"RTN","AHMLDOL2",289,0)\par
 .S LRFILE=69.03,LRIEN=LRSEND_","_LRSND_","_LRODT_",",LRAD=$$GET1^DIQ(LRFILE,LRIEN,2,"I")\par
"RTN","AHMLDOL2",290,0)\par
 ; Get Accession number LRAN\par
"RTN","AHMLDOL2",291,0)\par
 ; First try from File 69 entry, subnode 0\par
"RTN","AHMLDOL2",292,0)\par
 I LRAD="" Q LRACC\par
"RTN","AHMLDOL2",293,0)\par
 I LRAN="" D\par
"RTN","AHMLDOL2",294,0)\par
 .S LRORD=$P(LRDATA,";"),LRFILE=68.02,LRIEN=LRAN_","_LRAD_","_LRAA_","\par
"RTN","AHMLDOL2",295,0)\par
 . ; Second try:  Search File 68 for entry matching Lab Order\par
"RTN","AHMLDOL2",296,0)\par
 .S LRAN=0 F  S LRAN=$O(^LRO(68,LRAA,1,LRAD,1,LRAN)) Q:LRAN'?.N  D  Q:$P(LRACC," ",3)>0\par
"RTN","AHMLDOL2",297,0)\par
 ..S LRORN=$$GET1^DIQ(LRFILE,LRIEN,14,"I") I LRORN=LRORD S LRACC=$$GET1^DIQ(LRFILE,LRIEN,15,"I")\par
"RTN","AHMLDOL2",298,0)\par
 I $P(LRACC," ",3)>0 Q LRACC\par
"RTN","AHMLDOL2",299,0)\par
 ; Get Accession from Accession file (68)\par
"RTN","AHMLDOL2",300,0)\par
 S LRFILE=68.02,LRIEN=LRAN_","_LRAD_","_LRAA_","\par
"RTN","AHMLDOL2",301,0)\par
 S LRACC=$$GET1^DIQ(LRFILE,LRIEN,15,"I") I LRACC="" S LRACC=0\par
"RTN","AHMLDOL2",302,0)\par
 Q LRACC\par
"RTN","AHMLDOL2",303,0)\par
 ;\par
"RTN","AHMLDOL2",304,0)\par
GETLRSND(ORDNM,LRODT,COMB,LRSND,LRSEND,FLG) ;\par
"RTN","AHMLDOL2",305,0)\par
 S LRSND="" F  S LRSND=$O(^LRO(69,"C",+COMB,LRODT,LRSND)) Q:LRSND=""  D  Q:FLG\par
"RTN","AHMLDOL2",306,0)\par
 .S LRFILE=69.01,LRIEN=LRSND_","_LRODT_",",COMB=$$GET1^DIQ(LRFILE,LRIEN,22,"I")\par
"RTN","AHMLDOL2",307,0)\par
 .Q:COMB\par
"RTN","AHMLDOL2",308,0)\par
 .S LRSEND=0 F  S LRSEND=$O(^LRO(69,LRODT,1,LRSND,2,LRSEND)) Q:LRSEND=""  D  Q:FLG\par
"RTN","AHMLDOL2",309,0)\par
 ..S LRFILE=69.03,LRIEN=LRSEND_","_LRSND_","_LRODT_",",ORN=$$GET1^DIQ(LRFILE,LRIEN,6,"I")\par
"RTN","AHMLDOL2",310,0)\par
 ..I ORN=ORDNM S FLG=1\par
"RTN","AHMLDOL2",311,0)\par
 Q\par
"RTN","AHMLDOL2",312,0)\par
 ;\par
"RTN","AHMLDOL2",313,0)\par
Q15 ;from LROE1\par
"RTN","AHMLDOL2",314,0)\par
 N X,Y\par
"RTN","AHMLDOL2",315,0)\par
 S LRFILE=69.01,LRIEN=LRSND_","_LRODT_","\par
"RTN","AHMLDOL2",316,0)\par
 I '$$GET1^DIQ(LRFILE,LRIEN,.01,"I") Q\par
"RTN","AHMLDOL2",317,0)\par
 I M9>1 D\par
"RTN","AHMLDOL2",318,0)\par
 .D LRSPEC^LROE1\par
"RTN","AHMLDOL2",319,0)\par
 .S LRFILE=61,S1=$$GET1^DIQ(LRFILE,+LRSPEC,.01,"I")\par
"RTN","AHMLDOL2",320,0)\par
 .S LRFILE=62,S2=$$GET1^DIQ(LRFILE,LRSAMP,.01,"I"),S4=$$GET1^DIQ(LRFILE,LRSAMP,3,"I")\par
"RTN","AHMLDOL2",321,0)\par
 .S S3=S1_$S(S1'=S2:"  "_S2,1:"")\par
"RTN","AHMLDOL2",322,0)\par
 ; LRDPF is the Parent file that the .03 field of the Lab data file (#63) is a pointer to\par
"RTN","AHMLDOL2",323,0)\par
 S LRFILE=69.01,LRIEN=LRSND_","_LRODT_",",LRDFN=$$GET1^DIQ(LRFILE,LRIEN,.01,"I")\par
"RTN","AHMLDOL2",324,0)\par
 S LRFILE=63,LRDPF=$$GET1^DIQ(LRFILE,LRDFN,.02,"I")\par
"RTN","AHMLDOL2",325,0)\par
 S LRFILE=69.01,LRIEN=LRSND_","_LRODT_","\par
"RTN","AHMLDOL2",326,0)\par
 I '$$GET1^DIQ(LRFILE,LRIEN,10,"I") S LRSTATUS="C",DA=LRODT I '$D(LRSND) D P15^LROE1 Q:LRCDT<1\par
"RTN","AHMLDOL2",327,0)\par
 ; Checks to see if collection method is a scheduled Lab Collect\par
"RTN","AHMLDOL2",328,0)\par
 ; LRLLOC = Report Routing Location, LROLLOC = Ordering Location\par
"RTN","AHMLDOL2",329,0)\par
 I $D(LRSND),$$GET1^DIQ(LRFILE,LRIEN,4,"I")="LC",$$GET1^DIQ(LRFILE,LRIEN,10,"I") D\par
"RTN","AHMLDOL2",330,0)\par
 .S LRLLOC=$$GET1^DIQ(LRFILE,LRIEN,8,"I"),LROLLOC=$$GET1^DIQ(LRFILE,LRIEN,23,"I"),LRNT=$S($D(LRNT):LRNT,$D(LRTIM):LRTIM,$D(LRCDT):+LRCDT,1:"") D P15^LRPHITEM G Q16\par
"RTN","AHMLDOL2",331,0)\par
 ; If COMB is defined, this order was combined with other tests on a different Lab Order entry in file (#69)\par
"RTN","AHMLDOL2",332,0)\par
 ; Add parameter to the GTSPACC call and pass DMIS number.\par
"RTN","AHMLDOL2",333,0)\par
 ;D GTSPACC(LRTST,.ST,DMIS)\par
"RTN","AHMLDOL2",334,0)\par
 ;I ST D\par
"RTN","AHMLDOL2",335,0)\par
 .;S TMPDUZ=DUZ(2)\par
"RTN","AHMLDOL2",336,0)\par
 .;S DUZ(2)=ST\par
"RTN","AHMLDOL2",337,0)\par
 I $D(LRSND) D\par
"RTN","AHMLDOL2",338,0)\par
 .N COMB\par
"RTN","AHMLDOL2",339,0)\par
 .S COMB=$$GET1^DIQ(LRFILE,LRIEN,22,"I")\par
"RTN","AHMLDOL2",340,0)\par
 .S LRFDA(LRFILE,LRIEN,10)=$G(LRCDT)\par
"RTN","AHMLDOL2",341,0)\par
 .S LRFDA(LRFILE,LRIEN,11)=$G(LRUN)\par
"RTN","AHMLDOL2",342,0)\par
 .S LRFDA(LRFILE,LRIEN,12)=$G(ORNP)\par
"RTN","AHMLDOL2",343,0)\par
 .S LRFDA(LRFILE,LRIEN,13)=$G(LRSTATUS)\par
"RTN","AHMLDOL2",344,0)\par
 .S LRFDA(LRFILE,LRIEN,15)=""\par
"RTN","AHMLDOL2",345,0)\par
 .S LRFDA(LRFILE,LRIEN,22)=$G(COMB)\par
"RTN","AHMLDOL2",346,0)\par
 .S LRFDA(LRFILE,LRIEN,25)=$G(DUZ(2))\par
"RTN","AHMLDOL2",347,0)\par
 .D FILE^DIE("","LRFDA")\par
"RTN","AHMLDOL2",348,0)\par
 .S:LRSTATUS="C" ^LRO(69,"AA",+$$GET1^DIQ(LRFILE,LRIEN,9.5,"I"),LRODT_"|"_LRSND)=""\par
"RTN","AHMLDOL2",349,0)\par
 ;\par
"RTN","AHMLDOL2",350,0)\par
Q16 ;\par
"RTN","AHMLDOL2",351,0)\par
 ; Checks to see if LRDFN matches the LRDFN found when going through "C" cross reference in file (#69)\par
"RTN","AHMLDOL2",352,0)\par
 S J=0 D CHECK^LROW2 I J D BAD^LROW2\par
"RTN","AHMLDOL2",353,0)\par
 ;\par
"RTN","AHMLDOL2",354,0)\par
Q16A ;\par
"RTN","AHMLDOL2",355,0)\par
 I $D(LRLONG),$D(LRSND) S LRSN=LRSND,^TMP("LROE",$J,"LRORD")=LRORD_U_LRODT_U_LRTIM_U_PNM_U_SSN\par
"RTN","AHMLDOL2",356,0)\par
 K DR S LRTSTS=0\par
"RTN","AHMLDOL2",357,0)\par
 S LRSND=0 F  S LRSND=$O(LRSN(LRSND)) Q:'LRSND  D Q17\par
"RTN","AHMLDOL2",358,0)\par
 ; I LRLONG, this will set the performing lab when requirements are released\par
"RTN","AHMLDOL2",359,0)\par
 I $D(LRLONG),$D(LRSND) S LRSN=LRSND D LROE^LRFAST S X=^TMP("LROE",$J,"LRORD"),LRORD=+X,LRODT=$P(X,D1,2),LRTIM=$P(X,D1,3),LRLONG="",PNM=$P(X,D1,4),SSN=$P(X,D1,5)\par
"RTN","AHMLDOL2",360,0)\par
 Q\par
"RTN","AHMLDOL2",361,0)\par
 ;\par
"RTN","AHMLDOL2",362,0)\par
Q17 ;\par
"RTN","AHMLDOL2",363,0)\par
 ; Checks for Ward comments on specimen and will never be found on orders coming from CHCS.\par
"RTN","AHMLDOL2",364,0)\par
 S I=$O(^LRO(69,LRODT,1,LRSND,6,0)),J=$O(^(1)) S:'$D(IOM) IOM=80 K LRSPCDSC S:J LRSPCDSC=^(J,0) S:I DA=LRSND,DA(1)=LRODT,DR=6,DIC="^LRO(69,"_LRODT_",1," D EN^DIQ:I D LRSPEC^LROE1\par
"RTN","AHMLDOL2",365,0)\par
 ; Accessions the Lab order\par
"RTN","AHMLDOL2",366,0)\par
 D OLD(LRSD("RUID")) K ^TMP("LR",$J,"TMP")\par
"RTN","AHMLDOL2",367,0)\par
 S LRFILE=69.01,LRIEN=LRSND_","_LRODT_","\par
"RTN","AHMLDOL2",368,0)\par
 ; Sets the Lab order collection status to "collected"\par
"RTN","AHMLDOL2",369,0)\par
 S LRFDA(1,LRFILE,LRIEN,13)="C"\par
"RTN","AHMLDOL2",370,0)\par
 S LRFDA(1,LRFILE,LRIEN,12)=$G(LBTECH)\par
"RTN","AHMLDOL2",371,0)\par
 ; Sets the site number in piece 8 of the Lab order file (#69)\par
"RTN","AHMLDOL2",372,0)\par
 S LRFDA(1,LRFILE,LRIEN,25)=$G(DUZ(2))\par
"RTN","AHMLDOL2",373,0)\par
 D FILE^DIE("","LRFDA(1)")\par
"RTN","AHMLDOL2",374,0)\par
 ; Gets the Lab order Number\par
"RTN","AHMLDOL2",375,0)\par
 S ORNUM=$$GET1^DIQ(LRFILE,LRIEN,9.5,"I")\par
"RTN","AHMLDOL2",376,0)\par
 ; Builds the "AA" cross reference and sets it to the Urgency of the test ordered\par
"RTN","AHMLDOL2",377,0)\par
 S ^LRO(69,"AA",+ORNUM,LRODT_"|"_LRSND)=$G(LRURG)\par
"RTN","AHMLDOL2",378,0)\par
 Q\par
"RTN","AHMLDOL2",379,0)\par
 ;\par
"RTN","AHMLDOL2",380,0)\par
LROE2 ;\par
"RTN","AHMLDOL2",381,0)\par
 ; Initialize Collection info in Node 1 under Order date and accession send number in File 69\par
"RTN","AHMLDOL2",382,0)\par
 S LRFILE=69.01,LRIEN=DA_","_LRODT_","\par
"RTN","AHMLDOL2",383,0)\par
 I '$$GET1^DIQ(LRFILE,LRIEN,.01,"I") S ^LRO(69,LRODT,1,DA,1)="^^^^^^^^^^^^^^^^"\par
"RTN","AHMLDOL2",384,0)\par
 K LRSND\par
"RTN","AHMLDOL2",385,0)\par
 S (LRSND,LRSND(DA))=+DA\par
"RTN","AHMLDOL2",386,0)\par
 ; LRDFN points into Lab Results file (63).\par
"RTN","AHMLDOL2",387,0)\par
 ; LRDPF identifies parent file; DFN points to patient in this file.\par
"RTN","AHMLDOL2",388,0)\par
 S M9=$G(M9)+1\par
"RTN","AHMLDOL2",389,0)\par
 S LRIEN=LRSND_","_LRODT_",",LRDFN=$$GET1^DIQ(LRFILE,LRIEN,.01,"I")\par
"RTN","AHMLDOL2",390,0)\par
 S LRFILE=63,LRIEN=LRDFN_","\par
"RTN","AHMLDOL2",391,0)\par
 S LRDPF=$$GET1^DIQ(LRFILE,LRIEN,.02,"I"),DFN=$$GET1^DIQ(LRFILE,LRIEN,.03,"I")\par
"RTN","AHMLDOL2",392,0)\par
 S LRSVSN=LRSND D ORDER S LRSND=LRSVSN\par
"RTN","AHMLDOL2",393,0)\par
 Q\par
"RTN","AHMLDOL2",394,0)\par
 ;\par
"RTN","AHMLDOL2",395,0)\par
ORDER ;call with LRSND, from LROE, LROE1, LRORD1, LROW2, LROR1\par
"RTN","AHMLDOL2",396,0)\par
 K D,LRTT S LREND=0\par
"RTN","AHMLDOL2",397,0)\par
 S LRFILE=69.01,LRIEN=LRSND_","_LRODT_","\par
"RTN","AHMLDOL2",398,0)\par
 S X=$$GET1^DIQ(LRFILE,LRIEN,3,"I")\par
"RTN","AHMLDOL2",399,0)\par
 S LRFILE=62,LRIEN=X,X=$$GET1^DIQ(LRFILE,LRIEN,.01,"I") I X="" S X4=""\par
"RTN","AHMLDOL2",400,0)\par
 S LRSEND=1,LRFILE=69.02,LRIEN=LRSEND_","_LRSND_","_LRODT_","\par
"RTN","AHMLDOL2",401,0)\par
 S X=$$GET1^DIQ(LRFILE,LRIEN,.01,"I") I X="" S X4=""\par
"RTN","AHMLDOL2",402,0)\par
 I X'="" S LRFILE=61,LRIEN=X,X4=$$GET1^DIQ(LRFILE,LRIEN,.01,"I")\par
"RTN","AHMLDOL2",403,0)\par
 S LRACN=0 F  S LRACN=$O(^LRO(69,LRODT,1,LRSND,2,LRACN)) Q:LRACN<1!($G(LREND))  I $D(^(LRACN,0))#2 S LRACN0=^(0)\par
"RTN","AHMLDOL2",404,0)\par
 Q\par
"RTN","AHMLDOL2",405,0)\par
 ;\par
"RTN","AHMLDOL2",406,0)\par
GTSPACC(LRTEST,ST,DMIS) ;\par
"RTN","AHMLDOL2",407,0)\par
 ;Add third parameter to GTSPACC line tag for DMIS number passed in.\par
"RTN","AHMLDOL2",408,0)\par
 S ST=0,(AREA,TDMIS,DIV,ENT)=""\par
"RTN","AHMLDOL2",409,0)\par
 I '$D(^LAB(60,LRTEST,8)) Q\par
"RTN","AHMLDOL2",410,0)\par
 S DIV=0 F  S DIV=$O(^LAB(60,LRTEST,8,DIV)) Q:DIV=""  D\par
"RTN","AHMLDOL2",411,0)\par
 .I DIV="" Q\par
"RTN","AHMLDOL2",412,0)\par
 .S ENT=DIV_";DIC(4,"\par
"RTN","AHMLDOL2",413,0)\par
 .S TDMIS=$$GET^XPAR(ENT,"JV SPECIAL ACCESSION AREA",1,"E")\par
"RTN","AHMLDOL2",414,0)\par
 .I TDMIS="" Q\par
"RTN","AHMLDOL2",415,0)\par
 .I DMIS="" Q\par
"RTN","AHMLDOL2",416,0)\par
 .I DMIS'=TDMIS Q\par
"RTN","AHMLDOL2",417,0)\par
 .S AREA=$P($G(^LAB(60,LRTEST,8,DIV,0)),D1,2)\par
"RTN","AHMLDOL2",418,0)\par
 .I AREA="" Q\par
"RTN","AHMLDOL2",419,0)\par
 .I '$D(^LRO(68,AREA)) Q\par
"RTN","AHMLDOL2",420,0)\par
 .S ST=DIV\par
"RTN","AHMLDOL2",421,0)\par
 Q\par
"RTN","AHMLDOL2",422,0)\par
 ;\par
"RTN","AHMLDOL2",423,0)\par
OLD(LRID) ;\par
"RTN","AHMLDOL2",424,0)\par
 I LRNT="" D\par
"RTN","AHMLDOL2",425,0)\par
 .N LRNT\par
"RTN","AHMLDOL2",426,0)\par
 .S DT=$$DT^XLFDT()\par
"RTN","AHMLDOL2",427,0)\par
 .D NOW^%DTC\par
"RTN","AHMLDOL2",428,0)\par
 .S LRNT=%\par
"RTN","AHMLDOL2",429,0)\par
 I $P(LRPARAM,U,4),'$D(LRNOLABL),'$D(LRTJ) D ^LRLABLIO\par
"RTN","AHMLDOL2",430,0)\par
 D EN^AHMLDOL4(LRID,LRTST,JVCDT)\par
"RTN","AHMLDOL2",431,0)\par
 Q\par
"RTN","AHMLDOL2",432,0)\par
 ;\par
"RTN","AHMLDOL2",433,0)\par
RSORST(LRORD) ;\par
"RTN","AHMLDOL2",434,0)\par
 N JVSN,JVSND,FLG\par
"RTN","AHMLDOL2",435,0)\par
 S JVSN="",(FLG,JVSND)=0\par
"RTN","AHMLDOL2",436,0)\par
 S JVSN=$O(^LRO(69,"C",LRORD,LRODT,JVSN)) Q:JVSN=""  D\par
"RTN","AHMLDOL2",437,0)\par
 .S JVSND=0\par
"RTN","AHMLDOL2",438,0)\par
 .F  S JVSND=$O(^LRO(69,LRODT,1,JVSN,2,JVSND)) Q:JVSND<1  D\par
"RTN","AHMLDOL2",439,0)\par
 ..S JVX=^LRO(69,LRODT,1,JVSN,2,JVSND,0)\par
"RTN","AHMLDOL2",440,0)\par
 ..I $P(JVX,U,4)="" D  Q:FLG\par
"RTN","AHMLDOL2",441,0)\par
 ...;CHECK IF THIS TEST IS A PANEL TEST\par
"RTN","AHMLDOL2",442,0)\par
 ...S JVT=$P(JVX,U)\par
"RTN","AHMLDOL2",443,0)\par
 ...I $P($G(^LAB(60,JVT,2,0)),"^",3)>1 S FLG=1\par
"RTN","AHMLDOL2",444,0)\par
 ..I $P(JVX,U,4)'="" Q\par
"RTN","AHMLDOL2",445,0)\par
 ..S JVORN=$P(JVX,U,7)\par
"RTN","AHMLDOL2",446,0)\par
 ..I $P(^OR(100,JVORN,3),U,3)=6 S $P(^OR(100,JVORN,3),U,3)=5\par
"RTN","AHMLDOL2",447,0)\par
 K JVORN,JVSN,JVSND,JVX\par
"RTN","AHMLDOL2",448,0)\par
 Q\par
"RTN","AHMLDOL2",449,0)\par
 ;\par
"RTN","AHMLDOL2",450,0)\par
END ;\par
"RTN","AHMLDOL2",451,0)\par
 K AREA,CNT,COLST,D1,D2,DFN,DIC,DIE,DIV,DMIS,DLAYGO,DIR,DIRUT,ENT,FLAG,GOT,HLOBX,I,INST,J,LRACC,LRACN,LRACN0,LRAD,ARIV\par
"RTN","AHMLDOL2",452,0)\par
 K LRAN,LRCDT,LRDA1,LRDFN,LRDPF,LRDT,LREND,LRLABLIO,LRLLOC,LRNT,LRCNT,LRIDT,LRNT,LRORN,LROD0,%,LRNOLABL,LRTJ\par
"RTN","AHMLDOL2",453,0)\par
 K LROD1,LROD3,LROESTAT,LRORU3,LRPARAM,LRRSITE,LRSAMP,LRSD,LRSND,LRSEND,LRSPED,LRSS,LRSTATUS,LRODT0,LROLLOC\par
"RTN","AHMLDOL2",454,0)\par
 K DMIS,LRSPEC,LRSVSN,LRTIM,LRTM7,LRTS,LRTST,LRTSTS,LRUID,LRUN,LRURG,LRX,LRZX,LT,M9,MSHSEG,ORCSEG,ORN,ORNUM\par
"RTN","AHMLDOL2",455,0)\par
 K ORDNM,P2,P3,PIDSEG,PNM,RSITE,S1,S2,S3,S4,SITE,ST,STE,SUB,SSN,TDMIS,TMPDUZ,X4,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE\par
"RTN","AHMLDOL2",456,0)\par
 K DCORIG,IFN,ISNEWORD,JVTST,ORL,ORVP,ORNP,REAS,JVT,JVCDT,PNLTST,UID\par
"RTN","AHMLDOL2",457,0)\par
 K COM,ORDATA,R,SIEN,TEST,TST\par
"RTN","AHMLDOL2",458,0)\par
 Q\par
"RTN","AHMLDOL2",459,0)\par
 ;\par
"RTN","AHMLDOL2",460,0)\par
DBG ;\par
"RTN","AHMLDOL2",461,0)\par
 K DBKIND,DBCNT\par
"RTN","AHMLDOL2",462,0)\par
 D INT^JVHLDBG("JVLR",.DBKIND,.DBCNT)\par
"RTN","AHMLDOL2",463,0)\par
 I DBKIND["I" D JVIN^JVHLDBG("JVLR",DBCNT,.REC)\par
"RTN","AHMLDOL2",464,0)\par
 Q\par
"RTN","AHMLDOL2",465,0)\par
 ;\par
"RTN","AHMLDOL2",466,0)\par
DBGOUT ;\par
"RTN","AHMLDOL2",467,0)\par
 I $D(JVOROUT),$G(DBCNT) D JVOUT^JVHLDBG("JVLR",DBCNT,.JVOROUT)\par
"RTN","AHMLDOL2",468,0)\par
 Q\par
"RTN","AHMLDOL2",469,0)\par
 ;\par
"RTN","AHMLDOL3")\par
0^4^B46093181\par
"RTN","AHMLDOL3",1,0)\par
AHMLDOL3 ;SAIC/TCK- Orders Portability - Delete a test ; 10/16/16 8:30pm\par
"RTN","AHMLDOL3",2,0)\par
 ;;1.0;Orders Portability;;March 1, 2010;Build 26\par
"RTN","AHMLDOL3",3,0)\par
 Q\par
"RTN","AHMLDOL3",4,0)\par
ADD ;\par
"RTN","AHMLDOL3",5,0)\par
 Q\par
"RTN","AHMLDOL3",6,0)\par
 ;\par
"RTN","AHMLDOL3",7,0)\par
 ;\par
"RTN","AHMLDOL3",8,0)\par
EN(CHUID,JVTST,JVAA,JVAD,JVAN,ORNM) ;\par
"RTN","AHMLDOL3",9,0)\par
 N LRACC,LRADL,LRTSAD,LRNATURE,LRORDTYP\par
"RTN","AHMLDOL3",10,0)\par
 K LRPARAM D EN^LRPARAM\par
"RTN","AHMLDOL3",11,0)\par
 I '$D(LRPARAM) D END Q\par
"RTN","AHMLDOL3",12,0)\par
 ; Initialize flag for test added for auto download\par
"RTN","AHMLDOL3",13,0)\par
 S LRADL=0\par
"RTN","AHMLDOL3",14,0)\par
 ; If test added then check for automatic downloading\par
"RTN","AHMLDOL3",15,0)\par
 I LRADL D EN^LA7ADL($P($G(^LRO(68,LRAA,1,LRAD,1,LRAN,.3),0),"^")) S LRADL=0\par
"RTN","AHMLDOL3",16,0)\par
 S (LRAA,LRAD,LRAN,LRSS)=""\par
"RTN","AHMLDOL3",17,0)\par
 S LRACC=1\par
"RTN","AHMLDOL3",18,0)\par
 I '$D(^LRO(68,"C",CHUID)) S JVOROUT(1)="-1^Error: No CHCS UID in HL7 MESSAGE" Q\par
"RTN","AHMLDOL3",19,0)\par
 ;Populate LRAA,LRAD and LRAN with data from merge-to accession.\par
"RTN","AHMLDOL3",20,0)\par
 K LRACC,LRTSAD,LRNATURE\par
"RTN","AHMLDOL3",21,0)\par
 S LRAA=$O(^LRO(68,"C",CHUID,LRAA)),JVAA=LRAA\par
"RTN","AHMLDOL3",22,0)\par
 S LRSS=$P(^LRO(68,LRAA,0),"^",2)\par
"RTN","AHMLDOL3",23,0)\par
 S LRAD=$O(^LRO(68,"C",CHUID,LRAA,LRAD)),JVAD=LRAD\par
"RTN","AHMLDOL3",24,0)\par
 S LRAN=$O(^LRO(68,"C",CHUID,LRAA,LRAD,LRAN)),JVAN=LRAN\par
"RTN","AHMLDOL3",25,0)\par
 I LRAN<1 D END Q\par
"RTN","AHMLDOL3",26,0)\par
 ;\par
"RTN","AHMLDOL3",27,0)\par
 ;L +^LRO(68,LRAA,1,LRAD,1,LRAN):1 I '$T W !?5,"Someone else is editing this entry ",!,$C(7) G ADD1\par
"RTN","AHMLDOL3",28,0)\par
 ;\par
"RTN","AHMLDOL3",29,0)\par
 S X=^LRO(68,LRAA,1,LRAD,1,LRAN,0),LRDFN=$P(X,U),LRAODT=$P(X,U,3),LRODT=$P(X,U,4),LRSN=$P(X,U,5),LRDPF=$P(^LR(LRDFN,0),U,2),DFN=$P(^(0),U,3) D PT^LRX\par
"RTN","AHMLDOL3",30,0)\par
 S LRNATURE="4^SERVICE CORRECTION^99ORN",LRDPF=2\par
"RTN","AHMLDOL3",31,0)\par
 ;\par
"RTN","AHMLDOL3",32,0)\par
 S I=0\par
"RTN","AHMLDOL3",33,0)\par
 F  S I=$O(^LRO(68,LRAA,1,LRAD,1,LRAN,4,I)) Q:I<1  W !,?5,$P(^LAB(60,I,0),U,1) S LRTSAD(1,I)=""\par
"RTN","AHMLDOL3",34,0)\par
 ;\par
"RTN","AHMLDOL3",35,0)\par
LRTSP ;\par
"RTN","AHMLDOL3",36,0)\par
 S I="",I=$O(LRTSAD(1,I))\par
"RTN","AHMLDOL3",37,0)\par
 S LRTSP=I\par
"RTN","AHMLDOL3",38,0)\par
 ;\par
"RTN","AHMLDOL3",39,0)\par
ADDTST ;\par
"RTN","AHMLDOL3",40,0)\par
 S (LRTS,I)=JVTST I $D(^LRO(68,LRAA,1,LRAD,1,LRAN,4,I,0)) W !,"The accession already has this test."\par
"RTN","AHMLDOL3",41,0)\par
 S LRTSUB=1 D EXPLD^LRTSTJM1 I $D(LRTSAD(1,LRTS)) W !,"The accession already has this test."\par
"RTN","AHMLDOL3",42,0)\par
 S LRFLG=1 S (LRURG,Y)=6\par
"RTN","AHMLDOL3",43,0)\par
 I LRURG'="" G SETTST\par
"RTN","AHMLDOL3",44,0)\par
 ;\par
"RTN","AHMLDOL3",45,0)\par
 ;\par
"RTN","AHMLDOL3",46,0)\par
SETTST ;\par
"RTN","AHMLDOL3",47,0)\par
 ; LRORDTYP=1(add)/2(reflex)^file #64.061 ien for code^if reflex parent test^if reflex parent NLT^\par
"RTN","AHMLDOL3",48,0)\par
 S LRORDTYP="1^432"\par
"RTN","AHMLDOL3",49,0)\par
 I $P(LRORDTYP,"^")=2 S $P(LRORDTYP,"^",3)=LRTSP,$P(LRORDTYP,"^",4)=$$NLT^LRVER1(LRTSP)\par
"RTN","AHMLDOL3",50,0)\par
 I +LRDPF=2,$G(LRSS)'="BB",'$$CHKINP^LRBEBA4(LRDFN,LRODT) S LRBERF=$S(LRORDTYP>0:LRORDTYP-1,1:-1) ;CIDC\par
"RTN","AHMLDOL3",51,0)\par
 D EN1\par
"RTN","AHMLDOL3",52,0)\par
 Q\par
"RTN","AHMLDOL3",53,0)\par
 ;\par
"RTN","AHMLDOL3",54,0)\par
EN1 ;\par
"RTN","AHMLDOL3",55,0)\par
 S ^LRO(68,LRAA,1,LRAD,1,LRAN,4,LRTS,0)=LRTS_"^"_LRURG,$P(^(0),U,9)=$G(LRTSP)\par
"RTN","AHMLDOL3",56,0)\par
 S ^LRO(68,LRAA,1,LRAD,1,LRAN,4,"B",LRTS,LRTS)="",$P(^LRO(68,LRAA,1,LRAD,1,LRAN,3),U,4)=""\par
"RTN","AHMLDOL3",57,0)\par
 S $P(^LRO(68,LRAA,1,LRAD,1,LRAN,4,0),U,3)=LRTS,$P(^(0),U,4)=$P(^(0),U,4)+1\par
"RTN","AHMLDOL3",58,0)\par
 I $P(LRPARAM,U,14),$P(^LRO(68,LRAA,0),U,16) D CAP^LRWLST12\par
"RTN","AHMLDOL3",59,0)\par
 S LRACD=$P(^LRO(68,LRAA,1,LRAD,1,LRAN,0),"^",3),LRTSAD(1,LRTS)=""\par
"RTN","AHMLDOL3",60,0)\par
 I LRACD,LRACD'=LRAD D\par
"RTN","AHMLDOL3",61,0)\par
 .S ^LRO(68,LRAA,1,LRACD,1,LRAN,4,LRTS,0)=LRTS_"^"_LRURG,$P(^(0),U,9)=+LRTS\par
"RTN","AHMLDOL3",62,0)\par
 .S ^LRO(68,LRAA,1,LRACD,1,LRAN,4,"B",LRTS,LRTS)="",$P(^LRO(68,LRAA,1,LRAD,1,LRAN,3),"^",4)=""\par
"RTN","AHMLDOL3",63,0)\par
 .I $P(LRPARAM,U,14),$P(^LRO(68,LRAA,0),U,16) D CAP^LRWLST12\par
"RTN","AHMLDOL3",64,0)\par
 D ORUT^LRTSTJM1(LRDFN,LRAA,LRAD,LRAN,LRTS,LRORDTYP,LRURG,LRODT,LRSN)\par
"RTN","AHMLDOL3",65,0)\par
 S LRADL=1\par
"RTN","AHMLDOL3",66,0)\par
 S DIC="^LRO(69,"_LRODT_",1,"_LRSN_",2,",DA(2)=LRODT,DA(1)=LRSN\par
"RTN","AHMLDOL3",67,0)\par
 S DIC(0)="LOX",DLAYGO=69,X=$P(^LAB(60,LRTS,0),"^")\par
"RTN","AHMLDOL3",68,0)\par
 D ^DIC\par
"RTN","AHMLDOL3",69,0)\par
 ;\par
"RTN","AHMLDOL3",70,0)\par
FILE69 ;\par
"RTN","AHMLDOL3",71,0)\par
 I Y>0 D\par
"RTN","AHMLDOL3",72,0)\par
 .N LRDIE,LRFDA,LRIENS,I\par
"RTN","AHMLDOL3",73,0)\par
 .S LRXDA=+Y,LRIENS=LRXDA_","_LRSN_","_LRODT_","\par
"RTN","AHMLDOL3",74,0)\par
 .S LRXDA(3)=$G(^LRO(68,LRAA,1,LRAD,1,LRAN,.3))\par
"RTN","AHMLDOL3",75,0)\par
 .S LRFDA(1,69.03,LRIENS,1)=$G(LRURG)\par
"RTN","AHMLDOL3",76,0)\par
 .S LRFDA(1,69.03,LRIENS,2)=$G(LRAODT)\par
"RTN","AHMLDOL3",77,0)\par
 .S LRFDA(1,69.03,LRIENS,3)=$G(LRAA)\par
"RTN","AHMLDOL3",78,0)\par
 .S LRFDA(1,69.03,LRIENS,4)=$G(LRAN)\par
"RTN","AHMLDOL3",79,0)\par
 .S LRFDA(1,69.03,LRIENS,8)="IP"\par
"RTN","AHMLDOL3",80,0)\par
 .S LRFDA(1,69.03,LRIENS,9)="L"\par
"RTN","AHMLDOL3",81,0)\par
 .I $P(LRXDA(3),"^")'="" D\par
"RTN","AHMLDOL3",82,0)\par
 ..S LRFDA(1,69.03,LRIENS,13)=$P(LRXDA(3),"^")\par
"RTN","AHMLDOL3",83,0)\par
 ..I $P(LRXDA(3),"^",2) F I=2:1:5 S LRFDA(1,69.03,LRIENS,I+12)=$P(LRXDA(3),"^",I)\par
"RTN","AHMLDOL3",84,0)\par
 .D FILE^DIE("","LRFDA(1)","LRDIE(1)")\par
"RTN","AHMLDOL3",85,0)\par
 .D:$G(LRTSP)\par
"RTN","AHMLDOL3",86,0)\par
 ..S LRBETN=$O(^LRO(69,LRODT,1,LRSN,2,"B",LRTSP,""))\par
"RTN","AHMLDOL3",87,0)\par
 ..I LRBETN D DADD^LRBEBA31(LRODT,LRSN,LRBETN,LRXDA,LRTS,$G(LRBERF))\par
"RTN","AHMLDOL3",88,0)\par
 .K LRBETN,LRBERF\par
"RTN","AHMLDOL3",89,0)\par
 ;\par
"RTN","AHMLDOL3",90,0)\par
 I $G(LRXDA) D\par
"RTN","AHMLDOL3",91,0)\par
 .N X\par
"RTN","AHMLDOL3",92,0)\par
 .S X=1+$S($D(^LRO(69,LRODT,1,LRSN,2,LRXDA,1,0)):$P(^(0),"^",3),1:0),^(0)="^^"_X_"^"_DT,^(X,0)=" Added by "_$G(DUZ)_" on "_$$HTE^XLFDT($H,"M")\par
"RTN","AHMLDOL3",93,0)\par
 .S ^LRO(69,"AA",+$G(^LRO(69,LRODT,1,LRSN,.1)),LRODT_"|"_LRSN)=""\par
"RTN","AHMLDOL3",94,0)\par
 ;\par
"RTN","AHMLDOL3",95,0)\par
 ;\par
"RTN","AHMLDOL3",96,0)\par
SETOR ;\par
"RTN","AHMLDOL3",97,0)\par
 N LTS S LTS(LRTS)=""\par
"RTN","AHMLDOL3",98,0)\par
 D NEW^LR7OB1(LRODT,LRSN,"SN",$G(LRNATURE),.LTS,6)\par
"RTN","AHMLDOL3",99,0)\par
 K DLAYGO,DA,DIC,DIE,DR,LRBERF,LRBEFN,LRBEX\par
"RTN","AHMLDOL3",100,0)\par
 Q\par
"RTN","AHMLDOL3",101,0)\par
 ;\par
"RTN","AHMLDOL3",102,0)\par
END ;\par
"RTN","AHMLDOL3",103,0)\par
 I $G(LRAA),$G(LRAD),$G(LRAN) L -^LRO(68,LRAA,1,LRAD,1,LRAN)\par
"RTN","AHMLDOL3",104,0)\par
 K %,A,AGE,DD,DFN,DIC,DIE,DO,DOB,DR,I,K,LRAA,LRAD,LRACD,LRAN,LRCCOM,LRDFN,LRDPF,LREND,LRIDT,LRODT,LRSN,LRSS,LRTNM,LRTS,LRWRD,PNM,SEX,SSN,X,Y,Z,LRUSNM\par
"RTN","AHMLDOL3",105,0)\par
 K %DT,%H,%X,%Y,DA,J,LRBED,LRCS,LRCSS,LRDTM,LRDTO,LRGVP,LRIDENT,LRIOZERO,LRLLOC,LRLWC,LRNOP,LRONE,LRORD,LRORDTIM,LROWLE,LRPR,LRTST,LRTP,LRTSN,LRUR,LRUSNM,LRWDT1,LRWL1,LRXD,POP,T\par
"RTN","AHMLDOL3",106,0)\par
 K LRTSAD,LRTSUB,LRDATE,D,D0,D1,DN,LRAODT,LRFLG,LRRB,LRSAMP,LRTREA,LRTSP\par
"RTN","AHMLDOL3",107,0)\par
 K LRURG,VA,LRX,LRBERF,LRBETN\par
"RTN","AHMLDOL3",108,0)\par
 Q\par
"RTN","AHMLDOL3",109,0)\par
 ;\par
"RTN","AHMLDOL3",110,0)\par
CHK1 ;\par
"RTN","AHMLDOL3",111,0)\par
 I $D(^LRO(68,LRWL1,1,LRWDT1,1,LRAN,3)),$P(^(3),U,4) S LREND=1 Q\par
"RTN","AHMLDOL3",112,0)\par
 I $D(^LRO(69,LRODT,1,LRSN,3)),$P(^(3),U,2) S LREND=1 Q\par
"RTN","AHMLDOL3",113,0)\par
 S LRTST=0 F  S LRTST=$O(^LRO(68,LRWL1,1,LRWDT1,1,LRAN,4,LRTST)) Q:LRTST<1  I $D(^(LRTST,0)),$P(^(0),U,5) S LREND=1 Q\par
"RTN","AHMLDOL3",114,0)\par
 Q\par
"RTN","AHMLDOL3",115,0)\par
 ;\par
"RTN","AHMLDOL3",116,0)\par
CHKUID(ACCN,UID) ;\par
"RTN","AHMLDOL3",117,0)\par
 B\par
"RTN","AHMLDOL3",118,0)\par
 N FLG\par
"RTN","AHMLDOL3",119,0)\par
 S FLG=0\par
"RTN","AHMLDOL3",120,0)\par
 I $G(UID)'[" " S LUID=UID\par
"RTN","AHMLDOL3",121,0)\par
 I '$D(^LRO(68,"B",JVLAA1)),ACCN'="" D GTVAUID(ACCN,.UID)\par
"RTN","AHMLDOL3",122,0)\par
 Q:'UID\par
"RTN","AHMLDOL3",123,0)\par
 S JVLAD=$P(UID," ",2),JVYR=$E(DT,1,3),JVLAD=JVYR_JVLAD\par
"RTN","AHMLDOL3",124,0)\par
 S JVLAN=$P(UID," ",3)\par
"RTN","AHMLDOL3",125,0)\par
 S JVACC=^LRO(68,JVLAA,1,JVLAD,1,JVLAN,.2)\par
"RTN","AHMLDOL3",126,0)\par
 I JVACC'=UID S JVOROUT(1)="-1^ERROR: Accession number does not exist" Q\par
"RTN","AHMLDOL3",127,0)\par
 S UID=$P(^LRO(68,JVLAA,1,JVLAD,1,JVLAN,.3),U)\par
"RTN","AHMLDOL3",128,0)\par
 Q\par
"RTN","AHMLDOL3",129,0)\par
 ;\par
"RTN","AHMLDOL3",130,0)\par
GTVAUID(ACCN,UID) ;\par
"RTN","AHMLDOL3",131,0)\par
 N SUB,JVDT,JVN\par
"RTN","AHMLDOL3",132,0)\par
 S (UID,SUB,JVDT,JVN)=0\par
"RTN","AHMLDOL3",133,0)\par
 Q:ACCN=""\par
"RTN","AHMLDOL3",134,0)\par
 S SUB=$P(ACCN," ")\par
"RTN","AHMLDOL3",135,0)\par
 S JVDT=$P(ACCN," ",2)\par
"RTN","AHMLDOL3",136,0)\par
 S JVN=$P(ACCN," ",3)\par
"RTN","AHMLDOL3",137,0)\par
 Q:SUB=""\par
"RTN","AHMLDOL3",138,0)\par
 I $D(^LRO(68,"B",SUB)) S JVA=$O(^LRO(68,"B",SUB,""))\par
"RTN","AHMLDOL3",139,0)\par
 I $L((JVDT)'>2) S JVYR=$E(DT,1,3),JVD=JVYR_"0000"\par
"RTN","AHMLDOL3",140,0)\par
 I $L((JVDT)>2) S JVYR=$E(DT,1,3),JVDT=JVYR_JVDT\par
"RTN","AHMLDOL3",141,0)\par
 Q:'$D(^LRO(68,JVA,1,JVDT,1,JVN))\par
"RTN","AHMLDOL3",142,0)\par
 S IEN=JVN_","_JVDT_","_JVA_","\par
"RTN","AHMLDOL3",143,0)\par
 S UID=$$GET1^DIQ(68.02,IEN,16,"I")\par
"RTN","AHMLDOL3",144,0)\par
 Q\par
"RTN","AHMLDOL3",145,0)\par
 ;\par
"RTN","AHMLDOL3",146,0)\par
GTACC(RUID,JORD,JVACC,JVOLAD) ;\par
"RTN","AHMLDOL3",147,0)\par
 N LRAA,LRAD,LRAN,LRORD\par
"RTN","AHMLDOL3",148,0)\par
 S JVACC=0\par
"RTN","AHMLDOL3",149,0)\par
 S LRAA="",LRAA=$O(^LRO(68,"C",RUID,LRAA))\par
"RTN","AHMLDOL3",150,0)\par
 I LRAA'="" S LRAD="",LRAD=$O(^LRO(68,"C",RUID,LRAA,LRAD))\par
"RTN","AHMLDOL3",151,0)\par
 I LRAD'="" S LRAN="",LRAN=$O(^LRO(68,"C",RUID,LRAA,LRAD,LRAN))\par
"RTN","AHMLDOL3",152,0)\par
 I LRAN'="" S JVACC=$G(^LRO(68,LRAA,1,LRAD,1,LRAN,.2))\par
"RTN","AHMLDOL3",153,0)\par
 S LRORD=$G(^LRO(68,LRAA,1,LRAD,1,LRAN,.1))\par
"RTN","AHMLDOL3",154,0)\par
 I LRORD=JORD S JVACC=0\par
"RTN","AHMLDOL3",155,0)\par
 S JVOLAD=$O(^LRO(69,"C",LRORD,JVOLAD))\par
"RTN","AHMLDOL3",156,0)\par
 Q\par
"RTN","AHMLDOL3",157,0)\par
 ;\par
"RTN","AHMLDOL3",158,0)\par
GETEXEC(EXEC) ;\par
"RTN","AHMLDOL3",159,0)\par
 I EXEC=22 S EXEC=7\par
"RTN","AHMLDOL3",160,0)\par
 I EXEC=25 S EXEC=7\par
"RTN","AHMLDOL3",161,0)\par
 I EXEC=26 S EXEC=10\par
"RTN","AHMLDOL3",162,0)\par
 I EXEC=27 S EXEC=9\par
"RTN","AHMLDOL3",163,0)\par
 I EXEC=28 S EXEC=8\par
"RTN","AHMLDOL3",164,0)\par
 I EXEC=59 S EXEC=8\par
"RTN","AHMLDOL3",165,0)\par
 I EXEC=60 S EXEC=7\par
"RTN","AHMLDOL3",166,0)\par
 I EXEC=61 S EXEC=23\par
"RTN","AHMLDOL3",167,0)\par
 I EXEC=62 S EXEC=9\par
"RTN","AHMLDOL3",168,0)\par
 I EXEC=63 S EXEC=10\par
"RTN","AHMLDOL3",169,0)\par
 I EXEC=83 S EXEC=8\par
"RTN","AHMLDOL3",170,0)\par
 Q\par
"RTN","AHMLDOL3",171,0)\par
 ;\par
"RTN","AHMLDOL3",172,0)\par
QUIT ;\par
"RTN","AHMLDOL3",173,0)\par
 K AA,AN,AD,ARAY,COMP,D1,D2,DA,DFN,EXEC,HLARY,LVACC,JVLAA,JVLAA1,LVLAD\par
"RTN","AHMLDOL3",174,0)\par
 K JVDATA,JVNDE,JVLAN,JVYR,JVTSP,LR1ODT,LR1SN,LRAODT,LRBERF,LRCCOM,LRDPT\par
"RTN","AHMLDOL3",175,0)\par
 K LRDPF,LR1AA,LR1AD,LR1AN,LRAA,LRAD,LRAN,LRBETN,LRDATA,LRDFN,LRIDT1,LRIDT\par
"RTN","AHMLDOL3",176,0)\par
 K LRLABKY,LRMSTATI,LRNATURE,JVACC,JVLAD\par
"RTN","AHMLDOL3",177,0)\par
 K LRODT,LRORD,LRSEND,LRSN,LRT1SAD,LRTEST,LRTNM,LRTOACC,LRTS,LRSS,LRTSAD\par
"RTN","AHMLDOL3",178,0)\par
 K LRTSN,LRTSP,LRURG,LRX1,LRXDA\par
"RTN","AHMLDOL3",179,0)\par
 K ORDNM,OREND,ORGY,ORNATR,ORNDO,ORPK,ORSTS,SPEC,SPEC1,SS,SUBSC,X,Y\par
"RTN","AHMLDOL3",180,0)\par
 Q\par
"RTN","AHMLDOL3",181,0)\par
 ;\par
"RTN","AHMLDOL4")\par
0^5^B55894995\par
"RTN","AHMLDOL4",1,0)\par
AHMLDOL4 ;LEIDOS/TCK- REMOTE ORDERING- Laboratory Accessioning process - main driver ; 10/16/16 8:40pm\par
"RTN","AHMLDOL4",2,0)\par
 ;;1.0;Orders Portability;;March 1, 2010;Build 26\par
"RTN","AHMLDOL4",3,0)\par
 ;\par
"RTN","AHMLDOL4",4,0)\par
 Q\par
"RTN","AHMLDOL4",5,0)\par
 ;\par
"RTN","AHMLDOL4",6,0)\par
EN(LRID,JVTST,LRCDT) ;\par
"RTN","AHMLDOL4",7,0)\par
 N LRPWL,LRPWDT,LRPWLE\par
"RTN","AHMLDOL4",8,0)\par
 S (FLG,FLG1,DTIM)=0\par
"RTN","AHMLDOL4",9,0)\par
 D DT^LRX\par
"RTN","AHMLDOL4",10,0)\par
 Q:$G(LRKIL)\par
"RTN","AHMLDOL4",11,0)\par
 D:$D(XRTL) T0^%ZOSV ; START RESPONSE TIME LOGGING\par
"RTN","AHMLDOL4",12,0)\par
 ;CHECK IF LRSN POINTS TO A COMBINED ORDER\par
"RTN","AHMLDOL4",13,0)\par
 S LRCDT=+^LRO(69,LRODT,1,LRSN,1),LREAL=$P(^(1),U,2),X=^(0),LRLLOC=$P(X,U,7),LROLLOC=$P(X,U,9),LRORIFN=$P(X,"^",11)\par
"RTN","AHMLDOL4",14,0)\par
 I 'LRCDT S LRCDT=JVCDT\par
"RTN","AHMLDOL4",15,0)\par
 S JVOD=1\par
"RTN","AHMLDOL4",16,0)\par
 I '$D(^LRO(69,LRODT,1,LRSN,2,"B",JVTST)) D\par
"RTN","AHMLDOL4",17,0)\par
 .I PNLTST S FLG1=1\par
"RTN","AHMLDOL4",18,0)\par
 I FLG1 D FWL,FL69\par
"RTN","AHMLDOL4",19,0)\par
 S LRSEND="",LRSEND=$O(^LRO(69,LRODT,1,LRSN,2,"B",JVTST,LRSEND))\par
"RTN","AHMLDOL4",20,0)\par
 I $P(^LRO(69,LRODT,1,LRSN,2,LRSEND,0),U,6)'="" D\par
"RTN","AHMLDOL4",21,0)\par
 .S LRTSN=""\par
"RTN","AHMLDOL4",22,0)\par
 .F  S LRTSN=$O(^LRO(69,"C",LRORD,LRODT,LRTSN)) Q:LRTSN<1  D  Q:FLG\par
"RTN","AHMLDOL4",23,0)\par
 ..S LBORY(LRORD,LRTSN)=""\par
"RTN","AHMLDOL4",24,0)\par
 .S LRTSN="" F  S LRTSN=$O(LBORY(LRORD,LRTSN)) Q:LRTSN<1  D  Q:FLG\par
"RTN","AHMLDOL4",25,0)\par
 ..I '$D(^LRO(69,LRODT,1,LRTSN,2,"B",JVTST)) S FLG=1 Q\par
"RTN","AHMLDOL4",26,0)\par
 ..S LRSEND="",LRSEND=$O(^LRO(69,LRODT,1,LRTSN,2,"B",JVTST,LRSEND))\par
"RTN","AHMLDOL4",27,0)\par
 ..S LRBACK=$P(^LRO(69,LRODT,1,LRTSN,2,LRSEND,0),U,14) I LRBACK="" Q\par
"RTN","AHMLDOL4",28,0)\par
 ..S LRSN=LRTSN,FLG=1\par
"RTN","AHMLDOL4",29,0)\par
 I $P(^LRO(69,LRODT,1,LRSN,2,0),U,3)>1 D\par
"RTN","AHMLDOL4",30,0)\par
 .S FLG=0,LRSEND=0\par
"RTN","AHMLDOL4",31,0)\par
 .F  S LRSEND=$O(^LRO(69,LRODT,1,LRSN,2,LRSEND)) Q:LRSEND<1  D  Q:FLG\par
"RTN","AHMLDOL4",32,0)\par
 ..S LTACC=$G(^LRO(69,LRODT,1,LRSN,2,LRSEND,.3)) I LTACC="" Q\par
"RTN","AHMLDOL4",33,0)\par
 ..S CHACC=$P(^LRO(69,LRODT,1,LRSN,2,LRSEND,.3),U)\par
"RTN","AHMLDOL4",34,0)\par
 ..I CHACC'=LRID Q\par
"RTN","AHMLDOL4",35,0)\par
 ..S LTX=^LRO(69,LRODT,1,LRSN,2,LRSEND,0)\par
"RTN","AHMLDOL4",36,0)\par
 ..S TEST=$P(LTX,U),LRURG=$P(LTX,U,2),LRAD=$P(LTX,U,3),LRAA=$P(LTX,U,4),LRAN=$P(LTX,U,5),FLG=1\par
"RTN","AHMLDOL4",37,0)\par
 ..I $D(^LAB(60,JVTST,8,DUZ(2))) S LRAA1=$P(^LAB(60,JVTST,8,DUZ(2),0),U,2)\par
"RTN","AHMLDOL4",38,0)\par
 ..I LRAA="" S FLG=0 Q\par
"RTN","AHMLDOL4",39,0)\par
 ..I LRAA1'=LRAA S FLG=0\par
"RTN","AHMLDOL4",40,0)\par
 I FLG D\par
"RTN","AHMLDOL4",41,0)\par
 .S LRACC=^LRO(68,LRAA,1,LRAD,1,LRAN,.2)\par
"RTN","AHMLDOL4",42,0)\par
 .D LRAA\par
"RTN","AHMLDOL4",43,0)\par
 .I LRAA="" S LRAA=0,LRAA=$O(LRTSTS(LRWLC,0,LRAA))\par
"RTN","AHMLDOL4",44,0)\par
 .S LRIDT=$P(^LRO(68,LRAA,1,LRAD,1,LRAN,3),U,5)\par
"RTN","AHMLDOL4",45,0)\par
 .S LRPRAC=$P(^LRO(69,LRODT,1,LRSN,0),U,6)\par
"RTN","AHMLDOL4",46,0)\par
 .S LRLBLBP=""\par
"RTN","AHMLDOL4",47,0)\par
 .D:$G(LRTSTS)>0 ^LRWLST11\par
"RTN","AHMLDOL4",48,0)\par
 .D EN^LA7ADL(LRID)\par
"RTN","AHMLDOL4",49,0)\par
 I 'FLG D\par
"RTN","AHMLDOL4",50,0)\par
 .D LRAA,EN^AHMLDOL5(LRID)\par
"RTN","AHMLDOL4",51,0)\par
 S LRCDT=(+LRCDT)_"^"_LREAL\par
"RTN","AHMLDOL4",52,0)\par
 I '$L($P($G(^LRO(69,LRODT,1,LRSN,1)),"^",7)) S CONTROL=$S($L(LRORIFN):"SC",1:"SN") D NEW^LR7OB1(LRODT,LRSN,CONTROL,,,6)\par
"RTN","AHMLDOL4",53,0)\par
 K LRTSTS,^TMP("LR",$J,"TMP"),LRNM,DIC,I,LRORIFN,LRBACK\par
"RTN","AHMLDOL4",54,0)\par
 I $D(XRT0) S XRTN=$T(+0) D T1^%ZOSV ; STOP RESPONSE TIME LOGGING\par
"RTN","AHMLDOL4",55,0)\par
 Q\par
"RTN","AHMLDOL4",56,0)\par
 ;\par
"RTN","AHMLDOL4",57,0)\par
GTTST() ;\par
"RTN","AHMLDOL4",58,0)\par
 N ORN,FND,TST1,LRSND\par
"RTN","AHMLDOL4",59,0)\par
 S (FND,TST,ORN,LRSND)=0\par
"RTN","AHMLDOL4",60,0)\par
 I '$D(^LRO(69,LRODT,1,LRSN,2)) Q TST\par
"RTN","AHMLDOL4",61,0)\par
 F  S LRSND=$O(^LRO(69,LRODT,1,LRSN,2,LRSND)) Q:LRSND=""!(FND)  D\par
"RTN","AHMLDOL4",62,0)\par
 .S TST1=$P($G(^LRO(69,LRODT,1,LRSN,2,LRSND,0)),"^")\par
"RTN","AHMLDOL4",63,0)\par
 .S ORN=$P($G(^LRO(69,LRODT,1,LRSN,2,LRSND,0)),"^",7)\par
"RTN","AHMLDOL4",64,0)\par
 .I ORN=ORDNM S TST=TST1,FND=1\par
"RTN","AHMLDOL4",65,0)\par
 Q TST\par
"RTN","AHMLDOL4",66,0)\par
 ;\par
"RTN","AHMLDOL4",67,0)\par
LRAA ;\par
"RTN","AHMLDOL4",68,0)\par
 K LRTSTS,^TMP("LR",$J,"TMP")\par
"RTN","AHMLDOL4",69,0)\par
 S LRTSTS=0,LRIX=0,S5=0,LRTN=0\par
"RTN","AHMLDOL4",70,0)\par
 S LRTN="",LRTN=$O(^LRO(69,LRODT,1,LRSN,2,"B",JVTST,LRTN))\par
"RTN","AHMLDOL4",71,0)\par
 I LRTN="" S LRTN=$G(LRSND)\par
"RTN","AHMLDOL4",72,0)\par
 S LRX=^LRO(69,LRODT,1,LRSN,2,LRTN,0)\par
"RTN","AHMLDOL4",73,0)\par
 I '$P(LRX,U,3),'$P(LRX,U,6),'$P(LRX,U,11) S LRORIFN=$P(LRX,"^",7),LRBACK=$P(LRX,"^",14) D SET\par
"RTN","AHMLDOL4",74,0)\par
 ;\par
"RTN","AHMLDOL4",75,0)\par
WL1 ;\par
"RTN","AHMLDOL4",76,0)\par
 ; LRDAA is used by POC interface to specify the POC accession area.\par
"RTN","AHMLDOL4",77,0)\par
 S LRIX=0\par
"RTN","AHMLDOL4",78,0)\par
 F  S LRIX=$O(^TMP("LR",$J,"TMP",LRIX)) Q:LRIX<1  D\par
"RTN","AHMLDOL4",79,0)\par
 . S X=^(LRIX),LRTSTS=+X,LRURG=$P(X,"^",2),LRORIFN=$P(X,"^",4),LRBACK=$P(X,"^",5)\par
"RTN","AHMLDOL4",80,0)\par
 . S LRST=^LAB(60,LRTSTS,0)\par
"RTN","AHMLDOL4",81,0)\par
 . S LRAA=$S($G(LRDAA)>0:LRDAA,$D(^LAB(60,LRTSTS,8,$S($G(LRDUZ(2))>0:LRDUZ(2),1:DUZ(2)),0)):$P(^(0),U,2),1:"")\par
"RTN","AHMLDOL4",82,0)\par
 . S LRNM=$P(LRST,U),LRUNQ=+$P(LRST,U,7)\par
"RTN","AHMLDOL4",83,0)\par
 . D WL2\par
"RTN","AHMLDOL4",84,0)\par
 Q\par
"RTN","AHMLDOL4",85,0)\par
 ;\par
"RTN","AHMLDOL4",86,0)\par
WL2 ;\par
"RTN","AHMLDOL4",87,0)\par
 I 'PNLTST,LRAA="" D GTLRAA(JVTST,.LRAA)\par
"RTN","AHMLDOL4",88,0)\par
 D FWL:$G(LRAA)="" Q:LRAA=""\par
"RTN","AHMLDOL4",89,0)\par
 S LRWL0=^LRO(68,LRAA,0),LRSS=$P(LRWL0,U,2),LRIDIV=$S($L($P(LRWL0,U,19)):$P(LRWL0,U,19),1:"CP")\par
"RTN","AHMLDOL4",90,0)\par
 S LRPWL=$P($G(^LRO(68,LRAA,0)),U,4)\par
"RTN","AHMLDOL4",91,0)\par
 S LRWLC=$P(LRWL0,U,4)\par
"RTN","AHMLDOL4",92,0)\par
 S:'LRWLC LRWLC=LRAA\par
"RTN","AHMLDOL4",93,0)\par
 S LRTSTS(LRWLC,LRUNQ,LRAA)=LRSS_U_$P(LRWL0,U,12),LRTSTS(LRWLC,LRUNQ,LRAA,LRIX)=^TMP("LR",$J,"TMP",LRIX)\par
"RTN","AHMLDOL4",94,0)\par
 Q\par
"RTN","AHMLDOL4",95,0)\par
 ;\par
"RTN","AHMLDOL4",96,0)\par
GTLRAA(JVTST,LRAA) ;\par
"RTN","AHMLDOL4",97,0)\par
 N CMPTST\par
"RTN","AHMLDOL4",98,0)\par
 S CMPTST=0,LRAA=""\par
"RTN","AHMLDOL4",99,0)\par
 I $O(^LAB(60,JVTST,2,0))>0 D\par
"RTN","AHMLDOL4",100,0)\par
 .S I=0,I=$O(^LAB(60,JVTST,2,I)) Q:I=""\par
"RTN","AHMLDOL4",101,0)\par
 .;GET ACCESSION AREA FROM 8 NODE OF FILE 60\par
"RTN","AHMLDOL4",102,0)\par
 .S CMPTST=^LAB(60,JVTST,2,I,0)\par
"RTN","AHMLDOL4",103,0)\par
 .Q:CMPTST=""\par
"RTN","AHMLDOL4",104,0)\par
 .S LRAA=$P($G(^LAB(60,CMPTST,8,DUZ(2),0)),"^",2)\par
"RTN","AHMLDOL4",105,0)\par
 Q\par
"RTN","AHMLDOL4",106,0)\par
 ;\par
"RTN","AHMLDOL4",107,0)\par
SET ;\par
"RTN","AHMLDOL4",108,0)\par
 I $G(LRORDRR)="R" S LRTEST(LRTN)=$G(^LRO(69,LRODT,1,LRSN,2,LRTN,0))\par
"RTN","AHMLDOL4",109,0)\par
 S S5=S5+1,I5=$G(^LRO(69,LRODT,1,LRSN,2,LRTN,0))\par
"RTN","AHMLDOL4",110,0)\par
 I I5 S ^TMP("LR",$J,"TMP",S5)=$P(I5,U)_U_$P(I5,U,2)_U_LRTN_U_LRORIFN_U_LRBACK_U_$S($G(LRTSP):LRTSP,1:$P(I5,U)),I5=LRTN\par
"RTN","AHMLDOL4",111,0)\par
 Q\par
"RTN","AHMLDOL4",112,0)\par
 ;\par
"RTN","AHMLDOL4",113,0)\par
FWL ;\par
"RTN","AHMLDOL4",114,0)\par
 ;Get panel IEN from order number\par
"RTN","AHMLDOL4",115,0)\par
 S LRIX=1\par
"RTN","AHMLDOL4",116,0)\par
 I $O(^LAB(60,PNLTST,2,0))>0 D EXP S $P(^LRO(69,LRODT,1,LRSN,2,$P(^TMP("LR",$J,"TMP",LRIX),U,3),0),U,8)=1 Q\par
"RTN","AHMLDOL4",117,0)\par
 Q\par
"RTN","AHMLDOL4",118,0)\par
 ;\par
"RTN","AHMLDOL4",119,0)\par
EXP ;\par
"RTN","AHMLDOL4",120,0)\par
 N LRSEN\par
"RTN","AHMLDOL4",121,0)\par
 S (I,I5,S5)=0,LRSEN=""\par
"RTN","AHMLDOL4",122,0)\par
 F  S I=$O(^LAB(60,PNLTST,2,I)) Q:I<1!(S5)  D\par
"RTN","AHMLDOL4",123,0)\par
 .S J=+^LAB(60,PNLTST,2,I,0)\par
"RTN","AHMLDOL4",124,0)\par
 .Q:J'=JVTST\par
"RTN","AHMLDOL4",125,0)\par
 .S S5=S5+1,I5=I5+1\par
"RTN","AHMLDOL4",126,0)\par
 .S ^TMP("LR",$J,"TMP",S5)=J_"^"_LRURG_"^"_I5_"^"_ORDNM_"^^"_PNLTST\par
"RTN","AHMLDOL4",127,0)\par
 .;Get panel test comment date and comments to add to component\par
"RTN","AHMLDOL4",128,0)\par
 .I $D(^LRO(69,LRODT,1,LRSN,2,"B",PNLTST)) D\par
"RTN","AHMLDOL4",129,0)\par
 ..S LRSEN="",LRSEN=$O(^LRO(69,LRODT,1,LRSN,2,"B",PNLTST,LRSEN))\par
"RTN","AHMLDOL4",130,0)\par
 ..Q:$G(LRSEN)=""\par
"RTN","AHMLDOL4",131,0)\par
 ..Q:'$D(^LRO(69,LRODT,1,LRSN,2,LRSEN,1.1))\par
"RTN","AHMLDOL4",132,0)\par
 ..S CMTDT=$P(^LRO(69,LRODT,1,LRSN,2,LRSEN,1.1,0),"^",5)\par
"RTN","AHMLDOL4",133,0)\par
 ..S CNT=0 F  S CNT=$O(^LRO(69,LRODT,1,LRSN,2,LRSEN,1.1,CNT)) Q:CNT<1  D\par
"RTN","AHMLDOL4",134,0)\par
 ...Q:'$D(^LRO(69,LRODT,1,LRSN,2,LRSEN,1.1,CNT))\par
"RTN","AHMLDOL4",135,0)\par
 ...S CMT(CNT)=^LRO(69,LRODT,1,LRSN,2,LRSEN,1.1,CNT,0)\par
"RTN","AHMLDOL4",136,0)\par
 S LRIX=1\par
"RTN","AHMLDOL4",137,0)\par
 Q\par
"RTN","AHMLDOL4",138,0)\par
 ;\par
"RTN","AHMLDOL4",139,0)\par
PRESET ;\par
"RTN","AHMLDOL4",140,0)\par
 I '($D(^LRO(68,LRAA,1,LRAD,1,LRAN,0))#2) K ^LRO(68,LRAA,1,LRAD,1,LRAN) Q\par
"RTN","AHMLDOL4",141,0)\par
 S LROLRDFN=+^LRO(68,LRAA,1,LRAD,1,LRAN,0)\par
"RTN","AHMLDOL4",142,0)\par
 I $L($P(^LRO(68,LRAA,1,LRAD,1,LRAN,0),U,5)) S LRDPF=$P(^LR(LROLRDFN,0),U,2),DFN=$P(^(0),U,3) D PT^LRX\par
"RTN","AHMLDOL4",143,0)\par
 S LRIDT=9999999-^LRO(68,LRAA,1,LRAD,1,LRAN,3)\par
"RTN","AHMLDOL4",144,0)\par
 Q:'$D(^LR(LROLRDFN,LRSS,LRIDT,0))\par
"RTN","AHMLDOL4",145,0)\par
 ;\par
"RTN","AHMLDOL4",146,0)\par
PR2 ;\par
"RTN","AHMLDOL4",147,0)\par
 S LRNIDT=9999999-LRCDT\par
"RTN","AHMLDOL4",148,0)\par
 F  Q:'$D(^LR(LRDFN,LRSS,LRNIDT,0))  D\par
"RTN","AHMLDOL4",149,0)\par
 . S LRCDT=$$FMADD^XLFDT(LRCDT,,,,1)\par
"RTN","AHMLDOL4",150,0)\par
 . S LRNIDT=9999999-LRCDT\par
"RTN","AHMLDOL4",151,0)\par
 I $P(^LR(LROLRDFN,LRSS,LRIDT,0),U,3) S LREND=1 W !,$C(7),"CAN'T DO IT. The data has been verified for that log number." Q\par
"RTN","AHMLDOL4",152,0)\par
 S ^LR(LRDFN,LRSS,LRNIDT,0)=LRCDT_U_LREAL_U_$P(^LR(LROLRDFN,LRSS,LRIDT,0),U,3,4)_U_U_$P(^(0),U,6,99)\par
"RTN","AHMLDOL4",153,0)\par
 S J=0 F  S J=$O(^LR(LROLRDFN,LRSS,LRIDT,J)) Q:J<1  S ^LR(LRDFN,LRSS,LRNIDT,J)=^LR(LROLRDFN,LRSS,LRIDT,J)\par
"RTN","AHMLDOL4",154,0)\par
 S X=^LRO(68,LRAA,1,LRAD,1,LRAN,0),LROSN=$P(X,U,5),LROID=$P(X,U,6),LROCN=$S($D(^(.1)):$P(^(.1),U),1:"")\par
"RTN","AHMLDOL4",155,0)\par
 K:$L(LROID) ^LRO(68,LRAA,1,LRAD,1,"C",LROID,LRAN)\par
"RTN","AHMLDOL4",156,0)\par
 K:$L(LROCN) ^LRO(68,LRAA,1,LRAD,1,"D",LROCN,LRAN)\par
"RTN","AHMLDOL4",157,0)\par
 K ^LRO(68,LRAA,1,LRAD,1,LRAN),^LR(LROLRDFN,LRSS,LRIDT)\par
"RTN","AHMLDOL4",158,0)\par
 Q\par
"RTN","AHMLDOL4",159,0)\par
 ;\par
"RTN","AHMLDOL4",160,0)\par
OR ;from LRPHITEM\par
"RTN","AHMLDOL4",161,0)\par
 I $G(LRORDRR)="R" S LRTEST(LRTN)=$G(^LRO(69,LRODT,1,LRSN,2,LRTN,0)) Q\par
"RTN","AHMLDOL4",162,0)\par
 Q\par
"RTN","AHMLDOL4",163,0)\par
 ;\par
"RTN","AHMLDOL4",164,0)\par
FL69 ;\par
"RTN","AHMLDOL4",165,0)\par
 N Y\par
"RTN","AHMLDOL4",166,0)\par
 S (CNT,Y)=""\par
"RTN","AHMLDOL4",167,0)\par
 F  S Y=$O(^TMP("LR",$J,"TMP",Y)) Q:Y=""  D\par
"RTN","AHMLDOL4",168,0)\par
 .K LRIENS,LRMSG\par
"RTN","AHMLDOL4",169,0)\par
 .S TST=$P($G(^TMP("LR",$J,"TMP",Y)),"^")\par
"RTN","AHMLDOL4",170,0)\par
 .S LRURG=6\par
"RTN","AHMLDOL4",171,0)\par
 .S IEN="?+1,"_LRSN_","_LRODT_","\par
"RTN","AHMLDOL4",172,0)\par
 .S LRFDA(2,69.03,IEN,.01)=TST\par
"RTN","AHMLDOL4",173,0)\par
 .S LRFDA(2,69.03,IEN,1)=$G(LRURG)\par
"RTN","AHMLDOL4",174,0)\par
 .S LRFDA(2,69.03,IEN,6)=+ORDNM\par
"RTN","AHMLDOL4",175,0)\par
 .D UPDATE^DIE("","LRFDA(2)","LRIENS","LRMSG")\par
"RTN","AHMLDOL4",176,0)\par
 .;Set panel test comments into new component test nodes\par
"RTN","AHMLDOL4",177,0)\par
 .I $G(LRIENS(1)) S LRIENS=LRIENS(1) D\par
"RTN","AHMLDOL4",178,0)\par
 ..S ^LRO(69,LRODT,1,LRSN,2,LRIENS,1,0)=$G(CMTDT)\par
"RTN","AHMLDOL4",179,0)\par
 ..Q:'$D(CMT)\par
"RTN","AHMLDOL4",180,0)\par
 ..S CNT="" F  S CNT=$O(CMT(CNT)) Q:CNT<1  D\par
"RTN","AHMLDOL4",181,0)\par
 ...S ^LRO(69,LRODT,1,LRSN,2,LRIENS,1,CNT,0)=$G(CMT(CNT))\par
"RTN","AHMLDOL4",182,0)\par
 Q\par
"RTN","AHMLDOL4",183,0)\par
 K JVOD\par
"RTN","AHMLDOL4",184,0)\par
 ;\par
"RTN","AHMLDOL4",185,0)\par
EXIT ;\par
"RTN","AHMLDOL4",186,0)\par
 K CHACC,CONTROL,DFN,DTOUT,DUOUT,FLG,I5,J,LBORY,LRAA,LRACC,LRAA1,LRAN,LRDAA,LRDFN,LRCDT,LRAD\par
"RTN","AHMLDOL4",187,0)\par
 K IEN,CMT,CNT,FLG1,IEN,LRDUZ,LREAL,LREND,LRIDIV,LRIDT,LRIEN,LRIFN,LRDPF,LRIX,LRKILL,LRKIL\par
"RTN","AHMLDOL4",188,0)\par
 K JVCDT,LRFDA,ORDNM,PNLTST,TST,LRNIDT,LRNCWL,LRLLOC,LROCN,LRODT,LROID,LROLLOC,LROLRDFN,LRPHSET,LRPRAC\par
"RTN","AHMLDOL4",189,0)\par
 K LRQUIET,LRORD,LRORDRR,LROSN,LRSEND,LRSN,LRSS,LRST,LRTEST,LRTN,LRTSN,LRTSP,LRX,LTACC,LTX\par
"RTN","AHMLDOL4",190,0)\par
 K CMTDT,LRUNQ,LRURG,LRWLC,LRWL0,LRWO,PNM,SSN,S5,TEST,X,XRT0,XRTL,XRTN,XRTO,Y\par
"RTN","AHMLDOL4",191,0)\par
 Q\par
"RTN","AHMLDOL4",192,0)\par
 ;\par
"RTN","AHMLDOL5")\par
0^6^B60471622\par
"RTN","AHMLDOL5",1,0)\par
AHMLDOL5 ;SAIC/TCK- Orders Portability - Laboratory Accessioning Process ; 10/16/16 8:31pm\par
"RTN","AHMLDOL5",2,0)\par
 ;;1.0;Orders Portability;;March 1, 2010;Build 26\par
"RTN","AHMLDOL5",3,0)\par
 ;\par
"RTN","AHMLDOL5",4,0)\par
 Q\par
"RTN","AHMLDOL5",5,0)\par
 ;\par
"RTN","AHMLDOL5",6,0)\par
EN(LRID) ;\par
"RTN","AHMLDOL5",7,0)\par
 S (DTIME,LRWLC)=0\par
"RTN","AHMLDOL5",8,0)\par
 F  S LRWLC=$O(LRTSTS(LRWLC)) Q:LRWLC<1  S LRAD=DT D SPLIT\par
"RTN","AHMLDOL5",9,0)\par
 ;\par
"RTN","AHMLDOL5",10,0)\par
 ;If LEDI and comments came with order then copy to order in #69\par
"RTN","AHMLDOL5",11,0)\par
 I $G(LRORDRR)="R",$G(LR696),$D(^LRO(69.6,LR696,99)) D\par
"RTN","AHMLDOL5",12,0)\par
 . N LRDIE\par
"RTN","AHMLDOL5",13,0)\par
 . D WP^DIE(69.01,LRSN_","_LRODT_",",16,"A","^LRO(69.6,LR696,99)","LRDIE(16)")\par
"RTN","AHMLDOL5",14,0)\par
 ;\par
"RTN","AHMLDOL5",15,0)\par
 K DIC,DLAYGO,DR,DA,DIE,LRIXX\par
"RTN","AHMLDOL5",16,0)\par
 Q:$G(LRORDR)="P"\par
"RTN","AHMLDOL5",17,0)\par
 K LRNM,LRTSTS\par
"RTN","AHMLDOL5",18,0)\par
 K ^TMP("LR",$J,"TMP")\par
"RTN","AHMLDOL5",19,0)\par
 Q\par
"RTN","AHMLDOL5",20,0)\par
 ;\par
"RTN","AHMLDOL5",21,0)\par
SPLIT ;\par
"RTN","AHMLDOL5",22,0)\par
 N LRAA,LRX\par
"RTN","AHMLDOL5",23,0)\par
 ; Setup regular accessions (LRUNQ=0)\par
"RTN","AHMLDOL5",24,0)\par
 S LRUNQ=0,LREND=0\par
"RTN","AHMLDOL5",25,0)\par
 I $D(LRTSTS(LRWLC,0)) D\par
"RTN","AHMLDOL5",26,0)\par
 . D GTWLN\par
"RTN","AHMLDOL5",27,0)\par
 . I LREND Q\par
"RTN","AHMLDOL5",28,0)\par
 . S LRAA=0\par
"RTN","AHMLDOL5",29,0)\par
 . F  S LRAA=$O(LRTSTS(LRWLC,0,LRAA)) Q:LRAA<1  D\par
"RTN","AHMLDOL5",30,0)\par
 . . S LRSS=LRTSTS(LRWLC,0,LRAA)\par
"RTN","AHMLDOL5",31,0)\par
 . . D STWLN,ST2,^LRWLST11,EN^LA7ADL(LRID)\par
"RTN","AHMLDOL5",32,0)\par
 . . ;S LRTS="",LRIX=0\par
"RTN","AHMLDOL5",33,0)\par
 . . ;F  S LRIX=$O(LRTSTS(LRWLC,LRUNQ,LRAA,LRIX)) Q:LRIX<1  D\par
"RTN","AHMLDOL5",34,0)\par
 . . . ;D SET^LRWLST11 Q:LRUNQ\par
"RTN","AHMLDOL5",35,0)\par
 . . . ;D SCDT^LRWLST11,SLRSS^LRWLST11,COMMON^LRWLST11,EN^LA7ADL(LRID)\par
"RTN","AHMLDOL5",36,0)\par
 . D SICA^LRWLST11\par
"RTN","AHMLDOL5",37,0)\par
 ;\par
"RTN","AHMLDOL5",38,0)\par
 ; Setup accessions requiring 'unique' accession numbers (LRUNQ=1)\par
"RTN","AHMLDOL5",39,0)\par
 S LRUNQ=1,LRAA=0\par
"RTN","AHMLDOL5",40,0)\par
 F  S LRAA=$O(LRTSTS(LRWLC,1,LRAA)) Q:LRAA<1  D\par
"RTN","AHMLDOL5",41,0)\par
 . S LRSS=LRTSTS(LRWLC,1,LRAA)\par
"RTN","AHMLDOL5",42,0)\par
 . F  D GTWLN Q:LREND  D   Q:$O(LRTSTS(LRWLC,1,LRAA,0))<1\par
"RTN","AHMLDOL5",43,0)\par
 . . D STWLN,ST2,^LRWLST11,EN^LA7ADL(LRUID),SICA^LRWLST11\par
"RTN","AHMLDOL5",44,0)\par
 Q\par
"RTN","AHMLDOL5",45,0)\par
 ;\par
"RTN","AHMLDOL5",46,0)\par
 ;\par
"RTN","AHMLDOL5",47,0)\par
STWLN ; Set accession number\par
"RTN","AHMLDOL5",48,0)\par
 ;\par
"RTN","AHMLDOL5",49,0)\par
 D GETLOCK(LRAA,LRAD)\par
"RTN","AHMLDOL5",50,0)\par
 D CHECK68(LRAA,LRAD)\par
"RTN","AHMLDOL5",51,0)\par
 ;\par
"RTN","AHMLDOL5",52,0)\par
 S LRDPF=$P(^LR(LRDFN,0),U,2),DFN=$P(^(0),U,3)\par
"RTN","AHMLDOL5",53,0)\par
 ;\par
"RTN","AHMLDOL5",54,0)\par
 ; Handle 'in common' area that was not setup in GTWLN call.\par
"RTN","AHMLDOL5",55,0)\par
 I '$D(^LRO(68,LRAA,1,LRAD,1,LRAN)) D SETAN(LRAA,LRAD,LRAN)\par
"RTN","AHMLDOL5",56,0)\par
 ;\par
"RTN","AHMLDOL5",57,0)\par
 S LREND=0,LRLBLBP=1-$P(LRSS,U,2),LRSS=$P(LRSS,U)\par
"RTN","AHMLDOL5",58,0)\par
 S LRACC=$P(^LRO(68,LRAA,0),U,11)_" "_$S(LRAD["0000":$E(LRAD,2,3),1:$E(LRAD,4,7))_" "_LRAN\par
"RTN","AHMLDOL5",59,0)\par
 S LRPRAC=""\par
"RTN","AHMLDOL5",60,0)\par
 I $D(^LRO(69,LRODT,1,LRSN,0)) S LRPRAC=$P(^(0),U,6) S:$D(LRNT) ^(3)=LRNT\par
"RTN","AHMLDOL5",61,0)\par
 ;\par
"RTN","AHMLDOL5",62,0)\par
 ; Location type\par
"RTN","AHMLDOL5",63,0)\par
 S LRCAPLOC=$P($G(^SC(+LROLLOC,0)),U,3)\par
"RTN","AHMLDOL5",64,0)\par
 I LRCAPLOC="" S LRCAPLOC="Z"\par
"RTN","AHMLDOL5",65,0)\par
 ;\par
"RTN","AHMLDOL5",66,0)\par
 ; File information in file #68 for this accession\par
"RTN","AHMLDOL5",67,0)\par
 N LRFDA,LR6802,LRDIE\par
"RTN","AHMLDOL5",68,0)\par
 S LR6802=LRAN_","_LRAD_","_LRAA_","\par
"RTN","AHMLDOL5",69,0)\par
 S LRFDA(1,68.02,LR6802,.01)=LRDFN\par
"RTN","AHMLDOL5",70,0)\par
 S LRFDA(1,68.02,LR6802,1)=LRDPF\par
"RTN","AHMLDOL5",71,0)\par
 S LRFDA(1,68.02,LR6802,2)=LRAD\par
"RTN","AHMLDOL5",72,0)\par
 S LRFDA(1,68.02,LR6802,3)=LRODT\par
"RTN","AHMLDOL5",73,0)\par
 S LRFDA(1,68.02,LR6802,4)=LRSN\par
"RTN","AHMLDOL5",74,0)\par
 S LRFDA(1,68.02,LR6802,6)=LRLLOC\par
"RTN","AHMLDOL5",75,0)\par
 S X=$G(^LRO(69,LRODT,1,LRSN,.1)) I X'="" S LRFDA(1,68.02,LR6802,14)=X\par
"RTN","AHMLDOL5",76,0)\par
 ;\par
"RTN","AHMLDOL5",77,0)\par
 ; No ordering provider/location on controls\par
"RTN","AHMLDOL5",78,0)\par
 I LRDPF'=62.3 D\par
"RTN","AHMLDOL5",79,0)\par
 . S LRFDA(1,68.02,LR6802,6.5)=LRPRAC\par
"RTN","AHMLDOL5",80,0)\par
 . S LRFDA(1,68.02,LR6802,94)=LROLLOC\par
"RTN","AHMLDOL5",81,0)\par
 ;\par
"RTN","AHMLDOL5",82,0)\par
 ; Only store treating specialty on file #2 patients\par
"RTN","AHMLDOL5",83,0)\par
 ; If no treating specialty then use specialty from file #44 location\par
"RTN","AHMLDOL5",84,0)\par
 I LRDPF=2 D\par
"RTN","AHMLDOL5",85,0)\par
 . S LRTREA=$P($G(^DPT(DFN,.103)),U)\par
"RTN","AHMLDOL5",86,0)\par
 . I 'LRTREA S LRTREA=$P($G(^SC(+LROLLOC,0)),U,20)\par
"RTN","AHMLDOL5",87,0)\par
 . I LRTREA S LRFDA(1,68.02,LR6802,6.6)=LRTREA\par
"RTN","AHMLDOL5",88,0)\par
 ;\par
"RTN","AHMLDOL5",89,0)\par
 S LRFDA(1,68.02,LR6802,6.7)=DUZ\par
"RTN","AHMLDOL5",90,0)\par
 S LRFDA(1,68.02,LR6802,15)=LRACC\par
"RTN","AHMLDOL5",91,0)\par
 S LRFDA(1,68.02,LR6802,26)=DUZ(2)\par
"RTN","AHMLDOL5",92,0)\par
 S LRFDA(1,68.02,LR6802,92)=LRCAPLOC\par
"RTN","AHMLDOL5",93,0)\par
 D FILE^DIE("","LRFDA(1)","LRDIE(1)")\par
"RTN","AHMLDOL5",94,0)\par
 I $D(LRDIE(1)) D MAILALRT^LRWLST12("STWLN~LRWLST1")\par
"RTN","AHMLDOL5",95,0)\par
 ;\par
"RTN","AHMLDOL5",96,0)\par
 ; If specimen defined then set nodes, force to ien=1 since many lab\par
"RTN","AHMLDOL5",97,0)\par
 ; routines expect the specimen to be record number 1.\par
"RTN","AHMLDOL5",98,0)\par
 I $G(LRSPEC) D\par
"RTN","AHMLDOL5",99,0)\par
 . N LRFDAIEN,LRLOCKOK,LRLOOPCT\par
"RTN","AHMLDOL5",100,0)\par
 . S LRFDAIEN(1)=1\par
"RTN","AHMLDOL5",101,0)\par
 . S LRFDA(2,68.05,"+1,"_LR6802,.01)=LRSPEC\par
"RTN","AHMLDOL5",102,0)\par
 . S LRFDA(2,68.05,"+1,"_LR6802,1)=$P(LRSAMP,";",1)\par
"RTN","AHMLDOL5",103,0)\par
 . ;\par
"RTN","AHMLDOL5",104,0)\par
 . ; Modification to prevent lock failures - loop 10 times to give system a chance to get lock\par
"RTN","AHMLDOL5",105,0)\par
 . S LRLOCKOK=0\par
"RTN","AHMLDOL5",106,0)\par
 . F LRLOOPCT=1:1:10 D  Q:LRLOCKOK\par
"RTN","AHMLDOL5",107,0)\par
 . . D UPDATE^DIE("","LRFDA(2)","LRFDAIEN","LRDIE(2)")\par
"RTN","AHMLDOL5",108,0)\par
 . . I $G(LRDIE(2,"DIERR")),LRDIE(2,"DIERR",1)<120  H 5 K:LRLOOPCT<10 LRDIE(2)\par
"RTN","AHMLDOL5",109,0)\par
 . . E  S LRLOCKOK=1\par
"RTN","AHMLDOL5",110,0)\par
 . ;\par
"RTN","AHMLDOL5",111,0)\par
 . I $D(LRDIE(2)) D MAILALRT^LRWLST12("STWLN~LRWLST1")\par
"RTN","AHMLDOL5",112,0)\par
 ;\par
"RTN","AHMLDOL5",113,0)\par
 ; If no specimen defined then use specimen values from file #69.\par
"RTN","AHMLDOL5",114,0)\par
 I $G(LRSPEC)="",$D(^LRO(69,LRODT,1,LRSN,4,0)) D\par
"RTN","AHMLDOL5",115,0)\par
 . N LRFDA,LRFDAIEN,LRI,LRX\par
"RTN","AHMLDOL5",116,0)\par
 . S LRI=0\par
"RTN","AHMLDOL5",117,0)\par
 . F  S LRI=$O(^LRO(69,LRODT,1,LRSN,4,LRI)) Q:'LRI  D\par
"RTN","AHMLDOL5",118,0)\par
 . . S LRFDAIEN(1)=LRI,LRX=$G(^LRO(69,LRODT,1,LRSN,4,LRI,0))\par
"RTN","AHMLDOL5",119,0)\par
 . . S LRFDA(LRI,68.05,"+1,"_LR6802,.01)=$P(LRX,"^")\par
"RTN","AHMLDOL5",120,0)\par
 . . D UPDATE^DIE("","LRFDA(LRI)","LRFDAIEN","LRDIE(LRI)")\par
"RTN","AHMLDOL5",121,0)\par
 . . I $D(LRDIE(LRI)) D MAILALRT^LRWLST12("STWLN~LRWLST1")\par
"RTN","AHMLDOL5",122,0)\par
 ;\par
"RTN","AHMLDOL5",123,0)\par
 ; Create UID.\par
"RTN","AHMLDOL5",124,0)\par
 S LRUID=$$LRUID^LRX(LRAA,LRAD,LRAN)\par
"RTN","AHMLDOL5",125,0)\par
 I '$D(LRPHSET),('$G(LRQUIET)) W !!,"ACCESSION:  ",LRACC,"  <",LRUID,">"\par
"RTN","AHMLDOL5",126,0)\par
 D UPD696\par
"RTN","AHMLDOL5",127,0)\par
 ;\par
"RTN","AHMLDOL5",128,0)\par
 L -^LRO(68,LRAA,1,LRAD,1,0)\par
"RTN","AHMLDOL5",129,0)\par
 Q\par
"RTN","AHMLDOL5",130,0)\par
 ;\par
"RTN","AHMLDOL5",131,0)\par
 ;\par
"RTN","AHMLDOL5",132,0)\par
UPD696 ; Update file #69.6 if LEDI referral patient and no existing entry\par
"RTN","AHMLDOL5",133,0)\par
 K LR696IEN\par
"RTN","AHMLDOL5",134,0)\par
 I $G(LRORDRR)="R" D\par
"RTN","AHMLDOL5",135,0)\par
 . S LR696IEN=0\par
"RTN","AHMLDOL5",136,0)\par
 . I $G(LRRSITE("SMID"))'="",$G(LRSD("RUID"))'="" S LR696IEN=+$O(^LRO(69.6,"AD",LRRSITE("SMID"),LRSD("RUID"),0))\par
"RTN","AHMLDOL5",137,0)\par
 . I LR696IEN Q\par
"RTN","AHMLDOL5",138,0)\par
 . I '$G(LRRSTAT(0)) S LRRSTAT(0)=$$FIND1^DIC(64.061,"","OMX","Specimenin process","","I $P(^LAB(64.061,Y,0),U,7)=""U""")\par
"RTN","AHMLDOL5",139,0)\par
 . D PSET^LRPEND(SSN(2),+LRRSITE("RSITE"),LRSD("RUID"),+LRSD("RPSITE"),LRSPEC,LRSAMP,LRRSTAT(0),LRODT,$P(LRCDT,U),LRRSITE("SDT"),LRNT,.LROT)\par
"RTN","AHMLDOL5",140,0)\par
 Q\par
"RTN","AHMLDOL5",141,0)\par
 ;\par
"RTN","AHMLDOL5",142,0)\par
 ;\par
"RTN","AHMLDOL5",143,0)\par
ST2 ; Find next available node in LR global\par
"RTN","AHMLDOL5",144,0)\par
 ;\par
"RTN","AHMLDOL5",145,0)\par
 N LRFDA,LRFDAIEN,LRDIE,LRX,LRXIDT\par
"RTN","AHMLDOL5",146,0)\par
 ; Autopsy ("AU") is not a multiple - do not attempt to set in ^LR global\par
"RTN","AHMLDOL5",147,0)\par
 I LRSS="AU" S LRIDT=0 Q\par
"RTN","AHMLDOL5",148,0)\par
 ;\par
"RTN","AHMLDOL5",149,0)\par
 S LRIDT=0\par
"RTN","AHMLDOL5",150,0)\par
 F  D  Q:LRIDT\par
"RTN","AHMLDOL5",151,0)\par
 . S LRXIDT=9999999-LRCDT\par
"RTN","AHMLDOL5",152,0)\par
 . L +^LR(LRDFN,LRSS,LRXIDT,0):5\par
"RTN","AHMLDOL5",153,0)\par
 . I '$T S LRCDT=$$FMADD^XLFDT(LRCDT,0,0,0,1) Q\par
"RTN","AHMLDOL5",154,0)\par
 . I '$D(^LR(LRDFN,LRSS,LRXIDT,0)) S LRIDT=LRXIDT Q\par
"RTN","AHMLDOL5",155,0)\par
 . L -^LR(LRDFN,LRSS,LRXIDT,0)\par
"RTN","AHMLDOL5",156,0)\par
 . S LRCDT=$$FMADD^XLFDT(LRCDT,0,0,0,1)\par
"RTN","AHMLDOL5",157,0)\par
 ;\par
"RTN","AHMLDOL5",158,0)\par
 ; Create entry in appropriate subscript in LAB DATA file (#63).\par
"RTN","AHMLDOL5",159,0)\par
 S LRX=$S(LRSS="CH":63.04,LRSS="MI":63.05,LRSS="BB":63.01,LRSS="SP":63.08,LRSS="CY":63.09,LRSS="EM":63.02,1:0)\par
"RTN","AHMLDOL5",160,0)\par
 S LRFDAIEN(1)=LRIDT\par
"RTN","AHMLDOL5",161,0)\par
 S LRFDA(63,LRX,"+1,"_LRDFN_",",.01)=LRCDT\par
"RTN","AHMLDOL5",162,0)\par
 S LRFDA(63,LRX,"+1,"_LRDFN_",",.06)=LRACC\par
"RTN","AHMLDOL5",163,0)\par
 I LRSS'="CH" D\par
"RTN","AHMLDOL5",164,0)\par
 . S LRFDA(63,LRX,"+1,"_LRDFN_",",.1)=LRNT\par
"RTN","AHMLDOL5",165,0)\par
 . S LRFDA(63,LRX,"+1,"_LRDFN_",",.08)=LRLLOC\par
"RTN","AHMLDOL5",166,0)\par
 I LRSS="CH" D\par
"RTN","AHMLDOL5",167,0)\par
 . S LRFDA(63,LRX,"+1,"_LRDFN_",",.12)=3\par
"RTN","AHMLDOL5",168,0)\par
 . S LRFDA(63,LRX,"+1,"_LRDFN_",",.11)=LRLLOC\par
"RTN","AHMLDOL5",169,0)\par
 I LRSS="MI" S LRFDA(63,LRX,"+1,"_LRDFN_",",38)=3\par
"RTN","AHMLDOL5",170,0)\par
 I "SPCYEM"[LRSS N LRABV S LRABV=$P(LRACC," ")\par
"RTN","AHMLDOL5",171,0)\par
 I LRX D UPDATE^DIE("","LRFDA(63)","LRFDAIEN","LRDIE(63)")\par
"RTN","AHMLDOL5",172,0)\par
 I $D(LRDIE(63)) D MAILALRT^LRWLST12("ST2~LRWLST1")\par
"RTN","AHMLDOL5",173,0)\par
 ;\par
"RTN","AHMLDOL5",174,0)\par
 ; Uncomment following code when new field .9 in"MI" subscript is released\par
"RTN","AHMLDOL5",175,0)\par
 ;I LRSS="MI" D\par
"RTN","AHMLDOL5",176,0)\par
 ;. N LRN,ERR,IENS\par
"RTN","AHMLDOL5",177,0)\par
 ;. S IENS=LRIDT_","_LRDFN_",",LRN=0\par
"RTN","AHMLDOL5",178,0)\par
 ;. F  S LRN=$O(^LRO(69,LRODT,1,LRSN,2,LRN)) Q:LRN<1  D\par
"RTN","AHMLDOL5",179,0)\par
 ;. . I '$D(^LRO(69,LRODT,1,LRSN,2,LRN,1,0)) Q\par
"RTN","AHMLDOL5",180,0)\par
 ;. . D WP^DIE(63.05,IENS,.9,"A","^LRO(69,"_LRODT_",1,"_LRSN_",2,"_LRN_",1)","ERR")\par
"RTN","AHMLDOL5",181,0)\par
 ;\par
"RTN","AHMLDOL5",182,0)\par
 L -^LR(LRDFN,LRSS,LRIDT,0)\par
"RTN","AHMLDOL5",183,0)\par
 ;\par
"RTN","AHMLDOL5",184,0)\par
 Q\par
"RTN","AHMLDOL5",185,0)\par
 ;\par
"RTN","AHMLDOL5",186,0)\par
 ;\par
"RTN","AHMLDOL5",187,0)\par
GTWLN ;\par
"RTN","AHMLDOL5",188,0)\par
 N X\par
"RTN","AHMLDOL5",189,0)\par
 ;\par
"RTN","AHMLDOL5",190,0)\par
 ; Execute accession transform for this area.\par
"RTN","AHMLDOL5",191,0)\par
 S LRAN=0\par
"RTN","AHMLDOL5",192,0)\par
 S X=$G(^LRO(68,LRWLC,.1)) X:X'="" X\par
"RTN","AHMLDOL5",193,0)\par
 ;\par
"RTN","AHMLDOL5",194,0)\par
 D GETLOCK(LRWLC,LRAD)\par
"RTN","AHMLDOL5",195,0)\par
 D CHECK68(LRWLC,LRAD)\par
"RTN","AHMLDOL5",196,0)\par
 ;\par
"RTN","AHMLDOL5",197,0)\par
 S:'LRAN LRAN=1+$P($G(^LRO(68,LRWLC,1,LRAD,1,0)),U,3)\par
"RTN","AHMLDOL5",198,0)\par
 I "CYEMSP"'[LRSS F  Q:'$D(^LRO(68,LRWLC,1,LRAD,1,LRAN))  S LRAN=LRAN+1\par
"RTN","AHMLDOL5",199,0)\par
 ; check for AP Accessions\par
"RTN","AHMLDOL5",200,0)\par
 I "CYEMSP"[LRSS F  Q:'$D(^LRO(68,LRWLC,1,LRAD,1,LRAN))&'$D(^LR("A"_LRSS_"A",$E(LRAD,1,3),LRAN))  S LRAN=LRAN+1\par
"RTN","AHMLDOL5",201,0)\par
 D SETAN(LRWLC,LRAD,LRAN)\par
"RTN","AHMLDOL5",202,0)\par
 L -^LRO(68,LRWLC,1,LRAD,1,0)\par
"RTN","AHMLDOL5",203,0)\par
 Q\par
"RTN","AHMLDOL5",204,0)\par
 ;\par
"RTN","AHMLDOL5",205,0)\par
 ;\par
"RTN","AHMLDOL5",206,0)\par
CHECK68(LRAA,LRAD) ; Check for/set header node of ^LRO(68) 68.01 subfile.\par
"RTN","AHMLDOL5",207,0)\par
 ;\par
"RTN","AHMLDOL5",208,0)\par
 ; Call with LRAA = ien of entry in file #68\par
"RTN","AHMLDOL5",209,0)\par
 ;           LRAD = accession date in fileman format\par
"RTN","AHMLDOL5",210,0)\par
 ;\par
"RTN","AHMLDOL5",211,0)\par
 ; Set accession date in file #68 for this accession.\par
"RTN","AHMLDOL5",212,0)\par
 ; Check for existence of accession number multiple but not accession date multiple,\par
"RTN","AHMLDOL5",213,0)\par
 ; FileMan DBS call fails when accession number multiple exists but accession date multiple does not.\par
"RTN","AHMLDOL5",214,0)\par
 ; If this condition found then set missing node directly and quit.\par
"RTN","AHMLDOL5",215,0)\par
 ;\par
"RTN","AHMLDOL5",216,0)\par
 I '$D(^LRO(68,LRAA,1,LRAD,0)) D\par
"RTN","AHMLDOL5",217,0)\par
 . N LRFDA,LRFDAIEN,LRDIE,X\par
"RTN","AHMLDOL5",218,0)\par
 . S X=$Q(^LRO(68,LRAA,1,LRAD,0))\par
"RTN","AHMLDOL5",219,0)\par
 . I X'="",$QS(X,4)=LRAD S $P(^LRO(68,LRAA,1,LRAD,0),"^")=LRAD Q\par
"RTN","AHMLDOL5",220,0)\par
 . S (LRFDAIEN(1),LRFDA(1,68.01,"+1,"_LRAA_",",.01))=LRAD\par
"RTN","AHMLDOL5",221,0)\par
 . D UPDATE^DIE("","LRFDA(1)","LRFDAIEN","LRDIE(1)")\par
"RTN","AHMLDOL5",222,0)\par
 . I $D(LRDIE(1)) D MAILALRT^LRWLST12("CHECK~LRWLST1")\par
"RTN","AHMLDOL5",223,0)\par
 ;\par
"RTN","AHMLDOL5",224,0)\par
 Q\par
"RTN","AHMLDOL5",225,0)\par
 ;\par
"RTN","AHMLDOL5",226,0)\par
 ;\par
"RTN","AHMLDOL5",227,0)\par
GETLOCK(LRAA,LRAD) ; Obtain lock on zeroth node of this accession date\par
"RTN","AHMLDOL5",228,0)\par
 ; Call with LRAA = ien of entry in file #68\par
"RTN","AHMLDOL5",229,0)\par
 ;           LRAD = accession date in fileman format\par
"RTN","AHMLDOL5",230,0)\par
 ;\par
"RTN","AHMLDOL5",231,0)\par
 F  L +^LRO(68,LRAA,1,LRAD,1,0):10 Q:$T  D\par
"RTN","AHMLDOL5",232,0)\par
 . I $D(ZTQUEUED)!($G(LRQUIET)) Q\par
"RTN","AHMLDOL5",233,0)\par
 . W !!?5,"Accession area ",$P(^LRO(68,LRAA,0),"^")," is locked by another user.",!,$C(7)\par
"RTN","AHMLDOL5",234,0)\par
 Q\par
"RTN","AHMLDOL5",235,0)\par
 ;\par
"RTN","AHMLDOL5",236,0)\par
 ;\par
"RTN","AHMLDOL5",237,0)\par
SETAN(LRAA,LRAD,LRAN) ; Create stub entry in file #68 for this accession.\par
"RTN","AHMLDOL5",238,0)\par
 ;\par
"RTN","AHMLDOL5",239,0)\par
 ; Call with LRAA = ien of entry in file #68\par
"RTN","AHMLDOL5",240,0)\par
 ;           LRAD = accession date in fileman format\par
"RTN","AHMLDOL5",241,0)\par
 ;           LRAN = accession number\par
"RTN","AHMLDOL5",242,0)\par
 ;\par
"RTN","AHMLDOL5",243,0)\par
 N LR6802,LRFDA,LRFDAIEN,LRDIE,LRLOCKOK,LRLOOPCT\par
"RTN","AHMLDOL5",244,0)\par
 S LR6802=LRAD_","_LRAA_","\par
"RTN","AHMLDOL5",245,0)\par
 S LRFDAIEN(1)=LRAN\par
"RTN","AHMLDOL5",246,0)\par
 S LRFDA(2,68.02,"+1,"_LR6802,.01)=LRDFN\par
"RTN","AHMLDOL5",247,0)\par
 ;\par
"RTN","AHMLDOL5",248,0)\par
 ; Modification to prevent lock failures - loop 10 times to give system a chance to get lock\par
"RTN","AHMLDOL5",249,0)\par
 S LRLOCKOK=0\par
"RTN","AHMLDOL5",250,0)\par
 F LRLOOPCT=1:1:10 D  Q:LRLOCKOK\par
"RTN","AHMLDOL5",251,0)\par
 . D UPDATE^DIE("","LRFDA(2)","LRFDAIEN","LRDIE(2)")\par
"RTN","AHMLDOL5",252,0)\par
 . I $G(LRDIE(2,"DIERR")),LRDIE(2,"DIERR",1)<120  H 5 K:LRLOOPCT<10 LRDIE(2)\par
"RTN","AHMLDOL5",253,0)\par
 . E  S LRLOCKOK=1\par
"RTN","AHMLDOL5",254,0)\par
 ;\par
"RTN","AHMLDOL5",255,0)\par
 I $D(LRDIE(2)) D MAILALRT^LRWLST12("SET~LRWLST1")\par
"RTN","AHMLDOL5",256,0)\par
 Q\par
"RTN","AHMLDOL5",257,0)\par
 ;\par
"RTN","AHMLDOL5",258,0)\par
EXIT ;\par
"RTN","AHMLDOL5",259,0)\par
 K DFN,LR696,LRACC,LRALL,LRCAPLOC,LRCDT,LRDFN,LRDPF,LREND,LRID,LRIDT\par
"RTN","AHMLDOL5",260,0)\par
 K LRLBLBP,LRLLOC,LRNT,LRODT,LROLLOC,LRORDR,LRORDRR,LROT,LRPHSET\par
"RTN","AHMLDOL5",261,0)\par
 K LRPRAC,LRQUIET,LRSD,LRRSITE,LRRSTAT,LRSAMP,LRSPEC,LRSS,LRSN\par
"RTN","AHMLDOL5",262,0)\par
 K LRTREA,LRUID,LRUNQ,LRWLC,SSN,ZTQUEUED\par
"RTN","AHMLDOL5",263,0)\par
 Q\par
"RTN","AHMLDOL5",264,0)\par
 ;\par
"RTN","AHMLDOL6")\par
0^7^B111336362\par
"RTN","AHMLDOL6",1,0)\par
AHMLDOL6 ;LEIDOS/TCK Remote ordering Lab results ; 10/16/16 8:41pm\par
"RTN","AHMLDOL6",2,0)\par
 ;;1.0;Orders Portability;;March 1, 2010;Build 26\par
"RTN","AHMLDOL6",3,0)\par
 ;\par
"RTN","AHMLDOL6",4,0)\par
 ;2809 - check NTE.3 comments for HL7 encoded esc sequences and decode\par
"RTN","AHMLDOL6",5,0)\par
 Q\par
"RTN","AHMLDOL6",6,0)\par
 ;\par
"RTN","AHMLDOL6",7,0)\par
RSLT ; parse results message\par
"RTN","AHMLDOL6",8,0)\par
 ; Check user keys, site definition, etc...\par
"RTN","AHMLDOL6",9,0)\par
 K REC\par
"RTN","AHMLDOL6",10,0)\par
 N TSTARY,LRTST\par
"RTN","AHMLDOL6",11,0)\par
 D ^LRPARAM\par
"RTN","AHMLDOL6",12,0)\par
 S (LRAA,LRAD,LRAN,PNL)=0\par
"RTN","AHMLDOL6",13,0)\par
 S X=HLARY("ORC",1)\par
"RTN","AHMLDOL6",14,0)\par
 ; GET PROVIDER AND LAB TEST FROM OBR segment.  LRTS points to Lab Test file (60).\par
"RTN","AHMLDOL6",15,0)\par
 S LRPRV=$P($P(X,D1,12),D2)\par
"RTN","AHMLDOL6",16,0)\par
 S X=HLARY("OBR",1)\par
"RTN","AHMLDOL6",17,0)\par
 ;S LRTSPN=$P($P(X,D1,46),D2)\par
"RTN","AHMLDOL6",18,0)\par
 ;I LRTSPN'="" S LRTS=LRTSPN\par
"RTN","AHMLDOL6",19,0)\par
 S LRTST=$P(X,D1,4)\par
"RTN","AHMLDOL6",20,0)\par
 I LRTST["."!(LRTST'?.N) S LRTST=$P($P(X,D1,4),D2,4)\par
"RTN","AHMLDOL6",21,0)\par
 ; Get VERIFYING PERSON from OBX segment. 11/8/2012 DWA to resolve NCH00002638.\par
"RTN","AHMLDOL6",22,0)\par
 ;IF THE TEST IS A PANEL, LOOK FOR THE COMPONENT TEST IN OBX.\par
"RTN","AHMLDOL6",23,0)\par
 I $D(^LAB(60,LRTST,2,0)) S PNL=1\par
"RTN","AHMLDOL6",24,0)\par
 I PNL,$D(HLARY("OBX")) D\par
"RTN","AHMLDOL6",25,0)\par
 .S I="" F  S I=$O(HLARY("OBX",I)) Q:I=""  D\par
"RTN","AHMLDOL6",26,0)\par
 ..S X=HLARY("OBX",I)\par
"RTN","AHMLDOL6",27,0)\par
 ..S CMPTST=$P(X,D1,3)\par
"RTN","AHMLDOL6",28,0)\par
 ..I CMPTST["." S CMPTST=$P($P(X,D1,3),D2,4)\par
"RTN","AHMLDOL6",29,0)\par
 ..Q:$D(ARY(CMPTST))\par
"RTN","AHMLDOL6",30,0)\par
 ..S JVTECH=+$P($P(X,D1,15),D2)\par
"RTN","AHMLDOL6",31,0)\par
 ..Q:X["C4"\par
"RTN","AHMLDOL6",32,0)\par
 ..S ARY(CMPTST)=""\par
"RTN","AHMLDOL6",33,0)\par
 ..S TSTARY(I)=+CMPTST\par
"RTN","AHMLDOL6",34,0)\par
 K LTST,ARY\par
"RTN","AHMLDOL6",35,0)\par
 ;\par
"RTN","AHMLDOL6",36,0)\par
 ; Get order number from ORC-2.  ORDNM points to Orders file (100).\par
"RTN","AHMLDOL6",37,0)\par
 S X=HLARY("ORC",1),ORDNM=$P(X,D1,2),ORNUM=+ORDNM,LIEN=ORNUM_","\par
"RTN","AHMLDOL6",38,0)\par
 S LRDATA=$$GET1^DIQ(100,LIEN,33,"I")\par
"RTN","AHMLDOL6",39,0)\par
 S LRORD=$P(LRDATA,";"),LRODT=$P(LRDATA,";",2),LRSND=$P(LRDATA,";",3)\par
"RTN","AHMLDOL6",40,0)\par
 ; Get performing site number from ORC-13 and check if it is in the Institution file ^(DIC(4)\par
"RTN","AHMLDOL6",41,0)\par
 S RSITE=$P($G(X),D1,13) K X I RSITE="" S RSITE=0\par
"RTN","AHMLDOL6",42,0)\par
 I RSITE D\par
"RTN","AHMLDOL6",43,0)\par
 .S LRFILE=4,LRIEN=RSITE_",",SITE=$$GET1^DIQ(LRFILE,LRIEN,.01,"I")\par
"RTN","AHMLDOL6",44,0)\par
 .I SITE="" S RSITE=0\par
"RTN","AHMLDOL6",45,0)\par
 S X=HLARY("OBR",1)\par
"RTN","AHMLDOL6",46,0)\par
 ; Get accession number in OBR-20 and parse the segments\par
"RTN","AHMLDOL6",47,0)\par
 ;S JVTST=LTST\par
"RTN","AHMLDOL6",48,0)\par
 S LRACC=$$GETACC^AHMLDOL2(ORNUM,LRODT,LRORD,LRSND,LRTST)\par
"RTN","AHMLDOL6",49,0)\par
 I LRACC="" S JVOROUT(1)="-1^Error: Accession number not found" Q\par
"RTN","AHMLDOL6",50,0)\par
 S LRX=LRACC\par
"RTN","AHMLDOL6",51,0)\par
 ; Pieces: Lab type (e.g. CH), date, accession for date\par
"RTN","AHMLDOL6",52,0)\par
 S (X1,X2,X3)="",X1=$P(LRX," ",1),X2=$P(LRX," ",2),X3=$P(LRX," ",3)\par
"RTN","AHMLDOL6",53,0)\par
 S:X3=""&(+X2=X2) X3=X2,X2=""\par
"RTN","AHMLDOL6",54,0)\par
 ; LRAD (Accession date) formatted from X2\par
"RTN","AHMLDOL6",55,0)\par
 S %DT="EP",X=X2 D ^%DT S LRAD=Y\par
"RTN","AHMLDOL6",56,0)\par
 ; Build comments array from NTE segments (NTE-3)\par
"RTN","AHMLDOL6",57,0)\par
 I $D(HLARY("NTE")) D\par
"RTN","AHMLDOL6",58,0)\par
 .S N="" F  S N=$O(HLARY("NTE",N)) Q:N=""  D\par
"RTN","AHMLDOL6",59,0)\par
 ..S STOP=0\par
"RTN","AHMLDOL6",60,0)\par
 ..S X=$P(HLARY("NTE",N),"|",3)\par
"RTN","AHMLDOL6",61,0)\par
 ..I X["]" D\par
"RTN","AHMLDOL6",62,0)\par
 ...F I=1:1:STOP D\par
"RTN","AHMLDOL6",63,0)\par
 ....S Y=$P(X,"]",I)\par
"RTN","AHMLDOL6",64,0)\par
 ....I Y="" S STOP=1 Q\par
"RTN","AHMLDOL6",65,0)\par
 ....I Y'="" S LCMMT(I)=Y\par
"RTN","AHMLDOL6",66,0)\par
 ..I 'STOP S LCMMT(N)=X    ;2809 decode esc seq\par
"RTN","AHMLDOL6",67,0)\par
 S LRRDT=$$NOW^XLFDT,LRNOW=LRRDT,LRDCMP=LRRDT\par
"RTN","AHMLDOL6",68,0)\par
 ; Accession number relative to date\par
"RTN","AHMLDOL6",69,0)\par
 S LRAN=+X3\par
"RTN","AHMLDOL6",70,0)\par
 ; LRAA = internal value of accession area ^LRO(68,\par
"RTN","AHMLDOL6",71,0)\par
 S D="B",DIC="^LRO(68,",DIC(0)="D",X=X1 D IX^DIC\par
"RTN","AHMLDOL6",72,0)\par
 S LRAA=+Y\par
"RTN","AHMLDOL6",73,0)\par
 ; Lab type\par
"RTN","AHMLDOL6",74,0)\par
 S LRFILE=68,LRIEN=LRAA_","\par
"RTN","AHMLDOL6",75,0)\par
 S LRSS=$$GET1^DIQ(LRFILE,LRIEN,.02,"I")\par
"RTN","AHMLDOL6",76,0)\par
 ; LRDFN = Internal entry in LR( that is being worked on.\par
"RTN","AHMLDOL6",77,0)\par
 S LRFILE=68.02,LRIEN=LRAN_","_LRAD_","_LRAA_","\par
"RTN","AHMLDOL6",78,0)\par
 S LRDFN=$$GET1^DIQ(LRFILE,LRIEN,.01,"I")\par
"RTN","AHMLDOL6",79,0)\par
 ; Get collection Date/Time\par
"RTN","AHMLDOL6",80,0)\par
 S LRCDT=$$GET1^DIQ(LRFILE,LRIEN,9,"I")\par
"RTN","AHMLDOL6",81,0)\par
 ; Get UID number\par
"RTN","AHMLDOL6",82,0)\par
 S LRUID=$$GET1^DIQ(LRFILE,LRIEN,16,"I")\par
"RTN","AHMLDOL6",83,0)\par
 ; LRIDT = Inverse date/time that data is stored at. ^LR(LRDFN,"CH",\par
"RTN","AHMLDOL6",84,0)\par
 S LRIDT=$$GET1^DIQ(LRFILE,LRIEN,13.5,"I")\par
"RTN","AHMLDOL6",85,0)\par
 I LRIDT<1 S JVOROUT(1)="-1^Error: No Collection Date/Time found" Q\par
"RTN","AHMLDOL6",86,0)\par
 ; LRORD points to Orders file (100)\par
"RTN","AHMLDOL6",87,0)\par
 ; LRSN is specimen number, points to TOPOGRAPHY file (61)\par
"RTN","AHMLDOL6",88,0)\par
 S LRORD=$$GET1^DIQ(LRFILE,LRIEN,14,"I")\par
"RTN","AHMLDOL6",89,0)\par
 S:LRORD="" LRORD=0\par
"RTN","AHMLDOL6",90,0)\par
 ; LRODT = IEN of file (#\par
"RTN","AHMLDOL6",91,0)\par
 S LRODT=$$GET1^DIQ(LRFILE,LRIEN,3,"I")\par
"RTN","AHMLDOL6",92,0)\par
 S:'LRODT LRODT=$$GET1^DIQ(LRFILE,LRIEN,2,"I")\par
"RTN","AHMLDOL6",93,0)\par
 S LRSN=$$GET1^DIQ(LRFILE,LRIEN,4,"I")\par
"RTN","AHMLDOL6",94,0)\par
 ; Add technologist and date to Accession file now, index both. 11/8/2012 DWA changed out LRPRV for JVTECH since file calls for TECHNOLOGIST.  Part of resolution for NCH00002638\par
"RTN","AHMLDOL6",95,0)\par
 I $G(LRTST)>0,$D(^LRO(68,LRAA,1,LRAD,1,LRAN,4,"B",LRTST)) D\par
"RTN","AHMLDOL6",96,0)\par
 .S LRFILE=68.04,LRIEN=LRTST_","_LRAN_","_LRAD_","_LRAA_","\par
"RTN","AHMLDOL6",97,0)\par
 .S LRFDA(4,LRFILE,LRIEN,3)=$G(JVTECH)\par
"RTN","AHMLDOL6",98,0)\par
 .S LRFDA(4,LRFILE,LRIEN,4)=$G(LRAD)\par
"RTN","AHMLDOL6",99,0)\par
 .D UPDATE^DIE("","LRFDA(4)","LRIEN","LRMSG")\par
"RTN","AHMLDOL6",100,0)\par
 .;I $D(TSTARY(1)) S I="" F  S I=$O(TSTARY(I)) Q:I=""  D\par
"RTN","AHMLDOL6",101,0)\par
 .;S TEST=TSTARY(I)\par
"RTN","AHMLDOL6",102,0)\par
 .Q:'$D(^LRO(68,LRAA,1,LRAD,1,LRAN,4,"B",LRTST))\par
"RTN","AHMLDOL6",103,0)\par
 .;S LRFILE=68.04,LRIEN=LRTS_","_LRAN_","_LRAD_","_LRAA_","\par
"RTN","AHMLDOL6",104,0)\par
 .;S LRFDA(4,LRFILE,LRIEN,3)=$G(JVTECH)\par
"RTN","AHMLDOL6",105,0)\par
 .;S LRFDA(4,LRFILE,LRIEN,4)=$G(LRAD)\par
"RTN","AHMLDOL6",106,0)\par
 .D UPDATE^DIE("","LRFDA(4)","LRIENS","LRMSG")\par
"RTN","AHMLDOL6",107,0)\par
 S ^LRO(68,LRAA,1,LRAD,1,"AD",LRAD,+LRAN)="",^LRO(68,LRAA,1,LRAD,1,"AC",LRAD,+LRAN)=""\par
"RTN","AHMLDOL6",108,0)\par
 S LRVAL=LRTST\par
"RTN","AHMLDOL6",109,0)\par
 ; I test type is not Chemistry quit\par
"RTN","AHMLDOL6",110,0)\par
 I LRSS'="CH" D RSLT^AHMLDOL7(LRSS,LRAA,LRAD,LRAN) Q\par
"RTN","AHMLDOL6",111,0)\par
 ; Special case for Chem/Hem.\par
"RTN","AHMLDOL6",112,0)\par
 ; Get results from OBX segments\par
"RTN","AHMLDOL6",113,0)\par
 S N="" F  S N=$O(HLARY("OBX",N)) Q:N=""  D\par
"RTN","AHMLDOL6",114,0)\par
 .S X=HLARY("OBX",N)\par
"RTN","AHMLDOL6",115,0)\par
 .; LRTS is pointer to ^LAB(60), LRRSLT is the result, LRSB is subscript needed to file results.\par
"RTN","AHMLDOL6",116,0)\par
 .S TST=$P(X,D1,3)\par
"RTN","AHMLDOL6",117,0)\par
 .I TST["."!(TST'?.N) S TST=$P($P(X,D1,3),D2,4)\par
"RTN","AHMLDOL6",118,0)\par
 .S TARY(N)=TST,LRRSLT(N)=$P(X,D1,5)\par
"RTN","AHMLDOL6",119,0)\par
 .; Get DATA NAME from field 400 of file (#60)\par
"RTN","AHMLDOL6",120,0)\par
 .S LRFILE=60,LRIEN=TARY(N)_","\par
"RTN","AHMLDOL6",121,0)\par
 .S LRSB(N)=$$GET1^DIQ(LRFILE,LRIEN,400,"I")\par
"RTN","AHMLDOL6",122,0)\par
 .; Get High or Low flag\par
"RTN","AHMLDOL6",123,0)\par
 .S LRHL(N)=$P(X,D1,8)\par
"RTN","AHMLDOL6",124,0)\par
 .S FLG=LRHL(N)\par
"RTN","AHMLDOL6",125,0)\par
 .I FLG["H"&(FLG["*") S YYY=3\par
"RTN","AHMLDOL6",126,0)\par
 .I FLG["L"&(FLG["*") S YYY=3\par
"RTN","AHMLDOL6",127,0)\par
 .I FLG["H"&(FLG'["*") S YYY=2\par
"RTN","AHMLDOL6",128,0)\par
 .I FLG["L"&(FLG'["*") S YYY=2\par
"RTN","AHMLDOL6",129,0)\par
 .I FLG'["H"&(FLG'["L") S YYY=1\par
"RTN","AHMLDOL6",130,0)\par
 .; Get units of measurement and result range from message\par
"RTN","AHMLDOL6",131,0)\par
 .S LRUNTS(N)=$P(X,D1,6),LRRNGE(N)=$P(X,D1,7)\par
"RTN","AHMLDOL6",132,0)\par
 .; Set location from RSITE variable\par
"RTN","AHMLDOL6",133,0)\par
 .S LRLOC=$G(RSITE)\par
"RTN","AHMLDOL6",134,0)\par
 .; Get result status\par
"RTN","AHMLDOL6",135,0)\par
 .S LRSTS=$P(X,D1,11)\par
"RTN","AHMLDOL6",136,0)\par
 ; Check for entry in Lab Data file (#63) using reverse date.\par
"RTN","AHMLDOL6",137,0)\par
 S LRFILE=63.04,LRIEN=LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL6",138,0)\par
 I '$$GET1^DIQ(LRFILE,LRIEN,.01,"I") S JVOROUT(1)="-1^Error: No Data file found" Q\par
"RTN","AHMLDOL6",139,0)\par
 ; Get specimen type from file Lab Data file, (#63)\par
"RTN","AHMLDOL6",140,0)\par
 S LRSPT(1)=$$GET1^DIQ(LRFILE,LRIEN,.05,"I")\par
"RTN","AHMLDOL6",141,0)\par
 S LRFILE=69.01,LRIEN=LRSN_","_LRODT_","\par
"RTN","AHMLDOL6",142,0)\par
 I $$GET1^DIQ(LRFILE,LRIEN,.01,"I"),'$$GET1^DIQ(LRFILE,LRIEN,10,"I") S JVOROUT(1)="This order has not been collected." Q\par
"RTN","AHMLDOL6",143,0)\par
 S COLST=$$GET1^DIQ(LRFILE,LRIEN,13,"I")\par
"RTN","AHMLDOL6",144,0)\par
 I COLST'="C" S JVOROUT(1)="-1^Error^You cannot verify an accession which has not been collected." Q\par
"RTN","AHMLDOL6",145,0)\par
 Q:$D(JVOROUT)\par
"RTN","AHMLDOL6",146,0)\par
 ;\par
"RTN","AHMLDOL6",147,0)\par
CH ;\par
"RTN","AHMLDOL6",148,0)\par
 N N,XDATA,X5\par
"RTN","AHMLDOL6",149,0)\par
 S LRFILE=63.04,LRIEN=LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL6",150,0)\par
 S LRFDA(LRFILE,LRIEN,.03)=$G(LRRDT)\par
"RTN","AHMLDOL6",151,0)\par
 S LRFDA(LRFILE,LRIEN,.04)=$G(JVTECH)\par
"RTN","AHMLDOL6",152,0)\par
 ; File Lab result in Chemistry file (63.04), using info in XDATA.\par
"RTN","AHMLDOL6",153,0)\par
 D FILE^DIE("","LRFDA") K LRFDA,LRIEN,LRFILE,LRMSG,LRIENS\par
"RTN","AHMLDOL6",154,0)\par
 S N="" F  S N=$O(TARY(N)) Q:N=""  D\par
"RTN","AHMLDOL6",155,0)\par
 .S $P(XDATA,"^",1)=LRRSLT(N)\par
"RTN","AHMLDOL6",156,0)\par
 .S $P(XDATA,"^",2)=LRHL(N)\par
"RTN","AHMLDOL6",157,0)\par
 . ; Need to pull Workload code from Lab Results file, since CHCS doesn't provide.\par
"RTN","AHMLDOL6",158,0)\par
 . ;Code fix for DJE-NCHICAGO-2790\par
"RTN","AHMLDOL6",159,0)\par
 .S $P(XDATA,"^",3)=$P($G(^LR(LRDFN,LRSS,LRIDT,"ORUT",1,0)),D2,1)_"!!!!!!"_TARY(N)\par
"RTN","AHMLDOL6",160,0)\par
 .; Old code S $P(XDATA,"^",3)=$G(^LR(LRDFN,LRSS,LRIDT,"ORUT",1,0))_"!"_TSTARY(N)\par
"RTN","AHMLDOL6",161,0)\par
 .S $P(XDATA,"^",4)=$G(JVTECH)\par
"RTN","AHMLDOL6",162,0)\par
 .S $P(XDATA,"^",9)=LRLOC\par
"RTN","AHMLDOL6",163,0)\par
 .S $P(XDATA,"^",10)=1\par
"RTN","AHMLDOL6",164,0)\par
 .S $P(XDATA,"^",13)=1\par
"RTN","AHMLDOL6",165,0)\par
 .S X5=$G(LRSPT(1)),LRSPEC=X5\par
"RTN","AHMLDOL6",166,0)\par
 .S LRFILE=60.01,LRIEN=LRSPEC_","_TARY(N)_","\par
"RTN","AHMLDOL6",167,0)\par
 .S S=$$GET1^DIQ(LRFILE,LRIEN,.01,"I")\par
"RTN","AHMLDOL6",168,0)\par
 .S S1=$$GET1^DIQ(LRFILE,LRIEN,1,"I")\par
"RTN","AHMLDOL6",169,0)\par
 .S S2=$$GET1^DIQ(LRFILE,LRIEN,2,"I")\par
"RTN","AHMLDOL6",170,0)\par
 .S S3=$$GET1^DIQ(LRFILE,LRIEN,3,"I")\par
"RTN","AHMLDOL6",171,0)\par
 .S S4=$$GET1^DIQ(LRFILE,LRIEN,4,"I")\par
"RTN","AHMLDOL6",172,0)\par
 .S S5="",S6=$$GET1^DIQ(LRFILE,LRIEN,6,"I")\par
"RTN","AHMLDOL6",173,0)\par
 .S $P(X5,D2)=S_"^"_S1_"^"_S2_"^"_S3_"^"_S4_"^"_S5_"^"_S6\par
"RTN","AHMLDOL6",174,0)\par
 .S $P(X5,D2,2)=$P(LRRNGE(N),"-"),$P(X5,D2,3)=$P(LRRNGE(N),"-",2),$P(X5,D2,7)=LRUNTS(N)\par
"RTN","AHMLDOL6",175,0)\par
 .I $P($G(X5),D2,8)="" S X5=X5_"^"\par
"RTN","AHMLDOL6",176,0)\par
 .S X5=$TR(X5,"^","!")\par
"RTN","AHMLDOL6",177,0)\par
 .S $P(XDATA,"^",5)=X5\par
"RTN","AHMLDOL6",178,0)\par
 .; Stuff data into Lab data file\par
"RTN","AHMLDOL6",179,0)\par
 .S ^LR(LRDFN,LRSS,LRIDT,LRSB(N))=XDATA\par
"RTN","AHMLDOL6",180,0)\par
 .K XDATA ;Kill XDATA to be ready for component tests. DWA-NCHICAGO-2790\par
"RTN","AHMLDOL6",181,0)\par
 N CHECK S CHECK=0\par
"RTN","AHMLDOL6",182,0)\par
 D CHKRSLT(LRDFN,LRSS,LRIDT,.CHECK)\par
"RTN","AHMLDOL6",183,0)\par
 I $D(LCMMT) D\par
"RTN","AHMLDOL6",184,0)\par
 .K LRFDA\par
"RTN","AHMLDOL6",185,0)\par
 .I 'CHECK D CMARY(.LCMMT)\par
"RTN","AHMLDOL6",186,0)\par
 .N LRFILE,LRFDA,LRIEN\par
"RTN","AHMLDOL6",187,0)\par
 .S N="" F  S N=$O(LCMMT(N)) Q:N=""  D\par
"RTN","AHMLDOL6",188,0)\par
 ..S TXT=LCMMT(N)\par
"RTN","AHMLDOL6",189,0)\par
 ..S LRIENS=N_","_LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL6",190,0)\par
 ..S TX=$$GET1^DIQ(63.041,LRIENS,.01,"E")\par
"RTN","AHMLDOL6",191,0)\par
 ..Q:TX=TXT\par
"RTN","AHMLDOL6",192,0)\par
 ..K LRFDA\par
"RTN","AHMLDOL6",193,0)\par
 ..S LRFILE=63.041,LRIEN="+"_N_","_LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL6",194,0)\par
 ..S LRFDA(1,LRFILE,LRIEN,.01)=$G(LCMMT(N))\par
"RTN","AHMLDOL6",195,0)\par
 ..D UPDATE^DIE("","LRFDA(1)","LRIENS","LRERR(2)")\par
"RTN","AHMLDOL6",196,0)\par
 ;SEND ALERT TO CPRS\par
"RTN","AHMLDOL6",197,0)\par
 I $G(YYY)>0 D SNDALRT(LRDFN,LRSS,LRIDT,LRUID,LRTST,YYY)\par
"RTN","AHMLDOL6",198,0)\par
 S STA=2\par
"RTN","AHMLDOL6",199,0)\par
 S LRNOW=$$NOW^XLFDT\par
"RTN","AHMLDOL6",200,0)\par
 ; Get Date/Time ordered from field 5 of Lab order entry file, (#69).\par
"RTN","AHMLDOL6",201,0)\par
 S LRFILE=69.01,LRIEN=LRSN_","_LRODT_","\par
"RTN","AHMLDOL6",202,0)\par
 S LRDTO=$$GET1^DIQ(LRFILE,LRIEN,5,"I")\par
"RTN","AHMLDOL6",203,0)\par
 S LRFDA(3,LRFILE,LRIEN,20)=LRDTO\par
"RTN","AHMLDOL6",204,0)\par
 S LRFDA(3,LRFILE,LRIEN,21)=LRNOW\par
"RTN","AHMLDOL6",205,0)\par
 D UPDATE^DIE("","LRFDA(3)","LRIENS","LRMSG")\par
"RTN","AHMLDOL6",206,0)\par
 S LRFILE=68.02,LRIEN=LRAN_","_LRAD_","_LRAA_","\par
"RTN","AHMLDOL6",207,0)\par
 I '$$GET1^DIQ(LRFILE,LRIEN,12,"I") D\par
"RTN","AHMLDOL6",208,0)\par
 .S LRFDA(3,LRFILE,LRIEN,12)=$G(LRNOW)\par
"RTN","AHMLDOL6",209,0)\par
 S LRFDA(3,LRFILE,LRIEN,13)=$$NOW^XLFDT\par
"RTN","AHMLDOL6",210,0)\par
 D UPDATE^DIE("","LRFDA(3)","LRIENS","LRMSG")\par
"RTN","AHMLDOL6",211,0)\par
 S LRFILE=68.02,LRIEN=LRAN_","_LRAD_","_LRAA_","\par
"RTN","AHMLDOL6",212,0)\par
 S LRDFN=$$GET1^DIQ(LRFILE,LRIEN,.01,"I")\par
"RTN","AHMLDOL6",213,0)\par
 ; This node does not exist on .237 but does on Silver\par
"RTN","AHMLDOL6",214,0)\par
 S ^LR(LRDFN,"CH",LRIDT,"RF")=$P(^LRO(68,LRAA,1,LRAD,1,LRAN,.3),D2,2)\par
"RTN","AHMLDOL6",215,0)\par
 S ^LR(LRDFN,"CH",LRIDT,"ORU")=^LRO(68,LRAA,1,LRAD,1,LRAN,.3)\par
"RTN","AHMLDOL6",216,0)\par
 S LRFILE=100,LRIEN=ORNUM_","\par
"RTN","AHMLDOL6",217,0)\par
 ;S DATA=$$GET1^DIQ(LRFILE,LRIEN,33,"I")\par
"RTN","AHMLDOL6",218,0)\par
 I LRDATA'[LRSS D\par
"RTN","AHMLDOL6",219,0)\par
 .S LRFDA(4,LRFILE,LRIEN,33)=LRDATA_";"_LRSS_";"_LRIDT\par
"RTN","AHMLDOL6",220,0)\par
 .D UPDATE^DIE("","LRFDA(4)","LRIENS","LRMSG")\par
"RTN","AHMLDOL6",221,0)\par
 ; Set Order file (#100), field (#22) to LRNOW and field (#5) to "COMPLETED" \par
"RTN","AHMLDOL6",222,0)\par
 S DIE="^OR(100,",DA=ORNUM,ST=2,DR="22////"_LRNOW_";5////"_ST_";" D ^DIE K DIE,DA\par
"RTN","AHMLDOL6",223,0)\par
 S JVOROUT(1)=ORNUM_"^RS"\par
"RTN","AHMLDOL6",224,0)\par
 D END\par
"RTN","AHMLDOL6",225,0)\par
 Q\par
"RTN","AHMLDOL6",226,0)\par
 ;\par
"RTN","AHMLDOL6",227,0)\par
SNDALRT(LRDFN,LRSS,LRIDT,LRUID,LRTST,YYY) ;SEND ALERTS TO CPRS\par
"RTN","AHMLDOL6",228,0)\par
 ;  Call with LRDFN = file #63 IEN\par
"RTN","AHMLDOL6",229,0)\par
 ;             LRSS = file #63 subscript\par
"RTN","AHMLDOL6",230,0)\par
 ;            LRIDT = inverse d/t of entry in file #63\par
"RTN","AHMLDOL6",231,0)\par
 ;            LRUID = accession's UID\par
"RTN","AHMLDOL6",232,0)\par
 ;\par
"RTN","AHMLDOL6",233,0)\par
 ; Only supports CH and MI. AP subscript handled by separate API.\par
"RTN","AHMLDOL6",234,0)\par
 ;\par
"RTN","AHMLDOL6",235,0)\par
 N DFN,DIC,DIR,DIRUT,DTOUT,DUOUT,LRC,LRDOCS,LRMORE,LRQUIT,LRTST,LRTYPE,LRX,LRXQA,LRY,X,Y\par
"RTN","AHMLDOL6",236,0)\par
 ;\par
"RTN","AHMLDOL6",237,0)\par
 S (LRTYPE,LRXQA,LRY,CTR)=""\par
"RTN","AHMLDOL6",238,0)\par
 ;\par
"RTN","AHMLDOL6",239,0)\par
 ; Select test to alert\par
"RTN","AHMLDOL6",240,0)\par
 S LRTST=$G(TST)\par
"RTN","AHMLDOL6",241,0)\par
 S TSTNM=$$GET1^DIQ(60,TST,.01,"E")\par
"RTN","AHMLDOL6",242,0)\par
 S LRTST=LRTST_"^"_TSTNM_"^"_LRTST\par
"RTN","AHMLDOL6",243,0)\par
 S CTR=$G(CTR)+1,LRTYPE(1)=3\par
"RTN","AHMLDOL6",244,0)\par
 I YYY=1 S LRTYPE(CTR)=3\par
"RTN","AHMLDOL6",245,0)\par
 I YYY>1 D\par
"RTN","AHMLDOL6",246,0)\par
 .F I="ACT","IN" D\par
"RTN","AHMLDOL6",247,0)\par
 ..I I="ACT" D\par
"RTN","AHMLDOL6",248,0)\par
 ...S CTR=$G(CTR)+1\par
"RTN","AHMLDOL6",249,0)\par
 ...I YYY=2 S LRTYPE(CTR)=14\par
"RTN","AHMLDOL6",250,0)\par
 ...I YYY=3 S LRTYPE(CTR)=57\par
"RTN","AHMLDOL6",251,0)\par
 ..I I="IN" D\par
"RTN","AHMLDOL6",252,0)\par
 ...S CTR=$G(CTR)+1\par
"RTN","AHMLDOL6",253,0)\par
 ...I YYY=2 S LRTYPE(CTR)=24\par
"RTN","AHMLDOL6",254,0)\par
 ...I YYY=3 S LRYTPE(CTR)=58\par
"RTN","AHMLDOL6",255,0)\par
 Q:'$D(LRTYPE)\par
"RTN","AHMLDOL6",256,0)\par
 S CT="" F  S CT=$O(LRTYPE(CT)) Q:CT=""  D\par
"RTN","AHMLDOL6",257,0)\par
 .Q:XX=""\par
"RTN","AHMLDOL6",258,0)\par
 .S LRTYPE=LRTYPE(CT)\par
"RTN","AHMLDOL6",259,0)\par
 .D GETDOCS^LR7ORB3(.LRDOCS,LRDFN,LRSS,LRIDT)\par
"RTN","AHMLDOL6",260,0)\par
 .S (LRC,LRXQA)=0\par
"RTN","AHMLDOL6",261,0)\par
 .S LRC=1,LRDUZ=$P(LRDOCS(LRC),"^")\par
"RTN","AHMLDOL6",262,0)\par
 .S LRXQA(LRDUZ)=$P(LRDOCS(LRC),"^",3)\par
"RTN","AHMLDOL6",263,0)\par
 .S LRY=$$OR^LR7ORB3(LRTYPE,LRDFN,LRSS,LRIDT,LRUID,.LRXQA,LRTST)\par
"RTN","AHMLDOL6",264,0)\par
 Q\par
"RTN","AHMLDOL6",265,0)\par
 ;\par
"RTN","AHMLDOL6",266,0)\par
CMARY(ARY) ;\par
"RTN","AHMLDOL6",267,0)\par
 N Y,X\par
"RTN","AHMLDOL6",268,0)\par
 ;"AMENDED COMMENT" not required for the RESULT COMMENT(S) section.\par
"RTN","AHMLDOL6",269,0)\par
 S AFLG=0\par
"RTN","AHMLDOL6",270,0)\par
 ;\par
"RTN","AHMLDOL6",271,0)\par
 S X="" F  S X=$O(ARY(X)) Q:X=""  D\par
"RTN","AHMLDOL6",272,0)\par
 .;check for Result Comment in current array\par
"RTN","AHMLDOL6",273,0)\par
 .Q:AFLG=1\par
"RTN","AHMLDOL6",274,0)\par
 .I ARY(X)["RESULT COMMENT(S)" S AFLG=1 Q\par
"RTN","AHMLDOL6",275,0)\par
 .S Y=X+1,NARY(Y)=ARY(X)\par
"RTN","AHMLDOL6",276,0)\par
 .K ARY(X)\par
"RTN","AHMLDOL6",277,0)\par
 ;for results - amended comment not required.\par
"RTN","AHMLDOL6",278,0)\par
 I AFLG K NARY Q\par
"RTN","AHMLDOL6",279,0)\par
 ;for other amended comments\par
"RTN","AHMLDOL6",280,0)\par
 ;S NARY(1)="AMENDED COMMENT"\par
"RTN","AHMLDOL6",281,0)\par
 ;\par
"RTN","AHMLDOL6",282,0)\par
 M ARY=NARY K NARY\par
"RTN","AHMLDOL6",283,0)\par
 Q\par
"RTN","AHMLDOL6",284,0)\par
 ;\par
"RTN","AHMLDOL6",285,0)\par
CHKRSLT(LRDFN,LRSS,LRIDT,ANS) ;\par
"RTN","AHMLDOL6",286,0)\par
 S ANS=0\par
"RTN","AHMLDOL6",287,0)\par
 S L="" F  S L=$O(^LR(LRDFN,LRSS,LRIDT,L)) Q:L=""  D\par
"RTN","AHMLDOL6",288,0)\par
 .M XX=^LR(LRDFN,LRSS,LRIDT,L) I XX["!" S ANS=1\par
"RTN","AHMLDOL6",289,0)\par
 Q ANS\par
"RTN","AHMLDOL6",290,0)\par
 ;\par
"RTN","AHMLDOL6",291,0)\par
 ;\par
"RTN","AHMLDOL6",292,0)\par
GETIEN(R,ORD,JVWRKLD) ;\par
"RTN","AHMLDOL6",293,0)\par
 N JVDATA,JVDT,JVRN,TST,JVTST\par
"RTN","AHMLDOL6",294,0)\par
 S (JVDATA,JVDT,JVRN,TST,JVTST)="",R=0\par
"RTN","AHMLDOL6",295,0)\par
 I '$D(^OR(100,ORD)) S R="" Q\par
"RTN","AHMLDOL6",296,0)\par
 S JVDATA=^OR(100,ORD,4)\par
"RTN","AHMLDOL6",297,0)\par
 S JVDT=$P(JVDATA,";",2)\par
"RTN","AHMLDOL6",298,0)\par
 S JVRN=$P(JVDATA,";",3)\par
"RTN","AHMLDOL6",299,0)\par
 I '$D(^LRO(69,JVDT,1,JVRN)) S R="" Q\par
"RTN","AHMLDOL6",300,0)\par
 S TST="" F  S TST=$O(^LRO(69,JVDT,1,JVRN,2,"B",TST)) Q:TST=""  D  Q:R=""\par
"RTN","AHMLDOL6",301,0)\par
 .S JVTARY(TST)=TST\par
"RTN","AHMLDOL6",302,0)\par
 I '$D(JVTARY) S R="" Q\par
"RTN","AHMLDOL6",303,0)\par
 I '$D(^LAM("E",JVWRKLD)) S R="" Q\par
"RTN","AHMLDOL6",304,0)\par
 S JVWRKIEN="",JVWRKIEN=$O(^LAM("E",JVWRKLD,JVWRKIEN))\par
"RTN","AHMLDOL6",305,0)\par
 I JVWRKIEN="" S R="" Q\par
"RTN","AHMLDOL6",306,0)\par
 F  S JVTST=$O(JVTARY(JVTST)) Q:JVTST=""  D  Q:R=""\par
"RTN","AHMLDOL6",307,0)\par
 .S TEST=JVTST_";LAB(60,"\par
"RTN","AHMLDOL6",308,0)\par
 .I $D(^LAM(JVWRKIEN,7,"B",TEST)) S R=JVTST Q\par
"RTN","AHMLDOL6",309,0)\par
 Q\par
"RTN","AHMLDOL6",310,0)\par
 ;\par
"RTN","AHMLDOL6",311,0)\par
END ;\par
"RTN","AHMLDOL6",312,0)\par
 K ARY,TARY,LRTST,TSTARY,LRTST,REC,HLARY\par
"RTN","AHMLDOL6",313,0)\par
 K %DT,ANS,CHECK,AGE,COLST,CTR,D1,D2,D,DATA,DIC,DFN,DOB,DR,FLAG,HLARY,L,LRAA,LRAD,LRAN,LRBGO,JVTECH\par
"RTN","AHMLDOL6",314,0)\par
 K LRCCMT,LCMMT,LRDPF,LRDTOLREND,LRFIND,LRCW,LRBGO,LRBG0,LRCCMT,LRCDT,LRDCMP,LRDFN\par
"RTN","AHMLDOL6",315,0)\par
 K LRDTO,LREN,LRNOW,LRFINO,LRFINO,LRHL,LRI,LRIDT,LRLOC,LRNDISP,LRNG2,LRNG3,LRNG4,LRNG5\par
"RTN","AHMLDOL6",316,0)\par
 K LRNOW,LRODT,LRORD,LRPANEL,LRRDT,LRRNGE,LRPANEL,LRPRV,LRRSLT,LRSB,LRS,LRSN,LRSPEC\par
"RTN","AHMLDOL6",317,0)\par
 K LRSPT,LRTM60,LRSS,LRTS,LRSTS,LRUNDO,LRUID,LRUNTS,LRVAL,LRX,MSH,NUM\par
"RTN","AHMLDOL6",318,0)\par
 K ORDNM,ORNUM,OBR,OBX,REC,RSITE,S,S1,S2,S3,S4,S5,S6,SEX,SITE,ST,STA,TOT,TYPE,VA,XX,X1,X2,X3,XDATA,Y\par
"RTN","AHMLDOL6",319,0)\par
 Q\par
"RTN","AHMLDOL6",320,0)\par
 ;\par
"RTN","AHMLDOL7")\par
0^8^B289743908\par
"RTN","AHMLDOL7",1,0)\par
AHMLDOL7 ;SAIC/TCK- Orders Portability - Laboratory Results - Filer ; 10/16/16 8:32pm\par
"RTN","AHMLDOL7",2,0)\par
 ;;1.0;Orders Portability;;March 1, 2010;Build 26\par
"RTN","AHMLDOL7",3,0)\par
 ;\par
"RTN","AHMLDOL7",4,0)\par
 Q\par
"RTN","AHMLDOL7",5,0)\par
RSLT(LRSS,LRAA,LRAD,LRAN) ;  file results\par
"RTN","AHMLDOL7",6,0)\par
 I '$D(LRSS) S JVOROUT(1)="-1^Error: Order was not succesfully accessioned." Q\par
"RTN","AHMLDOL7",7,0)\par
 I LRSS="MI" D MI(LRAA,LRAD,LRAN) G EXIT\par
"RTN","AHMLDOL7",8,0)\par
 Q\par
"RTN","AHMLDOL7",9,0)\par
 ;\par
"RTN","AHMLDOL7",10,0)\par
MI(LRAA,LRAD,LRAN) ;  file microbiology reports\par
"RTN","AHMLDOL7",11,0)\par
 S LRCMT="",LRI=1\par
"RTN","AHMLDOL7",12,0)\par
 S LR6207(23)="",LROK=0 ; rhl  LR6207 is an array of LAB(62.07 entries that have been implmmented\par
"RTN","AHMLDOL7",13,0)\par
 ; LRDFN = Internal entry in LR( that is being worked on.\par
"RTN","AHMLDOL7",14,0)\par
 S LRFILE=68.02,LRIEN=LRAN_","_LRAD_","_LRAA_","\par
"RTN","AHMLDOL7",15,0)\par
 S LRDFN=$$GET1^DIQ(LRFILE,LRIEN,.01,"I")\par
"RTN","AHMLDOL7",16,0)\par
 S LRIDT=$$GET1^DIQ(LRFILE,LRIEN,13.5,"I")\par
"RTN","AHMLDOL7",17,0)\par
 S LRCDT=$$GET1^DIQ(LRFILE,LRIEN,9,"I")\par
"RTN","AHMLDOL7",18,0)\par
 S LRFILE=63.05,LRIEN=LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",19,0)\par
 I '$$GET1^DIQ(LRFILE,LRIEN,.01,"I") S JVOROUT(1)="-1^Error: No entry in file (#63) for this patient" Q\par
"RTN","AHMLDOL7",20,0)\par
 ; Pick up specimen\par
"RTN","AHMLDOL7",21,0)\par
 S LRFILE=68.05,LRSPEC=$$GET1^DIQ(LRFILE,LRIEN,.01,"I")\par
"RTN","AHMLDOL7",22,0)\par
 S LRCMT=""\par
"RTN","AHMLDOL7",23,0)\par
 S X=HLARY("ORC",1),RSITE=$P($G(X),D1,13) K X\par
"RTN","AHMLDOL7",24,0)\par
 I RSITE="" S RSITE=0\par
"RTN","AHMLDOL7",25,0)\par
 I RSITE D\par
"RTN","AHMLDOL7",26,0)\par
 .S LRFILE=4,LRIEN=RSITE_",",SITE=$$GET1^DIQ(LRFILE,LRIEN,.01,"I")\par
"RTN","AHMLDOL7",27,0)\par
 .I SITE="" S RSITE=0\par
"RTN","AHMLDOL7",28,0)\par
 S X=HLARY("OBR",1),LRTS=$P($P(X,D1,4),D2)\par
"RTN","AHMLDOL7",29,0)\par
 S LRTSPN=$P($P(X,D1,46),D2)\par
"RTN","AHMLDOL7",30,0)\par
 I LRTSPN'="" S LRTS=LRTSPN\par
"RTN","AHMLDOL7",31,0)\par
 I LRTSPN="" S LRTS=$P($P(X,D1,4),D2)\par
"RTN","AHMLDOL7",32,0)\par
 S LRFILE=68.04,LRIEN=LRTS_","_LRAN_","_LRAD_","_LRAA_","\par
"RTN","AHMLDOL7",33,0)\par
 I '$$GET1^DIQ(LRFILE,LRIEN,.01,"I") S JVOROUT(1)="-1^Error: No tests associated with this accession" Q\par
"RTN","AHMLDOL7",34,0)\par
 S Y=$$NOW^XLFDT\par
"RTN","AHMLDOL7",35,0)\par
 ; Update Accession file with technologist ID and timestamp\par
"RTN","AHMLDOL7",36,0)\par
 S LRFILE=68.04,LRIEN=LRTS_","_LRAN_","_LRAD_","_LRAA_","\par
"RTN","AHMLDOL7",37,0)\par
 S LRFDA(4,LRFILE,LRIEN,3)=$G(JVTECH)\par
"RTN","AHMLDOL7",38,0)\par
 S LRFDA(4,LRFILE,LRIEN,4)=$G(Y)\par
"RTN","AHMLDOL7",39,0)\par
 D UPDATE^DIE("","LRFDA(4)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",40,0)\par
 S ^LRO(68,LRAA,1,LRAD,1,"AD",$P(Y,"."),+LRAN)="",^LRO(68,LRAA,1,LRAD,1,"AC",Y,+LRAN)=""\par
"RTN","AHMLDOL7",41,0)\par
 ; Get Edit Code from Lab Test file (Bacteriology, Mycology, etc.)\par
"RTN","AHMLDOL7",42,0)\par
 S LRFILE=60,LRIEN=LRTS_",",EXEC=$$GET1^DIQ(LRFILE,LRIEN,98,"I")\par
"RTN","AHMLDOL7",43,0)\par
 I 'EXEC S JVOROUT(1)="-1^Error: Lab test is not configured correctly" Q\par
"RTN","AHMLDOL7",44,0)\par
 ; Normalize the value.\par
"RTN","AHMLDOL7",45,0)\par
 D GETEXEC^JVHLLR3(.EXEC)\par
"RTN","AHMLDOL7",46,0)\par
 I EXEC D\par
"RTN","AHMLDOL7",47,0)\par
 .; Get the executable file numbers from the EXECUTE FILE, (#62.07)\par
"RTN","AHMLDOL7",48,0)\par
 .S LRFILE=62.07,LRIEN=EXEC_",",LRTX(LRI)=$$GET1^DIQ(LRFILE,LRIEN,1,"I")\par
"RTN","AHMLDOL7",49,0)\par
 .; Set the file node using the LRTX(LRI)\par
"RTN","AHMLDOL7",50,0)\par
 .S LRSB=$S(LRTX(LRI)["11.5":1,LRTX(LRI)["23":11,LRTX(LRI)["19":8,LRTX(LRI)["15":5,LRTX(LRI)["34":16,1:"")\par
"RTN","AHMLDOL7",51,0)\par
 .D @("MI"_EXEC) ; RHL 20100809\par
"RTN","AHMLDOL7",52,0)\par
 I LROK=0 S JVOROUT(1)="-1^UNSUCESSFUL MICROBIOLOGY RESULTS SAVE"\par
"RTN","AHMLDOL7",53,0)\par
 I LROK=1 D\par
"RTN","AHMLDOL7",54,0)\par
 .S TIM=$$NOW^XLFDT\par
"RTN","AHMLDOL7",55,0)\par
 .S LRFILE=100,LRIEN=ORDNM_",",LRD=$$GET1^DIQ(LRFILE,LRIEN,33,"I")\par
"RTN","AHMLDOL7",56,0)\par
 .S LRORD=$P($G(LRD),";"),LRODT=$P($G(LRD),";",2),LRSN=$P($G(LRD),";",3)\par
"RTN","AHMLDOL7",57,0)\par
 .S LRFILE=69.01,LRIEN=LRSN_","_LRODT_","\par
"RTN","AHMLDOL7",58,0)\par
 .S LRFDA(3,LRFILE,LRIEN,20)=$G(TIM)\par
"RTN","AHMLDOL7",59,0)\par
 .S LRFDA(3,LRFILE,LRIEN,21)=$$NOW^XLFDT\par
"RTN","AHMLDOL7",60,0)\par
 .D UPDATE^DIE("","LRFDA(3)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",61,0)\par
 .S LRFILE=68.02,LRIEN=LRAN_","_LRAD_","_LRAA_","\par
"RTN","AHMLDOL7",62,0)\par
 .S LRSITE=$$GET1^DIQ(LRFILE,LRIEN,16.1,"I")\par
"RTN","AHMLDOL7",63,0)\par
 .S LRDFN=$$GET1^DIQ(LRFILE,LRIEN,.01,"I")\par
"RTN","AHMLDOL7",64,0)\par
 .S X=$$GET1^DIQ(LRFILE,LRIEN,12,"I")\par
"RTN","AHMLDOL7",65,0)\par
 .I X="" S LRFDA(3,LRFILE,LRIEN,12)=$G(TIM)\par
"RTN","AHMLDOL7",66,0)\par
 .S LRFDA(3,LRFILE,LRIEN,13)=$$NOW^XLFDT\par
"RTN","AHMLDOL7",67,0)\par
 .D UPDATE^DIE("","LRFDA(3)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",68,0)\par
 .S ^LR(LRDFN,"MI",LRIDT,"RF")=LRSITE\par
"RTN","AHMLDOL7",69,0)\par
 .S ^LR(LRDFN,"MI",LRIDT,"ORU")=^LRO(68,LRAA,1,LRAD,1,LRAN,.3)\par
"RTN","AHMLDOL7",70,0)\par
 .S LRFILE=100,LRIEN=ORDNM_","\par
"RTN","AHMLDOL7",71,0)\par
 .S DATA=$$GET1^DIQ(LRFILE,LRIEN,33,"I")\par
"RTN","AHMLDOL7",72,0)\par
 .I DATA'[LRSS D\par
"RTN","AHMLDOL7",73,0)\par
 ..S LRFDA(4,LRFILE,LRIEN,33)=DATA_";"_LRSS_";"_LRIDT\par
"RTN","AHMLDOL7",74,0)\par
 ..D UPDATE^DIE("","LRFDA(4)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",75,0)\par
 .I $G(LRSTS)="F" D\par
"RTN","AHMLDOL7",76,0)\par
 ..S DIE="^OR(100,",DA=ORDNM,ST=2,DR="22////"_$$NOW^XLFDT_";5////"_ST_";" D ^DIE K DIE,DA\par
"RTN","AHMLDOL7",77,0)\par
 .S JVOROUT(1)=ORDNM_"^RS"\par
"RTN","AHMLDOL7",78,0)\par
 K HLARY,LRSB,LRTS,LRTX,LRSPEC,REC\par
"RTN","AHMLDOL7",79,0)\par
 Q\par
"RTN","AHMLDOL7",80,0)\par
 ; ==================================================================\par
"RTN","AHMLDOL7",81,0)\par
MI7 ; BACTERIOLOGY\par
"RTN","AHMLDOL7",82,0)\par
 N DA,DIE,X,X1,X2,LR1,LRFDA,LRFILE,LRIEN,LRPRV,LRIENS,LRMSG\par
"RTN","AHMLDOL7",83,0)\par
 N RCNT,ORGC,ORG,OBR,OBX,XCNT,ORGNM,CNT,LRANT,LRSUSC,LRRS1,LRRS2\par
"RTN","AHMLDOL7",84,0)\par
 N LRRS3,LRORG,LRCCNT,LRGRAM,LRIEN,GRMARY,GRMCNT,NUM,NX,ORGIEN,QUIT\par
"RTN","AHMLDOL7",85,0)\par
 ; File 1 node of Bacteriology results\par
"RTN","AHMLDOL7",86,0)\par
 S X=HLARY("OBX",1),LRSTS=$P(X,D1,11),LRCMT=""\par
"RTN","AHMLDOL7",87,0)\par
 S LRFILE=63.05,LRIEN=LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",88,0)\par
 S LRFDA(1,LRFILE,LRIEN,11)=$G(LRCDT)\par
"RTN","AHMLDOL7",89,0)\par
 S LRFDA(1,LRFILE,LRIEN,11.5)=$G(LRSTS)\par
"RTN","AHMLDOL7",90,0)\par
 S LRFDA(1,LRFILE,LRIEN,11.55)=$G(JVTECH)\par
"RTN","AHMLDOL7",91,0)\par
 D UPDATE^DIE("","LRFDA(1)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",92,0)\par
 K LRFDA,LRIEN,LRIENS,LRMSG\par
"RTN","AHMLDOL7",93,0)\par
 S LRIEN=LRIDT_","_LRDFN_",",LRFILE=63.05\par
"RTN","AHMLDOL7",94,0)\par
 S LRFDA(99,LRFILE,LRIEN,.99)=$G(LRCMT)\par
"RTN","AHMLDOL7",95,0)\par
 D UPDATE^DIE("","LRFDA(99)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",96,0)\par
 ;\par
"RTN","AHMLDOL7",97,0)\par
 ;  build ORG array of organism  e.g.  ORG(1)=500714\\STREPTOCOCCUS SPECIES^<COLONY COUNT>^<GRAM STAIN>\par
"RTN","AHMLDOL7",98,0)\par
 ;                                      ^piece-1 = ien\\organism name\par
"RTN","AHMLDOL7",99,0)\par
 ;                                      ^piece-2 = colony count, if any\par
"RTN","AHMLDOL7",100,0)\par
 ;                                      ^piece-3 = gram stain, if any\par
"RTN","AHMLDOL7",101,0)\par
 ;                                      ORG(1,"PENICILLIN")=<susceptability>\par
"RTN","AHMLDOL7",102,0)\par
 ; ; CULTURE SUSCEPTIBILTY\par
"RTN","AHMLDOL7",103,0)\par
 S RCNT=0,ORGC=0,GRMCNT=0\par
"RTN","AHMLDOL7",104,0)\par
 S (LR1,ORGC,GRMCNT,NX)=0,(VAL,LNC)=""\par
"RTN","AHMLDOL7",105,0)\par
 F  S NX=$O(HLARY("OBX",NX)) Q:'NX  D\par
"RTN","AHMLDOL7",106,0)\par
 .S X=HLARY("OBX",NX)\par
"RTN","AHMLDOL7",107,0)\par
 .I $P(X,D1,2)["CE" D  Q\par
"RTN","AHMLDOL7",108,0)\par
 ..; Organism\par
"RTN","AHMLDOL7",109,0)\par
 ..I $P(X,D1,3)["99VA61.2" D\par
"RTN","AHMLDOL7",110,0)\par
 ...S VAL=$P(X,D1,4),ORGC=ORGC+1\par
"RTN","AHMLDOL7",111,0)\par
 ...S ORG(VAL,ORGC)=$P($P(X,D1,3),D2,1,2)_D1\par
"RTN","AHMLDOL7",112,0)\par
 ...S ORGNARY(+ORG(VAL,ORGC))="" Q\par
"RTN","AHMLDOL7",113,0)\par
 .I $P(X,D1,2)["ST" D\par
"RTN","AHMLDOL7",114,0)\par
 ..I $P(X,D1,3)["COLONY COUNT" D\par
"RTN","AHMLDOL7",115,0)\par
 ...S VAL=$P(X,D1,4),LRCCNT(VAL)=$P(X,D1,5)\par
"RTN","AHMLDOL7",116,0)\par
 ..I $P(X,D1,3)["SUSC" D\par
"RTN","AHMLDOL7",117,0)\par
 ...S VAL=$P(X,D1,4)\par
"RTN","AHMLDOL7",118,0)\par
 ...S LNC=$P($P(X,D1,3),D2,1),LRSUSC=$P(X,D1,8)\par
"RTN","AHMLDOL7",119,0)\par
 ...S LRRS1(VAL,LNC)=LRSUSC\par
"RTN","AHMLDOL7",120,0)\par
 ..; get BACT RPT REMARKS\par
"RTN","AHMLDOL7",121,0)\par
 ..I $P(X,D1,3)["93928.0000" D\par
"RTN","AHMLDOL7",122,0)\par
 ...S LR1=LR1+1,LRRS2(LR1)=$P(X,D1,5)\par
"RTN","AHMLDOL7",123,0)\par
 ..; get gram stain\par
"RTN","AHMLDOL7",124,0)\par
 ..I $P(X,D1,3)["664-3" D\par
"RTN","AHMLDOL7",125,0)\par
 ...S GRMCNT=GRMCNT+1,GRMARY(GRMCNT)=$P(X,D1,5)\par
"RTN","AHMLDOL7",126,0)\par
 ..I $P(X,D1,3)["87754.0000" D\par
"RTN","AHMLDOL7",127,0)\par
 ...S GRMCNT=GRMCNT+1,GRMARY(GRMCNT)=$P(X,D1,5)\par
"RTN","AHMLDOL7",128,0)\par
 ;\par
"RTN","AHMLDOL7",129,0)\par
 ; NODE-4, FIELD-13 - BACT RPT REMARK -- FILE63.33\par
"RTN","AHMLDOL7",130,0)\par
 I $D(LRRS2) D\par
"RTN","AHMLDOL7",131,0)\par
 .S X1="" F  S X1=$O(LRRS2(X1)) Q:X1=""  D\par
"RTN","AHMLDOL7",132,0)\par
 ..S RSLT=$$GET1^DIQ(63.33,X1_","_LRIDT_","_LRDFN_",",.01,"I")\par
"RTN","AHMLDOL7",133,0)\par
 ..I LRRS2(X1)=$G(RSLT) Q\par
"RTN","AHMLDOL7",134,0)\par
 ..S LRIEN="+"_X1_","_LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",135,0)\par
 ..S LRFDA(4,63.33,LRIEN,.01)=$G(LRRS2(X1))\par
"RTN","AHMLDOL7",136,0)\par
 ..D UPDATE^DIE("","LRFDA(4)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",137,0)\par
 K LRFDA,LRIENS,LRMSG,LRFILE,LRIEN\par
"RTN","AHMLDOL7",138,0)\par
 ;\par
"RTN","AHMLDOL7",139,0)\par
 ; file gram stain\par
"RTN","AHMLDOL7",140,0)\par
 I $D(GRMARY) D\par
"RTN","AHMLDOL7",141,0)\par
 .S X1="" F  S X1=$O(GRMARY(X1)) Q:X1=""  D\par
"RTN","AHMLDOL7",142,0)\par
 ..S LRFILE=63.29,LRIEN="+"_X1_","_LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",143,0)\par
 ..S RSLT=$$GET1^DIQ(LRFILE,X1_","_LRIDT_","_LRDFN_",",.01,"I")\par
"RTN","AHMLDOL7",144,0)\par
 ..I GRMARY(X1)=$G(RSLT) Q\par
"RTN","AHMLDOL7",145,0)\par
 ..S LRFDA(2,LRFILE,LRIEN,.01)=$G(GRMARY(X1))\par
"RTN","AHMLDOL7",146,0)\par
 ..D UPDATE^DIE("","LRFDA(2)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",147,0)\par
 ..K LRFDA,LRIEN,LRMSG,LRIENS\par
"RTN","AHMLDOL7",148,0)\par
 ;\par
"RTN","AHMLDOL7",149,0)\par
 ; NODE-3, FIELD-12 - ORGANISM -- FILE 63.3\par
"RTN","AHMLDOL7",150,0)\par
 N FLG\par
"RTN","AHMLDOL7",151,0)\par
 S (NUM,DA)=0\par
"RTN","AHMLDOL7",152,0)\par
 ; file organism\par
"RTN","AHMLDOL7",153,0)\par
 S QUIT=$P($G(^LR(LRDFN,"MI",LRIDT,3,0)),D1,3)\par
"RTN","AHMLDOL7",154,0)\par
 I QUIT'="" D\par
"RTN","AHMLDOL7",155,0)\par
 .F I=1:1:QUIT  D\par
"RTN","AHMLDOL7",156,0)\par
 ..S LRFILE=63.3,LRIEN=I_","_LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",157,0)\par
 ..S ORGN=$$GET1^DIQ(LRFILE,LRIEN,.01,"I") Q:ORGN=""\par
"RTN","AHMLDOL7",158,0)\par
 ..I $D(ORGNARY(ORGN)) S ORGARY(ORGN)=I\par
"RTN","AHMLDOL7",159,0)\par
 ..I '$D(ORGNARY(ORGN)) S LRFDA(3,LRFILE,LRIEN,.01)="@" D UPDATE^DIE("","LRFDA(3)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",160,0)\par
 S VAL="" F  S VAL=$O(ORG(VAL)) Q:VAL=""  D\par
"RTN","AHMLDOL7",161,0)\par
 .S ORGC=0 F  S ORGC=$O(ORG(VAL,ORGC)) Q:ORGC=""  D\par
"RTN","AHMLDOL7",162,0)\par
 ..S X1=ORGC,NUM=0\par
"RTN","AHMLDOL7",163,0)\par
 ..S X=ORG(VAL,ORGC),LRORG=+X,LRCCNT=$G(LRCCNT(VAL))  ;BL;ADDED $G TO STOP M ERROR WHERE LRCCNT(VAL) UNDEFINED\par
"RTN","AHMLDOL7",164,0)\par
 ..; Check if organism is already in file (#63)\par
"RTN","AHMLDOL7",165,0)\par
 ..; Do not file organsim if it's already in file (#63)\par
"RTN","AHMLDOL7",166,0)\par
 ..I '$D(ORGARY(LRORG)) D\par
"RTN","AHMLDOL7",167,0)\par
 ...S QUIT=$P($G(^LR(LRDFN,"MI",LRIDT,3,0)),D1,3) I QUIT="" S QUIT=1\par
"RTN","AHMLDOL7",168,0)\par
 ...S LRFILE=63.3,LRIEN="+"_QUIT_","_LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",169,0)\par
 ...S LRFDA(3,LRFILE,LRIEN,.01)=$G(LRORG)\par
"RTN","AHMLDOL7",170,0)\par
 ...S LRFDA(3,LRFILE,LRIEN,1)=$G(LRCCNT(VAL))_" "\par
"RTN","AHMLDOL7",171,0)\par
 ...D UPDATE^DIE("","LRFDA(3)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",172,0)\par
 ...S NUM=$P($G(^LR(LRDFN,"MI",LRIDT,3,0)),D1,3)\par
"RTN","AHMLDOL7",173,0)\par
 ...K LRFDA,LRIENS,LRMSG,LRIEN\par
"RTN","AHMLDOL7",174,0)\par
 ...; file antibiotic and susc\par
"RTN","AHMLDOL7",175,0)\par
 ..S LNC="" F  S LNC=$O(LRRS1(VAL,LNC)) Q:LNC=""  D\par
"RTN","AHMLDOL7",176,0)\par
 ...I 'NUM S NUM=ORGARY(LRORG)\par
"RTN","AHMLDOL7",177,0)\par
 ...S LRSUSC=LRRS1(VAL,LNC)\par
"RTN","AHMLDOL7",178,0)\par
 ...S LNCARY=$$HL2LAH^LA7VHLU6(LNC,"","LN",2.14,"","MI")\par
"RTN","AHMLDOL7",179,0)\par
 ...S LRCODE=$P(LNCARY,D1,4)\par
"RTN","AHMLDOL7",180,0)\par
 ...Q:LRCODE=""\par
"RTN","AHMLDOL7",181,0)\par
 ...I LRCODE'["." D\par
"RTN","AHMLDOL7",182,0)\par
 ....S LRCODE=+$P(^DD(63.3,LRCODE,0),D1,4)\par
"RTN","AHMLDOL7",183,0)\par
 ...Q:LRCODE=""\par
"RTN","AHMLDOL7",184,0)\par
 ...S ^LR(LRDFN,"MI",LRIDT,3,NUM,LRCODE)=LRSUSC\par
"RTN","AHMLDOL7",185,0)\par
 ...S SUSCARY(LRCODE)=LRSUSC\par
"RTN","AHMLDOL7",186,0)\par
 ..S LRCODE=0 F  S LRCODE=$O(^LR(LRDFN,"MI",LRIDT,3,NUM,LRCODE)) Q:'LRCODE  D\par
"RTN","AHMLDOL7",187,0)\par
 ...Q:LRCODE'>1\par
"RTN","AHMLDOL7",188,0)\par
 ...I '$D(SUSCARY(LRCODE)) S ^LR(LRDFN,"MI",LRIDT,3,NUM,LRCODE)="^^"\par
"RTN","AHMLDOL7",189,0)\par
 ..K SUSCARY\par
"RTN","AHMLDOL7",190,0)\par
 S LROK=1\par
"RTN","AHMLDOL7",191,0)\par
 Q\par
"RTN","AHMLDOL7",192,0)\par
 ;\par
"RTN","AHMLDOL7",193,0)\par
MI8 ; TB BACTERIOLOGY\par
"RTN","AHMLDOL7",194,0)\par
 N FLG,LR1,LR2,LR3,NX,LRIEN,LRRS1,LRRS1,LRRS3,LRMYC,LRCMT,LRQTY\par
"RTN","AHMLDOL7",195,0)\par
 N MYCC,MYCARY,MYARY,NUM,SUSCARY,QUIT,X1,X2,X,XCT,XX\par
"RTN","AHMLDOL7",196,0)\par
 ; File 1 node of TB Bacteriology results\par
"RTN","AHMLDOL7",197,0)\par
 S X=HLARY("OBX",1),LRSTS=$P(X,D1,11),LRCMT=""\par
"RTN","AHMLDOL7",198,0)\par
 S LRFILE=63.05,LRIEN=LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",199,0)\par
 S LRFDA(11,LRFILE,LRIEN,22)=$G(LRCDT)\par
"RTN","AHMLDOL7",200,0)\par
 S LRFDA(11,LRFILE,LRIEN,23)=$G(LRSTS)\par
"RTN","AHMLDOL7",201,0)\par
 S LRFDA(11,LRFILE,LRIEN,25)=$G(LRQTY)\par
"RTN","AHMLDOL7",202,0)\par
 S LRFDA(11,LRFILE,LRIEN,25.5)=$G(JVTECH)\par
"RTN","AHMLDOL7",203,0)\par
 D UPDATE^DIE("","LRFDA(11)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",204,0)\par
 K LRFDA,LRIEN,LRIENS,LRMSG\par
"RTN","AHMLDOL7",205,0)\par
 S LRIEN=LRIDT_","_LRDFN_",",LRFILE=63.05\par
"RTN","AHMLDOL7",206,0)\par
 S LRFDA(99,LRFILE,LRIEN,.99)=$G(LRCMT)\par
"RTN","AHMLDOL7",207,0)\par
 D UPDATE^DIE("","LRFDA(99)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",208,0)\par
 S (LR1,LR2,LR3,LR4,MYCC)=0\par
"RTN","AHMLDOL7",209,0)\par
 S NX="" F  S NX=$O(HLARY("OBX",NX)) Q:'NX  D\par
"RTN","AHMLDOL7",210,0)\par
 .S X=HLARY("OBX",NX)\par
"RTN","AHMLDOL7",211,0)\par
 .I $P(X,D1,2)="CE" D\par
"RTN","AHMLDOL7",212,0)\par
 ..S VAL=$P(X,D1,4),MYCC=MYCC+1\par
"RTN","AHMLDOL7",213,0)\par
 ..S LIEN=$P($P(X,D1,3),D2,4),MYC(VAL,MYCC)=LIEN\par
"RTN","AHMLDOL7",214,0)\par
 ..S MYCOARY(LIEN)=""\par
"RTN","AHMLDOL7",215,0)\par
 .I $P(X,D1,2)="ST" D\par
"RTN","AHMLDOL7",216,0)\par
 ..I $P(X,D1,3)["COLONY COUNT" D\par
"RTN","AHMLDOL7",217,0)\par
 ...S VAL=$P(X,D1,4),LRRS1(VAL)=$P(X,D1,5)\par
"RTN","AHMLDOL7",218,0)\par
 ..I $P(X,D1,3)["SUSC" D\par
"RTN","AHMLDOL7",219,0)\par
 ...S ANT=$P($P(X,D1,3),D2,2),ANT=$P(ANT,":")\par
"RTN","AHMLDOL7",220,0)\par
 ...S SUBSC="",SUBSC=$O(^DD(63.39,"B",ANT,SUBSC))\par
"RTN","AHMLDOL7",221,0)\par
 ...S VAL=$P(X,D1,4),LRSUSC=$P(X,D1,8)\par
"RTN","AHMLDOL7",222,0)\par
 ...S LRRS2(VAL,SUBSC)=LRSUSC\par
"RTN","AHMLDOL7",223,0)\par
 ..I $P(X,D1,3)[87860.0000 D\par
"RTN","AHMLDOL7",224,0)\par
 ...S LR3=LR3+1,LRCMT=$P(X,D1,5),LRRS3(LR3)=LRCMT\par
"RTN","AHMLDOL7",225,0)\par
 ..I $P(X,D1,3)[11545 D\par
"RTN","AHMLDOL7",226,0)\par
 ...S LRACFST=$P(X,D1,5),LR4=LR4+1,LRRS4(LR4)=LRACFST\par
"RTN","AHMLDOL7",227,0)\par
 ;\par
"RTN","AHMLDOL7",228,0)\par
 ; NODE-12, FIELD-26 -- 63.39 MYCOBACTERIUM\par
"RTN","AHMLDOL7",229,0)\par
 ; NODE-12, FIELD-2 -- 63.4 COMMENT\par
"RTN","AHMLDOL7",230,0)\par
 S NUM=0\par
"RTN","AHMLDOL7",231,0)\par
 S QUIT=$P($G(^LR(LRDFN,"MI",LRIDT,12,0)),D1,3)\par
"RTN","AHMLDOL7",232,0)\par
 I QUIT'="" D\par
"RTN","AHMLDOL7",233,0)\par
 .F I=1:1:QUIT  D\par
"RTN","AHMLDOL7",234,0)\par
 ..S LRIEN=I_","_LRIDT_","_LRDFN_",",LRFILE=63.39\par
"RTN","AHMLDOL7",235,0)\par
 ..S MYCO=$$GET1^DIQ(63.39,LRIEN,.01,"I") Q:MYCO=""\par
"RTN","AHMLDOL7",236,0)\par
 ..I $D(MYCOARY(MYCO)) S MYARY(MYCO)=I\par
"RTN","AHMLDOL7",237,0)\par
 ..I '$D(MYCOARY(MYCO)) S LRFDA(12,LRFILE,LRIEN,.01)="@" D UPDATE^DIE("","LRFDA(12)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",238,0)\par
 S VAL="" F  S VAL=$O(MYC(VAL)) Q:VAL=""  D\par
"RTN","AHMLDOL7",239,0)\par
 .S MYCC=0 F  S MYCC=$O(MYC(VAL,MYCC)) Q:MYCC=""  D\par
"RTN","AHMLDOL7",240,0)\par
 ..S X1=MYCC,NUM=0\par
"RTN","AHMLDOL7",241,0)\par
 ..S X=MYC(VAL,MYCC),LRORG=+X,LRCCNT=LRRS1(VAL)\par
"RTN","AHMLDOL7",242,0)\par
 ..I '$D(MYARY(LRORG)) D\par
"RTN","AHMLDOL7",243,0)\par
 ...S QUIT=$P($G(^LR(LRDFN,"MI",LRIDT,12,0)),D1,3) I QUIT="" S QUIT=1\par
"RTN","AHMLDOL7",244,0)\par
 ...S LRIEN="+"_QUIT_","_LRIDT_","_LRDFN_",",LRFILE=63.39\par
"RTN","AHMLDOL7",245,0)\par
 ...S LRFDA(12,LRFILE,LRIEN,.01)=$G(MYC(VAL,MYCC))\par
"RTN","AHMLDOL7",246,0)\par
 ...S LRFDA(12,LRFILE,LRIEN,1)=$G(LRRS1(VAL))\par
"RTN","AHMLDOL7",247,0)\par
 ...D UPDATE^DIE("","LRFDA(12)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",248,0)\par
 ...S NUM=$P($G(^LR(LRDFN,"MI",LRIDT,12,0)),D1,3)\par
"RTN","AHMLDOL7",249,0)\par
 ..S LNC="" F  S LNC=$O(LRRS2(VAL,LNC)) Q:LNC=""  D\par
"RTN","AHMLDOL7",250,0)\par
 ...I 'NUM S NUM=MYARY(LRORG)\par
"RTN","AHMLDOL7",251,0)\par
 ...S LRSUSC=LRRS2(VAL,LNC)\par
"RTN","AHMLDOL7",252,0)\par
 ...S ^LR(LRDFN,"MI",LRIDT,12,NUM,LNC)=LRSUSC\par
"RTN","AHMLDOL7",253,0)\par
 ...S SUSCARY(LNC)=LRSUSC\par
"RTN","AHMLDOL7",254,0)\par
 ..S LRCODE=0 F  S LRCODE=$O(^LR(LRDFN,"MI",LRIDT,12,NUM,LRCODE)) Q:'LRCODE  D\par
"RTN","AHMLDOL7",255,0)\par
 ...Q:LRCODE'>1\par
"RTN","AHMLDOL7",256,0)\par
 ...I '$D(SUSCARY(LRCODE)) S ^LR(LRDFN,"MI",LRIDT,12,NUM,LRCODE)="^^"\par
"RTN","AHMLDOL7",257,0)\par
 ..K SUSCARY\par
"RTN","AHMLDOL7",258,0)\par
 ;\par
"RTN","AHMLDOL7",259,0)\par
 ; NODE-13, FIELD-27- -- 63.41 TB RPT REMARK\par
"RTN","AHMLDOL7",260,0)\par
 S X1="" F  S X1=$O(LRRS3(X1)) Q:X1=""  D\par
"RTN","AHMLDOL7",261,0)\par
 .S LRFILE=63.41,LRIEN=X1_","_LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",262,0)\par
 .S RSLT=$$GET1^DIQ(LRFILE,LRIEN,.01,"I")\par
"RTN","AHMLDOL7",263,0)\par
 .I LRRS3(X1)=$G(RSLT) Q\par
"RTN","AHMLDOL7",264,0)\par
 .S LRIEN="+"_X1_","_LRIDT_","_LRDFN_",",LRFILE=63.41\par
"RTN","AHMLDOL7",265,0)\par
 .S LRFDA(13,LRFILE,LRIEN,.01)=$G(LRRS3(X1))\par
"RTN","AHMLDOL7",266,0)\par
 .D UPDATE^DIE("","LRFDA(13)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",267,0)\par
 ; File Acid Fast Stain result\par
"RTN","AHMLDOL7",268,0)\par
 S X1="" F  S X1=$O(LRRS4(X1)) Q:X1=""  D\par
"RTN","AHMLDOL7",269,0)\par
 .S LRFILE=63.05,LRIEN=LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",270,0)\par
 .S LRFDA(11,LRFILE,LRIEN,24)=$G(LRRS4(1))\par
"RTN","AHMLDOL7",271,0)\par
 .D UPDATE^DIE("","LRFDA(11)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",272,0)\par
 S LROK=1\par
"RTN","AHMLDOL7",273,0)\par
 Q\par
"RTN","AHMLDOL7",274,0)\par
 ;\par
"RTN","AHMLDOL7",275,0)\par
MI9 ; MYCOLOGY -- 9\par
"RTN","AHMLDOL7",276,0)\par
 N FLG,LR1,LR2,L3,LRIEN,LRFILE,LRRS1,LRRS2,LRRS3,LRSMP,QUIT,X,X1\par
"RTN","AHMLDOL7",277,0)\par
 S X=HLARY("OBX",1),LRSTS=$P(X,D1,11),LRCMT=""\par
"RTN","AHMLDOL7",278,0)\par
 S LRIEN=LRIDT_","_LRDFN_",",LRFILE=63.05\par
"RTN","AHMLDOL7",279,0)\par
 S LRFDA(8,LRFILE,LRIEN,18)=LRCDT\par
"RTN","AHMLDOL7",280,0)\par
 S LRFDA(8,LRFILE,LRIEN,19)=LRSTS\par
"RTN","AHMLDOL7",281,0)\par
 S LRFDA(8,LRFILE,LRIEN,19.5)=$G(JVTECH)\par
"RTN","AHMLDOL7",282,0)\par
 D UPDATE^DIE("","LRFDA(8)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",283,0)\par
 K LRFDA,LRIENS,LRMSG\par
"RTN","AHMLDOL7",284,0)\par
 S LRIEN=LRIDT_","_LRDFN_",",LRFILE=63.05\par
"RTN","AHMLDOL7",285,0)\par
 S LRFDA(99,LRFILE,LRIEN,.99)=$G(LRCMT)\par
"RTN","AHMLDOL7",286,0)\par
 D UPDATE^DIE("","LRFDA(99)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",287,0)\par
 ;\par
"RTN","AHMLDOL7",288,0)\par
 S (LR1,LR2,LR3)=0\par
"RTN","AHMLDOL7",289,0)\par
 ; Capture the Fungas IEN\par
"RTN","AHMLDOL7",290,0)\par
 S NX="" F  S NX=$O(HLARY("OBX",NX)) Q:'NX  D\par
"RTN","AHMLDOL7",291,0)\par
 .S X=HLARY("OBX",NX)\par
"RTN","AHMLDOL7",292,0)\par
 .I $P(X,D1,2)="CE" D\par
"RTN","AHMLDOL7",293,0)\par
 ..S LIEN=$P($P(X,D1,3),D2)\par
"RTN","AHMLDOL7",294,0)\par
 ..S LR1=LR1+1,LRRS1(LR1)=LIEN,FNGARY(LIEN)=""\par
"RTN","AHMLDOL7",295,0)\par
 .I $P(X,D1,2)="ST" D\par
"RTN","AHMLDOL7",296,0)\par
 ..S XX=$P(X,D1,3) D\par
"RTN","AHMLDOL7",297,0)\par
 ...I XX["93974.0000" S LR2=LR2+1,LRMCMT=$P(X,D1,5),LRRS2(LR2)=LRMCMT ;Mycology Rpt Remark\par
"RTN","AHMLDOL7",298,0)\par
 ...I XX["93984.0000" S LR3=LR3+1,LRSMP=$P(X,D1,5),LRRS3(LR3)=LRSMP ; Mycology Smear/Prep\par
"RTN","AHMLDOL7",299,0)\par
 ; NODE-9, FIELD-63.37 FUNGUS/YEAST\par
"RTN","AHMLDOL7",300,0)\par
 S QUIT=$P($G(^LR(LRDFN,"MI",LRIDT,9,0)),D1,3)\par
"RTN","AHMLDOL7",301,0)\par
 I QUIT'="" D  ; If fungus is new, file it, if it's there do not file.\par
"RTN","AHMLDOL7",302,0)\par
 .F I=1:1:QUIT  D\par
"RTN","AHMLDOL7",303,0)\par
 ..S LRIEN=I_","_LRIDT_","_LRDFN_",",LRFILE=63.37\par
"RTN","AHMLDOL7",304,0)\par
 ..S FUNG=$$GET1^DIQ(63.37,LRIEN,.01,"I") Q:FUNG=""\par
"RTN","AHMLDOL7",305,0)\par
 ..I $D(FNGARY(FUNG)) S FNARY(FUNG)=I\par
"RTN","AHMLDOL7",306,0)\par
 ..I '$D(FNGARY(FUNG)) S LRFDA(9,LRFILE,LRIEN,.01)="@" D UPDATE^DIE("","LRFDA(9)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",307,0)\par
 S X1="" F  S X1=$O(LRRS1(X1)) Q:X1=""  D\par
"RTN","AHMLDOL7",308,0)\par
 .I '$D(FNARY(LRRS1(X1))) D\par
"RTN","AHMLDOL7",309,0)\par
 ..S QUIT=$P($G(^LR(LRDFN,"MI",LRIDT,9,0)),D1,3) I QUIT="" S QUIT=1\par
"RTN","AHMLDOL7",310,0)\par
 ..S LRIEN="+"_QUIT_","_LRIDT_","_LRDFN_",",LRFILE=63.37\par
"RTN","AHMLDOL7",311,0)\par
 ..S LRFDA(9,LRFILE,LRIEN,.01)=$G(LIEN)\par
"RTN","AHMLDOL7",312,0)\par
 ..D UPDATE^DIE("","LRFDA(9)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",313,0)\par
 ; NODE-10, FIELD-21 MYCOLOGY RPT REMARK\par
"RTN","AHMLDOL7",314,0)\par
 S X1="" F  S X1=$O(LRRS2(X1)) Q:X1=""  D\par
"RTN","AHMLDOL7",315,0)\par
 .S LRFILE=63.38\par
"RTN","AHMLDOL7",316,0)\par
 .S RSLT=$$GET1^DIQ(LRFILE,X1_","_LRIDT_","_LRDFN_",",.01,"I")\par
"RTN","AHMLDOL7",317,0)\par
 .I LRRS2(X1)=$G(RSLT) Q\par
"RTN","AHMLDOL7",318,0)\par
 .S LRIEN="+"_X1_","_LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",319,0)\par
 .S LRFDA(10,LRFILE,LRIEN,.01)=$G(LRRS2(X1))\par
"RTN","AHMLDOL7",320,0)\par
 .D UPDATE^DIE("","LRFDA(10)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",321,0)\par
 .K LRIENS,LRMSG\par
"RTN","AHMLDOL7",322,0)\par
 ; NODE-15, FIELD 19.6 MYCOLOGY SMEAR/PREP\par
"RTN","AHMLDOL7",323,0)\par
 S X1="" F  S X1=$O(LRRS3(X1)) Q:X1=""  D\par
"RTN","AHMLDOL7",324,0)\par
 .S LRFILE=63.371\par
"RTN","AHMLDOL7",325,0)\par
 .S RSLT=$$GET1^DIQ(LRFILE,X1_","_LRIDT_","_LRDFN_",",.01,"I")\par
"RTN","AHMLDOL7",326,0)\par
 .I LRRS3(X1)=$G(RSLT) Q\par
"RTN","AHMLDOL7",327,0)\par
 .S LRIEN="+"_X1_","_LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",328,0)\par
 .S LRFDA(15,LRFILE,LRIEN,.01)=$G(LRRS3(X1))\par
"RTN","AHMLDOL7",329,0)\par
 .D UPDATE^DIE("","LRFDA(15)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",330,0)\par
 .K LRIENS,LRMSG\par
"RTN","AHMLDOL7",331,0)\par
 ;\par
"RTN","AHMLDOL7",332,0)\par
 S LROK=1\par
"RTN","AHMLDOL7",333,0)\par
 Q\par
"RTN","AHMLDOL7",334,0)\par
 ;\par
"RTN","AHMLDOL7",335,0)\par
MI10 ; PARISITOLOGY LRSB=10\par
"RTN","AHMLDOL7",336,0)\par
 ;\par
"RTN","AHMLDOL7",337,0)\par
 N N,DA,X,X2,X3,LRRS1,LRRS2,LRRS3,LRC1,LRC2,LRC3,QUIT\par
"RTN","AHMLDOL7",338,0)\par
 ;File Provider, Lab test and Collection Date/Time in Lab Data file (#63)\par
"RTN","AHMLDOL7",339,0)\par
 ; Get status from incoming message, OBX-11.  Final or Prelim.\par
"RTN","AHMLDOL7",340,0)\par
 S X=HLARY("OBX",1),LRSTS=$P(X,D1,11),LRCMT=""\par
"RTN","AHMLDOL7",341,0)\par
 S LRIEN=LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",342,0)\par
 S LRFILE=63.05\par
"RTN","AHMLDOL7",343,0)\par
 S LRFDA(5,LRFILE,LRIEN,14)=LRCDT\par
"RTN","AHMLDOL7",344,0)\par
 S LRFDA(5,LRFILE,LRIEN,15)=LRSTS\par
"RTN","AHMLDOL7",345,0)\par
 S LRFDA(5,LRFILE,LRIEN,15.5)=$G(JVTECH)\par
"RTN","AHMLDOL7",346,0)\par
 D UPDATE^DIE("","LRFDA(5)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",347,0)\par
 K LRFDA,LRIEN,LRIENS,LRMSG\par
"RTN","AHMLDOL7",348,0)\par
 S LRIEN=LRIDT_","_LRDFN_",",LRFILE=63.05\par
"RTN","AHMLDOL7",349,0)\par
 S LRFDA(99,LRFILE,LRIEN,.99)=$G(LRCMT)\par
"RTN","AHMLDOL7",350,0)\par
 D UPDATE^DIE("","LRFDA(99)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",351,0)\par
 ; Get the results from multiple OBX segments: Stage, Parasite remark, Parasite ID\par
"RTN","AHMLDOL7",352,0)\par
 S LRC1=0,LRC2=0,LRC3=0,SUB=""\par
"RTN","AHMLDOL7",353,0)\par
 S N=0 F  S N=$O(HLARY("OBX",N)) Q:'N  D\par
"RTN","AHMLDOL7",354,0)\par
 .S X=HLARY("OBX",N),X3=$P($P(X,D1,3),D2,1) I X3="87505.0000" S SUB=$P(X,D1,4),LRRS1(SUB)=$P(X,D1,5) Q\par
"RTN","AHMLDOL7",355,0)\par
 .S X=HLARY("OBX",N),X3=$P($P(X,D1,3),D2,1) I X3="93929.0000" S LRC2=LRC2+1,LRRS2(LRC2)=$P(X,D1,5) Q\par
"RTN","AHMLDOL7",356,0)\par
 .S X=HLARY("OBX",N),X3=$P(X,D1,3) I X3["99VA61.2" D\par
"RTN","AHMLDOL7",357,0)\par
 ..S LRC3=LRC3+1,SUB=$P(X,D1,4),LRRS3(SUB,LRC3)=$P($P(X,D1,5),D2),INCPARY(LRRS3(SUB,LRC3))="" Q\par
"RTN","AHMLDOL7",358,0)\par
 ;\par
"RTN","AHMLDOL7",359,0)\par
 ;16 File Parasite and stage of growth in Lab Data file (#63)\par
"RTN","AHMLDOL7",360,0)\par
 S QUIT=$P($G(^LR(LRDFN,"MI",LRIDT,6,0)),D1,3)\par
"RTN","AHMLDOL7",361,0)\par
 I QUIT'="" D\par
"RTN","AHMLDOL7",362,0)\par
 .F I=1:1:QUIT  D\par
"RTN","AHMLDOL7",363,0)\par
 ..S LRIEN=I_","_LRIDT_","_LRDFN_",",LRFILE=63.34\par
"RTN","AHMLDOL7",364,0)\par
 ..S PARAS=$$GET1^DIQ(63.34,LRIEN,.01,"I") Q:PARAS=""\par
"RTN","AHMLDOL7",365,0)\par
 ..I $D(INCPARY(PARAS)) S PARY(PARAS)=I\par
"RTN","AHMLDOL7",366,0)\par
 ..I '$D(INCPARY(PARAS)) S LRFDA(6,LRFILE,LRIEN,.01)="@" D UPDATE^DIE("","LRFDA(6)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",367,0)\par
 .; If no parasite is found in message, delete from file (#63).\par
"RTN","AHMLDOL7",368,0)\par
 S NUM=0\par
"RTN","AHMLDOL7",369,0)\par
 S VAL="" F  S VAL=$O(LRRS3(VAL)) Q:VAL=""  D\par
"RTN","AHMLDOL7",370,0)\par
 .S X1="" F  S X1=$O(LRRS3(VAL,X1)) Q:X1=""  D\par
"RTN","AHMLDOL7",371,0)\par
 ..S PARAS=LRRS3(VAL,X1),NUM=0\par
"RTN","AHMLDOL7",372,0)\par
 ..I '$D(PARY(PARAS)) D\par
"RTN","AHMLDOL7",373,0)\par
 ...S QUIT=$P($G(^LR(LRDFN,"MI",LRIDT,6,0)),D1,3) I QUIT="" S QUIT=1\par
"RTN","AHMLDOL7",374,0)\par
 ...S LRIEN="+"_QUIT_","_LRIDT_","_LRDFN_",",LRFILE=63.34\par
"RTN","AHMLDOL7",375,0)\par
 ...S LRFDA(6,63.34,LRIEN,.01)=PARAS\par
"RTN","AHMLDOL7",376,0)\par
 ...D UPDATE^DIE("","LRFDA(6)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",377,0)\par
 ...S NUM=$P($G(^LR(LRDFN,"MI",LRIDT,6,0)),"^",3)\par
"RTN","AHMLDOL7",378,0)\par
 ..I $D(LRRS1) D  ;Stage of growth\par
"RTN","AHMLDOL7",379,0)\par
 ...S LRFILE=63.35\par
"RTN","AHMLDOL7",380,0)\par
 ...S STAGE=LRRS1(VAL),STAGE=$E(STAGE,1)\par
"RTN","AHMLDOL7",381,0)\par
 ...I 'NUM S NUM=PARY(PARAS)\par
"RTN","AHMLDOL7",382,0)\par
 ...S NUM1=$P($G(^LR(LRDFN,"MI",LRIDT,6,NUM,1,0)),"^",3)\par
"RTN","AHMLDOL7",383,0)\par
 ...I NUM1="" S NUM1=1 D\par
"RTN","AHMLDOL7",384,0)\par
 ....S LRIEN="+"_NUM1_","_NUM_","_LRIDT_","_LRDFN_",",LRFILE=63.35\par
"RTN","AHMLDOL7",385,0)\par
 ....S LRFDA(6,63.35,LRIEN,.01)=$G(STAGE)\par
"RTN","AHMLDOL7",386,0)\par
 ....D UPDATE^DIE("","LRFDA(6)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",387,0)\par
 ...I NUM1'="" D\par
"RTN","AHMLDOL7",388,0)\par
 ....S RSLT=$$GET1^DIQ(LRFILE,NUM1_","_NUM_","_LRIDT_","_LRDFN_",",.01)\par
"RTN","AHMLDOL7",389,0)\par
 ....S RSLT=$E(RSLT,1) I RSLT=STAGE Q\par
"RTN","AHMLDOL7",390,0)\par
 ....S LRIEN="+"_NUM1_","_NUM_","_LRIDT_","_LRDFN_",",LRFILE=63.35\par
"RTN","AHMLDOL7",391,0)\par
 ....S LRFDA(6,63.35,LRIEN,.01)=$G(STAGE)\par
"RTN","AHMLDOL7",392,0)\par
 ....D UPDATE^DIE("","LRFDA(6)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",393,0)\par
 ;17   File Parasite Report Remark in Lab Data file (#63)\par
"RTN","AHMLDOL7",394,0)\par
 I $D(LRRS2) D\par
"RTN","AHMLDOL7",395,0)\par
 .S X1="" F  S X1=$O(LRRS2(X1)) Q:X1=""  D\par
"RTN","AHMLDOL7",396,0)\par
 ..S LRFILE=63.36\par
"RTN","AHMLDOL7",397,0)\par
 ..S RSLT=$$GET1^DIQ(LRFILE,X1_","_LRIDT_","_LRDFN_",",.01,"I")\par
"RTN","AHMLDOL7",398,0)\par
 ..I LRRS2(X1)=$G(RSLT) Q\par
"RTN","AHMLDOL7",399,0)\par
 ..S LRIEN="+"_X1_","_LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",400,0)\par
 ..S LRFDA(7,63.36,LRIEN,.01)=$G(LRRS2(X1))\par
"RTN","AHMLDOL7",401,0)\par
 ..D UPDATE^DIE("","LRFDA(7)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",402,0)\par
 K LRIEN,LRFDA,LRFILE\par
"RTN","AHMLDOL7",403,0)\par
 S LROK=1\par
"RTN","AHMLDOL7",404,0)\par
 Q\par
"RTN","AHMLDOL7",405,0)\par
 ;\par
"RTN","AHMLDOL7",406,0)\par
MI16 ; VIROLOGY LRBS=16\par
"RTN","AHMLDOL7",407,0)\par
 ;\par
"RTN","AHMLDOL7",408,0)\par
 N LR1,LR2,LRIEN,LRFILE,LRRS1,LRRS2,NX,QUIT,X,XCT\par
"RTN","AHMLDOL7",409,0)\par
 S X=HLARY("OBX",1),LRSTS=$P(X,D1,11),LRCMT="",LRCMT=""\par
"RTN","AHMLDOL7",410,0)\par
 S LRIEN=LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",411,0)\par
 S LRFILE=63.05\par
"RTN","AHMLDOL7",412,0)\par
 S LRFDA(16,LRFILE,LRIEN,33)=LRCDT\par
"RTN","AHMLDOL7",413,0)\par
 S LRFDA(16,LRFILE,LRIEN,34)=LRSTS\par
"RTN","AHMLDOL7",414,0)\par
 S LRFDA(16,LRFILE,LRIEN,35)=$G(JVTECH)\par
"RTN","AHMLDOL7",415,0)\par
 D UPDATE^DIE("","LRFDA(16)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",416,0)\par
 K LRFDA,LRIEN,LRIENS,LRMSG\par
"RTN","AHMLDOL7",417,0)\par
 S LRIEN=LRIDT_","_LRDFN_",",LRFILE=63.05\par
"RTN","AHMLDOL7",418,0)\par
 S LRFDA(99,LRFILE,LRIEN,.99)=$G(LRCMT)\par
"RTN","AHMLDOL7",419,0)\par
 D UPDATE^DIE("","LRFDA(99)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",420,0)\par
 S (LR1,LR2)=0\par
"RTN","AHMLDOL7",421,0)\par
 K LRRS1\par
"RTN","AHMLDOL7",422,0)\par
 S NX="" F  S NX=$O(HLARY("OBX",NX)) Q:'NX  D\par
"RTN","AHMLDOL7",423,0)\par
 .S X=HLARY("OBX",NX)\par
"RTN","AHMLDOL7",424,0)\par
 .I $P(X,D1,2)="CE" S LR1=LR1+1 D\par
"RTN","AHMLDOL7",425,0)\par
 ..S LRIEN=$P($P(X,D1,3),D2)\par
"RTN","AHMLDOL7",426,0)\par
 ..S LRRS1(LR1)=LRIEN,VIRARY(LRIEN)=""\par
"RTN","AHMLDOL7",427,0)\par
 .I $P(X,D1,2)="ST" S LR2=LR2+1 D\par
"RTN","AHMLDOL7",428,0)\par
 ..S LRCMT=$P(X,D1,5)\par
"RTN","AHMLDOL7",429,0)\par
 ..S LRRS2(LR2)=LRCMT\par
"RTN","AHMLDOL7",430,0)\par
 ;\par
"RTN","AHMLDOL7",431,0)\par
 S QUIT=$P($G(^LR(LRDFN,"MI",LRIDT,17,0)),D1,3)\par
"RTN","AHMLDOL7",432,0)\par
 I QUIT'="" D\par
"RTN","AHMLDOL7",433,0)\par
 .F I=1:1:QUIT  D\par
"RTN","AHMLDOL7",434,0)\par
 ..S LRIEN=I_","_LRIDT_","_LRDFN_",",LRFILE=63.43\par
"RTN","AHMLDOL7",435,0)\par
 ..S VIRUS=$$GET1^DIQ(LRFILE,LRIEN,.01,"I") Q:VIRUS=""\par
"RTN","AHMLDOL7",436,0)\par
 ..I $D(VIRARY(VIRUS)) S VARY(VIRUS)=I\par
"RTN","AHMLDOL7",437,0)\par
 ..I '$D(VIRARY(VIRUS)) S LRFDA(17,LRFILE,LRIEN,.01)="@" D UPDATE^DIE("","LRFDA(17)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",438,0)\par
 S LR1="" F  S LR1=$O(LRRS1(LR1)) Q:'LR1  D\par
"RTN","AHMLDOL7",439,0)\par
 .I '$D(VARY(LRRS1(LR1))) D\par
"RTN","AHMLDOL7",440,0)\par
 ..S QUIT=$P($G(^LR(LRDFN,"MI",LRIDT,17,0)),D1,3) I QUIT="" S QUIT=1\par
"RTN","AHMLDOL7",441,0)\par
 ..S LRIEN="+"_QUIT_","_LRIDT_","_LRDFN_",",LRFILE=63.43\par
"RTN","AHMLDOL7",442,0)\par
 ..S LRFDA(17,LRFILE,LRIEN,.01)=$G(LRRS1(LR1))\par
"RTN","AHMLDOL7",443,0)\par
 ..D UPDATE^DIE("","LRFDA(17)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",444,0)\par
 ; Virology report remark\par
"RTN","AHMLDOL7",445,0)\par
 S LR1="" F  S LR1=$O(LRRS2(LR1)) Q:'LR1  D\par
"RTN","AHMLDOL7",446,0)\par
 .S RSLT=$$GET1^DIQ(63.44,LR1_","_LRIDT_","_LRDFN_",",.01,"I")\par
"RTN","AHMLDOL7",447,0)\par
 .I LRRS2(LR1)=$G(RSLT) Q\par
"RTN","AHMLDOL7",448,0)\par
 .S LRFILE=63.44,LRIEN="+"_LR1_","_LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",449,0)\par
 .S LRFDA(18,LRFILE,LRIEN,.01)=$G(LRRS2(LR1))\par
"RTN","AHMLDOL7",450,0)\par
 .D UPDATE^DIE("","LRFDA(18)","LRIEN","LRMSG")\par
"RTN","AHMLDOL7",451,0)\par
 S LROK=1\par
"RTN","AHMLDOL7",452,0)\par
 Q\par
"RTN","AHMLDOL7",453,0)\par
 ;\par
"RTN","AHMLDOL7",454,0)\par
MI23 ; GRAM STAIN LABELED -- 23\par
"RTN","AHMLDOL7",455,0)\par
 N LRRS1,N1,N2,S1,X1\par
"RTN","AHMLDOL7",456,0)\par
 S S1=0\par
"RTN","AHMLDOL7",457,0)\par
 S X=HLARY("OBX",1),LRSTS=$P(X,D1,11),LRCMT=""\par
"RTN","AHMLDOL7",458,0)\par
 S LRIEN=LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",459,0)\par
 S LRFILE=63.05\par
"RTN","AHMLDOL7",460,0)\par
 S LRFDA(1,LRFILE,LRIEN,11)=$G(LRCDT)\par
"RTN","AHMLDOL7",461,0)\par
 S LRFDA(1,LRFILE,LRIEN,11.5)=$G(LRSTS)\par
"RTN","AHMLDOL7",462,0)\par
 S LRFDA(1,LRFILE,LRIEN,11.55)=$G(JVTECH)\par
"RTN","AHMLDOL7",463,0)\par
 D UPDATE^DIE("","LRFDA(1)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",464,0)\par
 K LRFDA,LRIENS,LRMSG,LRFILE\par
"RTN","AHMLDOL7",465,0)\par
 S N1="" F  S N1=$O(HLOBX(N1)) Q:N1=""  D\par
"RTN","AHMLDOL7",466,0)\par
 .S LR4=$P($P(HLOBX(N1),D1,4),D2,1)\par
"RTN","AHMLDOL7",467,0)\par
 .S LRFILE=60,LRIEN=LR4_",",LR4=$$GET1^DIQ(LRFILE,LRIEN,.01,"I")\par
"RTN","AHMLDOL7",468,0)\par
 .S N2="" F  S N2=$O(HLOBX(N1,N2)) Q:'N2  D\par
"RTN","AHMLDOL7",469,0)\par
 ..S S1=S1+1,LRRS1(S1)=$P(HLOBX(N1,N2),D1,5)\par
"RTN","AHMLDOL7",470,0)\par
 S X1="" F  S X1=$O(LRRS1(X1)) Q:X1=""  D\par
"RTN","AHMLDOL7",471,0)\par
 .S RSLT=$$GET1^DIQ(63.29,X1_","_LRIDT_","_LRDFN_",",.01,"I")\par
"RTN","AHMLDOL7",472,0)\par
 .I LRRS1(X1)=$G(RSLT) Q\par
"RTN","AHMLDOL7",473,0)\par
 .S LRIEN="+"_X1_","_LRIDT_","_LRDFN_","\par
"RTN","AHMLDOL7",474,0)\par
 .S LRFDA(2,63.29,LRIEN,.01)=$G(LRRS1(X1))\par
"RTN","AHMLDOL7",475,0)\par
 .D UPDATE^DIE("","LRFDA(2)","LRIENS","LRMSG")\par
"RTN","AHMLDOL7",476,0)\par
 S LROK=1\par
"RTN","AHMLDOL7",477,0)\par
 Q\par
"RTN","AHMLDOL7",478,0)\par
 ;\par
"RTN","AHMLDOL7",479,0)\par
EXIT ;\par
"RTN","AHMLDOL7",480,0)\par
 K ANT,DATA,D1,D2,DC3,DR,EXEC,FLAG,FLD,FLG,FNARY,FNGARY,FUNG,HLOBX,I,INCPARY,K,LIEN,LR4,LR6207\par
"RTN","AHMLDOL7",481,0)\par
 K LRACFST,LRBG0,LNC,LNCARY,LRCCNT,LRCDT,LRCODE,LRI,LRIDT,LRMIDEF,LRMIOTH,LRDFN,LRMCMT,JVTECH\par
"RTN","AHMLDOL7",482,0)\par
 K LRODT,LROK,LRORD,LRORG,LRPTP,LRPRV,LRVPRV,LRRDT,LRRS1,LRRS2,LRRS3,LRRS4,LRSAMELRSPT\par
"RTN","AHMLDOL7",483,0)\par
 K LRSN,LRSITE,LRSS,LRSTS,LRUNDO,LRD,LRVAL,LRVPRN,MYCARY,MYC,MYCC,MYCO,MYCOARY,NUM\par
"RTN","AHMLDOL7",484,0)\par
 K NUM1,ORDNM,PAARY,PARARY,PARY,PARA,PARAS,ORGARY,ORGN,ORGNARY,RSITE,RSLT,SITE,ST,STAGE\par
"RTN","AHMLDOL7",485,0)\par
 K SUB,SUBSC,SUSCARY,TIM,VA,VAL,VIRARY,VIRUS,VARY,X,X1,X2,X3,X5,XN,Y\par
"RTN","AHMLDOL7",486,0)\par
 Q\par
"RTN","AHMLDOL7",487,0)\par
 ;\par
"RTN","AHMLDOLO")\par
0^13^B10264219\par
"RTN","AHMLDOLO",1,0)\par
AHMLDOLO ;SAIC/TCK - REMOT~E ORDERING ; 11/14/16 5:16pm\par
"RTN","AHMLDOLO",2,0)\par
 ;;1.0;REMOTE ORDERING;;DEC 28, 2015;Build 26\par
"RTN","AHMLDOLO",3,0)\par
 Q\par
"RTN","AHMLDOLO",4,0)\par
 ;\par
"RTN","AHMLDOLO",5,0)\par
EN(MSG1,MSG2) ;Pass in message from VistA or CPRS\par
"RTN","AHMLDOLO",6,0)\par
 N HLA,PROT,PR,REC,FLG S (CHK,FLG)=0\par
"RTN","AHMLDOLO",7,0)\par
 I $D(MSG1)>1 M REC=XQORMSG D GENMSG(.REC)\par
"RTN","AHMLDOLO",8,0)\par
 I $G(MSG2)'="" I $G(ORAPMSG)'="" M REC=@ORAPMSG D GENMSG(.REC)\par
"RTN","AHMLDOLO",9,0)\par
 I $G(MSG1)["TMP" M REC=@XQORMSG D GENMSG(.REC)\par
"RTN","AHMLDOLO",10,0)\par
 I $G(MSG)["TMP" M REC=@MSG D GENMSG(.REC)\par
"RTN","AHMLDOLO",11,0)\par
 K MSG,MSG1,REC,CHK,FLG,ODC,AP,VFGL,STOP,CHG,MSGTYP,MSGNDE\par
"RTN","AHMLDOLO",12,0)\par
GENMSG(REC) ;\par
"RTN","AHMLDOLO",13,0)\par
 N FLAG1\par
"RTN","AHMLDOLO",14,0)\par
 S FLAG1=0\par
"RTN","AHMLDOLO",15,0)\par
 S ZCNT="",(CHK,FLG,ODC,AP,VFLG,STOP,CHG)=0\par
"RTN","AHMLDOLO",16,0)\par
 I $D(JVORIN) S JVOD=1,FLG=2 Q\par
"RTN","AHMLDOLO",17,0)\par
 F  S ZCNT=$O(REC(ZCNT)) Q:ZCNT=""  D  Q:FLG=2\par
"RTN","AHMLDOLO",18,0)\par
 .S MSGNDE=REC(ZCNT),MSGTYP=$P(MSGNDE,"|"),CCDE=$P(MSGNDE,"|",2)\par
"RTN","AHMLDOLO",19,0)\par
 .Q:MSGTYP=""\par
"RTN","AHMLDOLO",20,0)\par
 .I MSGTYP="MSH" D\par
"RTN","AHMLDOLO",21,0)\par
 ..S TYP=$P(MSGNDE,"|",5)\par
"RTN","AHMLDOLO",22,0)\par
 .I MSGTYP="ORC" D\par
"RTN","AHMLDOLO",23,0)\par
 ..S ONUM=+$P(MSGNDE,"|",3)\par
"RTN","AHMLDOLO",24,0)\par
 ..I $G(CCDE)="NA" S FLG=2 Q\par
"RTN","AHMLDOLO",25,0)\par
 ..I $G(CCDE)="SN" S FLG=1\par
"RTN","AHMLDOLO",26,0)\par
 ..I $G(CCDE)="NW" S FLG=1\par
"RTN","AHMLDOLO",27,0)\par
 ..I $G(CCDE)="CA" S FLG=1\par
"RTN","AHMLDOLO",28,0)\par
 ..I $G(CCDE)="DC" S FLG=1\par
"RTN","AHMLDOLO",29,0)\par
 .I MSGTYP="OBR" D\par
"RTN","AHMLDOLO",30,0)\par
 ..S MODE="" D GTMODE(.REC,ZCNT,.MODE,ONUM)\par
"RTN","AHMLDOLO",31,0)\par
 Q:'FLG\par
"RTN","AHMLDOLO",32,0)\par
 Q:FLG=2\par
"RTN","AHMLDOLO",33,0)\par
 D GTNME(.REC)\par
"RTN","AHMLDOLO",34,0)\par
 I $G(ORD)[";" S ORIFN=+ORD\par
"RTN","AHMLDOLO",35,0)\par
 I $G(ORDERID)>0,ORDERID[";" S ORIFN=+ORDERID\par
"RTN","AHMLDOLO",36,0)\par
 D GTREM(.PROT,ORIFN,TYP)\par
"RTN","AHMLDOLO",37,0)\par
 M HLA("HLS")=REC K HLA("HLS",1) D GENERATE^HLMA($O(^ORD(101,"B",PROT,0)),"LM",1,.HLREST,"",.HLP) S FLG=3\par
"RTN","AHMLDOLO",38,0)\par
 Q\par
"RTN","AHMLDOLO",39,0)\par
 ;\par
"RTN","AHMLDOLO",40,0)\par
GTMODE(REC,ZCNT,MODE,ONUM) ;\par
"RTN","AHMLDOLO",41,0)\par
 S MODE=""\par
"RTN","AHMLDOLO",42,0)\par
 Q:'$D(^OR(100,ONUM))\par
"RTN","AHMLDOLO",43,0)\par
 Q:'$D(^OR(100,ONUM,4.5))\par
"RTN","AHMLDOLO",44,0)\par
 Q:'$D(^OR(100,ONUM,4.5,"ID"))\par
"RTN","AHMLDOLO",45,0)\par
 Q:'$D(^OR(100,ONUM,4.5,"ID","MODE"))\par
"RTN","AHMLDOLO",46,0)\par
 S ID=$O(^OR(100,ONUM,4.5,"ID","MODE",MODE))\par
"RTN","AHMLDOLO",47,0)\par
 S MODE=^OR(100,ONUM,4.5,ID,1)\par
"RTN","AHMLDOLO",48,0)\par
 S $P(REC(ZCNT),"|",31)=MODE\par
"RTN","AHMLDOLO",49,0)\par
 Q\par
"RTN","AHMLDOLO",50,0)\par
 ;\par
"RTN","AHMLDOLO",51,0)\par
GTNME(REC) ;\par
"RTN","AHMLDOLO",52,0)\par
 N CNT,MSGNDE,MSGTYP\par
"RTN","AHMLDOLO",53,0)\par
 S (MSGNDE,MSGTYP)="",CNT=0\par
"RTN","AHMLDOLO",54,0)\par
 F  S CNT=$O(REC(CNT)) Q:CNT=""  D\par
"RTN","AHMLDOLO",55,0)\par
 .S MSGNDE=REC(CNT)\par
"RTN","AHMLDOLO",56,0)\par
 .Q:$G(MSGNDE)=""\par
"RTN","AHMLDOLO",57,0)\par
 .S MSGTYP=$P(MSGNDE,"|"),CCDE=$P(MSGNDE,"|",2)\par
"RTN","AHMLDOLO",58,0)\par
 .I MSGTYP="ORC" D\par
"RTN","AHMLDOLO",59,0)\par
 ..S ORD=$P(MSGNDE,"|",3)\par
"RTN","AHMLDOLO",60,0)\par
 ..S USR=$P(MSGNDE,"|",11)\par
"RTN","AHMLDOLO",61,0)\par
 ..S PROV=$P(MSGNDE,"|",13)\par
"RTN","AHMLDOLO",62,0)\par
 ..Q:$G(USR)'>0\par
"RTN","AHMLDOLO",63,0)\par
 ..Q:$G(PROV)'>0\par
"RTN","AHMLDOLO",64,0)\par
 ..S USRNME=$$GET1^DIQ(200,USR,.01,"I")\par
"RTN","AHMLDOLO",65,0)\par
 ..S ^XTMP("USRNME")=USRNME\par
"RTN","AHMLDOLO",66,0)\par
 ..S PROVNME=$$GET1^DIQ(200,PROV,.01,"I")\par
"RTN","AHMLDOLO",67,0)\par
 ..S ^XTMP("PROVNME")=PROVNME\par
"RTN","AHMLDOLO",68,0)\par
 ..I $G(USRNME)'="" S $P(REC(CNT),"|",11)=USR_"^"_USRNME\par
"RTN","AHMLDOLO",69,0)\par
 ..I $G(PROVNME)'="" S $P(REC(CNT),"|",13)=PROV_"^"_PROVNME\par
"RTN","AHMLDOLO",70,0)\par
 .W !,MSGTYP\par
"RTN","AHMLDOLO",71,0)\par
 Q\par
"RTN","AHMLDOLO",72,0)\par
 ;\par
"RTN","AHMLDOLO",73,0)\par
GTREM(PROT,ORIFN,TYP) ;\par
"RTN","AHMLDOLO",74,0)\par
 N FAC,REM\par
"RTN","AHMLDOLO",75,0)\par
 S PROT=0\par
"RTN","AHMLDOLO",76,0)\par
 Q:$G(ORIFN)'>0\par
"RTN","AHMLDOLO",77,0)\par
 Q:'$D(^OR(100,ORIFN,4.5,"ID"))\par
"RTN","AHMLDOLO",78,0)\par
 Q:'$D(^OR(100,ORIFN,4.5,"ID","Location"))\par
"RTN","AHMLDOLO",79,0)\par
 S IFN="",IFN=$O(^OR(100,ORIFN,4.5,"ID","Location",IFN))\par
"RTN","AHMLDOLO",80,0)\par
 S FAC=^OR(100,ORIFN,4.5,IFN,1)\par
"RTN","AHMLDOLO",81,0)\par
 S REM="",REM=$O(^DIC(4,"B",FAC,REM))\par
"RTN","AHMLDOLO",82,0)\par
 I TYP["LAB" S PROT="LA7V "_REM_" ORM-O01 EVENT"\par
"RTN","AHMLDOLO",83,0)\par
 I TYP["RAD" S PROT="RA "_REM_" ORM-O01 EVENT"\par
"RTN","AHMLDOLO",84,0)\par
 ;REMOVE STAION ID FROM 8 NODE\par
"RTN","AHMLDOLO",85,0)\par
 Q\par
"RTN","AHMLDOLO",86,0)\par
 ;\par
"RTN","AHMLDOLO",87,0)\par
GTDOM(R) ;\par
"RTN","AHMLDOLO",88,0)\par
 N NME,INST,CNT\par
"RTN","AHMLDOLO",89,0)\par
 S (DOM,INST,R)="",CNT=0\par
"RTN","AHMLDOLO",90,0)\par
 Q:'$D(^DIC(4,"E"))\par
"RTN","AHMLDOLO",91,0)\par
 S INST="" F  S INST=$O(^DIC(4,"E",INST)) Q:INST=""  D\par
"RTN","AHMLDOLO",92,0)\par
 .;Q:$G(DOM)'>0\par
"RTN","AHMLDOLO",93,0)\par
 .;S DOM=$$GET1^DIQ(4.2,DOM,.01,"E")\par
"RTN","AHMLDOLO",94,0)\par
 .S NME=$$GET1^DIQ(4,INST,.01,"E")\par
"RTN","AHMLDOLO",95,0)\par
 .S CNT=$G(CNT)+1\par
"RTN","AHMLDOLO",96,0)\par
 .S R(CNT)=INST_"^"_NME\par
"RTN","AHMLDOLO",97,0)\par
 Q\par
"RTN","AHMLDOP1")\par
0^14^B117690250\par
"RTN","AHMLDOP1",1,0)\par
AHMLDOP1 ;LEIDOS/TCK - REMOTE ORDERING - REMOTE LAB/RAD ORDERS BY LOCATION ; 10/16/16 8:57pm\par
"RTN","AHMLDOP1",2,0)\par
 ;;1.0;REMOTE ORDERS;;OCT 1,2016;Build 26\par
"RTN","AHMLDOP1",3,0)\par
 ;\par
"RTN","AHMLDOP1",4,0)\par
 Q\par
"RTN","AHMLDOP1",5,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP1",6,0)\par
LAB ; Entry point for Remote Laboratory Orders by Location.\par
"RTN","AHMLDOP1",7,0)\par
 ;\par
"RTN","AHMLDOP1",8,0)\par
 S LRT=2\par
"RTN","AHMLDOP1",9,0)\par
 ;\par
"RTN","AHMLDOP1",10,0)\par
 D INIT,GDT:'LREND,LOC:'LREND,DETAIL:'LREND,GDV:'LREND,RUN:'LREND,STOP\par
"RTN","AHMLDOP1",11,0)\par
 ;\par
"RTN","AHMLDOP1",12,0)\par
 Q\par
"RTN","AHMLDOP1",13,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP1",14,0)\par
RAD ; Entry point for Remote Radiology Orders by Location.\par
"RTN","AHMLDOP1",15,0)\par
 ;\par
"RTN","AHMLDOP1",16,0)\par
 S LRT=1\par
"RTN","AHMLDOP1",17,0)\par
 ;\par
"RTN","AHMLDOP1",18,0)\par
 D INIT,GDT:'LREND,LOC:'LREND,DETAIL:'LREND,GDV:'LREND,RUN:'LREND,STOP\par
"RTN","AHMLDOP1",19,0)\par
 ;\par
"RTN","AHMLDOP1",20,0)\par
 Q\par
"RTN","AHMLDOP1",21,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP1",22,0)\par
TAT ; Entry point for Turnaround Time for Remote Lab Orders report.\par
"RTN","AHMLDOP1",23,0)\par
 ;\par
"RTN","AHMLDOP1",24,0)\par
 S LRT="2A"\par
"RTN","AHMLDOP1",25,0)\par
 ;\par
"RTN","AHMLDOP1",26,0)\par
 D INIT,GDT:'LREND,LOC:'LREND,DETAIL:'LREND,GDV:'LREND,RUN:'LREND,STOP\par
"RTN","AHMLDOP1",27,0)\par
 ;\par
"RTN","AHMLDOP1",28,0)\par
 Q\par
"RTN","AHMLDOP1",29,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP1",30,0)\par
INIT ; Initialize common variables.\par
"RTN","AHMLDOP1",31,0)\par
 ;\par
"RTN","AHMLDOP1",32,0)\par
 S U="^",B="|",S=";"\par
"RTN","AHMLDOP1",33,0)\par
 S LREND=0,LRSDT="TODAY",LREDT="T-7"\par
"RTN","AHMLDOP1",34,0)\par
 I LRT="2A" W !,"Turnaround Time for Remote Lab Orders" Q\par
"RTN","AHMLDOP1",35,0)\par
 W !,"REMOTE ORDERS - Remote ",$S(LRT=1:"Radiology",1:"Lab")\par
"RTN","AHMLDOP1",36,0)\par
 W " Orders by Location"\par
"RTN","AHMLDOP1",37,0)\par
 ;\par
"RTN","AHMLDOP1",38,0)\par
 Q\par
"RTN","AHMLDOP1",39,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP1",40,0)\par
RUN ; Run the report either queued or in person.\par
"RTN","AHMLDOP1",41,0)\par
 ;\par
"RTN","AHMLDOP1",42,0)\par
 K ^TMP("LR",$J),^TMP("LRX",$J),^TMP("TAT",$J)\par
"RTN","AHMLDOP1",43,0)\par
 S:$D(ZTQUEUED) ZTREQ="@" U IO\par
"RTN","AHMLDOP1",44,0)\par
 S (LRPAG,LREND)=0\par
"RTN","AHMLDOP1",45,0)\par
 D:'LREND START\par
"RTN","AHMLDOP1",46,0)\par
 D:$D(ZTQUEUED) STOP\par
"RTN","AHMLDOP1",47,0)\par
 ;\par
"RTN","AHMLDOP1",48,0)\par
 Q\par
"RTN","AHMLDOP1",49,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP1",50,0)\par
STOP ; End and cleanup.\par
"RTN","AHMLDOP1",51,0)\par
 ;\par
"RTN","AHMLDOP1",52,0)\par
 I ($E(IOST,1,2)="C-") D WAIT\par
"RTN","AHMLDOP1",53,0)\par
 I '$D(ZTQUEUED) D ^%ZISC\par
"RTN","AHMLDOP1",54,0)\par
 K ^TMP("LR",$J),^TMP("LRX",$J),^TMP("TAT",$J)\par
"RTN","AHMLDOP1",55,0)\par
 K %DT,B,DATA1,DD,DM,DSTR,DTOUT,DUOUT,DY,LRDET,LREDT,LREND,LRLOC\par
"RTN","AHMLDOP1",56,0)\par
 K LRPAG,LRSDT,LRT,OR,PLOC,POP,S,X,Y,ZTDESC,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE\par
"RTN","AHMLDOP1",57,0)\par
 ;\par
"RTN","AHMLDOP1",58,0)\par
 Q\par
"RTN","AHMLDOP1",59,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP1",60,0)\par
GDT ; Get dates (start and end).\par
"RTN","AHMLDOP1",61,0)\par
 ;\par
"RTN","AHMLDOP1",62,0)\par
 I LRSDT?1.7N S Y=LRSDT D DD^LRX S LRSDT=Y\par
"RTN","AHMLDOP1",63,0)\par
 I LREDT?1.7N S Y=LREDT D DD^LRX S LREDT=Y\par
"RTN","AHMLDOP1",64,0)\par
 S %DT("A")="Enter START date: ",%DT("B")=LRSDT,%DT="AET"\par
"RTN","AHMLDOP1",65,0)\par
 D ^%DT S LREND=Y<1 Q:LREND\par
"RTN","AHMLDOP1",66,0)\par
 S LRSDT=Y\par
"RTN","AHMLDOP1",67,0)\par
 S %DT("A")="Enter END date: ",%DT("B")=LREDT\par
"RTN","AHMLDOP1",68,0)\par
 D ^%DT S LREND=Y<1 Q:LREND\par
"RTN","AHMLDOP1",69,0)\par
 S LREDT=Y\par
"RTN","AHMLDOP1",70,0)\par
 S:LREDT>LRSDT X=LREDT,LREDT=LRSDT,LRSDT=X\par
"RTN","AHMLDOP1",71,0)\par
 ;\par
"RTN","AHMLDOP1",72,0)\par
 Q\par
"RTN","AHMLDOP1",73,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP1",74,0)\par
GDV ; Get output device.\par
"RTN","AHMLDOP1",75,0)\par
 ;\par
"RTN","AHMLDOP1",76,0)\par
 S %ZIS="Q" D ^%ZIS K %ZIS I POP S LREND=1 Q\par
"RTN","AHMLDOP1",77,0)\par
 I $D(IO("Q")) D\par
"RTN","AHMLDOP1",78,0)\par
 .K IO("Q")\par
"RTN","AHMLDOP1",79,0)\par
 .S LREND=1,ZTRTN="RUN^AHMLDOP1",ZTDESC="Lab Special Report"\par
"RTN","AHMLDOP1",80,0)\par
 .S ZTSAVE("LR*")=""\par
"RTN","AHMLDOP1",81,0)\par
 .D ^%ZTLOAD\par
"RTN","AHMLDOP1",82,0)\par
 ;\par
"RTN","AHMLDOP1",83,0)\par
 Q\par
"RTN","AHMLDOP1",84,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP1",85,0)\par
LOC ; Get the locations to run report for.  Default "ALL".\par
"RTN","AHMLDOP1",86,0)\par
 ;\par
"RTN","AHMLDOP1",87,0)\par
 N I,J,LOC\par
"RTN","AHMLDOP1",88,0)\par
 ;\par
"RTN","AHMLDOP1",89,0)\par
 I '$D(^DIC(4,"E")) D  Q\par
"RTN","AHMLDOP1",90,0)\par
 .S LRLOC=B_$$NAME^XUAF4($$KSP^XUPARAM("INST"))_B\par
"RTN","AHMLDOP1",91,0)\par
 .S LRLOC=B_^ZTMP("AHMLDOP1_LOCATION")_B   ;[temp until configuration complete then remove]\par
"RTN","AHMLDOP1",92,0)\par
 ;\par
"RTN","AHMLDOP1",93,0)\par
 K DIR\par
"RTN","AHMLDOP1",94,0)\par
 S DIR("B")="ALL",DIR("A")="Location",DIR(0)="S^1:ALL;",I=""\par
"RTN","AHMLDOP1",95,0)\par
 S LOC(1)="ALL",DIR("?")="Select Location"\par
"RTN","AHMLDOP1",96,0)\par
 ;\par
"RTN","AHMLDOP1",97,0)\par
 F J=2:1 S I=$O(^DIC(4,"E",I)) Q:I=""  D\par
"RTN","AHMLDOP1",98,0)\par
 .S LOC=$$GET1^DIQ(4,I,.01),LOC(J)=LOC\par
"RTN","AHMLDOP1",99,0)\par
 .S DIR(0)=DIR(0)_J_":"_$$GET1^DIQ(4,I,.01)_";",LOC(J)=LOC\par
"RTN","AHMLDOP1",100,0)\par
 ;\par
"RTN","AHMLDOP1",101,0)\par
 D ^DIR\par
"RTN","AHMLDOP1",102,0)\par
 S:($D(DUOUT))!($D(DTOUT)) LREND=1\par
"RTN","AHMLDOP1",103,0)\par
 I 'LREND D\par
"RTN","AHMLDOP1",104,0)\par
 .I LOC(Y)'="ALL" D  Q\par
"RTN","AHMLDOP1",105,0)\par
 ..S LRLOC=B_LOC(Y)_B\par
"RTN","AHMLDOP1",106,0)\par
 .S I="",LRLOC=B\par
"RTN","AHMLDOP1",107,0)\par
 .F  S I=$O(^DIC(4,"E",I)) Q:I=""  S LRLOC=LRLOC_$$GET1^DIQ(4,I,.01)_B\par
"RTN","AHMLDOP1",108,0)\par
 ;\par
"RTN","AHMLDOP1",109,0)\par
 Q\par
"RTN","AHMLDOP1",110,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP1",111,0)\par
DETAIL ; Include detail?  (1=yes, 0=no).  Default "NO".\par
"RTN","AHMLDOP1",112,0)\par
 ;\par
"RTN","AHMLDOP1",113,0)\par
 K DIR\par
"RTN","AHMLDOP1",114,0)\par
 S DIR("B")="NO",DIR("A")="Include a Detailed Report?",DIR(0)="S^1:NO;2:YES"\par
"RTN","AHMLDOP1",115,0)\par
 ;\par
"RTN","AHMLDOP1",116,0)\par
 D ^DIR\par
"RTN","AHMLDOP1",117,0)\par
 S:($D(DUOUT))!($D(DTOUT)) LREND=1 S:'LREND LRDET=Y-1 Q\par
"RTN","AHMLDOP1",118,0)\par
 ;\par
"RTN","AHMLDOP1",119,0)\par
 Q\par
"RTN","AHMLDOP1",120,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP1",121,0)\par
START ; Produce report looping through OR(100 data.\par
"RTN","AHMLDOP1",122,0)\par
 ;\par
"RTN","AHMLDOP1",123,0)\par
 ;   Input: LRSDT - Start date\par
"RTN","AHMLDOP1",124,0)\par
 ;          LREDT - End date\par
"RTN","AHMLDOP1",125,0)\par
 ;          LRLOC - Location(s) [|loc1|loc2|...]\par
"RTN","AHMLDOP1",126,0)\par
 ;          LRDET - Detail      [0=No, 1=Yes]\par
"RTN","AHMLDOP1",127,0)\par
 ;\par
"RTN","AHMLDOP1",128,0)\par
 ;  Output: Report.\par
"RTN","AHMLDOP1",129,0)\par
 ;\par
"RTN","AHMLDOP1",130,0)\par
 N ABREV,CDATE,COLDT,CPT,D0,DATA,IPROC,ITYPE,LOC,LRDT,LRDT1,ODATE,OR,OR1\par
"RTN","AHMLDOP1",131,0)\par
 N PNAME,PROV,RDATE,RPTDT,STATUS,TAT,TEST,TMP,TNAME\par
"RTN","AHMLDOP1",132,0)\par
 ;\par
"RTN","AHMLDOP1",133,0)\par
 S LRDT=(LREDT-1)+.999999,LRDT1=LRSDT+.999999\par
"RTN","AHMLDOP1",134,0)\par
 ;\par
"RTN","AHMLDOP1",135,0)\par
 F  S LRDT=$O(^OR(100,"AF",LRDT)) Q:LRDT=""!(LRDT>LRDT1)  D\par
"RTN","AHMLDOP1",136,0)\par
 .S OR="" F  S OR=$O(^OR(100,"AF",LRDT,OR)) Q:OR=""  D\par
"RTN","AHMLDOP1",137,0)\par
 ..I +$P($G(^OR(100,OR,0)),U,5)'=+LRT Q           ;not a lab/rad test\par
"RTN","AHMLDOP1",138,0)\par
 ..I '$D(^OR(100,OR,4.5)) Q\par
"RTN","AHMLDOP1",139,0)\par
 ..S OR1="" F  S OR1=$O(^OR(100,OR,4.5,OR1)) Q:OR1=""  D\par
"RTN","AHMLDOP1",140,0)\par
 ...S DATA=$G(^OR(100,OR,4.5,OR1,0))\par
"RTN","AHMLDOP1",141,0)\par
 ...I $P(DATA,U,4)'="Location" Q\par
"RTN","AHMLDOP1",142,0)\par
 ...S LOC=$G(^OR(100,OR,4.5,OR1,1)) Q:LOC=""\par
"RTN","AHMLDOP1",143,0)\par
 ...I LRLOC'[(B_LOC_B) Q\par
"RTN","AHMLDOP1",144,0)\par
 ...I $D(^TMP("LR",$J,LOC,OR)) Q\par
"RTN","AHMLDOP1",145,0)\par
 ...S TEST=$G(^OR(100,OR,4.5,1,1))                ;test\par
"RTN","AHMLDOP1",146,0)\par
 ...S ODATE=$$DATE($$FMTE^XLFDT(LRDT))            ;order date/time\par
"RTN","AHMLDOP1",147,0)\par
 ...S PROV=$$GET1^DIQ(100,OR,1)                   ;provider\par
"RTN","AHMLDOP1",148,0)\par
 ...S PNAME=$$GET1^DIQ(100,OR,.02)                ;patient name\par
"RTN","AHMLDOP1",149,0)\par
 ...S TNAME=$$GET1^DIQ(101.43,TEST,.01)           ;test/procedure name\par
"RTN","AHMLDOP1",150,0)\par
 ...S D0=+$$GET1^DIQ(101.43,TEST,2,"I")           ;D0 rad/nuc #71 file\par
"RTN","AHMLDOP1",151,0)\par
 ...S (ABREV,CPT,ITYPE,IPROC,TMP)=""\par
"RTN","AHMLDOP1",152,0)\par
 ...I D0]"" D\par
"RTN","AHMLDOP1",153,0)\par
 ....S CPT=$$GET1^DIQ(71,D0,9)                    ;CPT code\par
"RTN","AHMLDOP1",154,0)\par
 ....S ITYPE=$$GET1^DIQ(71,D0,12)                 ;Imaging type\par
"RTN","AHMLDOP1",155,0)\par
 ....I ITYPE]"" S TMP=$O(^RA(79.2,"B",ITYPE,""))\par
"RTN","AHMLDOP1",156,0)\par
 ....I TMP]"" S ABREV=$$GET1^DIQ(79.2,TMP,3)      ;Imaging type abbrev\par
"RTN","AHMLDOP1",157,0)\par
 ....S IPROC=$$GET1^DIQ(71,D0,.01)                ;Imaging procedure\par
"RTN","AHMLDOP1",158,0)\par
 ...S STATUS=$$GET1^DIQ(100,OR,5)                 ;status\par
"RTN","AHMLDOP1",159,0)\par
 ...I LRT="2A",$E(STATUS,1)'="C" Q                ;only complete for TAT\par
"RTN","AHMLDOP1",160,0)\par
 ...I STATUS="UNRELEASED" Q                       ;no unreleased\par
"RTN","AHMLDOP1",161,0)\par
 ...S CDATE=$P($$GET1^DIQ(100,OR,33),S,2,3)       ;collect date/time\par
"RTN","AHMLDOP1",162,0)\par
 ...S COLDT=CDATE\par
"RTN","AHMLDOP1",163,0)\par
 ...I CDATE]"",$P(CDATE,S)]"",$P(CDATE,S,2)]"" D\par
"RTN","AHMLDOP1",164,0)\par
 ....S CDATE=$P($G(^LRO(69,$P(CDATE,S),1,$P(CDATE,S,2),1)),U)\par
"RTN","AHMLDOP1",165,0)\par
 ....S COLDT=CDATE\par
"RTN","AHMLDOP1",166,0)\par
 ....S CDATE=$$DATE($$FMTE^XLFDT(CDATE))\par
"RTN","AHMLDOP1",167,0)\par
 ...S RPTDT=$$GET1^DIQ(100,OR,22,"I")             ;report date/time internal\par
"RTN","AHMLDOP1",168,0)\par
 ...I LRT="2A",COLDT="" Q                         ;tat must have collect\par
"RTN","AHMLDOP1",169,0)\par
 ...S TAT="" I LRT="2A" D                         ;turnaround time (minutes)\par
"RTN","AHMLDOP1",170,0)\par
 ....S TAT=$TR($J($$FMDIFF^XLFDT(RPTDT,COLDT,2)/60,50,0)," ","")\par
"RTN","AHMLDOP1",171,0)\par
 ...S RDATE=$$DATE($$GET1^DIQ(100,OR,22,"E"))     ;report date/time\par
"RTN","AHMLDOP1",172,0)\par
 ...I LRT="2A",RDATE="" Q                         ;must have rpt date for tat\par
"RTN","AHMLDOP1",173,0)\par
 ...I LRT=1 D\par
"RTN","AHMLDOP1",174,0)\par
 ....S TMP=ODATE_B_PROV_B_PNAME_B_CPT             ;rad order detail\par
"RTN","AHMLDOP1",175,0)\par
 ....S TMP=TMP_B_ITYPE_B_IPROC_B_$E(STATUS,1)\par
"RTN","AHMLDOP1",176,0)\par
 ...I +LRT=2 D\par
"RTN","AHMLDOP1",177,0)\par
 ....S TMP=ODATE_B_PROV_B_PNAME_B_TNAME           ;lab order detail\par
"RTN","AHMLDOP1",178,0)\par
 ....S TMP=TMP_B_$E(STATUS,1)_B_CDATE_B_RDATE\par
"RTN","AHMLDOP1",179,0)\par
 ....S TMP=TMP_B_TAT\par
"RTN","AHMLDOP1",180,0)\par
 ...I LRT=1,ITYPE]"",ABREV]"" D\par
"RTN","AHMLDOP1",181,0)\par
 ....S ^TMP("LRX",$J,ITYPE)=ABREV                 ;Image type abrev\par
"RTN","AHMLDOP1",182,0)\par
 ...S ^TMP("LR",$J)=$G(^TMP("LR",$J))+1           ;grand total\par
"RTN","AHMLDOP1",183,0)\par
 ...S ^TMP("LR",$J,LOC)=$G(^TMP("LR",$J,LOC))+1   ;location total\par
"RTN","AHMLDOP1",184,0)\par
 ...S ^TMP("LR",$J,LOC,OR)=TMP                    ;order detail\par
"RTN","AHMLDOP1",185,0)\par
 ...S ^TMP("TAT",$J,LOC)=$G(^TMP("TAT",$J,LOC))+TAT   ;tat location total\par
"RTN","AHMLDOP1",186,0)\par
 ...S ^TMP("TAT",$J)=$G(^TMP("TAT",$J))+TAT       ;tat grand total\par
"RTN","AHMLDOP1",187,0)\par
 ;\par
"RTN","AHMLDOP1",188,0)\par
 D HDR\par
"RTN","AHMLDOP1",189,0)\par
 I 'LRDET Q\par
"RTN","AHMLDOP1",190,0)\par
 ;\par
"RTN","AHMLDOP1",191,0)\par
 S (LOC,OR,PLOC)=""\par
"RTN","AHMLDOP1",192,0)\par
 F  S LOC=$O(^TMP("LR",$J,LOC)) Q:LOC=""  D  Q:LREND\par
"RTN","AHMLDOP1",193,0)\par
 .I LOC'=PLOC S PLOC=LOC D SHDR\par
"RTN","AHMLDOP1",194,0)\par
 .F  S OR=$O(^TMP("LR",$J,LOC,OR)) Q:OR=""  D  Q:LREND\par
"RTN","AHMLDOP1",195,0)\par
 ..S DATA=^TMP("LR",$J,LOC,OR)\par
"RTN","AHMLDOP1",196,0)\par
 ..I $Y+2>IOSL D WAIT Q:LREND  D:$E(IOST,1,2)'="C-" HDR D SHDR\par
"RTN","AHMLDOP1",197,0)\par
 ..I LRT=1 D\par
"RTN","AHMLDOP1",198,0)\par
 ...S TMP=$P(DATA,B,5)\par
"RTN","AHMLDOP1",199,0)\par
 ...I TMP]"",$G(^TMP("LRX",$J,TMP))]"" S TMP=^TMP("LRX",$J,TMP)\par
"RTN","AHMLDOP1",200,0)\par
 ...W !,$P($P(DATA,B),"@")\par
"RTN","AHMLDOP1",201,0)\par
 ...W ?10,$E($P(DATA,B,2),1,14),?26,$E($P(DATA,B,3),1,14)\par
"RTN","AHMLDOP1",202,0)\par
 ...W ?42,$E($P(DATA,B,4),1,14),?49,$E(TMP,1,11)\par
"RTN","AHMLDOP1",203,0)\par
 ...W ?55,$E($P(DATA,B,6),1,21),?77,$P(DATA,B,7)\par
"RTN","AHMLDOP1",204,0)\par
 ...W ! I $P(DATA,B)]"" W " @",$P($P(DATA,B),"@",2)\par
"RTN","AHMLDOP1",205,0)\par
 ...W ?10,$E($P(DATA,B,2),15,28),?26,$E($P(DATA,B,3),15,28)\par
"RTN","AHMLDOP1",206,0)\par
 ...W ?42,$E($P(DATA,B,4),15,28),?49,$E(TMP,12,22)\par
"RTN","AHMLDOP1",207,0)\par
 ...W ?55,$E($P(DATA,B,6),22,42)\par
"RTN","AHMLDOP1",208,0)\par
 ..I LRT=2 D\par
"RTN","AHMLDOP1",209,0)\par
 ...W !,$P($P(DATA,B),"@"),?10,$E($P(DATA,B,2),1,14)\par
"RTN","AHMLDOP1",210,0)\par
 ...W ?26,$E($P(DATA,B,3),1,14),?42,$E($P(DATA,B,4),1,14)\par
"RTN","AHMLDOP1",211,0)\par
 ...W ?58,$P(DATA,B,5),?62,$P($P(DATA,B,6),"@")\par
"RTN","AHMLDOP1",212,0)\par
 ...W ?72 I $P(DATA,B,5)'="D" W $P($P(DATA,B,7),"@")\par
"RTN","AHMLDOP1",213,0)\par
 ...W ! I $P(DATA,B)]"" W " @",$P($P(DATA,B),"@",2)\par
"RTN","AHMLDOP1",214,0)\par
 ...W ?10,$E($P(DATA,B,2),15,28),?26,$E($P(DATA,B,3),15,28)\par
"RTN","AHMLDOP1",215,0)\par
 ...W ?42,$E($P(DATA,B,4),15,28)\par
"RTN","AHMLDOP1",216,0)\par
 ...W ?62 I $P(DATA,B,6)]"" W " @",$P($P(DATA,B,6),"@",2)\par
"RTN","AHMLDOP1",217,0)\par
 ...W ?72 I $P(DATA,B,5)'="D",$P(DATA,B,7)]"" D\par
"RTN","AHMLDOP1",218,0)\par
 ....W " @",$P($P(DATA,B,7),"@",2)\par
"RTN","AHMLDOP1",219,0)\par
 ..I LRT="2A" D\par
"RTN","AHMLDOP1",220,0)\par
 ...W !,$P($P(DATA,B),"@"),?9,$E($P(DATA,B,2),1,14)\par
"RTN","AHMLDOP1",221,0)\par
 ...W ?24,$E($P(DATA,B,3),1,14),?39,$E($P(DATA,B,4),1,14)\par
"RTN","AHMLDOP1",222,0)\par
 ...W ?54,$P(DATA,B,5),?57,$P($P(DATA,B,6),"@")\par
"RTN","AHMLDOP1",223,0)\par
 ...W ?66 I $P(DATA,B,5)'="D" W $P($P(DATA,B,7),"@")\par
"RTN","AHMLDOP1",224,0)\par
 ...W ?75,$P(DATA,B,8)\par
"RTN","AHMLDOP1",225,0)\par
 ...W ! I $P(DATA,B)]"" W " @",$P($P(DATA,B),"@",2)\par
"RTN","AHMLDOP1",226,0)\par
 ...W ?9,$E($P(DATA,B,2),15,28),?24,$E($P(DATA,B,3),15,28)\par
"RTN","AHMLDOP1",227,0)\par
 ...W ?39,$E($P(DATA,B,4),15,28)\par
"RTN","AHMLDOP1",228,0)\par
 ...W ?57 I $P(DATA,B,6)]"" W " @",$P($P(DATA,B,6),"@",2)\par
"RTN","AHMLDOP1",229,0)\par
 ...W ?66 I $P(DATA,B,5)'="D",$P(DATA,B,7)]"" D\par
"RTN","AHMLDOP1",230,0)\par
 ....W " @",$P($P(DATA,B,7),"@",2)\par
"RTN","AHMLDOP1",231,0)\par
 ;\par
"RTN","AHMLDOP1",232,0)\par
 Q\par
"RTN","AHMLDOP1",233,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP1",234,0)\par
HDR ; Print header and totals by location.\par
"RTN","AHMLDOP1",235,0)\par
 ;\par
"RTN","AHMLDOP1",236,0)\par
 N L,TC,TM,TTC,TTM\par
"RTN","AHMLDOP1",237,0)\par
 ;\par
"RTN","AHMLDOP1",238,0)\par
 S LRPAG=LRPAG+1\par
"RTN","AHMLDOP1",239,0)\par
 ;\par
"RTN","AHMLDOP1",240,0)\par
 I LRT'="2A" D\par
"RTN","AHMLDOP1",241,0)\par
 .W ?$S(LRT=1:22,1:24),"Remote ",$S(LRT=1:"Radiology",1:"Lab")\par
"RTN","AHMLDOP1",242,0)\par
 .W " Orders by Location"\par
"RTN","AHMLDOP1",243,0)\par
 I LRT="2A" W ?21,"Turnaround Time for Remote Lab Orders"\par
"RTN","AHMLDOP1",244,0)\par
 W ?73,"Page ",LRPAG\par
"RTN","AHMLDOP1",245,0)\par
 W !?23,"From ",$$FMTE^XLFDT(LREDT)," to ",$$FMTE^XLFDT(LRSDT)\par
"RTN","AHMLDOP1",246,0)\par
 W !?22,"Date Printed: ",$$FMTE^XLFDT($$NOW^XLFDT),!\par
"RTN","AHMLDOP1",247,0)\par
 ;\par
"RTN","AHMLDOP1",248,0)\par
 I LRT="2A" D  Q\par
"RTN","AHMLDOP1",249,0)\par
 .W !?5,"Location",?25,"# of Tests",?40,"Total Time",?60,"Average Time"\par
"RTN","AHMLDOP1",250,0)\par
 .W !?5,$TR($J("",68)," ","-")\par
"RTN","AHMLDOP1",251,0)\par
 .S L="",(TTC,TTM)=0\par
"RTN","AHMLDOP1",252,0)\par
 .F  S L=$O(^TMP("LR",$J,L)) Q:L=""  D  Q:LREND\par
"RTN","AHMLDOP1",253,0)\par
 ..S TC=^TMP("LR",$J,L),TM=^TMP("TAT",$J,L)\par
"RTN","AHMLDOP1",254,0)\par
 ..S TTC=TTC+TC,TTM=TTM+TM\par
"RTN","AHMLDOP1",255,0)\par
 ..W !?5,$J(L,15),$TR($J(TC,10)," ","."),?40,TM,?60,$J(TM/TC,10,2)\par
"RTN","AHMLDOP1",256,0)\par
 .W !?5,$TR($J("",68)," ","-")\par
"RTN","AHMLDOP1",257,0)\par
 .W !?5,$J("Totals",15),$TR($J(TTC,10)," ","."),?40,TTM,?60\par
"RTN","AHMLDOP1",258,0)\par
 .W $S(TTC=0:0,1:$J(TTM/TTC,10,2)),!\par
"RTN","AHMLDOP1",259,0)\par
 ;\par
"RTN","AHMLDOP1",260,0)\par
 S L=""\par
"RTN","AHMLDOP1",261,0)\par
 F  S L=$O(^TMP("LR",$J,L)) Q:L=""  D  Q:LREND\par
"RTN","AHMLDOP1",262,0)\par
 .W !?5,$J(L,15),$TR($J(^TMP("LR",$J,L),10)," ",".")\par
"RTN","AHMLDOP1",263,0)\par
 W !?5,$TR($J("",26)," ","-")\par
"RTN","AHMLDOP1",264,0)\par
 W !?5,$J("Total",15),$TR($J(+$G(^TMP("LR",$J)),10)," ","."),!\par
"RTN","AHMLDOP1",265,0)\par
 ;\par
"RTN","AHMLDOP1",266,0)\par
 Q\par
"RTN","AHMLDOP1",267,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP1",268,0)\par
SHDR ; Print sub header.\par
"RTN","AHMLDOP1",269,0)\par
 ;\par
"RTN","AHMLDOP1",270,0)\par
 I $Y+6>IOSL D WAIT Q:LREND  D:$E(IOST,1,2)'="C-" HDR W !\par
"RTN","AHMLDOP1",271,0)\par
 ;\par
"RTN","AHMLDOP1",272,0)\par
 W !!,"==> Performing Location: ",LOC,!\par
"RTN","AHMLDOP1",273,0)\par
 I LRT=1 D                                       ;rad sub header\par
"RTN","AHMLDOP1",274,0)\par
 .W !,"Order",?10,"Provider",?26,"Patient"\par
"RTN","AHMLDOP1",275,0)\par
 .W ?42,"CPT",?49,"Type",?55,"Image Procedure",?77,"St"\par
"RTN","AHMLDOP1",276,0)\par
 .W !,$TR($J("",8)," ","-"),?10,$TR($J("",14)," ","-")\par
"RTN","AHMLDOP1",277,0)\par
 .W ?26,$TR($J("",14)," ","-"),?42,$TR($J("",5)," ","-")\par
"RTN","AHMLDOP1",278,0)\par
 .W ?49,$TR($J("",4)," ","-"),?55,$TR($J("",20)," ","-")\par
"RTN","AHMLDOP1",279,0)\par
 .W ?77,$TR($J("",3)," ","-")\par
"RTN","AHMLDOP1",280,0)\par
 ;\par
"RTN","AHMLDOP1",281,0)\par
 I LRT=2 D                                       ;lab sub header\par
"RTN","AHMLDOP1",282,0)\par
 .W !,"Order",?10,"Provider",?26,"Patient",?42\par
"RTN","AHMLDOP1",283,0)\par
 .W "Test",?58,"St",?62,"Collect",?72,"Report"\par
"RTN","AHMLDOP1",284,0)\par
 .W !,$TR($J("",8)," ","-"),?10,$TR($J("",14)," ","-")\par
"RTN","AHMLDOP1",285,0)\par
 .W ?26,$TR($J("",14)," ","-"),?42,$TR($J("",14)," ","-")\par
"RTN","AHMLDOP1",286,0)\par
 .W ?58,$TR($J("",3)," ","-"),?62,$TR($J("",8)," ","-")\par
"RTN","AHMLDOP1",287,0)\par
 .W ?72,$TR($J("",8)," ","-")\par
"RTN","AHMLDOP1",288,0)\par
 ;\par
"RTN","AHMLDOP1",289,0)\par
 I LRT="2A" D                                       ;lab sub header\par
"RTN","AHMLDOP1",290,0)\par
 .W !,"Order",?9,"Provider",?24,"Patient",?39\par
"RTN","AHMLDOP1",291,0)\par
 .W "Test",?54,"St",?57,"Collect",?66,"Report",?75,"TAT"\par
"RTN","AHMLDOP1",292,0)\par
 .W !,$TR($J("",8)," ","-"),?9,$TR($J("",14)," ","-")\par
"RTN","AHMLDOP1",293,0)\par
 .W ?24,$TR($J("",14)," ","-"),?39,$TR($J("",14)," ","-")\par
"RTN","AHMLDOP1",294,0)\par
 .W ?54,$TR($J("",3)," ","-"),?57,$TR($J("",8)," ","-")\par
"RTN","AHMLDOP1",295,0)\par
 .W ?66,$TR($J("",8)," ","-"),?75,$TR($J("",5)," ","-")\par
"RTN","AHMLDOP1",296,0)\par
 ;\par
"RTN","AHMLDOP1",297,0)\par
 Q\par
"RTN","AHMLDOP1",298,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP1",299,0)\par
DATE(DATE) ; Convert mmm dd, yyyy@hh:mm to mm/dd/yyyy@hh:mm\par
"RTN","AHMLDOP1",300,0)\par
 ;\par
"RTN","AHMLDOP1",301,0)\par
 N DD,DM,DSTR,DY,LOWER,TM,UPPER\par
"RTN","AHMLDOP1",302,0)\par
 ;\par
"RTN","AHMLDOP1",303,0)\par
 I $G(DATE)="" Q ""\par
"RTN","AHMLDOP1",304,0)\par
 ;\par
"RTN","AHMLDOP1",305,0)\par
 S LOWER="abcdefghijklmnopqrstuvwxyz"\par
"RTN","AHMLDOP1",306,0)\par
 S UPPER="ABCDEFGHIJKLMNOPQRSTUVWXYZ"\par
"RTN","AHMLDOP1",307,0)\par
 S DSTR("JAN")="01",DSTR("FEB")="02",DSTR("MAR")="03",DSTR("APR")="04"\par
"RTN","AHMLDOP1",308,0)\par
 S DSTR("MAY")="05",DSTR("JUN")="06",DSTR("JUL")="07",DSTR("AUG")="08"\par
"RTN","AHMLDOP1",309,0)\par
 S DSTR("SEP")="09",DSTR("OCT")=10,DSTR("NOV")=11,DSTR("DEC")=12\par
"RTN","AHMLDOP1",310,0)\par
 ;\par
"RTN","AHMLDOP1",311,0)\par
 S DM=$TR($P(DATE," "),LOWER,UPPER),DD=$P($P(DATE," ",2),",")\par
"RTN","AHMLDOP1",312,0)\par
 S DY=$E($P($P(DATE," ",3),"@"),3,4),TM=$P($P(DATE,"@",2),":",1,2)\par
"RTN","AHMLDOP1",313,0)\par
 ;\par
"RTN","AHMLDOP1",314,0)\par
 Q DSTR(DM)_"/"_DD_"/"_DY_"@"_TM\par
"RTN","AHMLDOP1",315,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP1",316,0)\par
WAIT ; Pause for page breaks.\par
"RTN","AHMLDOP1",317,0)\par
 ;\par
"RTN","AHMLDOP1",318,0)\par
 K DIR\par
"RTN","AHMLDOP1",319,0)\par
 S DIR(0)="E"\par
"RTN","AHMLDOP1",320,0)\par
 D ^DIR\par
"RTN","AHMLDOP1",321,0)\par
 S:($D(DUOUT))!($D(DTOUT)) LREND=1\par
"RTN","AHMLDOP1",322,0)\par
 S $Y=1\par
"RTN","AHMLDOP1",323,0)\par
 ;\par
"RTN","AHMLDOP1",324,0)\par
 Q\par
"RTN","AHMLDOP2")\par
0^15^B169259843\par
"RTN","AHMLDOP2",1,0)\par
AHMLDOP2 ;LEIDOS/TCK - REMOTE ORDERING - REMOTE LAB/RAD ORDERS BY TEST/IMAGE ; 10/16/16 8:58pm\par
"RTN","AHMLDOP2",2,0)\par
 ;;1.0;REMOTE ORDERS;;OCT 1,2016;Build 26\par
"RTN","AHMLDOP2",3,0)\par
 ;\par
"RTN","AHMLDOP2",4,0)\par
 Q\par
"RTN","AHMLDOP2",5,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",6,0)\par
LAB ; Entry point for Remote Laboratory Orders by Test Name.\par
"RTN","AHMLDOP2",7,0)\par
 ;\par
"RTN","AHMLDOP2",8,0)\par
 S LRT=2,XREF="AF"\par
"RTN","AHMLDOP2",9,0)\par
 ;\par
"RTN","AHMLDOP2",10,0)\par
 D INIT,GDT:'LREND,TEST:'LREND,LOC:'LREND,DETAIL:'LREND\par
"RTN","AHMLDOP2",11,0)\par
 D GDV:'LREND,RUN:'LREND,STOP\par
"RTN","AHMLDOP2",12,0)\par
 ;\par
"RTN","AHMLDOP2",13,0)\par
 Q\par
"RTN","AHMLDOP2",14,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",15,0)\par
RAD ; Entry point for Remote Radiology Orders by Image Type.\par
"RTN","AHMLDOP2",16,0)\par
 ;\par
"RTN","AHMLDOP2",17,0)\par
 S LRT=1,XREF="AF"\par
"RTN","AHMLDOP2",18,0)\par
 ;\par
"RTN","AHMLDOP2",19,0)\par
 D INIT,GDT:'LREND,IMAGE:'LREND,LOC:'LREND,DETAIL:'LREND\par
"RTN","AHMLDOP2",20,0)\par
 D GDV:'LREND,RUN:'LREND,STOP\par
"RTN","AHMLDOP2",21,0)\par
 ;\par
"RTN","AHMLDOP2",22,0)\par
 Q\par
"RTN","AHMLDOP2",23,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",24,0)\par
RADC ; Entry point for Remote Radiology Orders by CPT Code.\par
"RTN","AHMLDOP2",25,0)\par
 ;\par
"RTN","AHMLDOP2",26,0)\par
 S LRT="1A",XREF="AF"\par
"RTN","AHMLDOP2",27,0)\par
 ;\par
"RTN","AHMLDOP2",28,0)\par
 D INIT,GDT:'LREND,CPT:'LREND,LOC:'LREND,DETAIL:'LREND\par
"RTN","AHMLDOP2",29,0)\par
 D GDV:'LREND,RUN:'LREND,STOP\par
"RTN","AHMLDOP2",30,0)\par
 ;\par
"RTN","AHMLDOP2",31,0)\par
 Q\par
"RTN","AHMLDOP2",32,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",33,0)\par
RADCR ; Entry point for Remote Radiology Orders by CPT Code and RVU.\par
"RTN","AHMLDOP2",34,0)\par
 ;\par
"RTN","AHMLDOP2",35,0)\par
 S LRT="1B",XREF="AF",LRTEST="*"\par
"RTN","AHMLDOP2",36,0)\par
 ;\par
"RTN","AHMLDOP2",37,0)\par
 D INIT,GDT:'LREND,LOC:'LREND,DETAIL:'LREND,GDV:'LREND,RUN:'LREND,STOP\par
"RTN","AHMLDOP2",38,0)\par
 ;\par
"RTN","AHMLDOP2",39,0)\par
 Q\par
"RTN","AHMLDOP2",40,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",41,0)\par
INIT ; Initialize common variables.\par
"RTN","AHMLDOP2",42,0)\par
 ;\par
"RTN","AHMLDOP2",43,0)\par
 S U="^",B="|",S=";"\par
"RTN","AHMLDOP2",44,0)\par
 S LREND=0,LRSDT="TODAY",LREDT="T-7"\par
"RTN","AHMLDOP2",45,0)\par
 W !,"REMOTE ORDERS - Remote ",$S(LRT=1:"Radiology",1:"Lab")\par
"RTN","AHMLDOP2",46,0)\par
 W " Orders by "_$S(LRT=2:"Test Name",LRT=1:"Imaging Type",1:"CPT Code")\par
"RTN","AHMLDOP2",47,0)\par
 I LRT="1B" W " and wRVU"\par
"RTN","AHMLDOP2",48,0)\par
 ;\par
"RTN","AHMLDOP2",49,0)\par
 Q\par
"RTN","AHMLDOP2",50,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",51,0)\par
RUN ; Run the report either queued or in person.\par
"RTN","AHMLDOP2",52,0)\par
 ;\par
"RTN","AHMLDOP2",53,0)\par
 K ^TMP("LR",$J)\par
"RTN","AHMLDOP2",54,0)\par
 S:$D(ZTQUEUED) ZTREQ="@" U IO\par
"RTN","AHMLDOP2",55,0)\par
 S (LRPAG,LREND)=0\par
"RTN","AHMLDOP2",56,0)\par
 D:'LREND START\par
"RTN","AHMLDOP2",57,0)\par
 D:$D(ZTQUEUED) STOP\par
"RTN","AHMLDOP2",58,0)\par
 ;\par
"RTN","AHMLDOP2",59,0)\par
 Q\par
"RTN","AHMLDOP2",60,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",61,0)\par
STOP ; End and cleanup.\par
"RTN","AHMLDOP2",62,0)\par
 ;\par
"RTN","AHMLDOP2",63,0)\par
 I ($E(IOST,1,2)="C-") D WAIT\par
"RTN","AHMLDOP2",64,0)\par
 I '$D(ZTQUEUED) D ^%ZISC\par
"RTN","AHMLDOP2",65,0)\par
 K ^TMP("LR",$J),^TMP("LRTEST",$J),^TMP("LRX",$J),^TMP("LRCPT",$J)\par
"RTN","AHMLDOP2",66,0)\par
 K %DT,B,DATA1,DD,DM,DSTR,DTOUT,DUOUT,DY\par
"RTN","AHMLDOP2",67,0)\par
 K LRDET,LREDT,LREND,LRLOC,LRPAG,LRSDT,LRTEST\par
"RTN","AHMLDOP2",68,0)\par
 K OR,PLOC,POP,S,X,XREF,Y,ZTDESC,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE\par
"RTN","AHMLDOP2",69,0)\par
 ;\par
"RTN","AHMLDOP2",70,0)\par
 Q\par
"RTN","AHMLDOP2",71,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",72,0)\par
GDT ; Get dates (start and end).\par
"RTN","AHMLDOP2",73,0)\par
 ;\par
"RTN","AHMLDOP2",74,0)\par
 I LRSDT?1.7N S Y=LRSDT D DD^LRX S LRSDT=Y\par
"RTN","AHMLDOP2",75,0)\par
 I LREDT?1.7N S Y=LREDT D DD^LRX S LREDT=Y\par
"RTN","AHMLDOP2",76,0)\par
 S %DT("A")="Enter START date: ",%DT("B")=LRSDT,%DT="AET"\par
"RTN","AHMLDOP2",77,0)\par
 D ^%DT S LREND=Y<1 Q:LREND\par
"RTN","AHMLDOP2",78,0)\par
 S LRSDT=Y\par
"RTN","AHMLDOP2",79,0)\par
 S %DT("A")="Enter END date: ",%DT("B")=LREDT\par
"RTN","AHMLDOP2",80,0)\par
 D ^%DT S LREND=Y<1 Q:LREND\par
"RTN","AHMLDOP2",81,0)\par
 S LREDT=Y\par
"RTN","AHMLDOP2",82,0)\par
 S:LREDT>LRSDT X=LREDT,LREDT=LRSDT,LRSDT=X\par
"RTN","AHMLDOP2",83,0)\par
 ;\par
"RTN","AHMLDOP2",84,0)\par
 Q\par
"RTN","AHMLDOP2",85,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",86,0)\par
GDV ; Get output device.\par
"RTN","AHMLDOP2",87,0)\par
 ;\par
"RTN","AHMLDOP2",88,0)\par
 S %ZIS="Q" D ^%ZIS K %ZIS I POP S LREND=1 Q\par
"RTN","AHMLDOP2",89,0)\par
 I $D(IO("Q")) D\par
"RTN","AHMLDOP2",90,0)\par
 .K IO("Q")\par
"RTN","AHMLDOP2",91,0)\par
 .S LREND=1,ZTRTN="RUN^AHMLDOP2",ZTDESC="Lab Special Report"\par
"RTN","AHMLDOP2",92,0)\par
 .S ZTSAVE("LR*")=""\par
"RTN","AHMLDOP2",93,0)\par
 .D ^%ZTLOAD\par
"RTN","AHMLDOP2",94,0)\par
 ;\par
"RTN","AHMLDOP2",95,0)\par
 Q\par
"RTN","AHMLDOP2",96,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",97,0)\par
LOC ; Get the locations to run report for.  Default "ALL".\par
"RTN","AHMLDOP2",98,0)\par
 ;\par
"RTN","AHMLDOP2",99,0)\par
 N I,J,LOC\par
"RTN","AHMLDOP2",100,0)\par
 ;\par
"RTN","AHMLDOP2",101,0)\par
 I '$D(^DIC(4,"E")) D  Q\par
"RTN","AHMLDOP2",102,0)\par
 .S LRLOC=B_$$NAME^XUAF4($$KSP^XUPARAM("INST"))_B\par
"RTN","AHMLDOP2",103,0)\par
 .S LRLOC=B_^ZTMP("AHMLDOP1_LOCATION")_B   ;[temp until configuration complete then remove]\par
"RTN","AHMLDOP2",104,0)\par
 ;\par
"RTN","AHMLDOP2",105,0)\par
 K DIR\par
"RTN","AHMLDOP2",106,0)\par
 S DIR("B")="ALL",DIR("A")="Location",DIR(0)="S^1:ALL;",I=""\par
"RTN","AHMLDOP2",107,0)\par
 S LOC(1)="ALL",DIR("?")="Select Location"\par
"RTN","AHMLDOP2",108,0)\par
 ;\par
"RTN","AHMLDOP2",109,0)\par
 F J=2:1 S I=$O(^DIC(4,"E",I)) Q:I=""  D\par
"RTN","AHMLDOP2",110,0)\par
 .S LOC=$$GET1^DIQ(4,I,.01),LOC(J)=LOC\par
"RTN","AHMLDOP2",111,0)\par
 .S DIR(0)=DIR(0)_J_":"_$$GET1^DIQ(4,I,.01)_";",LOC(J)=LOC\par
"RTN","AHMLDOP2",112,0)\par
 ;\par
"RTN","AHMLDOP2",113,0)\par
 D ^DIR\par
"RTN","AHMLDOP2",114,0)\par
 S:($D(DUOUT))!($D(DTOUT)) LREND=1\par
"RTN","AHMLDOP2",115,0)\par
 I 'LREND D\par
"RTN","AHMLDOP2",116,0)\par
 .I LOC(Y)'="ALL" D  Q\par
"RTN","AHMLDOP2",117,0)\par
 ..S LRLOC=B_LOC(Y)_B\par
"RTN","AHMLDOP2",118,0)\par
 .S I="",LRLOC=B\par
"RTN","AHMLDOP2",119,0)\par
 .F  S I=$O(^DIC(4,"E",I)) Q:I=""  S LRLOC=LRLOC_$$GET1^DIQ(4,I,.01)_B\par
"RTN","AHMLDOP2",120,0)\par
 ;\par
"RTN","AHMLDOP2",121,0)\par
 Q\par
"RTN","AHMLDOP2",122,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",123,0)\par
TEST ; Prompt for lab test(s) to be included (<Return> for all).\par
"RTN","AHMLDOP2",124,0)\par
 ;\par
"RTN","AHMLDOP2",125,0)\par
 N STOP\par
"RTN","AHMLDOP2",126,0)\par
 ;\par
"RTN","AHMLDOP2",127,0)\par
 K DIC,^TMP("LRTEST",$J)\par
"RTN","AHMLDOP2",128,0)\par
 W !!,"Press <Enter> at LABORATORY TEST NAME Prompt to select All Tests",!\par
"RTN","AHMLDOP2",129,0)\par
 S DIC="^LAB(60,",DIC(0)="AEMOQ",STOP=0\par
"RTN","AHMLDOP2",130,0)\par
 S DIC("S")="I $P(^(0),U,4)[""CH"",""BO""[$P(^(0),U,3)"\par
"RTN","AHMLDOP2",131,0)\par
 ;\par
"RTN","AHMLDOP2",132,0)\par
 F  D  Q:STOP!(LREND)\par
"RTN","AHMLDOP2",133,0)\par
 .D ^DIC\par
"RTN","AHMLDOP2",134,0)\par
 .I X["^" S LREND=1 Q\par
"RTN","AHMLDOP2",135,0)\par
 .I Y>0 S ^TMP("LRTEST",$J,$P(Y,U,2))=""\par
"RTN","AHMLDOP2",136,0)\par
 .I Y<0 S STOP=1 Q\par
"RTN","AHMLDOP2",137,0)\par
 ;\par
"RTN","AHMLDOP2",138,0)\par
 I '$D(^TMP("LRTEST",$J)) S LRTEST="*" W "ALL Tests Selected"\par
"RTN","AHMLDOP2",139,0)\par
 E  S LRTEST=""\par
"RTN","AHMLDOP2",140,0)\par
 ;\par
"RTN","AHMLDOP2",141,0)\par
 Q\par
"RTN","AHMLDOP2",142,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",143,0)\par
IMAGE ; Prompt for rad image type(s) to be included (<Return> for all).\par
"RTN","AHMLDOP2",144,0)\par
 ;\par
"RTN","AHMLDOP2",145,0)\par
 N STOP\par
"RTN","AHMLDOP2",146,0)\par
 ;\par
"RTN","AHMLDOP2",147,0)\par
 K DIC,^TMP("LRTEST",$J)\par
"RTN","AHMLDOP2",148,0)\par
 W !!,"Press <Enter> at IMAGE TYPE Prompt to select All Tests",!\par
"RTN","AHMLDOP2",149,0)\par
 S DIC="^RA(79.2,",DIC(0)="AEMOQ",STOP=0,DIC("A")="IMAGE TYPE: "\par
"RTN","AHMLDOP2",150,0)\par
 ;\par
"RTN","AHMLDOP2",151,0)\par
 F  D  Q:STOP!(LREND)\par
"RTN","AHMLDOP2",152,0)\par
 .D ^DIC\par
"RTN","AHMLDOP2",153,0)\par
 .I X["^" S LREND=1 Q\par
"RTN","AHMLDOP2",154,0)\par
 .I Y>0 S ^TMP("LRTEST",$J,$P(Y,U,2))=""\par
"RTN","AHMLDOP2",155,0)\par
 .I Y<0 S STOP=1 Q\par
"RTN","AHMLDOP2",156,0)\par
 ;\par
"RTN","AHMLDOP2",157,0)\par
 I '$D(^TMP("LRTEST",$J)) S LRTEST="*" W "ALL Image Types Selected"\par
"RTN","AHMLDOP2",158,0)\par
 E  S LRTEST=""\par
"RTN","AHMLDOP2",159,0)\par
 ;\par
"RTN","AHMLDOP2",160,0)\par
 Q\par
"RTN","AHMLDOP2",161,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",162,0)\par
CPT ; Prompt for CPT Code(s) to be included (<Return> for all).\par
"RTN","AHMLDOP2",163,0)\par
 ;\par
"RTN","AHMLDOP2",164,0)\par
 N STOP\par
"RTN","AHMLDOP2",165,0)\par
 ;\par
"RTN","AHMLDOP2",166,0)\par
 K DIC,^TMP("LRCPT",$J)\par
"RTN","AHMLDOP2",167,0)\par
 W !!,"Press <Enter> at CPT CODE Prompt to select All Tests",!\par
"RTN","AHMLDOP2",168,0)\par
 S DIC="^ICPT(",DIC(0)="AEMOQ",STOP=0,DIC("A")="CPT CODE: "\par
"RTN","AHMLDOP2",169,0)\par
 ;\par
"RTN","AHMLDOP2",170,0)\par
 F  D  Q:STOP!(LREND)\par
"RTN","AHMLDOP2",171,0)\par
 .D ^DIC\par
"RTN","AHMLDOP2",172,0)\par
 .I X["^" S LREND=1 Q\par
"RTN","AHMLDOP2",173,0)\par
 .I Y>0 S ^TMP("LRCPT",$J,$P(Y,U,2))=""\par
"RTN","AHMLDOP2",174,0)\par
 .I Y<0 S STOP=1 Q\par
"RTN","AHMLDOP2",175,0)\par
 ;\par
"RTN","AHMLDOP2",176,0)\par
 I '$D(^TMP("LRCPT",$J)) S LRTEST="*" W "ALL CPT Codes Selected"\par
"RTN","AHMLDOP2",177,0)\par
 E  S LRTEST=""\par
"RTN","AHMLDOP2",178,0)\par
 ;\par
"RTN","AHMLDOP2",179,0)\par
 Q\par
"RTN","AHMLDOP2",180,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",181,0)\par
DETAIL ; Include detail?  (1=yes, 0=no).  Default "NO".\par
"RTN","AHMLDOP2",182,0)\par
 ;\par
"RTN","AHMLDOP2",183,0)\par
 K DIR\par
"RTN","AHMLDOP2",184,0)\par
 S DIR("B")="NO",DIR("A")="Include a Detailed Report?",DIR(0)="S^1:NO;2:YES"\par
"RTN","AHMLDOP2",185,0)\par
 ;\par
"RTN","AHMLDOP2",186,0)\par
 D ^DIR\par
"RTN","AHMLDOP2",187,0)\par
 S:($D(DUOUT))!($D(DTOUT)) LREND=1 S:'LREND LRDET=Y-1 Q\par
"RTN","AHMLDOP2",188,0)\par
 ;\par
"RTN","AHMLDOP2",189,0)\par
 Q\par
"RTN","AHMLDOP2",190,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",191,0)\par
START ; Produce report looping through OR(100 data.\par
"RTN","AHMLDOP2",192,0)\par
 ;\par
"RTN","AHMLDOP2",193,0)\par
 ;   Input: LRSDT - Start date\par
"RTN","AHMLDOP2",194,0)\par
 ;          LREDT - End date\par
"RTN","AHMLDOP2",195,0)\par
 ;          LRLOC - Location(s) [|loc1|loc2|...]\par
"RTN","AHMLDOP2",196,0)\par
 ;          LRDET - Detail      [0=No, 1=Yes]\par
"RTN","AHMLDOP2",197,0)\par
 ;\par
"RTN","AHMLDOP2",198,0)\par
 ;  Output: Report.\par
"RTN","AHMLDOP2",199,0)\par
 ;\par
"RTN","AHMLDOP2",200,0)\par
 N ABREV,CDATE,CPT,D0,DATA,IPROC,ITYPE,LOC,LRDT,LRDT1,ODATE,OR,OR1\par
"RTN","AHMLDOP2",201,0)\par
 N PNAME,PROV,RDATE,STATUS,TEST,TMP,TNAME\par
"RTN","AHMLDOP2",202,0)\par
 ;\par
"RTN","AHMLDOP2",203,0)\par
 S LRDT=(LREDT-1)+.999999,LRDT1=LRSDT+.999999\par
"RTN","AHMLDOP2",204,0)\par
 ;\par
"RTN","AHMLDOP2",205,0)\par
 F  S LRDT=$O(^OR(100,XREF,LRDT)) Q:LRDT=""!(LRDT>LRDT1)  D\par
"RTN","AHMLDOP2",206,0)\par
 .S OR="" F  S OR=$O(^OR(100,XREF,LRDT,OR)) Q:OR=""  D\par
"RTN","AHMLDOP2",207,0)\par
 ..I +$P($G(^OR(100,OR,0)),U,5)'=+LRT Q           ;not a lab/rad test\par
"RTN","AHMLDOP2",208,0)\par
 ..I '$D(^OR(100,OR,4.5)) Q\par
"RTN","AHMLDOP2",209,0)\par
 ..S OR1="" F  S OR1=$O(^OR(100,OR,4.5,OR1)) Q:OR1=""  D\par
"RTN","AHMLDOP2",210,0)\par
 ...S DATA=$G(^OR(100,OR,4.5,OR1,0))\par
"RTN","AHMLDOP2",211,0)\par
 ...I $P(DATA,U,4)'="Location" Q\par
"RTN","AHMLDOP2",212,0)\par
 ...S LOC=$G(^OR(100,OR,4.5,OR1,1)) Q:LOC=""\par
"RTN","AHMLDOP2",213,0)\par
 ...I LRLOC'[(B_LOC_B) Q\par
"RTN","AHMLDOP2",214,0)\par
 ...I $D(^TMP("LR",$J,LOC,OR)) Q\par
"RTN","AHMLDOP2",215,0)\par
 ...S TEST=$G(^OR(100,OR,4.5,1,1))                ;test\par
"RTN","AHMLDOP2",216,0)\par
 ...S ODATE=$$DATE($$FMTE^XLFDT(LRDT))            ;order date/time\par
"RTN","AHMLDOP2",217,0)\par
 ...S PROV=$$GET1^DIQ(100,OR,1)                   ;provider\par
"RTN","AHMLDOP2",218,0)\par
 ...S PNAME=$$GET1^DIQ(100,OR,.02)                ;patient name\par
"RTN","AHMLDOP2",219,0)\par
 ...S TNAME=$$GET1^DIQ(101.43,TEST,.01)           ;test/procedure name\par
"RTN","AHMLDOP2",220,0)\par
 ...S D0=+$$GET1^DIQ(101.43,TEST,2,"I")           ;D0 rad/nuc #71 file\par
"RTN","AHMLDOP2",221,0)\par
 ...S (ABREV,CPT,ITYPE,IPROC,TMP)=""\par
"RTN","AHMLDOP2",222,0)\par
 ...I D0]"" D\par
"RTN","AHMLDOP2",223,0)\par
 ....S CPT=$$GET1^DIQ(71,D0,9)                    ;CPT code\par
"RTN","AHMLDOP2",224,0)\par
 ....S ITYPE=$$GET1^DIQ(71,D0,12)                 ;Imaging type\par
"RTN","AHMLDOP2",225,0)\par
 ....I ITYPE]"" S TMP=$O(^RA(79.2,"B",ITYPE,""))\par
"RTN","AHMLDOP2",226,0)\par
 ....I TMP]"" S ABREV=$$GET1^DIQ(79.2,TMP,3)      ;Imaging type abbrev\par
"RTN","AHMLDOP2",227,0)\par
 ....S IPROC=$$GET1^DIQ(71,D0,.01)                ;Imaging procedure\par
"RTN","AHMLDOP2",228,0)\par
 ...S STATUS=$$GET1^DIQ(100,OR,5)                 ;status\par
"RTN","AHMLDOP2",229,0)\par
 ...I STATUS="UNRELEASED" Q                       ;no unreleased\par
"RTN","AHMLDOP2",230,0)\par
 ...S CDATE=$P($$GET1^DIQ(100,OR,33),S,2,3)       ;collect date/time\par
"RTN","AHMLDOP2",231,0)\par
 ...I CDATE]"",$P(CDATE,S)]"",$P(CDATE,S,2)]"" D\par
"RTN","AHMLDOP2",232,0)\par
 ....S CDATE=$P($G(^LRO(69,$P(CDATE,S),1,$P(CDATE,S,2),1)),U)\par
"RTN","AHMLDOP2",233,0)\par
 ....S CDATE=$$DATE($$FMTE^XLFDT(CDATE))\par
"RTN","AHMLDOP2",234,0)\par
 ...S RDATE=$$DATE($$GET1^DIQ(100,OR,22,"E"))     ;report date/time\par
"RTN","AHMLDOP2",235,0)\par
 ...I LRT="1B",RDATE="" Q                         ;CPT wRVU only reported\par
"RTN","AHMLDOP2",236,0)\par
 ...I LRT="1B",$E(STATUS,1)="D" Q                 ;         and no deleted\par
"RTN","AHMLDOP2",237,0)\par
 ...I +LRT=1 D\par
"RTN","AHMLDOP2",238,0)\par
 ....S TMP=$S(LRT="1B":RDATE,1:ODATE)_B_PROV      ;rad order detail\par
"RTN","AHMLDOP2",239,0)\par
 ....S TMP=TMP_B_PNAME_B_CPT_B_ITYPE\par
"RTN","AHMLDOP2",240,0)\par
 ....S TMP=TMP_B_IPROC_B_$E(STATUS,1)\par
"RTN","AHMLDOP2",241,0)\par
 ....S TNAME=ITYPE\par
"RTN","AHMLDOP2",242,0)\par
 ...I LRT=2 D\par
"RTN","AHMLDOP2",243,0)\par
 ....S TMP=ODATE_B_PROV_B_PNAME_B_TNAME           ;lab report detail\par
"RTN","AHMLDOP2",244,0)\par
 ....S TMP=TMP_B_$E(STATUS,1)_B_CDATE_B_RDATE\par
"RTN","AHMLDOP2",245,0)\par
 ...I LRT'="1A",LRT'="1B",TNAME]"",$D(^TMP("LRTEST",$J,TNAME))!(LRTEST="*") D\par
"RTN","AHMLDOP2",246,0)\par
 ....S ^TMP("LRTEST",$J)=$I(^TMP("LRTEST",$J))              ;total\par
"RTN","AHMLDOP2",247,0)\par
 ....S ^TMP("LRTEST",$J,TNAME)=$I(^TMP("LRTEST",$J,TNAME))  ;total by test\par
"RTN","AHMLDOP2",248,0)\par
 ...I +LRT=1,TNAME]"",ABREV]"" D\par
"RTN","AHMLDOP2",249,0)\par
 ....S ^TMP("LRX",$J,TNAME)=ABREV                           ;Image type abrev\par
"RTN","AHMLDOP2",250,0)\par
 ...I LRT'="1A",LRT'="1B",TNAME]"",'$D(^TMP("LRTEST",$J,TNAME)),LRTEST'="*" Q   ;test not selected\par
"RTN","AHMLDOP2",251,0)\par
 ...I (LRT="1A"!(LRT="1B")),IPROC]"" S:CPT="" CPT="NONE" D\par
"RTN","AHMLDOP2",252,0)\par
 ....I LRTEST'="*",'$D(^TMP("LRCPT",$J,CPT)) Q\par
"RTN","AHMLDOP2",253,0)\par
 ....S ^TMP("LRTEST",$J)=$I(^TMP("LRTEST",$J))                      ;Total\par
"RTN","AHMLDOP2",254,0)\par
 ....S ^TMP("LRTEST",$J,CPT,IPROC)=$I(^TMP("LRTEST",$J,CPT,IPROC))  ;total by CPT\par
"RTN","AHMLDOP2",255,0)\par
 ...I LRT="1A",LRTEST'="*",CPT]"",'$D(^TMP("LRCPT",$J,CPT)) Q       ;not a CPT to total\par
"RTN","AHMLDOP2",256,0)\par
 ...I LRT="1A",CPT="",LRTEST'="*" Q\par
"RTN","AHMLDOP2",257,0)\par
 ...S ^TMP("LR",$J)=$G(^TMP("LR",$J))+1                     ;grand total\par
"RTN","AHMLDOP2",258,0)\par
 ...S ^TMP("LR",$J,LOC)=$G(^TMP("LR",$J,LOC))+1             ;location total\par
"RTN","AHMLDOP2",259,0)\par
 ...S ^TMP("LR",$J,LOC,OR)=TMP                              ;order detail\par
"RTN","AHMLDOP2",260,0)\par
 ;\par
"RTN","AHMLDOP2",261,0)\par
 I '$D(^TMP("LR",$J)) D  Q                                  ;nothing matching criteria\par
"RTN","AHMLDOP2",262,0)\par
 .W !!,"No data found matching prescribed criteria.",!\par
"RTN","AHMLDOP2",263,0)\par
 D HDR\par
"RTN","AHMLDOP2",264,0)\par
 I 'LRDET Q\par
"RTN","AHMLDOP2",265,0)\par
 ;\par
"RTN","AHMLDOP2",266,0)\par
 S (LOC,OR,PLOC)=""\par
"RTN","AHMLDOP2",267,0)\par
 F  S LOC=$O(^TMP("LR",$J,LOC)) Q:LOC=""  D  Q:LREND\par
"RTN","AHMLDOP2",268,0)\par
 .I LOC'=PLOC S PLOC=LOC D SHDR\par
"RTN","AHMLDOP2",269,0)\par
 .F  S OR=$O(^TMP("LR",$J,LOC,OR)) Q:OR=""  D  Q:LREND\par
"RTN","AHMLDOP2",270,0)\par
 ..S DATA=^TMP("LR",$J,LOC,OR)\par
"RTN","AHMLDOP2",271,0)\par
 ..I DATA="" Q\par
"RTN","AHMLDOP2",272,0)\par
 ..I $Y+2>IOSL D WAIT Q:LREND  D:$E(IOST,1,2)'="C-" HDR D SHDR\par
"RTN","AHMLDOP2",273,0)\par
 ..I +LRT=1 D\par
"RTN","AHMLDOP2",274,0)\par
 ...S TMP=$P(DATA,B,5)\par
"RTN","AHMLDOP2",275,0)\par
 ...I TMP]"",$G(^TMP("LRX",$J,TMP))]"" S TMP=^TMP("LRX",$J,TMP)\par
"RTN","AHMLDOP2",276,0)\par
 ...W !,$P($P(DATA,B),"@")\par
"RTN","AHMLDOP2",277,0)\par
 ...W ?10,$E($P(DATA,B,2),1,14),?26,$E($P(DATA,B,3),1,14)\par
"RTN","AHMLDOP2",278,0)\par
 ...W ?42,$E($P(DATA,B,4),1,14),?49,$E(TMP,1,11)\par
"RTN","AHMLDOP2",279,0)\par
 ...W ?55,$E($P(DATA,B,6),1,21),?77,$P(DATA,B,7)\par
"RTN","AHMLDOP2",280,0)\par
 ...W ! I $P(DATA,B)]"" W " @",$P($P(DATA,B),"@",2)\par
"RTN","AHMLDOP2",281,0)\par
 ...W ?10,$E($P(DATA,B,2),15,28),?26,$E($P(DATA,B,3),15,28)\par
"RTN","AHMLDOP2",282,0)\par
 ...W ?42,$E($P(DATA,B,4),15,28),?49,$E(TMP,12,22)\par
"RTN","AHMLDOP2",283,0)\par
 ...W ?55,$E($P(DATA,B,6),22,42)\par
"RTN","AHMLDOP2",284,0)\par
 ..I LRT=2 D\par
"RTN","AHMLDOP2",285,0)\par
 ...W !,$P($P(DATA,B),"@"),?10,$E($P(DATA,B,2),1,14)\par
"RTN","AHMLDOP2",286,0)\par
 ...W ?26,$E($P(DATA,B,3),1,14),?42,$E($P(DATA,B,4),1,14)\par
"RTN","AHMLDOP2",287,0)\par
 ...W ?58,$P(DATA,B,5),?62,$P($P(DATA,B,6),"@")\par
"RTN","AHMLDOP2",288,0)\par
 ...W ?72 I $P(DATA,B,5)'="D" W $P($P(DATA,B,7),"@")\par
"RTN","AHMLDOP2",289,0)\par
 ...W ! I $P(DATA,B)]"" W " @",$P($P(DATA,B),"@",2)\par
"RTN","AHMLDOP2",290,0)\par
 ...W ?10,$E($P(DATA,B,2),15,28),?26,$E($P(DATA,B,3),15,28)\par
"RTN","AHMLDOP2",291,0)\par
 ...W ?42,$E($P(DATA,B,4),15,28)\par
"RTN","AHMLDOP2",292,0)\par
 ...W ?62 I $P(DATA,B,6)]"" W " @",$P($P(DATA,B,6),"@",2)\par
"RTN","AHMLDOP2",293,0)\par
 ...W ?72 I $P(DATA,B,5)'="D",$P(DATA,B,7)]"" D\par
"RTN","AHMLDOP2",294,0)\par
 ....W " @",$P($P(DATA,B,7),"@",2)\par
"RTN","AHMLDOP2",295,0)\par
 ;\par
"RTN","AHMLDOP2",296,0)\par
 Q\par
"RTN","AHMLDOP2",297,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",298,0)\par
HDR ; Print header and totals by location.\par
"RTN","AHMLDOP2",299,0)\par
 ;\par
"RTN","AHMLDOP2",300,0)\par
 N EXAM,GTWRVU,L,NAME,TEXAM,TWRVU,WRVU\par
"RTN","AHMLDOP2",301,0)\par
 ;\par
"RTN","AHMLDOP2",302,0)\par
 S LRPAG=LRPAG+1\par
"RTN","AHMLDOP2",303,0)\par
 ;\par
"RTN","AHMLDOP2",304,0)\par
 W ?$S(LRT=2:24,LRT=1:20,LRT="1B":18,1:22),"Remote "\par
"RTN","AHMLDOP2",305,0)\par
 W $S(LRT=2:"Lab",1:"Radiology")," Orders by "\par
"RTN","AHMLDOP2",306,0)\par
 W $S(LRT=2:"Test Name",LRT=1:"Imaging Type",1:"CPT Code")\par
"RTN","AHMLDOP2",307,0)\par
 I LRT="1B" W " and wRVU"\par
"RTN","AHMLDOP2",308,0)\par
 W ?73,"Page ",LRPAG\par
"RTN","AHMLDOP2",309,0)\par
 W !?23,"From ",$$FMTE^XLFDT(LREDT)," to ",$$FMTE^XLFDT(LRSDT)\par
"RTN","AHMLDOP2",310,0)\par
 W !?22,"Date Printed: ",$$FMTE^XLFDT($$NOW^XLFDT),!\par
"RTN","AHMLDOP2",311,0)\par
 ;\par
"RTN","AHMLDOP2",312,0)\par
 I LRT="1A" D  Q\par
"RTN","AHMLDOP2",313,0)\par
 .W !?5,"CPT",?12,"Procedure",?50,"Total"\par
"RTN","AHMLDOP2",314,0)\par
 .W !?5,$TR($J("",65)," ","-")\par
"RTN","AHMLDOP2",315,0)\par
 .S (L,NAME)=""\par
"RTN","AHMLDOP2",316,0)\par
 .F  S L=$O(^TMP("LRTEST",$J,L)) Q:L=""  D  Q:LREND\par
"RTN","AHMLDOP2",317,0)\par
 ..F  S NAME=$O(^TMP("LRTEST",$J,L,NAME)) Q:NAME=""  D  Q:LREND\par
"RTN","AHMLDOP2",318,0)\par
 ...W !?5,L,?12,$E(NAME,1,37),?50,^TMP("LRTEST",$J,L,NAME)\par
"RTN","AHMLDOP2",319,0)\par
 .W !?5,$TR($J("",50)," ","-")\par
"RTN","AHMLDOP2",320,0)\par
 .W !?5,$J("Total",38),$TR($J(^TMP("LRTEST",$J),10)," ","."),!\par
"RTN","AHMLDOP2",321,0)\par
 ;\par
"RTN","AHMLDOP2",322,0)\par
 I LRT="1B" D  Q\par
"RTN","AHMLDOP2",323,0)\par
 .S (WRVU,TWRVU,GTWRVU,EXAM,GTEXAM)=0\par
"RTN","AHMLDOP2",324,0)\par
 .W !?58,"Total",?70,"Total"\par
"RTN","AHMLDOP2",325,0)\par
 .W !?5,"CPT",?12,"Procedure",?50,"wRVU",?58,"Exams",?70,"wRVU"\par
"RTN","AHMLDOP2",326,0)\par
 .W !?5,$TR($J("",70)," ","-")\par
"RTN","AHMLDOP2",327,0)\par
 .S (L,NAME)=""\par
"RTN","AHMLDOP2",328,0)\par
 .F  S L=$O(^TMP("LRTEST",$J,L)) Q:L=""  D  Q:LREND\par
"RTN","AHMLDOP2",329,0)\par
 ..F  S NAME=$O(^TMP("LRTEST",$J,L,NAME)) Q:NAME=""  D  Q:LREND\par
"RTN","AHMLDOP2",330,0)\par
 ...S WRVU=+$$RVU^FBRVU(L),EXAM=^TMP("LRTEST",$J,L,NAME)\par
"RTN","AHMLDOP2",331,0)\par
 ...S TWRVU=WRVU*EXAM,GTWRVU=GTWRVU+TWRVU,GTEXAM=GTEXAM+EXAM\par
"RTN","AHMLDOP2",332,0)\par
 ...W !?5,L,?12,$E(NAME,1,37),?50,WRVU,?58,EXAM,?70,TWRVU\par
"RTN","AHMLDOP2",333,0)\par
 .W !?5,$TR($J("",70)," ","-")\par
"RTN","AHMLDOP2",334,0)\par
 .W !?5,$J("Totals",40),?58,GTEXAM,?70,GTWRVU,!\par
"RTN","AHMLDOP2",335,0)\par
 ;\par
"RTN","AHMLDOP2",336,0)\par
 S L=""\par
"RTN","AHMLDOP2",337,0)\par
 F  S L=$O(^TMP("LRTEST",$J,L)) Q:L=""  D  Q:LREND\par
"RTN","AHMLDOP2",338,0)\par
 .I $G(^TMP("LRX",$J,L))]"" S NAME=^TMP("LRX",$J,L)\par
"RTN","AHMLDOP2",339,0)\par
 .E  S NAME=L\par
"RTN","AHMLDOP2",340,0)\par
 .W !?5,$J(NAME,$S(+LRT=1:15,1:35))\par
"RTN","AHMLDOP2",341,0)\par
 .W $TR($J(^TMP("LRTEST",$J,L),10)," ",".")\par
"RTN","AHMLDOP2",342,0)\par
 W !?5,$TR($J("",$S(+LRT=1:26,1:46))," ","-")\par
"RTN","AHMLDOP2",343,0)\par
 W !?5,$J("Total",$S(+LRT=1:15,1:35))\par
"RTN","AHMLDOP2",344,0)\par
 W $TR($J(+$G(^TMP("LRTEST",$J)),10)," ","."),!\par
"RTN","AHMLDOP2",345,0)\par
 ;\par
"RTN","AHMLDOP2",346,0)\par
 Q\par
"RTN","AHMLDOP2",347,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",348,0)\par
SHDR ; Print sub header.\par
"RTN","AHMLDOP2",349,0)\par
 ;\par
"RTN","AHMLDOP2",350,0)\par
 I $Y+6>IOSL D WAIT Q:LREND  D:$E(IOST,1,2)'="C-" HDR W !\par
"RTN","AHMLDOP2",351,0)\par
 ;\par
"RTN","AHMLDOP2",352,0)\par
 W !!,"==> Performing Location: ",LOC,!\par
"RTN","AHMLDOP2",353,0)\par
 I +LRT=1 D                                       ;rad sub header\par
"RTN","AHMLDOP2",354,0)\par
 .W !,$S(LRT="1B":"Report",1:"Order")\par
"RTN","AHMLDOP2",355,0)\par
 .W ?10,"Provider",?26,"Patient",?42,"CPT",?49,"Type"\par
"RTN","AHMLDOP2",356,0)\par
 .W ?55,"Image Procedure",?77,"St"\par
"RTN","AHMLDOP2",357,0)\par
 .W !,$TR($J("",8)," ","-"),?10,$TR($J("",14)," ","-")\par
"RTN","AHMLDOP2",358,0)\par
 .W ?26,$TR($J("",14)," ","-"),?42,$TR($J("",5)," ","-")\par
"RTN","AHMLDOP2",359,0)\par
 .W ?49,$TR($J("",4)," ","-"),?55,$TR($J("",20)," ","-")\par
"RTN","AHMLDOP2",360,0)\par
 .W ?77,$TR($J("",3)," ","-")\par
"RTN","AHMLDOP2",361,0)\par
 ;\par
"RTN","AHMLDOP2",362,0)\par
 I LRT=2 D                                       ;lab sub header\par
"RTN","AHMLDOP2",363,0)\par
 .W !,"Order",?10,"Provider",?26,"Patient",?42\par
"RTN","AHMLDOP2",364,0)\par
 .W "Test",?58,"St",?62,"Collect",?72,"Report"\par
"RTN","AHMLDOP2",365,0)\par
 .W !,$TR($J("",8)," ","-"),?10,$TR($J("",14)," ","-")\par
"RTN","AHMLDOP2",366,0)\par
 .W ?26,$TR($J("",14)," ","-"),?42,$TR($J("",14)," ","-")\par
"RTN","AHMLDOP2",367,0)\par
 .W ?58,$TR($J("",3)," ","-"),?62,$TR($J("",8)," ","-")\par
"RTN","AHMLDOP2",368,0)\par
 .W ?72,$TR($J("",8)," ","-")\par
"RTN","AHMLDOP2",369,0)\par
 ;\par
"RTN","AHMLDOP2",370,0)\par
 Q\par
"RTN","AHMLDOP2",371,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",372,0)\par
DATE(DATE) ; Convert mmm dd, yyyy@hh:mm to mm/dd/yyyy@hh:mm\par
"RTN","AHMLDOP2",373,0)\par
 ;\par
"RTN","AHMLDOP2",374,0)\par
 N DD,DM,DSTR,DY,LOWER,TM,UPPER\par
"RTN","AHMLDOP2",375,0)\par
 ;\par
"RTN","AHMLDOP2",376,0)\par
 I $G(DATE)="" Q ""\par
"RTN","AHMLDOP2",377,0)\par
 ;\par
"RTN","AHMLDOP2",378,0)\par
 S LOWER="abcdefghijklmnopqrstuvwxyz"\par
"RTN","AHMLDOP2",379,0)\par
 S UPPER="ABCDEFGHIJKLMNOPQRSTUVWXYZ"\par
"RTN","AHMLDOP2",380,0)\par
 S DSTR("JAN")="01",DSTR("FEB")="02",DSTR("MAR")="03",DSTR("APR")="04"\par
"RTN","AHMLDOP2",381,0)\par
 S DSTR("MAY")="05",DSTR("JUN")="06",DSTR("JUL")="07",DSTR("AUG")="08"\par
"RTN","AHMLDOP2",382,0)\par
 S DSTR("SEP")="09",DSTR("OCT")=10,DSTR("NOV")=11,DSTR("DEC")=12\par
"RTN","AHMLDOP2",383,0)\par
 ;\par
"RTN","AHMLDOP2",384,0)\par
 S DM=$TR($P(DATE," "),LOWER,UPPER),DD=$P($P(DATE," ",2),",")\par
"RTN","AHMLDOP2",385,0)\par
 S DY=$E($P($P(DATE," ",3),"@"),3,4),TM=$P($P(DATE,"@",2),":",1,2)\par
"RTN","AHMLDOP2",386,0)\par
 ;\par
"RTN","AHMLDOP2",387,0)\par
 Q DSTR(DM)_"/"_DD_"/"_DY_"@"_TM\par
"RTN","AHMLDOP2",388,0)\par
 ;---------------------------------------------------------------------\par
"RTN","AHMLDOP2",389,0)\par
WAIT ; Pause for page breaks.\par
"RTN","AHMLDOP2",390,0)\par
 ;\par
"RTN","AHMLDOP2",391,0)\par
 K DIR\par
"RTN","AHMLDOP2",392,0)\par
 S DIR(0)="E"\par
"RTN","AHMLDOP2",393,0)\par
 D ^DIR\par
"RTN","AHMLDOP2",394,0)\par
 S:($D(DUOUT))!($D(DTOUT)) LREND=1\par
"RTN","AHMLDOP2",395,0)\par
 S $Y=1\par
"RTN","AHMLDOP2",396,0)\par
 ;\par
"RTN","AHMLDOP2",397,0)\par
 Q\par
"RTN","AHMLDOR")\par
0^9^B14346987\par
"RTN","AHMLDOR",1,0)\par
AHMLDOR ;LEIDOS/TCK- Remote ordering - Radiology ; 10/16/16 8:50pm\par
"RTN","AHMLDOR",2,0)\par
 ;;1.0;Radiology Orders Portability;;April 1, 2016;Build 26\par
"RTN","AHMLDOR",3,0)\par
 ; Reference to ^DIC(4 supported by IA #10090\par
"RTN","AHMLDOR",4,0)\par
 ; Reference to DC^ORWDXA supported by IA #5595\par
"RTN","AHMLDOR",5,0)\par
 ; Reference to SEND^ORWDX supported by IA #5596\par
"RTN","AHMLDOR",6,0)\par
 ;\par
"RTN","AHMLDOR",7,0)\par
 ; Updated: 20100908\par
"RTN","AHMLDOR",8,0)\par
 ; updated 20101124 rhl DBGOUT\par
"RTN","AHMLDOR",9,0)\par
 ; updated 20110509 dje: IA comments, code cleanup.  Note:  the IA references may be unnecessary, since the relevant code is commented out.\par
"RTN","AHMLDOR",10,0)\par
 ;\par
"RTN","AHMLDOR",11,0)\par
 ; gsn - Start using RD1 type delimiters instead of D1 types as these\par
"RTN","AHMLDOR",12,0)\par
 ;       variables are used by fileman calls\par
"RTN","AHMLDOR",13,0)\par
 ; 4076 - PACS define REQLOC from OBR13\par
"RTN","AHMLDOR",14,0)\par
 ;\par
"RTN","AHMLDOR",15,0)\par
EN ;\par
"RTN","AHMLDOR",16,0)\par
 ; Note: HL7 delimitors D1-D5 are defined in JVOR\par
"RTN","AHMLDOR",17,0)\par
 ;\par
"RTN","AHMLDOR",18,0)\par
 S ^TMP("HLMT")=HLMTIEN\par
"RTN","AHMLDOR",19,0)\par
 ;\par
"RTN","AHMLDOR",20,0)\par
 K ^TMP("RMTE"),REC,HLARY\par
"RTN","AHMLDOR",21,0)\par
 N I,D1,D2,D3,D4,D5,TYPE\par
"RTN","AHMLDOR",22,0)\par
 S (D1,D2,D3,D4,D5,TYPE)="",C=0  ;Initialize variables\par
"RTN","AHMLDOR",23,0)\par
 I $G(HLMTIEN)'>0 S LROROUT(1)="0^No Results Array Received" Q\par
"RTN","AHMLDOR",24,0)\par
 S HLMA="",HLMA=$O(^HLMA("B",HLMTIEN,HLMA))\par
"RTN","AHMLDOR",25,0)\par
 Q:$G(HLMA)'>0\par
"RTN","AHMLDOR",26,0)\par
 Q:'$D(^HLMA(HLMA,0))\par
"RTN","AHMLDOR",27,0)\par
 Q:'$D(^HLMA(HLMA,"MSH"))\par
"RTN","AHMLDOR",28,0)\par
 S LOC=+$P(^HLMA(HLMA,"MSH",1,0),"|",4)\par
"RTN","AHMLDOR",29,0)\par
 M ^TMP("RMTE",1)=^HLMA(HLMA,"MSH",1,0)\par
"RTN","AHMLDOR",30,0)\par
 S DONE=0\par
"RTN","AHMLDOR",31,0)\par
 S I=0 F  S I=$O(^HL(772,HLMTIEN,"IN",I)) Q:I=""  D\par
"RTN","AHMLDOR",32,0)\par
 .Q:I=""\par
"RTN","AHMLDOR",33,0)\par
 .S C=$G(I)+1\par
"RTN","AHMLDOR",34,0)\par
 .S SB=$P(^HL(772,HLMTIEN,"IN",I,0),"|")\par
"RTN","AHMLDOR",35,0)\par
 .I 'DONE,SB=""!(SB'?.A),$P(^TMP("RMTE",I),"|")="OBR" D  Q\par
"RTN","AHMLDOR",36,0)\par
 ..S ^TMP("RMTE",C-1)=^TMP("RMTE",C-1)_^HL(772,HLMTIEN,"IN",I,0),DONE=1\par
"RTN","AHMLDOR",37,0)\par
 .S ^TMP("RMTE",C)=^HL(772,HLMTIEN,"IN",I,0)\par
"RTN","AHMLDOR",38,0)\par
 K RAMSG M RAMSG=^TMP("RMTE")\par
"RTN","AHMLDOR",39,0)\par
 K ^TMP("RMTE")\tab  \par
"RTN","AHMLDOR",40,0)\par
 S RD1="|",RD2="^",RD3="\\"\par
"RTN","AHMLDOR",41,0)\par
 K RAOROUT\par
"RTN","AHMLDOR",42,0)\par
 N XC\par
"RTN","AHMLDOR",43,0)\par
 N ORIEN,WPRT,WPACH\par
"RTN","AHMLDOR",44,0)\par
 N LROK S LROK=1\par
"RTN","AHMLDOR",45,0)\par
 N IMGLOC,PROC,REQPRV,PRISTF,EXMDT,RPTSTA,RPTDT,TRNSCP,VRFDT\par
"RTN","AHMLDOR",46,0)\par
 N RADTE,IMGTYP,HOSDIV,CASE,EXSTAT,EXCAT,WARD,SERVC,RAOIEN,REQPRV,RPTEN\par
"RTN","AHMLDOR",47,0)\par
 N BED,REQLOC,CRDMTH,PRIRES,PRIDGC,RPTIEN,SECRES,SECSTF,SECDGC\par
"RTN","AHMLDOR",48,0)\par
 N LCASE,DFN,RPTENTDT,VRFDT,VRFPHY,ESCD,SVCBY,ITRLOC,LOGDT,ACTION,WPIT,WPRT,REQSTA,LSTACT,RAOSTADT,RAONWSTA\par
"RTN","AHMLDOR",49,0)\par
 ;\par
"RTN","AHMLDOR",50,0)\par
 N RACNT S RACNT=1\par
"RTN","AHMLDOR",51,0)\par
 Q:'$D(RAMSG)\par
"RTN","AHMLDOR",52,0)\par
 D PARSE\par
"RTN","AHMLDOR",53,0)\par
 Q:'$D(HLARY)\par
"RTN","AHMLDOR",54,0)\par
 ;\par
"RTN","AHMLDOR",55,0)\par
 I ORC1="DC" D EN^AHMLDOL G ENQ ; CPRS discontinue\par
"RTN","AHMLDOR",56,0)\par
 ;I ORC1="CA" D HLD^AHMLDOR1 G ENQ ; Hold order\par
"RTN","AHMLDOR",57,0)\par
 I ORC1="CA" D EN^AHMLDOL G ENQ ; Cancel exam and case\par
"RTN","AHMLDOR",58,0)\par
 I ORC1="NW",ORC5="IP" D REG^AHMLDOR1 G ENQ\par
"RTN","AHMLDOR",59,0)\par
 I ORC1="SC",ORC5="IP" D  G ENQ\par
"RTN","AHMLDOR",60,0)\par
 .I OBR25="X" D HLD^AHMLDOR1 ;Cancel Arrival\par
"RTN","AHMLDOR",61,0)\par
 .I OBR25="I" D REG^AHMLDOR1 ;Rad Arrival\par
"RTN","AHMLDOR",62,0)\par
 I ORC1="RE" D  G ENQ ;  results\par
"RTN","AHMLDOR",63,0)\par
 .I OBR25'["F" Q\par
"RTN","AHMLDOR",64,0)\par
 .D RSLT^AHMLDOR1 G ENQ\par
"RTN","AHMLDOR",65,0)\par
 I ORC1="XO" D MOD^AHMLDOR1 G ENQ  ;set to EXAMINED status\par
"RTN","AHMLDOR",66,0)\par
 ;\par
"RTN","AHMLDOR",67,0)\par
 ;bsl;non-translated vista codes instead of CHCS codes\par
"RTN","AHMLDOR",68,0)\par
 ;I ORC1="NW" Q D REG^JVHLRAD G ENQ  ; registration\par
"RTN","AHMLDOR",69,0)\par
 ;\par
"RTN","AHMLDOR",70,0)\par
 S RAOROUT(1)="-1^UNKNOWN RAD MESSAGE TYPE RECEIVED="_ORC1\par
"RTN","AHMLDOR",71,0)\par
ENQ ;\par
"RTN","AHMLDOR",72,0)\par
 I '$D(RAOROUT(1)) S RAOROUT(1)="-1^NO RETURN MESSAGE"\par
"RTN","AHMLDOR",73,0)\par
 S RAOROUT(1)=RAOROUT(1)_$C(13)\par
"RTN","AHMLDOR",74,0)\par
 K MSHSEG,ORC,ORCSEG,ORDSEG,ORWREC,PID\par
"RTN","AHMLDOR",75,0)\par
 Q\par
"RTN","AHMLDOR",76,0)\par
 ;\par
"RTN","AHMLDOR",77,0)\par
TEST(LROROUT,HLMTIEN) ;\par
"RTN","AHMLDOR",78,0)\par
 D EN\par
"RTN","AHMLDOR",79,0)\par
 Q\par
"RTN","AHMLDOR",80,0)\par
 ;\par
"RTN","AHMLDOR",81,0)\par
CHKORID(ID) ;\par
"RTN","AHMLDOR",82,0)\par
 Q\par
"RTN","AHMLDOR",83,0)\par
 ;\par
"RTN","AHMLDOR",84,0)\par
PARSE ;\par
"RTN","AHMLDOR",85,0)\par
 K PIDSEG\par
"RTN","AHMLDOR",86,0)\par
 N ZCNT,FLG,XT,XC,X\par
"RTN","AHMLDOR",87,0)\par
 S PIDSEG="",ORCSEG=""\par
"RTN","AHMLDOR",88,0)\par
 ;\par
"RTN","AHMLDOR",89,0)\par
 S ZCNT="",FLG=0,U="^"\par
"RTN","AHMLDOR",90,0)\par
 F  S ZCNT=$O(RAMSG(ZCNT)) Q:ZCNT=""  D  Q:FLG=2\par
"RTN","AHMLDOR",91,0)\par
 . S XT=$P(RAMSG(ZCNT),RD1,1) Q:XT=""\par
"RTN","AHMLDOR",92,0)\par
 . S XC=$G(HLARY(XT))+1,HLARY(XT)=XC\par
"RTN","AHMLDOR",93,0)\par
 . S HLARY(XT,XC)=$P(RAMSG(ZCNT),RD1,2,999)\par
"RTN","AHMLDOR",94,0)\par
 ;   set some basic variables:\par
"RTN","AHMLDOR",95,0)\par
 S X=HLARY("MSH",1),X=$P(X,RD1,8),XMT=$P(X,RD1,1),XME=$P(X,RD1,2)\par
"RTN","AHMLDOR",96,0)\par
 S MSHSEG=HLARY("MSH",1),PIDSEG=$G(HLARY("PID",1)),ORCSEG=$G(HLARY("ORC",1))\par
"RTN","AHMLDOR",97,0)\par
 S ORC1=$P($G(HLARY("ORC",1)),RD1,1),ORC5=$P($G(HLARY("ORC",1)),RD1,5)\par
"RTN","AHMLDOR",98,0)\par
 S REQLOC=+$P($G(HLARY("ORC",1)),RD1,13)         ;4076 init Reqloc\par
"RTN","AHMLDOR",99,0)\par
 S OBR25=$P($G(HLARY("OBR",1)),RD1,25)\par
"RTN","AHMLDOR",100,0)\par
 S ORIEN=$P($G(HLARY("OBR",1)),RD1,2)\par
"RTN","AHMLDOR",101,0)\par
 I $G(HLARY("ORC"))'>0 S ORC1="RE"\par
"RTN","AHMLDOR",102,0)\par
 Q\par
"RTN","AHMLDOR",103,0)\par
 ;\par
"RTN","AHMLDOR",104,0)\par
DBG ;\par
"RTN","AHMLDOR",105,0)\par
 K DBKIND,DBCNT\par
"RTN","AHMLDOR",106,0)\par
 D INT^JVHLDBG("JVRA",.DBKIND,.DBCNT)\par
"RTN","AHMLDOR",107,0)\par
 I DBKIND["I" D JVIN^JVHLDBG("JVRA",DBCNT,.RAMSG)\par
"RTN","AHMLDOR",108,0)\par
 Q\par
"RTN","AHMLDOR",109,0)\par
DBGOUT ;\par
"RTN","AHMLDOR",110,0)\par
 I $D(RAOROUT),$G(DBCNT) D JVOUT^JVHLDBG("JVRA",DBCNT,.RAOROUT)\par
"RTN","AHMLDOR",111,0)\par
 Q\par
"RTN","AHMLDOR",112,0)\par
 ;\par
"RTN","AHMLDOR1")\par
0^10^B226327375\par
"RTN","AHMLDOR1",1,0)\par
AHMLDOR1 ;LEIDOS/TCK- REMOTE ORDERING - Radiology - filing driver ; 10/16/16 8:54pm\par
"RTN","AHMLDOR1",2,0)\par
 ;;1.0;Radiology Orders Portability;;April 1, 2016;Build 26\par
"RTN","AHMLDOR1",3,0)\par
 ; Reference to ^OR(100 supported by IA #5196\par
"RTN","AHMLDOR1",4,0)\par
 ; Reference to ^RAO(75.1 supported by IA #5604\par
"RTN","AHMLDOR1",5,0)\par
 ; Reference to ^RADPT( supported by IA #5602\par
"RTN","AHMLDOR1",6,0)\par
 ; Reference to ^RA(78.4 supported by IA #5662\par
"RTN","AHMLDOR1",7,0)\par
 ; Reference to ^RA(78.6 supported by IA #5663\par
"RTN","AHMLDOR1",8,0)\par
 ; Reference to X7005^RADD3 supported by IA #5661\par
"RTN","AHMLDOR1",9,0)\par
 ; Reference to A7007^RADD3 supported by IA #5661\par
"RTN","AHMLDOR1",10,0)\par
 ; Reference to ^DPT( supported by IA #10035\par
"RTN","AHMLDOR1",11,0)\par
 ; Reference to ^RAMIS(71.2 supported by IA #5664\par
"RTN","AHMLDOR1",12,0)\par
 ; Reference to ^DIC(81.3 supported by IA #2816\par
"RTN","AHMLDOR1",13,0)\par
 ; Reference to NOW^%DTC supported by IA #10000\par
"RTN","AHMLDOR1",14,0)\par
 ; Reference to GETDLG^ORCD supported by IA #5493\par
"RTN","AHMLDOR1",15,0)\par
 ;\par
"RTN","AHMLDOR1",16,0)\par
 ; updated:  20100908\par
"RTN","AHMLDOR1",17,0)\par
 ; updated 20110510 dje: Code cleanup, documentation of IAs.\par
"RTN","AHMLDOR1",18,0)\par
 ;\par
"RTN","AHMLDOR1",19,0)\par
 ; gsn - converted over to using RD1 delimiters for JVRA* code\par
"RTN","AHMLDOR1",20,0)\par
 ;4833 - Verifier and Esig not sent, define as doctor.\par
"RTN","AHMLDOR1",21,0)\par
 ;5161 - CKREG not checking for Case sts needed for re-arrivals.\par
"RTN","AHMLDOR1",22,0)\par
 ;5265 - Kill temp "AE xref used to prevent dupe case numbers assigned\par
"RTN","AHMLDOR1",23,0)\par
 ;       in SCASE^AHMLDOR2\par
"RTN","AHMLDOR1",24,0)\par
 ;\par
"RTN","AHMLDOR1",25,0)\par
 Q\par
"RTN","AHMLDOR1",26,0)\par
 ;\par
"RTN","AHMLDOR1",27,0)\par
RSLT ; file a RE message ( Rad Results )\par
"RTN","AHMLDOR1",28,0)\par
 ;\par
"RTN","AHMLDOR1",29,0)\par
 K LROK\par
"RTN","AHMLDOR1",30,0)\par
 S LROK=0\par
"RTN","AHMLDOR1",31,0)\par
 ;BL;fix to address unverified results being sent\par
"RTN","AHMLDOR1",32,0)\par
 I $P(HLARY("OBR",1),"^",25)="R" S LROK=1,RAOROUT(1)=RADARRY("ORIEN")_"^UNVERIFIED RESULTS NOT FILED" Q\par
"RTN","AHMLDOR1",33,0)\par
 S NWSTATUS="COMPLETE"\par
"RTN","AHMLDOR1",34,0)\par
 D EN^AHMLDOR2 ; set local variables from HLARY\par
"RTN","AHMLDOR1",35,0)\par
 D CHK1^AHMLDOR2 I 'LROK G RSLTQ ; check validity of local variables.\par
"RTN","AHMLDOR1",36,0)\par
 ;\par
"RTN","AHMLDOR1",37,0)\par
 D CKREG I 'FOUND D REG\par
"RTN","AHMLDOR1",38,0)\par
 D VARS^AHMLDOR2 ; set derived local variables.\par
"RTN","AHMLDOR1",39,0)\par
 ;BL;Pass an Array to JVHLRA2\par
"RTN","AHMLDOR1",40,0)\par
 D BLDA\par
"RTN","AHMLDOR1",41,0)\par
 D RPT^AHMLDOR3(.RADARRY) I 'LROK G RSLTQ ; file results\par
"RTN","AHMLDOR1",42,0)\par
 ;\par
"RTN","AHMLDOR1",43,0)\par
RSLTQ ;\par
"RTN","AHMLDOR1",44,0)\par
 K RAOROUT(1)\par
"RTN","AHMLDOR1",45,0)\par
 S:LROK RAOROUT(1)=RADARRY("ORIEN")_"^RS" ; success\par
"RTN","AHMLDOR1",46,0)\par
 I 'LROK,'$D(RAOROUT(1)) S RAOROUT(1)="-1^RESULT ERROR MESSAGE"\par
"RTN","AHMLDOR1",47,0)\par
 Q\par
"RTN","AHMLDOR1",48,0)\par
 ;============================================================================\par
"RTN","AHMLDOR1",49,0)\par
REG ; file a SC message ( Rad Registration )\par
"RTN","AHMLDOR1",50,0)\par
 ;\par
"RTN","AHMLDOR1",51,0)\par
 ;\par
"RTN","AHMLDOR1",52,0)\par
 S (DUZ,DUZNME)=""\par
"RTN","AHMLDOR1",53,0)\par
 D PROXY^AHMLDOR2(.DUZ,DUZNME)\par
"RTN","AHMLDOR1",54,0)\par
 S LROK=0\par
"RTN","AHMLDOR1",55,0)\par
 N DIE,DA,ST,DR,SETRA\par
"RTN","AHMLDOR1",56,0)\par
 S NWSTATUS="WAITING FOR EXAM" ;rhl 20100929\par
"RTN","AHMLDOR1",57,0)\par
 D EN^AHMLDOR2 ; set local variables from HLARY\par
"RTN","AHMLDOR1",58,0)\par
 S SETRA=0\par
"RTN","AHMLDOR1",59,0)\par
 ;BL;SETTING SC TO ACTIVE AND EXAMINED  \par
"RTN","AHMLDOR1",60,0)\par
 I $P(HLARY("ORC",1),"|",5)="IP" D\par
"RTN","AHMLDOR1",61,0)\par
 . Q:$P(HLARY("OBR",1),"|",25)'="I"\par
"RTN","AHMLDOR1",62,0)\par
 . S DIE="^OR(100,",DA=ORIEN,ST=6,DR="5////"_ST_";" D ^DIE K DIE,DA\par
"RTN","AHMLDOR1",63,0)\par
 . S SETRA=1 ; success\par
"RTN","AHMLDOR1",64,0)\par
 S STOP=0\par
"RTN","AHMLDOR1",65,0)\par
 D CKREG  ;BSL;For setting update variables need to know if registered\par
"RTN","AHMLDOR1",66,0)\par
 I FOUND,SEX="F" D  ;BSL;SET VARIABLES TO CHECK FOR PREGNANCY UPDATE\par
"RTN","AHMLDOR1",67,0)\par
 . K X13\par
"RTN","AHMLDOR1",68,0)\par
 . ;BL;IA compliance change\par
"RTN","AHMLDOR1",69,0)\par
 . S RAOIEN=$$GET1^DIQ(100,ORIEN,33,"I")\par
"RTN","AHMLDOR1",70,0)\par
 . S X13=$$GET1^DIQ(75.1,RAOIEN,13,"I")\par
"RTN","AHMLDOR1",71,0)\par
 . Q:PRGFLG=X13  ;If preg flag is same as preg status quit\par
"RTN","AHMLDOR1",72,0)\par
 . Q:PRGFLG=""  ;If there is no preg status quit\par
"RTN","AHMLDOR1",73,0)\par
 . D PRGSET  ;update pregnancy status\par
"RTN","AHMLDOR1",74,0)\par
 . S SETRA=1  ;This was an update so do not error, but quit when done\par
"RTN","AHMLDOR1",75,0)\par
 I FOUND&(SETRA=0) S LROK=0,RAOROUT(1)="-1^ALREADY REGISTERED" G REGQ\par
"RTN","AHMLDOR1",76,0)\par
 ;I FOUND S LROK=1 G REGQ\par
"RTN","AHMLDOR1",77,0)\par
 K RADTI,CASE,FOUND\par
"RTN","AHMLDOR1",78,0)\par
 D CHK2^AHMLDOR2 I 'LROK G REGQ ; check validity of local variables.\par
"RTN","AHMLDOR1",79,0)\par
 D SRADTI^AHMLDOR2 I 'LROK G REGQ ; get RADTE & RADTI\par
"RTN","AHMLDOR1",80,0)\par
 D SCASE^AHMLDOR2 I 'LROK G REGQ ; get case#\par
"RTN","AHMLDOR1",81,0)\par
 D VARS^AHMLDOR2 I 'LROK G REGQ ; set derived local variables.\par
"RTN","AHMLDOR1",82,0)\par
 ;\par
"RTN","AHMLDOR1",83,0)\par
 ;BL;Pass an array to JVHLRA2\par
"RTN","AHMLDOR1",84,0)\par
 S EXMST=9\par
"RTN","AHMLDOR1",85,0)\par
 D BLDA\par
"RTN","AHMLDOR1",86,0)\par
 I '$D(^RADPT(RADFN)) D PAT^AHMLDOR3(.RADARRY) ; stub record in ^RADPT\par
"RTN","AHMLDOR1",87,0)\par
 D REG^AHMLDOR3(.RADARRY)         ; register exam\par
"RTN","AHMLDOR1",88,0)\par
 ;\par
"RTN","AHMLDOR1",89,0)\par
REGQ ;Report back registration success or fail\par
"RTN","AHMLDOR1",90,0)\par
 ;\par
"RTN","AHMLDOR1",91,0)\par
 S:LROK RAOROUT(1)=ORIEN_"^RS" ; success\par
"RTN","AHMLDOR1",92,0)\par
 I 'LROK,'$D(RAOROUT(1)) S RAOROUT(1)="-1^REG ERROR MESSAGE"\par
"RTN","AHMLDOR1",93,0)\par
 S CASE=$P(LCASE,"-",2)\par
"RTN","AHMLDOR1",94,0)\par
 K ^RADPT("AE",CASE,$J)         ;kill temp xref used by JVHLRA2   5265\par
"RTN","AHMLDOR1",95,0)\par
 Q\par
"RTN","AHMLDOR1",96,0)\par
 ;===================================================================\par
"RTN","AHMLDOR1",97,0)\par
MOD ;MODIFY EXAM STATUS TO EXAMINED\par
"RTN","AHMLDOR1",98,0)\par
 N RADFN,PROC,ORIEN,RAOIEN,EXSTAT\par
"RTN","AHMLDOR1",99,0)\par
 K RADTI,DA2,CONTMEDIA,FILMA,CPTMOD,FILMAMT,FILMSIZE,OBXCNT,PROCMOD,X,TECH,PRICAM,SIZE\par
"RTN","AHMLDOR1",100,0)\par
 Q:$P(HLARY("ORC",1),"^",5)'="CM"\par
"RTN","AHMLDOR1",101,0)\par
 S ORIEN=$P($G(HLARY("OBR",1)),"^",2)\par
"RTN","AHMLDOR1",102,0)\par
 ;BL;IA compliance change\par
"RTN","AHMLDOR1",103,0)\par
 S RAOIEN=$$GET1^DIQ(100,ORIEN,33,"I")\par
"RTN","AHMLDOR1",104,0)\par
 S PROC=$$GET1^DIQ(75.1,RAOIEN,2,"I")\par
"RTN","AHMLDOR1",105,0)\par
 S RADFN=$$GET1^DIQ(75.1,RAOIEN,.01,"I")\par
"RTN","AHMLDOR1",106,0)\par
 I RADFN="" S RAOROUT(1)="-1^NO RADIOLOGY PATIENT ON FILE" Q\par
"RTN","AHMLDOR1",107,0)\par
 S DFN=RADFN\par
"RTN","AHMLDOR1",108,0)\par
 ;Setup OBX values associated with modification of exam status \par
"RTN","AHMLDOR1",109,0)\par
 ;if there are multiple films used there will need to be a film array\par
"RTN","AHMLDOR1",110,0)\par
 N FCNT\par
"RTN","AHMLDOR1",111,0)\par
 S FCNT=0,OBXCNT=0\par
"RTN","AHMLDOR1",112,0)\par
 FOR  S OBXCNT=$O(HLARY("OBX",OBXCNT)) Q:'OBXCNT  D\par
"RTN","AHMLDOR1",113,0)\par
 . S X=HLARY("OBX",OBXCNT)\par
"RTN","AHMLDOR1",114,0)\par
 . I $P(X,RD1,3)["IVCON" S CONTMEDIA=$P(X,RD1,5)     ;contmedia Y OR N\par
"RTN","AHMLDOR1",115,0)\par
 . I $P(X,RD1,3)["99FLM" D\par
"RTN","AHMLDOR1",116,0)\par
 . . S FCNT=FCNT+1\par
"RTN","AHMLDOR1",117,0)\par
 . . ;S FILMA(FCNT,"SIZE")=$P($P(X,RD1,3),RD2,1)      ;FILMSIZE CQ 3229 DEFAULT TO "PACS"\par
"RTN","AHMLDOR1",118,0)\par
 . . S SIZE=""\par
"RTN","AHMLDOR1",119,0)\par
 . . S SIZE=$$FIND1^DIC(78.4,,,"PACS")\par
"RTN","AHMLDOR1",120,0)\par
 . . S FILMA(FCNT,"SIZE")=SIZE\par
"RTN","AHMLDOR1",121,0)\par
 . . S FILMA(FCNT,"AMT")=$P(X,RD1,5)   ;FILMAMT\par
"RTN","AHMLDOR1",122,0)\par
 ;S X=HLARY("OBR",1),TECH=+$P($P(X,RD1,34),RD2,1)  ;TECHNOLOGIST\par
"RTN","AHMLDOR1",123,0)\par
 S PRICAM=""\par
"RTN","AHMLDOR1",124,0)\par
 S PRICAM=$$FIND1^DIC(78.6,,,"CHCS")  ;DEFAULT TO CHCS CQ 3229 MUST BE A "CHCS" ENTRY\par
"RTN","AHMLDOR1",125,0)\par
 I PRICAM="" S RAOROUT(1)="-1^NO MATCHING CAMERA/EQUIP/RM ENTRY IN 78.6" Q\par
"RTN","AHMLDOR1",126,0)\par
 D BLDA\par
"RTN","AHMLDOR1",127,0)\par
 I PROC="" S RAOROUT(1)="-1^ERROR MESSAGE-NO PROCEDURE" Q\par
"RTN","AHMLDOR1",128,0)\par
 S EXSTAT=$$GETSTA^RAHNIN2(PROC,"EXAMINED")  ;GET CODE FOR EXAMINED STATUS FOR PROCEDURE\par
"RTN","AHMLDOR1",129,0)\par
 I EXSTAT="" S RAOROUT(1)="-1^ERROR MESSAGE-NO EXAMINED STATUS FOR PROCEDURE" Q\par
"RTN","AHMLDOR1",130,0)\par
 S RADFDA(75.1,RAOIEN_",",5)=EXSTAT     ; Examined Status bsl 20101220\par
"RTN","AHMLDOR1",131,0)\par
 D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR1",132,0)\par
 K RADFDA\par
"RTN","AHMLDOR1",133,0)\par
 ;NEED TO UPDATE 70 FILE\par
"RTN","AHMLDOR1",134,0)\par
 ;SET DA2 AND RADTI FOR 70 FILE\par
"RTN","AHMLDOR1",135,0)\par
 S RADTI=0,DA2="",FOUND=0\par
"RTN","AHMLDOR1",136,0)\par
 FOR  S RADTI=$O(^RADPT(RADFN,"DT",RADTI)) Q:'RADTI  D  Q:FOUND\par
"RTN","AHMLDOR1",137,0)\par
 . S DA2=0,DA2=$O(^RADPT(RADFN,"DT",RADTI,"P",DA2)) Q:DA2'=+DA2  D  Q:FOUND\par
"RTN","AHMLDOR1",138,0)\par
 . I $P(^RADPT(RADFN,"DT",RADTI,"P",DA2,0),"^",11)=RAOIEN S FOUND=1\par
"RTN","AHMLDOR1",139,0)\par
 ;If not found quit out with no case rad order found\par
"RTN","AHMLDOR1",140,0)\par
 I 'FOUND S RAOROUT(1)="-1^NO RADIOLOGY ORDER FOUND" Q\par
"RTN","AHMLDOR1",141,0)\par
 ;\par
"RTN","AHMLDOR1",142,0)\par
 S RADFDA(70.03,DA2_","_RADTI_","_RADFN_",",3)=EXSTAT  ;EXAM STATUS\par
"RTN","AHMLDOR1",143,0)\par
 S RADFDA(70.03,DA2_","_RADTI_","_RADFN_",",10)=RADARRY("CONTMEDIA")\par
"RTN","AHMLDOR1",144,0)\par
 S RADFDA(70.03,DA2_","_RADTI_","_RADFN_",",18)=RADARRY("PRICAM")\par
"RTN","AHMLDOR1",145,0)\par
 D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR1",146,0)\par
 ;\par
"RTN","AHMLDOR1",147,0)\par
 ;store film size and amt <multiple>\par
"RTN","AHMLDOR1",148,0)\par
 K RADFDA\par
"RTN","AHMLDOR1",149,0)\par
 S FCNT=0\par
"RTN","AHMLDOR1",150,0)\par
 I $D(FILMA) D\par
"RTN","AHMLDOR1",151,0)\par
 . F  S FCNT=$O(FILMA(FCNT)) Q:FCNT=""  D\par
"RTN","AHMLDOR1",152,0)\par
 . . S RADFDA(70.04,"+1"_","_DA2_","_RADTI_","_RADFN_",",.01)=FILMA(FCNT,"SIZE")\par
"RTN","AHMLDOR1",153,0)\par
 . . S RADFDA(70.04,"+1"_","_DA2_","_RADTI_","_RADFN_",",2)=FILMA(FCNT,"AMT")\par
"RTN","AHMLDOR1",154,0)\par
 . . D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR1",155,0)\par
 ;\par
"RTN","AHMLDOR1",156,0)\par
 ;Need to update 70.05 exam status change history\par
"RTN","AHMLDOR1",157,0)\par
 K RADFDA\par
"RTN","AHMLDOR1",158,0)\par
 ;\par
"RTN","AHMLDOR1",159,0)\par
 ;BL;MAKE CALL TO UTILITY TO SET 70.05 INSTEAD OF DOING IT OURSELVES\par
"RTN","AHMLDOR1",160,0)\par
 ;\par
"RTN","AHMLDOR1",161,0)\par
 D X7005^RADD3(RADFN,RADTI,DA2,"","",EXSTAT,RADARRY("DUZ"))\par
"RTN","AHMLDOR1",162,0)\par
 K RADFDA\par
"RTN","AHMLDOR1",163,0)\par
 ;\par
"RTN","AHMLDOR1",164,0)\par
 ;NEED TO ADD 70.07  - Tech comments are not part of the interface yet\par
"RTN","AHMLDOR1",165,0)\par
 D A7007^RADD3(RADFN,RADTI,DA2,RADARRY("DUZ"),RADARRY("TECH"))\par
"RTN","AHMLDOR1",166,0)\par
 ;\par
"RTN","AHMLDOR1",167,0)\par
 K RADFDA\par
"RTN","AHMLDOR1",168,0)\par
 ;IF THERE IS NO RADIOLOGY TECH RESULTS WILL NOT FILE PROPERLY (REVERSION ERROR)\par
"RTN","AHMLDOR1",169,0)\par
 I '$D(RADARRY("TECH")) S LROK=0,RAOROUT(1)="-1^NO RADIOLOGY TECHNICIAN" Q\par
"RTN","AHMLDOR1",170,0)\par
 ;S RADFDA(70.12,"+1,"_DA2_","_RADTI_","_RADFN_",",.01)=RADARRY("DUZ")\par
"RTN","AHMLDOR1",171,0)\par
 D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR1",172,0)\par
 I '$D(RAOROUT(1)) S LROK=1\par
"RTN","AHMLDOR1",173,0)\par
 S RADFDA(70.07,"+1,"_DA2_","_RADTI_","_RADFN_",",4)=$G(TCM)\par
"RTN","AHMLDOR1",174,0)\par
 D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR1",175,0)\par
 ;\par
"RTN","AHMLDOR1",176,0)\par
 ;Set "M" and "CMOD" nodes in 70 file to prevent reversion\par
"RTN","AHMLDOR1",177,0)\par
 ;procedure modifiers and CPT modifiers are not coming over in the interface, set to NULL\par
"RTN","AHMLDOR1",178,0)\par
 K RADFDA\par
"RTN","AHMLDOR1",179,0)\par
 S RADFDA(70.1,"+1,"_DA2_","_RADTI_","_RADFN_",",.01)=RADARRY("PROCMOD")\par
"RTN","AHMLDOR1",180,0)\par
 D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR1",181,0)\par
 K RADFDA\par
"RTN","AHMLDOR1",182,0)\par
 ;\par
"RTN","AHMLDOR1",183,0)\par
 D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR1",184,0)\par
 K RADFDA\par
"RTN","AHMLDOR1",185,0)\par
 ;\par
"RTN","AHMLDOR1",186,0)\par
MODQ ;Report back exam status updated successfully\par
"RTN","AHMLDOR1",187,0)\par
 S:LROK RAOROUT(1)=ORIEN_"^RS" ; success\par
"RTN","AHMLDOR1",188,0)\par
 I 'LROK,'$D(RAOROUT(1)) S RAOROUT(1)="-1^EXAM STATUS ERROR MESSAGE"\par
"RTN","AHMLDOR1",189,0)\par
 Q\par
"RTN","AHMLDOR1",190,0)\par
 ;\par
"RTN","AHMLDOR1",191,0)\par
UNARR ;Unarrive an order that has been moved to "EXAMINED" status back to Waiting for Exam"\par
"RTN","AHMLDOR1",192,0)\par
 N RADFN,PROC,ORIEN,RAOIEN,EXSTAT\par
"RTN","AHMLDOR1",193,0)\par
 K RADTI,DA2,CONTMEDIA,FILMA,CPTMOD,FILMAMT,FILMSIZE,OBXCNT,PROCMOD,X,TECH,PRICAM,SIZE\par
"RTN","AHMLDOR1",194,0)\par
 Q:$P(HLARY("ORC",1),"^",5)'="CM"   ;Expecting CA:?? in 5th piece\par
"RTN","AHMLDOR1",195,0)\par
 S ORIEN=$P($G(HLARY("OBR",1)),"^",2)\par
"RTN","AHMLDOR1",196,0)\par
 ;BL;IA compliance change\par
"RTN","AHMLDOR1",197,0)\par
 S RAOIEN=$$GET1^DIQ(100,ORIEN,33,"I")\par
"RTN","AHMLDOR1",198,0)\par
 S PROC=$$GET1^DIQ(75.1,RAOIEN,2,"I")\par
"RTN","AHMLDOR1",199,0)\par
 S RADFN=$$GET1^DIQ(75.1,RAOIEN,.01,"I")\par
"RTN","AHMLDOR1",200,0)\par
 I RADFN="" S RAOROUT(1)="-1^NO RADIOLOGY PATIENT ON FILE" Q\par
"RTN","AHMLDOR1",201,0)\par
 S DFN=RADFN\par
"RTN","AHMLDOR1",202,0)\par
 D BLDA\par
"RTN","AHMLDOR1",203,0)\par
 I PROC="" S RAOROUT(1)="-1^ERROR MESSAGE-NO PROCEDURE" Q\par
"RTN","AHMLDOR1",204,0)\par
 S EXSTAT=$$GETSTA^AHMLDOR2(PROC,"WAITING FOR EXAM")  ;GET CODE FOR "WAITING FOR EXAM"\par
"RTN","AHMLDOR1",205,0)\par
 I EXSTAT="" S RAOROUT(1)="-1^ERROR MESSAGE-NO WAITING STATUS FOR PROCEDURE" Q\par
"RTN","AHMLDOR1",206,0)\par
 S RADFDA(75.1,RAOIEN_",",5)=EXSTAT     ; WAITING STATUS\par
"RTN","AHMLDOR1",207,0)\par
 D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR1",208,0)\par
 K RADFDA\par
"RTN","AHMLDOR1",209,0)\par
 ;NEED TO UPDATE 70 FILE\par
"RTN","AHMLDOR1",210,0)\par
 ;SET DA2 AND RADTI FOR 70 FILE\par
"RTN","AHMLDOR1",211,0)\par
 S RADTI=0,DA2="",FOUND=0\par
"RTN","AHMLDOR1",212,0)\par
 FOR  S RADTI=$O(^RADPT(RADFN,"DT",RADTI)) Q:'RADTI  D  Q:FOUND\par
"RTN","AHMLDOR1",213,0)\par
 . S DA2=0 FOR  S DA2=$O(^RADPT(RADFN,"DT",RADTI,"P",DA2)) Q:DA2'=+DA2  D  Q:FOUND\par
"RTN","AHMLDOR1",214,0)\par
 .. I $P(^RADPT(RADFN,"DT",RADTI,"P",DA2,0),"^",11)=RAOIEN S FOUND=1\par
"RTN","AHMLDOR1",215,0)\par
 ;If not found quit out with no case rad order found\par
"RTN","AHMLDOR1",216,0)\par
 I 'FOUND S RAOROUT(1)="-1^NO RADIOLOGY ORDER FOUND" Q\par
"RTN","AHMLDOR1",217,0)\par
 ;\par
"RTN","AHMLDOR1",218,0)\par
 S RADFDA(70.03,DA2_","_RADTI_","_RADFN_",",3)=EXSTAT  ;EXAM STATUS\par
"RTN","AHMLDOR1",219,0)\par
 D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR1",220,0)\par
 K RADFDA\par
"RTN","AHMLDOR1",221,0)\par
 ;\par
"RTN","AHMLDOR1",222,0)\par
 ;BL;MAKE CALL TO UTILITY TO SET 70.05 (EXAM STATUS CHANGE HISTORY)\par
"RTN","AHMLDOR1",223,0)\par
 D X7005^RADD3(RADFN,RADTI,DA2,"","",EXSTAT,RADARRY("DUZ"))\par
"RTN","AHMLDOR1",224,0)\par
 ;\par
"RTN","AHMLDOR1",225,0)\par
UNARRQ ;Report back exam status updated successfully\par
"RTN","AHMLDOR1",226,0)\par
 S:LROK RAOROUT(1)=ORIEN_"^RS" ; success\par
"RTN","AHMLDOR1",227,0)\par
 I 'LROK,'$D(RAOROUT(1)) S RAOROUT(1)="-1^UNARRIVE EXAM STATUS ERROR MESSAGE"\par
"RTN","AHMLDOR1",228,0)\par
 Q\par
"RTN","AHMLDOR1",229,0)\par
 ;\par
"RTN","AHMLDOR1",230,0)\par
CKREG ;  check if this exam has been registered:\par
"RTN","AHMLDOR1",231,0)\par
 ; input:   ORIEN\par
"RTN","AHMLDOR1",232,0)\par
 ; returns: RADTI,DA2,CASE,FOUND\par
"RTN","AHMLDOR1",233,0)\par
 N RAOIEN,RADFN,DA2,EXMST\par
"RTN","AHMLDOR1",234,0)\par
 S FOUND=0,CASE=""\par
"RTN","AHMLDOR1",235,0)\par
 ;\par
"RTN","AHMLDOR1",236,0)\par
 ;BL;IA compliance change\par
"RTN","AHMLDOR1",237,0)\par
 S RAOIEN=$$GET1^DIQ(100,ORIEN,33,"I")\par
"RTN","AHMLDOR1",238,0)\par
 S RADFN=$$GET1^DIQ(75.1,RAOIEN,.01,"I")\par
"RTN","AHMLDOR1",239,0)\par
 I 'RAOIEN S LROK=0,RAOROUT(1)="-1^ NO RAOIEN IN OR(100" Q\par
"RTN","AHMLDOR1",240,0)\par
 I 'RADFN S LROK=0,RAOROUT(1)="-1^ NO DFN IN ORDER FILE" Q\par
"RTN","AHMLDOR1",241,0)\par
 I $$GET1^DIQ(2,RADFN_",",.01,"I")="" S LROK=0,RAOROUT(1)="-1^"_RADFN_" NOT IN PATIENT FILE" Q \par
"RTN","AHMLDOR1",242,0)\par
 I '$D(^RAO(75.1,RAOIEN)) S LROK=0,RAOROUT(1)="-1^ COULD NOT FIND RAOIEN ENTRY IN RAO(75.1" Q\par
"RTN","AHMLDOR1",243,0)\par
 ;\par
"RTN","AHMLDOR1",244,0)\par
 S RADTI=0,DA2=""\par
"RTN","AHMLDOR1",245,0)\par
CASE ;\par
"RTN","AHMLDOR1",246,0)\par
 F  S RADTI=$O(^RADPT(RADFN,"DT",RADTI)) Q:'RADTI  D  Q:FOUND\par
"RTN","AHMLDOR1",247,0)\par
 .S DA2=0,DA2=$O(^RADPT(DFN,"DT",RADTI,"P",DA2))\par
"RTN","AHMLDOR1",248,0)\par
 .; 5161 - ignore find of case number if it has been cancelled\par
"RTN","AHMLDOR1",249,0)\par
 .Q:'DA2\par
"RTN","AHMLDOR1",250,0)\par
 .I $P(^RADPT(DFN,"DT",RADTI,"P",DA2,0),"^",11)=RAOIEN D\par
"RTN","AHMLDOR1",251,0)\par
 ..S EXMST=$$GET1^DIQ(70.03,DA2_","_RADTI_","_DFN_",","EXAM STATUS")\par
"RTN","AHMLDOR1",252,0)\par
 ..Q:EXMST="CANCELLED"\par
"RTN","AHMLDOR1",253,0)\par
 ..S FOUND=1,CASE=$P(^RADPT(DFN,"DT",RADTI,"P",DA2,0),"^")\par
"RTN","AHMLDOR1",254,0)\par
 ;\par
"RTN","AHMLDOR1",255,0)\par
 Q\par
"RTN","AHMLDOR1",256,0)\par
 ;\par
"RTN","AHMLDOR1",257,0)\par
BLDA ;Build an array to pass to AHMLDOR2\par
"RTN","AHMLDOR1",258,0)\par
 S RADARRY("DBKIND")=$G(DBKIND)\par
"RTN","AHMLDOR1",259,0)\par
 S RADARRY("DBCNT")=$G(DBCNT)\par
"RTN","AHMLDOR1",260,0)\par
 S RADARRY("ORIEN")=$G(ORIEN)\par
"RTN","AHMLDOR1",261,0)\par
 I $D(RADARRY("ORIEN"))="" S RADARRY("ORIEN")=$P($G(HLARY("OBR",1)),"^",2)\par
"RTN","AHMLDOR1",262,0)\par
 S RADARRY("IMGTYP")=$G(IMGTYP)        ;type of image=>79.2\par
"RTN","AHMLDOR1",263,0)\par
 S RADARRY("HOSDIV")=500  ;BL;TEMPORARY FIX FOR CRASHING DAILY REPORTS ;$G(HOSDIV)   ; hospital division=>79\par
"RTN","AHMLDOR1",264,0)\par
 S RADARRY("IMGLOC")=$G(IMGLOC)        ;imaging location=>79.1\par
"RTN","AHMLDOR1",265,0)\par
 S RADARRY("CASE")=$G(CASE)            ;case#\par
"RTN","AHMLDOR1",266,0)\par
 S RADARRY("PROC")=$G(PROC)            ;procedure=>71\par
"RTN","AHMLDOR1",267,0)\par
 S RADARRY("EXSTAT")=$G(EXMSTA)        ;exam status=>72\par
"RTN","AHMLDOR1",268,0)\par
 S RADARRY("EXCAT")=$G(CATEG)          ;category of exam:codes\par
"RTN","AHMLDOR1",269,0)\par
 S RADARRY("WARD")=$G(WARD)            ;ward=>42\par
"RTN","AHMLDOR1",270,0)\par
 S RADARRY("SERVC")=$G(SERVICE)          ;service=>49\par
"RTN","AHMLDOR1",271,0)\par
 S RADARRY("RAOIEN")=$G(RAOIEN)        ;imaging order=>75.1\par
"RTN","AHMLDOR1",272,0)\par
 S RADARRY("REQPRV")=$G(REQPRV)        ;requesting provider\par
"RTN","AHMLDOR1",273,0)\par
 S RADARRY("BED")=$G(BED)              ;bedsection=>42.4\par
"RTN","AHMLDOR1",274,0)\par
 S RADARRY("REQDT")=$G(REQDT)          ;request date\par
"RTN","AHMLDOR1",275,0)\par
 S RADARRY("REQLOC")=$G(REQLOC)        ;request location=>44\par
"RTN","AHMLDOR1",276,0)\par
 S RADARRY("CRDMTH")=$G(CRDMTH)        ;credit method: codes\par
"RTN","AHMLDOR1",277,0)\par
 S RADARRY("REQSTA")=$G(REQSTA)        ;request status:codes\par
"RTN","AHMLDOR1",278,0)\par
 D NOW^%DTC S NOW=% K %\par
"RTN","AHMLDOR1",279,0)\par
 S RADARRY("NOW")=NOW                  ;activity d/t\par
"RTN","AHMLDOR1",280,0)\par
 S RADARRY("RAONWSTA")=$G(RAONWSTA)    ;new status:codes\par
"RTN","AHMLDOR1",281,0)\par
 S RADARRY("DUZ")=$G(DUZ)              ;computer user\par
"RTN","AHMLDOR1",282,0)\par
 S RADARRY("DFN")=DFN                  ;patient=>2\par
"RTN","AHMLDOR1",283,0)\par
 S RADARRY("EXMDT")=$G(EXMDT)          ;exam dt\par
"RTN","AHMLDOR1",284,0)\par
 S RADARRY("RPTSTA")=$G(RPTSTA)        ;report status:codes\par
"RTN","AHMLDOR1",285,0)\par
 S RADARRY("RPTENTDT")=$G(RPTENTDT)    ;date report entered\par
"RTN","AHMLDOR1",286,0)\par
 S RADARRY("VRFDT")=$G(VRFDT)          ;verified date\par
"RTN","AHMLDOR1",287,0)\par
 S RADARRY("RPTDT")=$G(RPTDT)          ;reported date\par
"RTN","AHMLDOR1",288,0)\par
 S RADARRY("VRFPHY")=+$G(VRFPHY)       ;verifying physician\par
"RTN","AHMLDOR1",289,0)\par
 ;4833 Esig can't be updated here must wait until RPTIEN^JVHLRA2\par
"RTN","AHMLDOR1",290,0)\par
 S RADARRY("ESCD")=$G(ESCD)            ;electronic signature code\par
"RTN","AHMLDOR1",291,0)\par
 S RADARRY("TRNSCP")=$G(TRNSCP)        ;transcriptionist\par
"RTN","AHMLDOR1",292,0)\par
 ;4833 verfied by phy\par
"RTN","AHMLDOR1",293,0)\par
 S SCVBY=$G(VRFPHY)                    ;verifying phy also used here\par
"RTN","AHMLDOR1",294,0)\par
 S RADARRY("SCVBY")=$G(SCVBY)          ;status changed to verified by\par
"RTN","AHMLDOR1",295,0)\par
 S RADARRY("ITRLOC")=$G(ITRLOC)        ;interpreting imaging loc=>79.1\par
"RTN","AHMLDOR1",296,0)\par
 S RADARRY("ACTION")=$G(ACTION)        ;type of action\par
"RTN","AHMLDOR1",297,0)\par
 S RADARRY("PRIDGC")=$G(PRIDGC)        ;primary diagnosis code=>74\par
"RTN","AHMLDOR1",298,0)\par
 S RADARRY("SECDGC")=$G(SECDGC)\par
"RTN","AHMLDOR1",299,0)\par
 S RADARRY("PRISTF")=$G(PRISTF)        ;primary interpreting staff\par
"RTN","AHMLDOR1",300,0)\par
 S RADARRY("RPTIEN")=$G(RPTIEN)        ;report text=>74\par
"RTN","AHMLDOR1",301,0)\par
 S RADARRY("PRGFLG")=$G(PRGFLG)        ; pregnancy flag  ;rhl 20100927\par
"RTN","AHMLDOR1",302,0)\par
 ;BL;Examined status fields added CQ 3229\par
"RTN","AHMLDOR1",303,0)\par
 S RADARRY("CONTMEDIA")=$G(CONTMEDIA)  ;Contrast Media Used \par
"RTN","AHMLDOR1",304,0)\par
 S RADARRY("FILMSIZE")=$G(FILMSIZE)    ;Film Size \par
"RTN","AHMLDOR1",305,0)\par
 S RADARRY("FILMAMT")=$G(FILMAMT)      ;Amount (# films) \par
"RTN","AHMLDOR1",306,0)\par
 S RADARRY("PRICAM")=$G(PRICAM)        ;Primary Camera/Equip/Rm ***\par
"RTN","AHMLDOR1",307,0)\par
 ;Must have a default PROCMOD & CPTMOD to prevent reversion of status\par
"RTN","AHMLDOR1",308,0)\par
 ;Using NO MODIFIER for default\par
"RTN","AHMLDOR1",309,0)\par
 I '$D(PMOD) S PMOD(1)="NO MODIFIER"\par
"RTN","AHMLDOR1",310,0)\par
 I $D(PMOD) D\par
"RTN","AHMLDOR1",311,0)\par
 . S I="" F  S I=$O(PMOD(I)) Q:I=""  D\par
"RTN","AHMLDOR1",312,0)\par
 . . Q:PMOD(I)=""\par
"RTN","AHMLDOR1",313,0)\par
 . . S X=PMOD(I),PROCMOD="",PROCMOD=$O(^RAMIS(71.2,"B",X,PROCMOD))\par
"RTN","AHMLDOR1",314,0)\par
 . . S PMOD(I)=$G(PROCMOD)\par
"RTN","AHMLDOR1",315,0)\par
 I PMOD(1)="" K PMOD(1)\par
"RTN","AHMLDOR1",316,0)\par
 S CPTMOD=""\par
"RTN","AHMLDOR1",317,0)\par
 S RADARRY("CPTMOD")=$G(CPTMOD)\par
"RTN","AHMLDOR1",318,0)\par
 ;Using normal healthy patient as defautl CPTMOD\par
"RTN","AHMLDOR1",319,0)\par
 ;CHCS does not send cpt modifiers.\par
"RTN","AHMLDOR1",320,0)\par
 ;\par
"RTN","AHMLDOR1",321,0)\par
 ;Kill off hanging variables from other routines\par
"RTN","AHMLDOR1",322,0)\par
 K RPTIEN,PRISTF,ACTION,ITRLOC,SCVBY,TRNSCP,ESCD,VRFPHY,RPTDT,VRFDT,RPTENTDT,RPTSTA,CASE,EXMDT,DFN,ACTION,BED,CRDMTH,ESCD\par
"RTN","AHMLDOR1",323,0)\par
 K EXCAT,EXSTAT,HLARY,HOSDIV,IMGLOC,IMGTYP,NOW,ORIEN,PROC,RAONWSTA\par
"RTN","AHMLDOR1",324,0)\par
 K REQLOC,REQPRV,REQSTA,SERVC,WARD,RAOROUT,PRGFLG\par
"RTN","AHMLDOR1",325,0)\par
 K DBKIND,DBCNT\par
"RTN","AHMLDOR1",326,0)\par
 Q\par
"RTN","AHMLDOR1",327,0)\par
 ;\par
"RTN","AHMLDOR1",328,0)\par
HLD ; Put Rad orders on Hold\par
"RTN","AHMLDOR1",329,0)\par
 N CSN,DA,DIE,HLDTE,RAPROV,STS,ORID,FND\par
"RTN","AHMLDOR1",330,0)\par
 S FND=0\par
"RTN","AHMLDOR1",331,0)\par
 S ORID=$P(HLARY("ORC",1),"|",2)\par
"RTN","AHMLDOR1",332,0)\par
 I '$D(^OR(100,ORID)) S RAOROUT(1)="-1^Error: Order number is not a valid VA order number." Q\par
"RTN","AHMLDOR1",333,0)\par
 ;BL;IA compliance change\par
"RTN","AHMLDOR1",334,0)\par
 ;CHECK FOR HOLD COMMENTS\par
"RTN","AHMLDOR1",335,0)\par
 I $D(HLARY("OBX")) D\par
"RTN","AHMLDOR1",336,0)\par
 .F OBXCNT=0:0 S OBXCNT=$O(HLARY("OBX",OBXCNT)) Q:'OBXCNT  D  Q:FND\par
"RTN","AHMLDOR1",337,0)\par
 ..S X=HLARY("OBX",OBXCNT)\par
"RTN","AHMLDOR1",338,0)\par
 ..I $P(X,RD1,3)["TCM" S TECH=$P(X,RD1,5)\par
"RTN","AHMLDOR1",339,0)\par
 ..I $G(TECH)'="" S FND=1 Q\par
"RTN","AHMLDOR1",340,0)\par
 S CSN=$$GET1^DIQ(100,ORID,33,"I")\par
"RTN","AHMLDOR1",341,0)\par
 S STS=3\par
"RTN","AHMLDOR1",342,0)\par
 S DIE="^OR(100,",DA=ORID,DR="5////"_STS_";" D ^DIE K DIE,DA,DR\par
"RTN","AHMLDOR1",343,0)\par
 I '$D(^RAO(75.1,CSN)) Q\par
"RTN","AHMLDOR1",344,0)\par
 ;BL;IA compliance change\par
"RTN","AHMLDOR1",345,0)\par
 S RAPROV=$$GET1^DIQ(100,ORID,1,"I")\par
"RTN","AHMLDOR1",346,0)\par
 D PROXY^AHMLDOR2(.RAPROV,.RAPRVNME)\par
"RTN","AHMLDOR1",347,0)\par
 S HLDTE=$$GET1^DIQ(100,ORID,31,"I")\par
"RTN","AHMLDOR1",348,0)\par
 I '$D(^RAO(75.1,CSN,"T")) S ^RAO(75.1,CSN,"T",0)="^75.12DA^^"\par
"RTN","AHMLDOR1",349,0)\par
 S DA=$P(^RAO(75.1,CSN,"T",0),"^",3),DA=DA+1\par
"RTN","AHMLDOR1",350,0)\par
 S $P(^RAO(75.1,CSN,"T",0),"^",3)=DA,$P(^RAO(75.1,CSN,"T",0),"^",4)=DA\par
"RTN","AHMLDOR1",351,0)\par
 S ^RAO(75.1,CSN,"T",DA,0)=HLDTE_"^"_STS_"^"_RAPROV\par
"RTN","AHMLDOR1",352,0)\par
 S DIE="^RAO(75.1,",DA=CSN,DR="5////"_STS_";" D ^DIE K DIE,STS,DR,DA\par
"RTN","AHMLDOR1",353,0)\par
 ; GET RADTI AND RACNI\par
"RTN","AHMLDOR1",354,0)\par
 S RAOIEN=CSN,RADFN=$$GET1^DIQ(75.1,RAOIEN,.01,"I")\par
"RTN","AHMLDOR1",355,0)\par
 S (FOUND,RADTI)=0,RACNI="",NOW=$$NOW^XLFDT\par
"RTN","AHMLDOR1",356,0)\par
 F  S RADTI=$O(^RADPT(RADFN,"DT",RADTI)) Q:'RADTI  D  Q:FOUND\par
"RTN","AHMLDOR1",357,0)\par
 .S RACNI=0 F  S RACNI=$O(^RADPT(RADFN,"DT",RADTI,"P",RACNI)) Q:'RACNI  D  Q:FOUND\par
"RTN","AHMLDOR1",358,0)\par
 ..I $P(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0),"^",11)=RAOIEN D\par
"RTN","AHMLDOR1",359,0)\par
 ...S FOUND=1\par
"RTN","AHMLDOR1",360,0)\par
 ...S CASE=$P(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0),"^")\par
"RTN","AHMLDOR1",361,0)\par
 I FOUND D\par
"RTN","AHMLDOR1",362,0)\par
 .S RAIENS=""_RACNI_","_RADTI_","_RADFN_","\par
"RTN","AHMLDOR1",363,0)\par
 .S RAFDA(70.03,RAIENS,3)="CANCELLED"\par
"RTN","AHMLDOR1",364,0)\par
 .D FILE^DIE("KSE","RAFDA","RAERR")\par
"RTN","AHMLDOR1",365,0)\par
 .K RAIENS,RAFDA\par
"RTN","AHMLDOR1",366,0)\par
 .S RAIENS="+1,"_RACNI_","_RADTI_","_RADFN_","\par
"RTN","AHMLDOR1",367,0)\par
 .S RAFDA(70.05,RAIENS,.01)=NOW\par
"RTN","AHMLDOR1",368,0)\par
 .D UPDATE^DIE(,"RAFDA","RAIEN","RAERR")\par
"RTN","AHMLDOR1",369,0)\par
 .K RAIENS,RAFDA\par
"RTN","AHMLDOR1",370,0)\par
 .S RAIENS=RAIEN(1)_","_RACNI_","_RADTI_","_RADFN_","\par
"RTN","AHMLDOR1",371,0)\par
 .S RAFDA(70.05,RAIENS,2)=3\par
"RTN","AHMLDOR1",372,0)\par
 .S RAFDA(70.05,RAIENS,3)=RAPROV\par
"RTN","AHMLDOR1",373,0)\par
 .D FILE^DIE(,"RAFDA","RAERR")\par
"RTN","AHMLDOR1",374,0)\par
 .K RAFDA,RAIENS,RAIEN\par
"RTN","AHMLDOR1",375,0)\par
 .S RAIENS="+1,"_RACNI_","_RADTI_","_RADFN_","\par
"RTN","AHMLDOR1",376,0)\par
 .S RAFDA(70.07,RAIENS,.01)=NOW\par
"RTN","AHMLDOR1",377,0)\par
 .D UPDATE^DIE("E","RAFDA","RAIEN","RAMSG")\par
"RTN","AHMLDOR1",378,0)\par
 .K RAIENS,RAFDA\par
"RTN","AHMLDOR1",379,0)\par
 .S RAIENS=RAIEN(1)_","_RACNI_","_RADTI_","_RADFN_","\par
"RTN","AHMLDOR1",380,0)\par
 .S RAFDA(70.07,RAIENS,2)="X"\par
"RTN","AHMLDOR1",381,0)\par
 .S RAFDA(70.07,RAIENS,3)=RAPROV\par
"RTN","AHMLDOR1",382,0)\par
 .S RAFDA(70.07,RAIENS,4)=$G(TECH)\par
"RTN","AHMLDOR1",383,0)\par
 .D FILE^DIE(,"RAFDA","RAERR")\par
"RTN","AHMLDOR1",384,0)\par
 S RAOROUT(1)=ORID_"^RS"\par
"RTN","AHMLDOR1",385,0)\par
 Q\par
"RTN","AHMLDOR1",386,0)\par
 ;\par
"RTN","AHMLDOR1",387,0)\par
PRGSET ;Set pregnancy flag in RAO(75.1 and OR(100\par
"RTN","AHMLDOR1",388,0)\par
 ;This is only done on an update, changing an existing pregnancy status\par
"RTN","AHMLDOR1",389,0)\par
 K PRGDONE,PRGSEQ,LSTSEQ,PRGTEXT,PRGTEXT1,PRGTEXT2,RADFDA\par
"RTN","AHMLDOR1",390,0)\par
 S PRGSEQ=0,PRGDONE=0  ;pregnancy sequence\par
"RTN","AHMLDOR1",391,0)\par
 F  S PRGSEQ=$O(^OR(100,ORIEN,4.5,PRGSEQ)) Q:PRGSEQ'=+PRGSEQ  D  Q:PRGDONE\par
"RTN","AHMLDOR1",392,0)\par
 . I ^OR(100,ORIEN,4.5,PRGSEQ,0)["PREGNANT" S PRGDONE=1\par
"RTN","AHMLDOR1",393,0)\par
 . S LSTSEQ=PRGSEQ\par
"RTN","AHMLDOR1",394,0)\par
 N ORDIALOG\par
"RTN","AHMLDOR1",395,0)\par
 S PRGFLG=$TR(PRGFLG,"nyu","NYU")\par
"RTN","AHMLDOR1",396,0)\par
 D GETDLG^ORCD(1)\par
"RTN","AHMLDOR1",397,0)\par
 S PRGTEXT1=$P(ORDIALOG("B","PREGNANT"),"^",2)\par
"RTN","AHMLDOR1",398,0)\par
 S PRGTEXT2=$P(ORDIALOG(PRGTEXT1),"^")\par
"RTN","AHMLDOR1",399,0)\par
 S PRGTEXT=PRGTEXT2_"^"_PRGTEXT1_"^1^PREGNANT"\par
"RTN","AHMLDOR1",400,0)\par
 K ORDIALOG\par
"RTN","AHMLDOR1",401,0)\par
 I PRGDONE=0 D  ;IF NO PREGNANCY STATUS HAS BEEN STORED\par
"RTN","AHMLDOR1",402,0)\par
 . N RAIEN,RADFDA,RADFILE\par
"RTN","AHMLDOR1",403,0)\par
 . S RADFILE=100.045,RAIEN=ORIEN_","\par
"RTN","AHMLDOR1",404,0)\par
 . S RADFDA(1,RADFILE,"+1,"_RAIEN,.01)=PRGTEXT2\par
"RTN","AHMLDOR1",405,0)\par
 . S RADFDA(1,RADFILE,"+1,"_RAIEN,.02)=PRGTEXT1\par
"RTN","AHMLDOR1",406,0)\par
 . S RADFDA(1,RADFILE,"+1,"_RAIEN,.03)="1"\par
"RTN","AHMLDOR1",407,0)\par
 . S RADFDA(1,RADFILE,"+1,"_RAIEN,.04)="PREGNANT"\par
"RTN","AHMLDOR1",408,0)\par
 . S RADFDA(1,RADFILE,"+1,"_RAIEN,1)=PRGFLG\par
"RTN","AHMLDOR1",409,0)\par
 . D UPDATE^DIE("","RADFDA(1)","","ERRMSG") K RADFDA,RADFILE,RAIEN\par
"RTN","AHMLDOR1",410,0)\par
 I PRGDONE=1 D  ;IF MODIFYING A PREGNANCY STATUS\par
"RTN","AHMLDOR1",411,0)\par
 . N RAIEN,RADFDA,RADFILE\par
"RTN","AHMLDOR1",412,0)\par
 . S RADFILE=100.045,RAIEN=LSTSEQ_","_ORIEN_","\par
"RTN","AHMLDOR1",413,0)\par
 . S RADFDA(RADFILE,RAIEN,1)=PRGFLG\par
"RTN","AHMLDOR1",414,0)\par
 . D FILE^DIE("","RADFDA","ERRMSG") K RADFDA,RADFILE,RAIEN\par
"RTN","AHMLDOR1",415,0)\par
 S RAOIEN=+$G(^OR(100,ORIEN,4)) ; pointer to RAO(75.1\par
"RTN","AHMLDOR1",416,0)\par
 S RADFDA(75.1,RAOIEN_",",13)=RADARRY("PRGFLG")     ; preg flag ; rhl 20100927\par
"RTN","AHMLDOR1",417,0)\par
 D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR2")\par
0^11^B97217147\par
"RTN","AHMLDOR2",1,0)\par
RAHBIN2 ;LEIDOS/TCK- REMOTE ORDERING - Radiology - PARSER ; 10/16/16 8:55pm\par
"RTN","AHMLDOR2",2,0)\par
 ;;1.0;Radiology Orders Portability;** GSN TEST VERSION ***;April 1, 2016;Build 26\par
"RTN","AHMLDOR2",3,0)\par
 ; Reference to NOW^%DTC supported by IA #10000\par
"RTN","AHMLDOR2",4,0)\par
 ; Reference to ^OR(100 supported by IA #5196\par
"RTN","AHMLDOR2",5,0)\par
 ; Reference to ^RAMIS(71 supported by IA #5607\par
"RTN","AHMLDOR2",6,0)\par
 ; Reference to ^RADPT( supported by IA #5602\par
"RTN","AHMLDOR2",7,0)\par
 ; Reference to ^RAO(75.1 supported by IA #5604\par
"RTN","AHMLDOR2",8,0)\par
 ; Reference to ^DPT( supported by IA #10035\par
"RTN","AHMLDOR2",9,0)\par
 ; Reference to ^VA(200 supported by IA #10060\par
"RTN","AHMLDOR2",10,0)\par
 ; Reference to ^RA(79.1 supported by IA #5610\par
"RTN","AHMLDOR2",11,0)\par
 ; Reference to CN^RAREG1 supported by IA #5479\par
"RTN","AHMLDOR2",12,0)\par
 ; Reference to HL7TFM^XLFDT supported by IA #10103\par
"RTN","AHMLDOR2",13,0)\par
 ; Reference to ^RA(72 supported by IA #5606\par
"RTN","AHMLDOR2",14,0)\par
 ;\par
"RTN","AHMLDOR2",15,0)\par
 ; updated 20100908\par
"RTN","AHMLDOR2",16,0)\par
 ; updated 20110509 dje: document IAs, code cleanup\par
"RTN","AHMLDOR2",17,0)\par
 ;\par
"RTN","AHMLDOR2",18,0)\par
 ; gsn  - convert to RD1 type delimiters.\par
"RTN","AHMLDOR2",19,0)\par
 ; 4839 - add Impression txt for filing seperately from report txt\par
"RTN","AHMLDOR2",20,0)\par
 ;        also had to rework amendment text logic here and in rtn\par
"RTN","AHMLDOR2",21,0)\par
 ;        AHMLDOR2.\par
"RTN","AHMLDOR2",22,0)\par
 ; 5265 - Add the "AE xref after we get case number so other processes\par
"RTN","AHMLDOR2",23,0)\par
 ;        also calling CN^RARE1, will see the case number is in use.\par
"RTN","AHMLDOR2",24,0)\par
 ;\par
"RTN","AHMLDOR2",25,0)\par
 Q\par
"RTN","AHMLDOR2",26,0)\par
 ;\par
"RTN","AHMLDOR2",27,0)\par
EN ;\par
"RTN","AHMLDOR2",28,0)\par
 N X,OBXCNT,RCNT,STOP\par
"RTN","AHMLDOR2",29,0)\par
 K PRGFLG S PRGFLG=""\par
"RTN","AHMLDOR2",30,0)\par
 ;\par
"RTN","AHMLDOR2",31,0)\par
 ;   process HL7 segments:\par
"RTN","AHMLDOR2",32,0)\par
PID ;\par
"RTN","AHMLDOR2",33,0)\par
 K DFN\par
"RTN","AHMLDOR2",34,0)\par
 S DFN=""\par
"RTN","AHMLDOR2",35,0)\par
 S X=HLARY("PID",1),DFN=$P(X,RD1,2)\par
"RTN","AHMLDOR2",36,0)\par
 I DFN["-" S DFN=+$P(DFN,"-",2)\par
"RTN","AHMLDOR2",37,0)\par
 ;I $G(NAME)'="" S DFN="",DFN=$O(^DPT("B",NAME,DFN))\par
"RTN","AHMLDOR2",38,0)\par
 S SEX=$$GET1^DIQ(2,DFN,.02,"I")\par
"RTN","AHMLDOR2",39,0)\par
 ;\par
"RTN","AHMLDOR2",40,0)\par
PV1 ;\par
"RTN","AHMLDOR2",41,0)\par
 S X=$G(HLARY("PV1",1)) D  ; rhl 20100927\par
"RTN","AHMLDOR2",42,0)\par
 . S X="NO"\par
"RTN","AHMLDOR2",43,0)\par
 . S PRGFLG=$P(X,RD1,15),PRGFLG=$E(PRGFLG,1),PRGFLG=$TR(PRGFLG,"YNU","ynu")\par
"RTN","AHMLDOR2",44,0)\par
 . I PRGFLG'="y",PRGFLG'="n",PRGFLG'="u" S PRGFLG=""\par
"RTN","AHMLDOR2",45,0)\par
 ;\par
"RTN","AHMLDOR2",46,0)\par
ORC ;\par
"RTN","AHMLDOR2",47,0)\par
 I $D(HLARY("ORC")) D\par
"RTN","AHMLDOR2",48,0)\par
 .S X=HLARY("ORC",1),EXMDT=$P(X,RD1,9)\par
"RTN","AHMLDOR2",49,0)\par
 .S:'EXMDT EXMDT=$P(X,"^",14) I 'EXMDT D NOW^%DTC S EXMDT=%\par
"RTN","AHMLDOR2",50,0)\par
 .S EXMDT=$$HLD(EXMDT),REQDT=EXMDT\par
"RTN","AHMLDOR2",51,0)\par
 .S EXMSTA=$P($P(X,"|",17),"^")\par
"RTN","AHMLDOR2",52,0)\par
 .S CATEG=$P($P(X,"|",17),"^",2)\par
"RTN","AHMLDOR2",53,0)\par
 .S WARD=$P($P(X,"|",17),"^",3)\par
"RTN","AHMLDOR2",54,0)\par
 .S SERVICE=$P($P(X,"|",17),"^",4)\par
"RTN","AHMLDOR2",55,0)\par
 .S OR=$P(X,2),ST=$$GET1^DIQ(100,OR,5,"I")\par
"RTN","AHMLDOR2",56,0)\par
 .I ST=5 S RAONWSTA=6\par
"RTN","AHMLDOR2",57,0)\par
 .I ST=6 S RAONWSTA=2\par
"RTN","AHMLDOR2",58,0)\par
 .S USER=$P(X,"|",10),USER=$P(USER,"^",2,3),USER=$TR(USER,"^",",")\par
"RTN","AHMLDOR2",59,0)\par
 .S RADARRY("USER")=$G(USER)\par
"RTN","AHMLDOR2",60,0)\par
OBR ;\par
"RTN","AHMLDOR2",61,0)\par
 K ORIEN,IMGLOC,PRISTF,PROC,REQPRV,RPTSTA,RPTDT,TRNSCP,VRFDT,ITRLOC,VRFPHY\par
"RTN","AHMLDOR2",62,0)\par
 ;K RADARRY("RPTSTA")\par
"RTN","AHMLDOR2",63,0)\par
 S ORIEN="",IMGLOC="",ITRLOC="",VRFPHYN=""\par
"RTN","AHMLDOR2",64,0)\par
 N %\par
"RTN","AHMLDOR2",65,0)\par
 S X=HLARY("OBR",1),IMGLOC=+$P($P(X,RD1,21),"`",2),PROC=+$P($P(X,RD1,4),"^",4),REQPRV=$P(X,RD1,16),PRISTF=0,VRFPHY=$P(X,RD1,32)\par
"RTN","AHMLDOR2",66,0)\par
 S PRVNM=$P(REQPRV,"^",2,3) I PRVNM["^" S PRVNM=$TR(PRVNM,"^",",")\par
"RTN","AHMLDOR2",67,0)\par
 I PRVNM'="",$D(^VA(200,"B",PRVNM)) D\par
"RTN","AHMLDOR2",68,0)\par
 .S REQPRV="",REQPRV=$O(^VA(200,"B",PRVNM,REQPRV))\par
"RTN","AHMLDOR2",69,0)\par
 I PRVNM=""!('$D(^VA(200,"B",PRVNM))) D PROXY(.REQPRV,.PRVNM)\par
"RTN","AHMLDOR2",70,0)\par
 I VRFPHY="" S VRFPHY=0\par
"RTN","AHMLDOR2",71,0)\par
 D PROXY(.VRFPHY,.VRFPHYN)\par
"RTN","AHMLDOR2",72,0)\par
 S USER=$P(X,"|",35),USER=$P(USER,"^",2,3),USER=$TR(USER,"^",",")\par
"RTN","AHMLDOR2",73,0)\par
 S ITRLOC=+$P($P(X,RD1,21),"`",2)\par
"RTN","AHMLDOR2",74,0)\par
 I $G(EXMDT)'>0 D\par
"RTN","AHMLDOR2",75,0)\par
 .S EXMDT=$P(X,RD1,7)\par
"RTN","AHMLDOR2",76,0)\par
 .S:'EXMDT EXMDT=$P(X,"^",14)\par
"RTN","AHMLDOR2",77,0)\par
 .I 'EXMDT D NOW^%DTC S EXMDT=%\par
"RTN","AHMLDOR2",78,0)\par
 .S EXMDT=$$HLD(EXMDT),REQDT=EXMDT\par
"RTN","AHMLDOR2",79,0)\par
 S RPTSTA=$P(X,RD1,25),RPTDT=$$HLD($P(X,RD1,22)),TRNSCP=+$P(X,RD1,35)\par
"RTN","AHMLDOR2",80,0)\par
 S VRFDT=$P(X,RD1,22),VRFDT=$$HLD($P(X,RD1,22)),ORIEN=+$P(X,RD1,2)\par
"RTN","AHMLDOR2",81,0)\par
 I RPTSTA="F" S RPTSTA="V"  ;BSL;Fix to allow results viewing\par
"RTN","AHMLDOR2",82,0)\par
 S RADARRY("RPTSTA")=RPTSTA\par
"RTN","AHMLDOR2",83,0)\par
 S RADARRY("USER")=$G(USER)\par
"RTN","AHMLDOR2",84,0)\par
 ;\par
"RTN","AHMLDOR2",85,0)\par
 I $G(NWSTATUS)'="",$G(PROC) S EXSTAT=$$GETSTA(PROC,NWSTATUS) ; rhl 20100929\par
"RTN","AHMLDOR2",86,0)\par
 S RADARRY("EXSTAT")=$G(EXSTAT)\par
"RTN","AHMLDOR2",87,0)\par
 ;\par
"RTN","AHMLDOR2",88,0)\par
OBX ; \par
"RTN","AHMLDOR2",89,0)\par
 N HCNT,ICNT,RCNT,IMPBEG,RAAM,AMENDED,DELIM,RATMP,SKIP,TXT\par
"RTN","AHMLDOR2",90,0)\par
 S (IMPBEG,RAAM)=0\par
"RTN","AHMLDOR2",91,0)\par
 ;\par
"RTN","AHMLDOR2",92,0)\par
 ;4839:\par
"RTN","AHMLDOR2",93,0)\par
 S (RCNT,HCNT,ICNT)=1 ;init these counters when first OBX happens\par
"RTN","AHMLDOR2",94,0)\par
 ;\par
"RTN","AHMLDOR2",95,0)\par
 ;Loop thru HLARY and convert Report nodes, which qaulify, to\par
"RTN","AHMLDOR2",96,0)\par
 ;Impression nodes.\par
"RTN","AHMLDOR2",97,0)\par
 ;\par
"RTN","AHMLDOR2",98,0)\par
 F OBXCNT=0:0 S OBXCNT=$O(HLARY("OBX",OBXCNT)) Q:'OBXCNT  D\par
"RTN","AHMLDOR2",99,0)\par
 . S X=HLARY("OBX",OBXCNT)\par
"RTN","AHMLDOR2",100,0)\par
 . Q:($P(X,RD1,3)'["REPORT")&($P(X,RD1,3)'["RESCODE")\par
"RTN","AHMLDOR2",101,0)\par
 . ;check for beginning of IMP txt\par
"RTN","AHMLDOR2",102,0)\par
 . S:$$UP^XLFSTR($P(X,RD1,5))["IMPRESSION:" IMPBEG=1\par
"RTN","AHMLDOR2",103,0)\par
 . I $P(X,RD1,3)["RESCODE" S IMPBEG=0   ;reset impbeg at Rescode line\par
"RTN","AHMLDOR2",104,0)\par
 . I IMPBEG D\par
"RTN","AHMLDOR2",105,0)\par
 .. S $P(X,RD1,3)="I\\IMPRESSION\\L",HLARY("OBX",OBXCNT)=X\par
"RTN","AHMLDOR2",106,0)\par
 ;\par
"RTN","AHMLDOR2",107,0)\par
 ;Now loop thru HLARY & determine type of text and call correct tag\par
"RTN","AHMLDOR2",108,0)\par
 ;\par
"RTN","AHMLDOR2",109,0)\par
 K OCXCNT,PRIDGC\par
"RTN","AHMLDOR2",110,0)\par
 S (PRIDGC,PRIFLG)=0\par
"RTN","AHMLDOR2",111,0)\par
 F OBXCNT=0:0 S OBXCNT=$O(HLARY("OBX",OBXCNT)) Q:'OBXCNT  D\par
"RTN","AHMLDOR2",112,0)\par
 . S X=HLARY("OBX",OBXCNT)\par
"RTN","AHMLDOR2",113,0)\par
 . I $P(X,RD1,3)["TECH" S RADARRY("TECH")=$P(X,RD1,5) Q\par
"RTN","AHMLDOR2",114,0)\par
 . I $P(X,RD1,3)["MODIFIERS" D OBXMOD Q\par
"RTN","AHMLDOR2",115,0)\par
 . I $P(X,RD1,3)["DIAGNOSTIC" D OBXDGN Q\par
"RTN","AHMLDOR2",116,0)\par
 . I $P(X,RD1,3)["REPORT" D OBXRPT Q\par
"RTN","AHMLDOR2",117,0)\par
 . I $P(X,RD1,3)["HISTORY" D OBXHST Q\par
"RTN","AHMLDOR2",118,0)\par
 . I $P(X,RD1,3)["IMPRESSION" D OBXIMP Q\par
"RTN","AHMLDOR2",119,0)\par
 ;\par
"RTN","AHMLDOR2",120,0)\par
 ;4839:\par
"RTN","AHMLDOR2",121,0)\par
 ;determine the last update sent (RAAM) just sent via DOD HL7 msg\par
"RTN","AHMLDOR2",122,0)\par
 ;as DOD sends ALL text, the orig text + all amendments to date.\par
"RTN","AHMLDOR2",123,0)\par
 ;  RAAM=1 is an orig final report, 2 or more are amendments\par
"RTN","AHMLDOR2",124,0)\par
 ;\par
"RTN","AHMLDOR2",125,0)\par
 I $D(WPRT) S RATMP=$O(WPRT(999),-1) S:RATMP>RAAM RAAM=RATMP\par
"RTN","AHMLDOR2",126,0)\par
 I $D(WPIT) S RATMP=$O(WPIT(999),-1) S:RATMP>RAAM RAAM=RATMP\par
"RTN","AHMLDOR2",127,0)\par
 I $D(WPACH) S RATMP=$O(WPACH(999),-1) S:RATMP>RAAM RAAM=RATMP\par
"RTN","AHMLDOR2",128,0)\par
 ;\par
"RTN","AHMLDOR2",129,0)\par
 ;now init report & imp text arrays only if they had amended text\par
"RTN","AHMLDOR2",130,0)\par
 ;that was just sent, else kill that specific array to stop its update\par
"RTN","AHMLDOR2",131,0)\par
 I $D(WPRT(RAAM)) M TMP=WPRT(RAAM) K WPRT M WPRT=TMP K TMP\par
"RTN","AHMLDOR2",132,0)\par
 E  K WPRT\par
"RTN","AHMLDOR2",133,0)\par
 I $D(WPIT(RAAM)) M TMP=WPIT(RAAM) K WPIT M WPIT=TMP K TMP\par
"RTN","AHMLDOR2",134,0)\par
 E  K WPIT\par
"RTN","AHMLDOR2",135,0)\par
 I $D(WPACH(RAAM)) M TMP=WPACH(RAAM) K WPACH M WPACH=TMP K TMP\par
"RTN","AHMLDOR2",136,0)\par
 E  K WPACH\par
"RTN","AHMLDOR2",137,0)\par
 Q\par
"RTN","AHMLDOR2",138,0)\par
 ;====================================================================\par
"RTN","AHMLDOR2",139,0)\par
 ;\par
"RTN","AHMLDOR2",140,0)\par
PROXY(VAL,VAL1) ;\par
"RTN","AHMLDOR2",141,0)\par
 S VAL1="PROXY,PROVIDER"\par
"RTN","AHMLDOR2",142,0)\par
 I $D(^VA(200,"B",VAL1)) S VAL="",VAL=$O(^VA(200,"B",VAL1,VAL))\par
"RTN","AHMLDOR2",143,0)\par
 I '$D(^VA(200,"B",VAL1)) S VAL=0\par
"RTN","AHMLDOR2",144,0)\par
 Q\par
"RTN","AHMLDOR2",145,0)\par
 ;\par
"RTN","AHMLDOR2",146,0)\par
OBXMOD ; PROCEDURE MODIFIERS\par
"RTN","AHMLDOR2",147,0)\par
 B\par
"RTN","AHMLDOR2",148,0)\par
 S CNT=1\par
"RTN","AHMLDOR2",149,0)\par
 I $D(PMOD) S CNT=999,CNT=$O(PMOD(CNT),-1),CNT=CNT+1\par
"RTN","AHMLDOR2",150,0)\par
 S PMOD(CNT)=$P(X,RD1,5)\par
"RTN","AHMLDOR2",151,0)\par
 S RAAM=$G(RAAM)+1\par
"RTN","AHMLDOR2",152,0)\par
 S (RCNT,HCNT,ICNT)=1\par
"RTN","AHMLDOR2",153,0)\par
 Q\par
"RTN","AHMLDOR2",154,0)\par
 ;\par
"RTN","AHMLDOR2",155,0)\par
OBXDGN ; DIAGNOSIC CODE always Precedes the Report text. also contains diagnosis\par
"RTN","AHMLDOR2",156,0)\par
 ;\par
"RTN","AHMLDOR2",157,0)\par
 S AMENDED=$S($P(X,RD1,11)="C":1,1:0)\par
"RTN","AHMLDOR2",158,0)\par
 I PRIFLG D\par
"RTN","AHMLDOR2",159,0)\par
 .I $D(SECDGC) S CNT=99,CNT=$O(SECDGC(CNT),-1),CNT=CNT+1,SECDGC(CNT)=+$P(X,RD1,5)\par
"RTN","AHMLDOR2",160,0)\par
 .I '$D(SECDGC) S CNT=1,SECDGC(CNT)=+$P(X,RD1,5)\par
"RTN","AHMLDOR2",161,0)\par
 I 'PRIFLG S PRIDGC=+$P(X,RD1,5),PRIFLG=1\par
"RTN","AHMLDOR2",162,0)\par
 ;increment Amendments,1 = ORIG, 2 - n = Amendments\par
"RTN","AHMLDOR2",163,0)\par
 S RAAM=RAAM+1\par
"RTN","AHMLDOR2",164,0)\par
 ;re-init when RESCODE happens, covers each OBX result so orig result\par
"RTN","AHMLDOR2",165,0)\par
 ;and multiple amendment results kept separate.\par
"RTN","AHMLDOR2",166,0)\par
 S (RCNT,HCNT,ICNT)=1\par
"RTN","AHMLDOR2",167,0)\par
 Q\par
"RTN","AHMLDOR2",168,0)\par
 ;\par
"RTN","AHMLDOR2",169,0)\par
OBXRPT ; report text\par
"RTN","AHMLDOR2",170,0)\par
 I $P(X,RD1,3)'["REPORT" Q\par
"RTN","AHMLDOR2",171,0)\par
 I '$D(WPRT) S RAAM=1\par
"RTN","AHMLDOR2",172,0)\par
 I $D(WPRT) S RAAM=99999,RAAM=$O(WPRT(RAAM),-1)\par
"RTN","AHMLDOR2",173,0)\par
 ;I $G(VRFPHY)="" S VRFPHY=REQPRV\par
"RTN","AHMLDOR2",174,0)\par
 S WPRT(RAAM,"WP",RCNT)=$P(X,RD1,5)\par
"RTN","AHMLDOR2",175,0)\par
 S RCNT=RCNT+1 \par
"RTN","AHMLDOR2",176,0)\par
 Q\par
"RTN","AHMLDOR2",177,0)\par
 ;\par
"RTN","AHMLDOR2",178,0)\par
OBXIMP ; impression text\par
"RTN","AHMLDOR2",179,0)\par
 I $P(X,RD1,3)'["IMPRESSION" Q\par
"RTN","AHMLDOR2",180,0)\par
 S TXT=$P(X,RD1,5)\par
"RTN","AHMLDOR2",181,0)\par
 S SKIP=0\par
"RTN","AHMLDOR2",182,0)\par
 I ICNT=1 D\par
"RTN","AHMLDOR2",183,0)\par
 . S DELIM=$S(TXT["IMPRESSION:":"IMPRESSION:",TXT["Impression:":"Impression:",1:"")\par
"RTN","AHMLDOR2",184,0)\par
 . I DELIM]"" S TXT=$P(TXT,DELIM,2) I $E(TXT,1)=" " S TXT=$E(TXT,2,999)\par
"RTN","AHMLDOR2",185,0)\par
 . S:TXT="" SKIP=1    ;skip hdr only line\par
"RTN","AHMLDOR2",186,0)\par
 Q:SKIP\par
"RTN","AHMLDOR2",187,0)\par
 I '$D(WPIT) S RAAM=1\par
"RTN","AHMLDOR2",188,0)\par
 I $D(WPIT) S RAAM=99999,RAAM=$O(WPIT(RAAM),-1)\par
"RTN","AHMLDOR2",189,0)\par
 S WPIT(RAAM,"WP",ICNT)=TXT\par
"RTN","AHMLDOR2",190,0)\par
 S ICNT=ICNT+1\par
"RTN","AHMLDOR2",191,0)\par
 Q \par
"RTN","AHMLDOR2",192,0)\par
 ;\par
"RTN","AHMLDOR2",193,0)\par
OBXHST ; additional clinical history text\par
"RTN","AHMLDOR2",194,0)\par
 I $P(X,RD1,3)'["HISTORY" Q\par
"RTN","AHMLDOR2",195,0)\par
 I '$D(WPACH) S RAAM=1\par
"RTN","AHMLDOR2",196,0)\par
 I $D(WPACH) S RAAM=99999,RAAM=$O(WPACH(RAAM),-1)\par
"RTN","AHMLDOR2",197,0)\par
 S WPACH(RAAM,"WP",HCNT)=$P(X,RD1,5)\par
"RTN","AHMLDOR2",198,0)\par
 S HCNT=HCNT+1\par
"RTN","AHMLDOR2",199,0)\par
 Q\par
"RTN","AHMLDOR2",200,0)\par
 ;\par
"RTN","AHMLDOR2",201,0)\par
 ;=======================================================\par
"RTN","AHMLDOR2",202,0)\par
VARS ; check variables for HL7 -- generate varibles\par
"RTN","AHMLDOR2",203,0)\par
 N X13\par
"RTN","AHMLDOR2",204,0)\par
 K IMGTYP,RADFN,RAOIEN\par
"RTN","AHMLDOR2",205,0)\par
 S IMGTYP=""\par
"RTN","AHMLDOR2",206,0)\par
 ;S RAOIEN=+$G(^OR(100,ORIEN,4)) ; pointer to RAO(75.1 \par
"RTN","AHMLDOR2",207,0)\par
 ;BL;IA compliance change\par
"RTN","AHMLDOR2",208,0)\par
 S RAOIEN=$$GET1^DIQ(100,ORIEN,33,"I")\par
"RTN","AHMLDOR2",209,0)\par
 I $G(RAOIEN)'>0 S LROK=0,RAOROUT(1)="-1^NO RADIOLOGY ORDER NUMBER FOUND",MSG="ERR^NO RADIOLOGY ORDER NUMBER FOUND" D ERR Q\par
"RTN","AHMLDOR2",210,0)\par
 S IMGTYP=$P($G(^RAMIS(71,PROC,0)),"^",12)\par
"RTN","AHMLDOR2",211,0)\par
 ;BL;IA compliance change\par
"RTN","AHMLDOR2",212,0)\par
 S RADFN=DFN\par
"RTN","AHMLDOR2",213,0)\par
 I '$G(RADTE) S RADTE=$P(^RADPT(DFN,"DT",RADTI,0),"^")\par
"RTN","AHMLDOR2",214,0)\par
 I '$G(CASE) D SCASE\par
"RTN","AHMLDOR2",215,0)\par
 I '$G(LCASE) S LCASE=$E(RADTE,4,5)_$E(RADTE,6,7)_$E(RADTE,2,3)_"-"_CASE\par
"RTN","AHMLDOR2",216,0)\par
 ;  check pregnancy flag precedence: Y>U>N>"" ; rhl 20100927\par
"RTN","AHMLDOR2",217,0)\par
 ;BL;IA compliance change\par
"RTN","AHMLDOR2",218,0)\par
 I SEX="F" D\par
"RTN","AHMLDOR2",219,0)\par
 .S X13=$$GET1^DIQ(75.1,RAOIEN,13,"I")\par
"RTN","AHMLDOR2",220,0)\par
 .I PRGFLG="",X13="" S PRGFLG="u"\par
"RTN","AHMLDOR2",221,0)\par
 .I PRGFLG="",X13'="" S PRGFLG=X13\par
"RTN","AHMLDOR2",222,0)\par
 ;\par
"RTN","AHMLDOR2",223,0)\par
 Q\par
"RTN","AHMLDOR2",224,0)\par
 ;=========================================================\par
"RTN","AHMLDOR2",225,0)\par
CHK1 ; check for result variables\par
"RTN","AHMLDOR2",226,0)\par
 ; check patient DFN & SSN\par
"RTN","AHMLDOR2",227,0)\par
 ; verify providers\par
"RTN","AHMLDOR2",228,0)\par
 ; check providers: REQPRV, PRISTF, TRNSCP\par
"RTN","AHMLDOR2",229,0)\par
 K I,LROK,MSG,TCNT,CHKLOC,CHKPROC,CHKPRIDGC\par
"RTN","AHMLDOR2",230,0)\par
 S CHKLOC="",CHKPROC="",CHKPRIDGC=""\par
"RTN","AHMLDOR2",231,0)\par
 S TCNT=RACNT\par
"RTN","AHMLDOR2",232,0)\par
 S I="",LROK=1,MSG=""\par
"RTN","AHMLDOR2",233,0)\par
 I $G(PRISTF)="" S PRISTF=0\par
"RTN","AHMLDOR2",234,0)\par
 F I="REQPRV","TRNSCP","IMGLOC" S:@I=0 @I=""\par
"RTN","AHMLDOR2",235,0)\par
 F I="DFN","PROC","REQPRV","REQDT","PRISTF","EXMDT","RPTSTA","RPTDT","VRFDT","PRIDGC" D  ;\par
"RTN","AHMLDOR2",236,0)\par
 . Q:@I'=""\par
"RTN","AHMLDOR2",237,0)\par
 . S RACNT=RACNT+1\par
"RTN","AHMLDOR2",238,0)\par
 . S RAOROUT(RACNT)="ERR^REQUIRED FIELD NOT DEFINED "_I\par
"RTN","AHMLDOR2",239,0)\par
 . S LROK=0\par
"RTN","AHMLDOR2",240,0)\par
 Q:'LROK\par
"RTN","AHMLDOR2",241,0)\par
 S RACNT=1\par
"RTN","AHMLDOR2",242,0)\par
 ;\par
"RTN","AHMLDOR2",243,0)\par
 I $G(IMGLOC)="" S MSG="ERR^NO IMAGE LOCATION SPECIFIED " D ERR Q\par
"RTN","AHMLDOR2",244,0)\par
 I $$GET1^DIQ(2,DFN_",",.01,"I")="" S MSG="ERR^DFN "_DFN_" NOT IN PATIENT FILE " D ERR Q\par
"RTN","AHMLDOR2",245,0)\par
 ;Use fileman calls to check for global references (removing $D)\par
"RTN","AHMLDOR2",246,0)\par
 S CHKLOC=$$GET1^DIQ(79.1,IMGLOC,.01,"I")\par
"RTN","AHMLDOR2",247,0)\par
 S CHKPROC=$$GET1^DIQ(71,PROC,.01,"I")\par
"RTN","AHMLDOR2",248,0)\par
 S CHKPRIDGC=$$GET1^DIQ(78.3,PRIDGC,.01,"I")\par
"RTN","AHMLDOR2",249,0)\par
 I '$D(CHKLOC) S MSG="ERR^IMAGE LOCATION "_IMGLOC_" NOT IN IMG LOCATION FILE " D ERR Q\par
"RTN","AHMLDOR2",250,0)\par
 I '$D(CHKPROC) S MSG="ERR^PROCEDURE "_PROC_" NOT IN RAD PROC FILE " D ERR Q\par
"RTN","AHMLDOR2",251,0)\par
 ;I $$GET1^DIQ(200,REQPRV_",",.01,"I")="" S MSG="ERR^REQUESTING PROVIDER "_REQPRV_" NOT IN NEW PERSON FILE " D ERR Q\par
"RTN","AHMLDOR2",252,0)\par
 ;I $$GET1^DIQ(200,PRISTF_",",.01,"I")="" S MSG="ERR^REQUESTING PROVIDER "_REQPRV_" NOT IN NEW PERSON FILE " D ERR Q\par
"RTN","AHMLDOR2",253,0)\par
 ;I '$D(CHKPRIDGC) S MSG="ERR^PRIMARY DIAGNOSIS "_PRIDGC_" NOT IN RAD DIAGNOSIS FILE " D ERR Q\par
"RTN","AHMLDOR2",254,0)\par
 S RACNT=TCNT\par
"RTN","AHMLDOR2",255,0)\par
 ;\par
"RTN","AHMLDOR2",256,0)\par
 Q\par
"RTN","AHMLDOR2",257,0)\par
 ;\par
"RTN","AHMLDOR2",258,0)\par
CHK2 ; check for registration variables\par
"RTN","AHMLDOR2",259,0)\par
 ; check patient DFN & SSN\par
"RTN","AHMLDOR2",260,0)\par
 ; verify providers\par
"RTN","AHMLDOR2",261,0)\par
 ; check providers: REQPRV\par
"RTN","AHMLDOR2",262,0)\par
 K CHKLOC,CHKPROC\par
"RTN","AHMLDOR2",263,0)\par
 S CHKLOC="",CHKPROC=""\par
"RTN","AHMLDOR2",264,0)\par
 S I="",LROK=1\par
"RTN","AHMLDOR2",265,0)\par
 I $G(REQDT)>0 S EXMDT=REQDT\par
"RTN","AHMLDOR2",266,0)\par
 I $G(PRISTF)="" S PRISTF=0\par
"RTN","AHMLDOR2",267,0)\par
 F I="REQPRV","TRNSCP","IMGLOC" S:@I=0 @I=""\par
"RTN","AHMLDOR2",268,0)\par
 F I="DFN","PROC","REQPRV","REQDT","EXMDT" D  ;\par
"RTN","AHMLDOR2",269,0)\par
 . Q:@I'=""\par
"RTN","AHMLDOR2",270,0)\par
 . S RACNT=RACNT+1,RAOROUT(RACNT)="ERR^REQUIRED FIELD NOT DEFINED "_I,LROK=0\par
"RTN","AHMLDOR2",271,0)\par
 Q:'LROK\par
"RTN","AHMLDOR2",272,0)\par
 ;\par
"RTN","AHMLDOR2",273,0)\par
 I $$GET1^DIQ(2,DFN_",",.01,"I")="" S MSG="ERR^DFN "_DFN_" NOT IN PATIENT FILE " D ERR Q\par
"RTN","AHMLDOR2",274,0)\par
 S CHKLOC=$$GET1^DIQ(79.1,IMGLOC,.01,"I")\par
"RTN","AHMLDOR2",275,0)\par
 S CHKPROC=$$GET1^DIQ(71,PROC,.01,"I")\par
"RTN","AHMLDOR2",276,0)\par
 I $G(IMGLOC),'$D(CHKLOC) S MSG="ERR^IMAGE LOCATION "_IMGLOC_" NOT IN IMG LOCATION FILE " D ERR Q\par
"RTN","AHMLDOR2",277,0)\par
 I '$D(CHKPROC) S MSG="ERR^PROCEDURE "_PROC_" NOT IN RAD PROC FILE " D ERR Q\par
"RTN","AHMLDOR2",278,0)\par
 I $$GET1^DIQ(200,REQPRV_",",.01,"I")="" S MSG="ERR^REQUESTING PROVIDER "_REQPRV_" NOT IN NEW PERSON FILE " D ERR Q\par
"RTN","AHMLDOR2",279,0)\par
 ;\par
"RTN","AHMLDOR2",280,0)\par
 Q\par
"RTN","AHMLDOR2",281,0)\par
 ;\par
"RTN","AHMLDOR2",282,0)\par
SRADTI ; get RADTE & RADTI\par
"RTN","AHMLDOR2",283,0)\par
 ; input EXAMDT, Exam Date/Time in HL7 format\par
"RTN","AHMLDOR2",284,0)\par
 K RADTE,RADTI\par
"RTN","AHMLDOR2",285,0)\par
 S RADTE=EXMDT\par
"RTN","AHMLDOR2",286,0)\par
 ; RADTI is 9's complement of FM Internal D/T and used as 3rd subscript in 70.02, 70.03, etc.\par
"RTN","AHMLDOR2",287,0)\par
 S RADTI=9999999.9999-RADTE ; ^RADPT(RADFN,"DT",RADTI, . . .\par
"RTN","AHMLDOR2",288,0)\par
 ;BL;Adding code to ensure only 1 test per RADTI;JIRA 1822\par
"RTN","AHMLDOR2",289,0)\par
 ;check for existing RADTI\par
"RTN","AHMLDOR2",290,0)\par
CKRADTI ;begin loop for RADTI check (need a new RADTI)\par
"RTN","AHMLDOR2",291,0)\par
 K CHKRADTI\par
"RTN","AHMLDOR2",292,0)\par
 S CHKRADTI=$$GET1^DIQ(70.02,RADTI_","_DFN,.01,"I")\par
"RTN","AHMLDOR2",293,0)\par
 I CHKRADTI'="" D INCTI\par
"RTN","AHMLDOR2",294,0)\par
 Q\par
"RTN","AHMLDOR2",295,0)\par
INCTI ;RADTI exists increment X2 \par
"RTN","AHMLDOR2",296,0)\par
 S RADTE=$$FMADD^XLFDT(RADTE,,,+1)\par
"RTN","AHMLDOR2",297,0)\par
 S RADTI=9999999.9999-RADTE\par
"RTN","AHMLDOR2",298,0)\par
 D CKRADTI\par
"RTN","AHMLDOR2",299,0)\par
 Q\par
"RTN","AHMLDOR2",300,0)\par
SCASE ; get case#\par
"RTN","AHMLDOR2",301,0)\par
 ; RADTE & RADTI must be defined.\par
"RTN","AHMLDOR2",302,0)\par
 N RATYPE,RASET,RAX\par
"RTN","AHMLDOR2",303,0)\par
 S RATYPE=1,RASET=0\par
"RTN","AHMLDOR2",304,0)\par
 K CASE,LCASE\par
"RTN","AHMLDOR2",305,0)\par
 S CASE="",LCASE=""\par
"RTN","AHMLDOR2",306,0)\par
 D CN^RAREG1 ; create Case#  ;  need agreement\par
"RTN","AHMLDOR2",307,0)\par
 ;5265 - build temp Case# xref that the API, CN^RAREG1, uses to get\par
"RTN","AHMLDOR2",308,0)\par
 ;       the next available Case number. Both ORP & Legacy use this.\par
"RTN","AHMLDOR2",309,0)\par
 ;       Further down in our process, AHMLDOR2, files are stored, which\par
"RTN","AHMLDOR2",310,0)\par
 ;       includes creating the real AE xref.  Then kill temp xref.\par
"RTN","AHMLDOR2",311,0)\par
 S ^RADPT("AE",X,$J)=""       ;temp xref  5265\par
"RTN","AHMLDOR2",312,0)\par
 S CASE=X\par
"RTN","AHMLDOR2",313,0)\par
 ;\par
"RTN","AHMLDOR2",314,0)\par
 S LCASE=$E(RADTE,4,5)_$E(RADTE,6,7)_$E(RADTE,2,3)_"-"_CASE\par
"RTN","AHMLDOR2",315,0)\par
 I $D(^RADPT("ADC",LCASE)) S LROK=0,RAOROUT(1)="-1^CASE NUMBER ALREADY IN USE"\par
"RTN","AHMLDOR2",316,0)\par
 Q\par
"RTN","AHMLDOR2",317,0)\par
HLD(XD) ; convert HL7 date to FM date\par
"RTN","AHMLDOR2",318,0)\par
 Q:$G(XD)="" ""\par
"RTN","AHMLDOR2",319,0)\par
 Q $$HL7TFM^XLFDT(XD)\par
"RTN","AHMLDOR2",320,0)\par
 ;\par
"RTN","AHMLDOR2",321,0)\par
ERR ;\par
"RTN","AHMLDOR2",322,0)\par
 S RACNT=RACNT+1,RAOROUT(RACNT)="ERR^"_MSG,LROK=0\par
"RTN","AHMLDOR2",323,0)\par
 Q\par
"RTN","AHMLDOR2",324,0)\par
GETSTA(PROC,STATUS) ; get status (EXSTAT) for RADPT ; rhl 20100929 - new subrtn\par
"RTN","AHMLDOR2",325,0)\par
 N IMGTYP,XIEN,X7,XSTAT\par
"RTN","AHMLDOR2",326,0)\par
 S EXMSTA=""\par
"RTN","AHMLDOR2",327,0)\par
 ;BL;IA compliance change\par
"RTN","AHMLDOR2",328,0)\par
 S IMGTYP=$$GET1^DIQ(71,PROC,12,"I") I IMGTYP="" Q ""\par
"RTN","AHMLDOR2",329,0)\par
 ;\par
"RTN","AHMLDOR2",330,0)\par
 S XSTAT=""\par
"RTN","AHMLDOR2",331,0)\par
 F  S XSTAT=$O(^RA(72,"B",XSTAT)) Q:XSTAT=""  D  Q:EXMSTA\par
"RTN","AHMLDOR2",332,0)\par
 . Q:XSTAT'[STATUS\par
"RTN","AHMLDOR2",333,0)\par
 . S XIEN=0 FOR  S XIEN=$O(^RA(72,"B",STATUS,XIEN)) Q:'XIEN  D  Q:EXMSTA\par
"RTN","AHMLDOR2",334,0)\par
 . . ;BL;IA compliance change\par
"RTN","AHMLDOR2",335,0)\par
 . . S X7=$$GET1^DIQ(72,XIEN,7,"I")\par
"RTN","AHMLDOR2",336,0)\par
 . . I X7=IMGTYP S EXMSTA=XIEN\par
"RTN","AHMLDOR2",337,0)\par
 ;\par
"RTN","AHMLDOR2",338,0)\par
 Q EXMSTA\par
"RTN","AHMLDOR2",339,0)\par
 ;\par
"RTN","AHMLDOR2",340,0)\par
ENDQ ;\par
"RTN","AHMLDOR2",341,0)\par
 K NWSTATUS,EXSTAT,HLARY,WPACH,WPRT,WRPT\par
"RTN","AHMLDOR2",342,0)\par
 Q\par
"RTN","AHMLDOR3")\par
0^12^B207339876\par
"RTN","AHMLDOR3",1,0)\par
AHMLDOR3 ;LEIDOS/TCK- Remote Ordering - Radiology - Filer ; 10/16/16 8:56pm\par
"RTN","AHMLDOR3",2,0)\par
 ;;1.0;Radiology Orders Portability;;March 1, 2016;Build 26\par
"RTN","AHMLDOR3",3,0)\par
 ; Reference to ^RADPT( supported by IA #5602\par
"RTN","AHMLDOR3",4,0)\par
 ; Reference to NOW^%DTC supported by IA #10000\par
"RTN","AHMLDOR3",5,0)\par
 ; Reference to ^RAO(75.1 supported by IA #5604\par
"RTN","AHMLDOR3",6,0)\par
 ; Reference to ^OR(100 supported by IA #5196\par
"RTN","AHMLDOR3",7,0)\par
 ; Reference to GETDLG^ORCD supported by IA #5493\par
"RTN","AHMLDOR3",8,0)\par
 ; Reference to ^RARPT(74 supported by IA #5605\par
"RTN","AHMLDOR3",9,0)\par
 ; Reference to NOW^XLFDT supported by IA #10103\par
"RTN","AHMLDOR3",10,0)\par
 ; Reference to X7005^RADD3 supported by IA #5661\par
"RTN","AHMLDOR3",11,0)\par
 ; Reference to FIELD^DID supported by IA #2052\par
"RTN","AHMLDOR3",12,0)\par
 ;\par
"RTN","AHMLDOR3",13,0)\par
 ; updated:  20100908\par
"RTN","AHMLDOR3",14,0)\par
 ; 4839 - changed Amended Impression & Report text label hdrs.\par
"RTN","AHMLDOR3",15,0)\par
 ;        added 3 subhdr lines. File into subfile 74.06 old\par
"RTN","AHMLDOR3",16,0)\par
 ;        text data to trigger the AMENDED report headings.\par
"RTN","AHMLDOR3",17,0)\par
 ; 4833 - Encrypted Esig now saved, defined as Verifing Doctor.\par
"RTN","AHMLDOR3",18,0)\par
 ; 4076 - init Principal Clinic from Requesting Loc\par
"RTN","AHMLDOR3",19,0)\par
 ; 5329 - Send Abnormal diag Provider Alert, if needed\par
"RTN","AHMLDOR3",20,0)\par
 Q\par
"RTN","AHMLDOR3",21,0)\par
 ;\par
"RTN","AHMLDOR3",22,0)\par
 ; NOTES:\par
"RTN","AHMLDOR3",23,0)\par
 ; RADTE = Examination date/time in FM format truncated to maximum of 4 decimal places.\par
"RTN","AHMLDOR3",24,0)\par
 ; RADTI = 9'S complement of RADTE (9999999.9999-RADTE) used as subscript in ^RADPT( to force chronological order.\par
"RTN","AHMLDOR3",25,0)\par
 ; CASE = case# a 'Unique' number given to an exam when it is registered (generated by CN^RAREG1) ; AKA short case#\par
"RTN","AHMLDOR3",26,0)\par
 ; LCASE = long case# ; LCASE=$E(RADTE,4,5)_$E(RADTE,6,7)_$E(RADTE,2,3)_"-"_CASE\par
"RTN","AHMLDOR3",27,0)\par
 ;\par
"RTN","AHMLDOR3",28,0)\par
 ;      3 files are affected by Radiology Registration and Resulting:\par
"RTN","AHMLDOR3",29,0)\par
 ; ^RADPT(     #70    -- RAD/NUC MED PATIENT FILE\par
"RTN","AHMLDOR3",30,0)\par
 ; ^RARPT(     #74    -- RAD/NUC MED REPORTS FILE\par
"RTN","AHMLDOR3",31,0)\par
 ; ^RAO(75.1   #75.1  -- RAD/NUC MED ORDERS FILE\par
"RTN","AHMLDOR3",32,0)\par
 ;\par
"RTN","AHMLDOR3",33,0)\par
 ;====================================================================\par
"RTN","AHMLDOR3",34,0)\par
EN ;\par
"RTN","AHMLDOR3",35,0)\par
 ;\par
"RTN","AHMLDOR3",36,0)\par
 ;\par
"RTN","AHMLDOR3",37,0)\par
 Q\par
"RTN","AHMLDOR3",38,0)\par
PAT(RADARRY) ; create patient entry in RADPT\par
"RTN","AHMLDOR3",39,0)\par
 K DR,DA,DIE,LROK,DLAYGO\par
"RTN","AHMLDOR3",40,0)\par
 I $G(RADFN)'>0,$G(DFN)>0 S RADFN=DFN\par
"RTN","AHMLDOR3",41,0)\par
 S LROK=1\par
"RTN","AHMLDOR3",42,0)\par
 Q:$D(^RADPT(RADFN))\par
"RTN","AHMLDOR3",43,0)\par
 N X,Y,DINUM,DIC,DLAYGO\par
"RTN","AHMLDOR3",44,0)\par
 ;\par
"RTN","AHMLDOR3",45,0)\par
 S LROK=1\par
"RTN","AHMLDOR3",46,0)\par
 S X=RADFN,DINUM=RADFN,DIC(0)="L",DIC="^RADPT(",DLAYGO=2\par
"RTN","AHMLDOR3",47,0)\par
 K RADFN\par
"RTN","AHMLDOR3",48,0)\par
 S RADFN=X\par
"RTN","AHMLDOR3",49,0)\par
 D FILE^DICN\par
"RTN","AHMLDOR3",50,0)\par
 I RADFN'=+Y S LROK=0,RAOROUT(1)="-1^COULD NOT CREATE RECORD IN RADPT" Q\par
"RTN","AHMLDOR3",51,0)\par
 ;\par
"RTN","AHMLDOR3",52,0)\par
 S DR=".06////"_DUZ\par
"RTN","AHMLDOR3",53,0)\par
 S DA=RADFN,DIE=70 K Y D ^DIE\par
"RTN","AHMLDOR3",54,0)\par
 ;\par
"RTN","AHMLDOR3",55,0)\par
 Q\par
"RTN","AHMLDOR3",56,0)\par
 ;========================================================== \par
"RTN","AHMLDOR3",57,0)\par
REG(RADARRY) ; register exam in RADPT (#70)  & RAO(75.1  (#75.1)\par
"RTN","AHMLDOR3",58,0)\par
 ; Input:\par
"RTN","AHMLDOR3",59,0)\par
 ;\par
"RTN","AHMLDOR3",60,0)\par
 N RADFDA,RAIEN,ERRMSG,NOW,REQSTA,RAONWSTA,%,DT1\par
"RTN","AHMLDOR3",61,0)\par
 D NOW^%DTC S NOW=%\par
"RTN","AHMLDOR3",62,0)\par
 S RADARRY("REQSTA")=6,RADARRY("RAONWSTA")="6"\par
"RTN","AHMLDOR3",63,0)\par
 ;\par
"RTN","AHMLDOR3",64,0)\par
 ;    file #70.02:    Registered Exams\par
"RTN","AHMLDOR3",65,0)\par
 S DT1=RADTI\par
"RTN","AHMLDOR3",66,0)\par
 K DFN\par
"RTN","AHMLDOR3",67,0)\par
 S DFN=RADFN\par
"RTN","AHMLDOR3",68,0)\par
 S RAIEN(1)=DT1\par
"RTN","AHMLDOR3",69,0)\par
 S RADFDA(70.02,"+1,"_RADFN_",",.01)=RADTE      ; exam date/time\par
"RTN","AHMLDOR3",70,0)\par
 S RADFDA(70.02,"+1,"_RADFN_",",2)=RADARRY("IMGTYP")   ; type of image=>79.2\par
"RTN","AHMLDOR3",71,0)\par
 S RADFDA(70.02,"+1,"_RADFN_",",3)=RADARRY("HOSDIV")   ; hospital division=>79\par
"RTN","AHMLDOR3",72,0)\par
 S RADFDA(70.02,"+1,"_RADFN_",",4)=RADARRY("IMGLOC")   ; imaging location=>79.1\par
"RTN","AHMLDOR3",73,0)\par
 ;\par
"RTN","AHMLDOR3",74,0)\par
 D UPDATE^DIE("S","RADFDA","RAIEN","ERRMSG")\par
"RTN","AHMLDOR3",75,0)\par
 I $G(DIERR) D ERR\par
"RTN","AHMLDOR3",76,0)\par
 ;    file #70.03:    Examinations\par
"RTN","AHMLDOR3",77,0)\par
 K RADFDA,ERRMSG\par
"RTN","AHMLDOR3",78,0)\par
 S RADFDA(70.03,"+2,"_RADTI_","_RADFN_",",.01)=RADARRY("CASE")   ; case#\par
"RTN","AHMLDOR3",79,0)\par
 S RADFDA(70.03,"+2,"_RADTI_","_RADFN_",",2)=RADARRY("PROC")     ; procedure=>71\par
"RTN","AHMLDOR3",80,0)\par
 S RADFDA(70.03,"+2,"_RADTI_","_RADFN_",",3)=RADARRY("EXSTAT")   ; exam status=>72\par
"RTN","AHMLDOR3",81,0)\par
 S RADFDA(70.03,"+2,"_RADTI_","_RADFN_",",4)=RADARRY("EXCAT")    ; category of exam:codes\par
"RTN","AHMLDOR3",82,0)\par
 S RADFDA(70.03,"+2,"_RADTI_","_RADFN_",",6)=RADARRY("WARD")     ; ward=>42\par
"RTN","AHMLDOR3",83,0)\par
 S RADFDA(70.03,"+2,"_RADTI_","_RADFN_",",7)=RADARRY("SERVC")    ; service=>49\par
"RTN","AHMLDOR3",84,0)\par
 S RADFDA(70.03,"+2,"_RADTI_","_RADFN_",",8)=RADARRY("REQLOC")  ;4076 dupe in Reqloc ptr=>44\par
"RTN","AHMLDOR3",85,0)\par
 S RADFDA(70.03,"+2,"_RADTI_","_RADFN_",",11)=RADARRY("RAOIEN")  ; imaging order=>75.1\par
"RTN","AHMLDOR3",86,0)\par
 S RADFDA(70.03,"+2,"_RADTI_","_RADFN_",",14)=RADARRY("REQPRV")  ; requesting provider=>200\par
"RTN","AHMLDOR3",87,0)\par
 S RADFDA(70.03,"+2,"_RADTI_","_RADFN_",",19)=RADARRY("BED")     ; bedsection=>42.4\par
"RTN","AHMLDOR3",88,0)\par
 S RADFDA(70.03,"+2,"_RADTI_","_RADFN_",",21)=RADARRY("REQDT")   ; request date\par
"RTN","AHMLDOR3",89,0)\par
 S RADFDA(70.03,"+2,"_RADTI_","_RADFN_",",22)=RADARRY("REQLOC")  ; request location=>44\par
"RTN","AHMLDOR3",90,0)\par
 S RADFDA(70.03,"+2,"_RADTI_","_RADFN_",",26)=RADARRY("CRDMTH")  ; credit method: codes\par
"RTN","AHMLDOR3",91,0)\par
 ;\par
"RTN","AHMLDOR3",92,0)\par
 D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR3",93,0)\par
 I $G(DIERR) D ERR\par
"RTN","AHMLDOR3",94,0)\par
 ;\par
"RTN","AHMLDOR3",95,0)\par
 ;   get DA2\par
"RTN","AHMLDOR3",96,0)\par
 N RAOIEN S RAOIEN=RADARRY("RAOIEN") ; 20110329\par
"RTN","AHMLDOR3",97,0)\par
 N DA2,FOUND S FOUND=0 ; 20110329\par
"RTN","AHMLDOR3",98,0)\par
 S DA2=0,DA2=$O(^RADPT(RADFN,"DT",RADTI,"P",DA2)) Q:FOUND  ; 20110329\par
"RTN","AHMLDOR3",99,0)\par
 Q:'DA2\par
"RTN","AHMLDOR3",100,0)\par
 I $P(^RADPT(RADFN,"DT",RADTI,"P",DA2,0),"^",11)=RAOIEN S FOUND=1 ; 20110329\par
"RTN","AHMLDOR3",101,0)\par
 I 'FOUND S DA2=0 ; 20110329\par
"RTN","AHMLDOR3",102,0)\par
 ;\par
"RTN","AHMLDOR3",103,0)\par
 ;Need to update 70.05 exam status change history\par
"RTN","AHMLDOR3",104,0)\par
 I $G(DA2) D  ; 20110329\par
"RTN","AHMLDOR3",105,0)\par
 . K RADFDA,ERRMSG\par
"RTN","AHMLDOR3",106,0)\par
 . ;D A7007^RADD3(RADFN,RADTI,DA2,RADARRY("DUZ"),$G(RADARRY("TECH")))\par
"RTN","AHMLDOR3",107,0)\par
 . S RADFDA(70.07,"+1,"_DA2_","_RADTI_","_RADFN_",",.01)=$$NOW^XLFDT\par
"RTN","AHMLDOR3",108,0)\par
 . S RADFDA(70.07,"+1,"_DA2_","_RADTI_","_RADFN_",",2)="E"\par
"RTN","AHMLDOR3",109,0)\par
 . S RADFDA(70.07,"+1,"_DA2_","_RADTI_","_RADFN_",",3)=$G(RADARRY("DUZ"))\par
"RTN","AHMLDOR3",110,0)\par
 . S RADFDA(70.07,"+1,"_DA2_","_RADTI_","_RADFN_",",4)=$G(RADARRY("TECH"))\par
"RTN","AHMLDOR3",111,0)\par
 . D UPDATE^DIE("S","RADFDA","","ERRMSG") K RADFDA,ERRMSG\par
"RTN","AHMLDOR3",112,0)\par
 . S EXSTAT=RADARRY("EXSTAT")\par
"RTN","AHMLDOR3",113,0)\par
 . D X7005^RADD3(RADFN,RADTI,DA2,1,"",EXSTAT,RADARRY("DUZ"))\par
"RTN","AHMLDOR3",114,0)\par
 . ;S RAIENS="+1,"_DA2_","_RADTI_","_RADFN_","\par
"RTN","AHMLDOR3",115,0)\par
 . ;S RADFDA(70.05,RAIENS,.01)=$$MIDNGHT^RAUTL5($$NOW^XLFDT()) ; 20110329\par
"RTN","AHMLDOR3",116,0)\par
 . ;D UPDATE^DIE(,"RADFDA","RAIENS","ERRMSG")\par
"RTN","AHMLDOR3",117,0)\par
 . ;S RAIENS="+1,"_DA2_","_RADTI_","_RADFN_","\par
"RTN","AHMLDOR3",118,0)\par
 . ;S RADFDA(70.05,RAIENS,2)=EXSTAT ; 20110329\par
"RTN","AHMLDOR3",119,0)\par
 . ;S RADFDA(70.05,RAIENS,3)=RADARRY("DUZ") ; 20110329\par
"RTN","AHMLDOR3",120,0)\par
 . ;D UPDATE^DIE(,"RADFDA","RAIENS","ERRMSG") K RADFDA,ERRMSG\par
"RTN","AHMLDOR3",121,0)\par
 . ;D UPDATE^DIE("S","RADFDA","","ERRMSG") K RADFDA,ERRMSG\par
"RTN","AHMLDOR3",122,0)\par
 . I $D(PMOD) D FLEMOD(.PMOD)\par
"RTN","AHMLDOR3",123,0)\par
 . I $G(DIERR) D ERR\par
"RTN","AHMLDOR3",124,0)\par
 ;    log activity in RAO(75.1\par
"RTN","AHMLDOR3",125,0)\par
 K RADFDA,ERRMSG\par
"RTN","AHMLDOR3",126,0)\par
 S RADFDA(75.1,RAOIEN_",",5)=RADARRY("REQSTA")      ; request status:codes\par
"RTN","AHMLDOR3",127,0)\par
 I SEX="F" S RADFDA(75.1,RAOIEN_",",13)=RADARRY("PRGFLG")     ; preg flag ; rhl 20100927\par
"RTN","AHMLDOR3",128,0)\par
 S RADFDA(75.1,RAOIEN_",",18)=RADARRY("NOW")     ; last activity d/t\par
"RTN","AHMLDOR3",129,0)\par
 S RADFDA(75.12,"+1,"_RAOIEN_",",.01)=RADARRY("NOW")   ; status change d/t\par
"RTN","AHMLDOR3",130,0)\par
 S RADFDA(75.12,"+1,"_RAOIEN_",",2)=RADARRY("RAONWSTA")    ; new status:codes\par
"RTN","AHMLDOR3",131,0)\par
 ;S RADFDA(75.12,"+1,"_RAOIEN_",",3)=RADARRY("VRFPHY")  ; computer user=>200\par
"RTN","AHMLDOR3",132,0)\par
 ;\par
"RTN","AHMLDOR3",133,0)\par
 D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR3",134,0)\par
 I $G(DIERR) D ERR\par
"RTN","AHMLDOR3",135,0)\par
 ;\par
"RTN","AHMLDOR3",136,0)\par
 ;Pregnancy update in 100 file 4.5 node (Dialogue)\par
"RTN","AHMLDOR3",137,0)\par
 ;convert from lower case to upper case\par
"RTN","AHMLDOR3",138,0)\par
 ;First check to see if Rad status is set in OR(100 file\par
"RTN","AHMLDOR3",139,0)\par
 K PRGSEQ,PRGDONE,LSTSEQ,PRGSEQ,LSTSEQ,PRGTEXT1,PRGTEXT2,PRGTEXT\par
"RTN","AHMLDOR3",140,0)\par
 S PRGSEQ=5,PRGDONE=0  ;Never going to have less than a 6 for pregnancy sequence\par
"RTN","AHMLDOR3",141,0)\par
 S ORIEN=$G(RADARRY("ORIEN"))\par
"RTN","AHMLDOR3",142,0)\par
 I $G(SEX)="F" D\par
"RTN","AHMLDOR3",143,0)\par
 . F  S PRGSEQ=$O(^OR(100,ORIEN,4.5,PRGSEQ)) Q:PRGSEQ'=+PRGSEQ  D\par
"RTN","AHMLDOR3",144,0)\par
 . . I ^OR(100,ORIEN,4.5,PRGSEQ,0)["PREGNANT" S PRGDONE=1\par
"RTN","AHMLDOR3",145,0)\par
 . . S LSTSEQ=PRGSEQ\par
"RTN","AHMLDOR3",146,0)\par
 . I PRGDONE=0 D\par
"RTN","AHMLDOR3",147,0)\par
 . . N ORDIALOG\par
"RTN","AHMLDOR3",148,0)\par
 . . K PRGFLG\par
"RTN","AHMLDOR3",149,0)\par
 . . S PRGFLG=RADARRY("PRGFLG")\par
"RTN","AHMLDOR3",150,0)\par
 . . S PRGFLG=$TR(PRGFLG,"nyu","NYU")\par
"RTN","AHMLDOR3",151,0)\par
 . . D GETDLG^ORCD(1)\par
"RTN","AHMLDOR3",152,0)\par
 . . S PRGTEXT1=$P(ORDIALOG("B","PREGNANT"),"^",2)\par
"RTN","AHMLDOR3",153,0)\par
 . . S PRGTEXT2=$P(ORDIALOG(PRGTEXT1),"^")\par
"RTN","AHMLDOR3",154,0)\par
 . . K ORDIALOG\par
"RTN","AHMLDOR3",155,0)\par
 . . N RAIEN,RADFDA,RADFILE\par
"RTN","AHMLDOR3",156,0)\par
 . . S RADFILE=100.045,RAIEN=ORIEN_","\par
"RTN","AHMLDOR3",157,0)\par
 . . S RADFDA(1,RADFILE,"+1,"_RAIEN,.01)=PRGTEXT2\par
"RTN","AHMLDOR3",158,0)\par
 . . S RADFDA(1,RADFILE,"+1,"_RAIEN,.02)=PRGTEXT1\par
"RTN","AHMLDOR3",159,0)\par
 . . S RADFDA(1,RADFILE,"+1,"_RAIEN,.03)="1"\par
"RTN","AHMLDOR3",160,0)\par
 . . S RADFDA(1,RADFILE,"+1,"_RAIEN,.04)="PREGNANT"\par
"RTN","AHMLDOR3",161,0)\par
 . . S RADFDA(1,RADFILE,"+1,"_RAIEN,1)=PRGFLG\par
"RTN","AHMLDOR3",162,0)\par
 . . D UPDATE^DIE("S","RADFDA(1)","","ERRMSG") K RADFDA,RADFILE,RAIEN\par
"RTN","AHMLDOR3",163,0)\par
 ;\par
"RTN","AHMLDOR3",164,0)\par
REGQ ; \par
"RTN","AHMLDOR3",165,0)\par
 Q\par
"RTN","AHMLDOR3",166,0)\par
 ;==========================================================\par
"RTN","AHMLDOR3",167,0)\par
 ;\par
"RTN","AHMLDOR3",168,0)\par
FLEMOD(PMOD) ;\par
"RTN","AHMLDOR3",169,0)\par
 Q:'$D(PMOD)\par
"RTN","AHMLDOR3",170,0)\par
 S IDX="" F  S IDX=$O(PMOD(IDX)) Q:IDX=""  D\par
"RTN","AHMLDOR3",171,0)\par
 .Q:$G(PMOD(IDX))=""\par
"RTN","AHMLDOR3",172,0)\par
 .S MOD=PMOD(IDX) K PMOD(IDX)\par
"RTN","AHMLDOR3",173,0)\par
 .;Q:$D(^RADPT(RADFN,"DT",RADTI,"P",1,"M","B",MOD))\par
"RTN","AHMLDOR3",174,0)\par
 .S RADARRY("PROCMOD")=MOD\par
"RTN","AHMLDOR3",175,0)\par
 .S RADFDA(70.1,"+1,"_DA2_","_RADTI_","_RADFN_",",.01)=RADARRY("PROCMOD")\par
"RTN","AHMLDOR3",176,0)\par
 .D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR3",177,0)\par
 .S ORIEN=$G(RADARRY("ORIEN"))\par
"RTN","AHMLDOR3",178,0)\par
 .Q:$$CHKMOD(ORIEN,MOD)\par
"RTN","AHMLDOR3",179,0)\par
 .N ORDIALOG\par
"RTN","AHMLDOR3",180,0)\par
 .K PROCMOD\par
"RTN","AHMLDOR3",181,0)\par
 .S PROCMOD=RADARRY("PROCMOD")\par
"RTN","AHMLDOR3",182,0)\par
 .D GETDLG^ORCD(1)\par
"RTN","AHMLDOR3",183,0)\par
 .S PROCMOD1=$P(ORDIALOG("B","PROCEDURE MODIFIER"),"^",2)\par
"RTN","AHMLDOR3",184,0)\par
 .S PROCMOD2=$P(ORDIALOG(PROCMOD1),"^")\par
"RTN","AHMLDOR3",185,0)\par
 .S I=$O(^OR(100,ORIEN,4.5,"ID","MODIFIER",999),-1)\par
"RTN","AHMLDOR3",186,0)\par
 .S I=$G(I)+1\par
"RTN","AHMLDOR3",187,0)\par
 .K ORDIALOG\par
"RTN","AHMLDOR3",188,0)\par
 .N RAIEN,RADFDA,RADFILE\par
"RTN","AHMLDOR3",189,0)\par
 .S RADFILE=100.045,RAIEN=ORIEN_","\par
"RTN","AHMLDOR3",190,0)\par
 .S RADFDA(1,RADFILE,"+1,"_RAIEN,.01)=PROCMOD2\par
"RTN","AHMLDOR3",191,0)\par
 .S RADFDA(1,RADFILE,"+1,"_RAIEN,.02)=PROCMOD1\par
"RTN","AHMLDOR3",192,0)\par
 .S RADFDA(1,RADFILE,"+1,"_RAIEN,.03)=$G(I)\par
"RTN","AHMLDOR3",193,0)\par
 .S RADFDA(1,RADFILE,"+1,"_RAIEN,.04)="MODIFIER"\par
"RTN","AHMLDOR3",194,0)\par
 .S RADFDA(1,RADFILE,"+1,"_RAIEN,1)=RADARRY("PROCMOD")\par
"RTN","AHMLDOR3",195,0)\par
 .D UPDATE^DIE("S","RADFDA(1)","","ERRMSG") K RADFDA,RADFILE,RAIEN\par
"RTN","AHMLDOR3",196,0)\par
 Q\par
"RTN","AHMLDOR3",197,0)\par
 ;\par
"RTN","AHMLDOR3",198,0)\par
CHKMOD(ORIEN,MOD) ;\par
"RTN","AHMLDOR3",199,0)\par
 N N\par
"RTN","AHMLDOR3",200,0)\par
 S FOUND=0,N=""\par
"RTN","AHMLDOR3",201,0)\par
 Q:'$D(^OR(100,ORIEN,4.5,"ID","MODIFIER"))\par
"RTN","AHMLDOR3",202,0)\par
 F  S N=$O(^OR(100,ORIEN,4.5,"ID","MODIFIER",N)) Q:N=""  D  Q:FOUND\par
"RTN","AHMLDOR3",203,0)\par
 .Q:$P(^OR(100,ORIEN,4.5,N,0),"^",4)'["MOD"\par
"RTN","AHMLDOR3",204,0)\par
 .Q:'$D(^OR(100,ORIEN,4.5,N,1))\par
"RTN","AHMLDOR3",205,0)\par
 .I MOD=^OR(100,ORIEN,4.5,N,1) S FOUND=1\par
"RTN","AHMLDOR3",206,0)\par
 Q FOUND\par
"RTN","AHMLDOR3",207,0)\par
 ;\par
"RTN","AHMLDOR3",208,0)\par
RPT(RADARRY) ; file results in RADPT (#70), RARPT (#74)\par
"RTN","AHMLDOR3",209,0)\par
 ; Input: CASE, RAOIEN, ORIEN\par
"RTN","AHMLDOR3",210,0)\par
 N RADTI,DA2,NOW,ACTION,ERROR\par
"RTN","AHMLDOR3",211,0)\par
 D NOW^%DTC S NOW=%\par
"RTN","AHMLDOR3",212,0)\par
 S RADARRY("RPTSTA")="V",ERROR=0\par
"RTN","AHMLDOR3",213,0)\par
 ; Input:\par
"RTN","AHMLDOR3",214,0)\par
 ;\par
"RTN","AHMLDOR3",215,0)\par
 ;\par
"RTN","AHMLDOR3",216,0)\par
 ;bsl; add code for amending results\par
"RTN","AHMLDOR3",217,0)\par
 ;Must check to see if results have already been filed\par
"RTN","AHMLDOR3",218,0)\par
 K AMEND,EXRSLT\par
"RTN","AHMLDOR3",219,0)\par
 D GETDPT I 'LROK S RAOROUT(1)="-1^COULD NOT FIND RECORD TO POST RESULTS" Q\par
"RTN","AHMLDOR3",220,0)\par
 S EXRSLT=^RADPT(RADFN,"DT",RADTI,"P",DA2,0)\par
"RTN","AHMLDOR3",221,0)\par
 S RPTIEN=+$P(EXRSLT,"^",17)     ;convert to number\par
"RTN","AHMLDOR3",222,0)\par
 ;\par
"RTN","AHMLDOR3",223,0)\par
 ;* Report amendment process, Do IF ien non 0 and then quit filer *\par
"RTN","AHMLDOR3",224,0)\par
RPTIEN ;\par
"RTN","AHMLDOR3",225,0)\par
 I RPTIEN D  Q\par
"RTN","AHMLDOR3",226,0)\par
 . N II\par
"RTN","AHMLDOR3",227,0)\par
 . D RPTERR    ;4839-save prev text fields first/Error Reports subfile\par
"RTN","AHMLDOR3",228,0)\par
 . ;\par
"RTN","AHMLDOR3",229,0)\par
 . ;4839:\par
"RTN","AHMLDOR3",230,0)\par
 . ;save incoming text fields to RARPT file #74\par
"RTN","AHMLDOR3",231,0)\par
 . ;        Impression amended text\par
"RTN","AHMLDOR3",232,0)\par
 . I $D(WPIT("WP")) D\par
"RTN","AHMLDOR3",233,0)\par
 . . S AMEND("WP",1)=""\par
"RTN","AHMLDOR3",234,0)\par
 . . S AMEND("WP",2)="***Addendum Below***"\par
"RTN","AHMLDOR3",235,0)\par
 . . ;insert blank if needed\par
"RTN","AHMLDOR3",236,0)\par
 . . S II=$O(WPIT("WP",0))\par
"RTN","AHMLDOR3",237,0)\par
 . . S:$G(WPIT("WP",II))]"" AMEND("WP",3)=""\par
"RTN","AHMLDOR3",238,0)\par
 . . D WP^DIE(74,RPTIEN_",",300,"A","AMEND(""WP"")","ERRMSG")\par
"RTN","AHMLDOR3",239,0)\par
 . . D WP^DIE(74,RPTIEN_",",300,"A","WPIT(""WP"")","ERRMSG")\par
"RTN","AHMLDOR3",240,0)\par
 . . K AMEND("WP")\par
"RTN","AHMLDOR3",241,0)\par
 . ;        Report amended text\par
"RTN","AHMLDOR3",242,0)\par
 . I $D(WPRT("WP")) D\par
"RTN","AHMLDOR3",243,0)\par
 . . S AMEND("WP",1)=""\par
"RTN","AHMLDOR3",244,0)\par
 . . S AMEND("WP",2)="***Addendum Below***"\par
"RTN","AHMLDOR3",245,0)\par
 . . ;insert blank if needed\par
"RTN","AHMLDOR3",246,0)\par
 . . S II=$O(WPRT("WP",0))\par
"RTN","AHMLDOR3",247,0)\par
 . . S:$G(WPRT("WP",II))]"" AMEND("WP",3)=""\par
"RTN","AHMLDOR3",248,0)\par
 . . D WP^DIE(74,RPTIEN_",",200,"A","AMEND(""WP"")","ERRMSG")\par
"RTN","AHMLDOR3",249,0)\par
 . . D WP^DIE(74,RPTIEN_",",200,"A","WPRT(""WP"")","ERRMSG")\par
"RTN","AHMLDOR3",250,0)\par
 . ;update Report DT & Verify DT & xref to show the amended DOD report\par
"RTN","AHMLDOR3",251,0)\par
 . ;time - 4839\par
"RTN","AHMLDOR3",252,0)\par
 . N OLDVTIM,VNOW\par
"RTN","AHMLDOR3",253,0)\par
 . S OLDVTIM=$P(^RARPT(RPTIEN,0),U,7),OLDVTIM=9999999.9999-OLDVTIM\par
"RTN","AHMLDOR3",254,0)\par
 . K ^RARPT("AA",OLDVTIM,RPTIEN)\par
"RTN","AHMLDOR3",255,0)\par
 . S VNOW=$E($$NOW^XLFDT,1,12)\par
"RTN","AHMLDOR3",256,0)\par
 . S $P(^RARPT(RPTIEN,0),U,7)=VNOW\par
"RTN","AHMLDOR3",257,0)\par
 . S $P(^RARPT(RPTIEN,0),U,8)=VNOW\par
"RTN","AHMLDOR3",258,0)\par
 . S ^RARPT("AA",9999999.9999-VNOW,RPTIEN)=""\par
"RTN","AHMLDOR3",259,0)\par
 . D END\par
"RTN","AHMLDOR3",260,0)\par
 ;* End of Report amendment process *\par
"RTN","AHMLDOR3",261,0)\par
 ;\par
"RTN","AHMLDOR3",262,0)\par
 ;** Filing of original reports below **\par
"RTN","AHMLDOR3",263,0)\par
 ;  file RARPT #74\par
"RTN","AHMLDOR3",264,0)\par
 K RPTIEN,DIE,DA,DR\par
"RTN","AHMLDOR3",265,0)\par
 N X,DIC,DLAYGO\par
"RTN","AHMLDOR3",266,0)\par
 S X=LCASE,DIC(0)="L",DIC="^RARPT(",DLAYGO=2\par
"RTN","AHMLDOR3",267,0)\par
 D FILE^DICN S RPTIEN=+Y ; create new report record file# 74\par
"RTN","AHMLDOR3",268,0)\par
 S RADARRY("RPTIEN")=RPTIEN\par
"RTN","AHMLDOR3",269,0)\par
 ;\par
"RTN","AHMLDOR3",270,0)\par
 K RADFDA,ERRMSG,LCASE\par
"RTN","AHMLDOR3",271,0)\par
 S RADFDA(74,RPTIEN_",",2)=RADARRY("DFN")      ; patient=>2\par
"RTN","AHMLDOR3",272,0)\par
 S RADFDA(74,RPTIEN_",",3)=RADARRY("EXMDT")    ; exam dt\par
"RTN","AHMLDOR3",273,0)\par
 S RADFDA(74,RPTIEN_",",4)=RADARRY("CASE")     ; case#\par
"RTN","AHMLDOR3",274,0)\par
 S RADFDA(74,RPTIEN_",",5)=RADARRY("RPTSTA")   ; report status:codes\par
"RTN","AHMLDOR3",275,0)\par
 S RADFDA(74,RPTIEN_",",6)=RADARRY("RPTENTDT") ; date report entered\par
"RTN","AHMLDOR3",276,0)\par
 S RADFDA(74,RPTIEN_",",7)=RADARRY("VRFDT")    ; verified date\par
"RTN","AHMLDOR3",277,0)\par
 S RADFDA(74,RPTIEN_",",8)=RADARRY("RPTDT")    ; reported date\par
"RTN","AHMLDOR3",278,0)\par
 ;S RADFDA(74,RPTIEN_",",9)=RADARRY("VRFPHY")   ; verifying physician=>200\par
"RTN","AHMLDOR3",279,0)\par
 ;4833 dot structure\par
"RTN","AHMLDOR3",280,0)\par
 ;D:RADARRY("VRFPHY")   ;encrpyt esig from RARPT ien, doc duz, doc name\par
"RTN","AHMLDOR3",281,0)\par
 . ;S X2=RPTIEN,X1=RADARRY("VRFPHY"),X=$P($$ESBLOCK^XUSESIG1(X1),U,1)\par
"RTN","AHMLDOR3",282,0)\par
 . ;D EN^XUSHSHP S RADARRY("ESCD")=X\par
"RTN","AHMLDOR3",283,0)\par
 S RADFDA(74,RPTIEN_",",10)=RADARRY("ESCD")    ; electronic signature code\par
"RTN","AHMLDOR3",284,0)\par
 S RADFDA(74,RPTIEN_",",11)=RADARRY("TRNSCP")  ; transcriptionist=>200\par
"RTN","AHMLDOR3",285,0)\par
 S RADFDA(74,RPTIEN_",",17)=RADARRY("SCVBY")   ; status changed to verified by=>200\par
"RTN","AHMLDOR3",286,0)\par
 S RADFDA(74,RPTIEN_",",86)=RADARRY("ITRLOC")  ; interpreting imaging location=>79.1\par
"RTN","AHMLDOR3",287,0)\par
 ;\par
"RTN","AHMLDOR3",288,0)\par
 K FLAGS\par
"RTN","AHMLDOR3",289,0)\par
 S FLAGS=""\par
"RTN","AHMLDOR3",290,0)\par
 D FILE^DIE(FLAGS,"RADFDA","ERRMSG")\par
"RTN","AHMLDOR3",291,0)\par
 I $G(DIERR) D ERR\par
"RTN","AHMLDOR3",292,0)\par
 ;\par
"RTN","AHMLDOR3",293,0)\par
 K RADFDA,ERRMSG\par
"RTN","AHMLDOR3",294,0)\par
 S RADFDA(74.01,"+1,"_RPTIEN_",",.01)=RADARRY("NOW") ; log date\par
"RTN","AHMLDOR3",295,0)\par
 S RADFDA(74.01,"+1,"_RPTIEN_",",2)=RADARRY("ACTION")    ; type of action\par
"RTN","AHMLDOR3",296,0)\par
 S RADFDA(74.01,"+1,"_RPTIEN_",",3)=RADARRY("DUZ")       ; computer user\par
"RTN","AHMLDOR3",297,0)\par
 D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR3",298,0)\par
 I $G(DIERR) D ERR\par
"RTN","AHMLDOR3",299,0)\par
 ;     file word processing data\par
"RTN","AHMLDOR3",300,0)\par
 I $D(WPACH("WP")) D WP^DIE(74,RPTIEN_",",400,"","WPACH(""WP"")","ERRMSG")  ; additional clinical history\par
"RTN","AHMLDOR3",301,0)\par
 I $D(WPIT("WP")) D WP^DIE(74,RPTIEN_",",300,"","WPIT(""WP"")","ERRMSG")     ; impression text\par
"RTN","AHMLDOR3",302,0)\par
 I $D(WPRT("WP")) D WP^DIE(74,RPTIEN_",",200,"","WPRT(""WP"")","ERRMSG")     ; report text\par
"RTN","AHMLDOR3",303,0)\par
 ;\par
"RTN","AHMLDOR3",304,0)\par
 ;  file results into RADPT( exminations\par
"RTN","AHMLDOR3",305,0)\par
 ;    file #70.03:\par
"RTN","AHMLDOR3",306,0)\par
 K RADFDA,ERRMSG,PROC\par
"RTN","AHMLDOR3",307,0)\par
 S FLAGS=""\par
"RTN","AHMLDOR3",308,0)\par
 ;BSL;Set exam status to complete\par
"RTN","AHMLDOR3",309,0)\par
 S RADARRY("EXSTAT")=$$GETSTA^AHMLDOR2(RADARRY("PROC"),"COMPLETE")\par
"RTN","AHMLDOR3",310,0)\par
 ;\par
"RTN","AHMLDOR3",311,0)\par
 ;S RADFDA(70.03,DA2_","_RADTI_","_RADFN_",",12)=PRIRES   ; primary interpreting resident=>200\par
"RTN","AHMLDOR3",312,0)\par
 S RADFDA(70.03,DA2_","_RADTI_","_RADFN_",",13)=RADARRY("PRIDGC")   ; primary diagnosis code=>74\par
"RTN","AHMLDOR3",313,0)\par
 S RADFDA(70.03,DA2_","_RADTI_","_RADFN_",",15)=RADARRY("PRISTF")   ; primary interpreting staff=>200\par
"RTN","AHMLDOR3",314,0)\par
 S RADFDA(70.03,DA2_","_RADTI_","_RADFN_",",17)=RADARRY("RPTIEN")   ; report text=>74\par
"RTN","AHMLDOR3",315,0)\par
 S RADFDA(70.03,DA2_","_RADTI_","_RADFN_",",3)=RADARRY("EXSTAT")  ;EXAM STATUS\par
"RTN","AHMLDOR3",316,0)\par
 S FLAGS=""\par
"RTN","AHMLDOR3",317,0)\par
 D FILE^DIE(FLAGS,"RADFDA","ERRMSG")\par
"RTN","AHMLDOR3",318,0)\par
 I $G(DIERR) D ERR\par
"RTN","AHMLDOR3",319,0)\par
 D X7005^RADD3(RADFN,RADTI,DA2,"","",RADARRY("EXSTAT"),$G(RADARRY("DUZ")))\par
"RTN","AHMLDOR3",320,0)\par
 D A7007^RADD3(RADFN,RADTI,DA2,RADARRY("DUZ"),$G(RADARRY("TECH")))\par
"RTN","AHMLDOR3",321,0)\par
 ;Update 100 File\par
"RTN","AHMLDOR3",322,0)\par
 ;BL;Modified to update status regardless of errors, response to JIRA 2048\par
"RTN","AHMLDOR3",323,0)\par
 ;I 'ERROR,$D(ORIEN) D removing dot structure to ensure code gets called jira 2048\par
"RTN","AHMLDOR3",324,0)\par
 ;file new proc mods if found\par
"RTN","AHMLDOR3",325,0)\par
 ;BL;IA compliance change\par
"RTN","AHMLDOR3",326,0)\par
 S ORIEN=RADARRY("ORIEN")\par
"RTN","AHMLDOR3",327,0)\par
 N NOW\par
"RTN","AHMLDOR3",328,0)\par
 S NOW=$$NOW^XLFDT,FLAGS=""\par
"RTN","AHMLDOR3",329,0)\par
 S RADFDA(100,ORIEN_",",22)=NOW\par
"RTN","AHMLDOR3",330,0)\par
 S RADFDA(100,ORIEN_",",5)=2\par
"RTN","AHMLDOR3",331,0)\par
 D FILE^DIE(FLAGS,"RADFDA","ERRMSG")\par
"RTN","AHMLDOR3",332,0)\par
 ;add remote user's name to the 8 node of file 100\par
"RTN","AHMLDOR3",333,0)\par
 I $D(^OR(100,ORIEN,8,1,.1)) D\par
"RTN","AHMLDOR3",334,0)\par
 .S CNT=$P(^OR(100,ORIEN,8,1,.1,0),"^",3)\par
"RTN","AHMLDOR3",335,0)\par
 .S CNT=CNT+1,$P(^OR(100,ORIEN,8,1,.1,0),"^",2,3)=CNT\par
"RTN","AHMLDOR3",336,0)\par
 .S ^OR(100,ORIEN,8,1,.1,CNT,0)="Verified By: "_RADARRY("USER")\par
"RTN","AHMLDOR3",337,0)\par
 I $G(DIERR) D ERR\par
"RTN","AHMLDOR3",338,0)\par
 ;UPDATE 75.1 with new status\par
"RTN","AHMLDOR3",339,0)\par
 S RADFDA(75.1,RAOIEN_",",5)=RADARRY("EXSTAT")\par
"RTN","AHMLDOR3",340,0)\par
 S RADFDA(75.1,RAOIEN_",",18)=RADARRY("NOW")\par
"RTN","AHMLDOR3",341,0)\par
 S RADFDA(75.12,"+1,"_RAOIEN_",",.01)=RADARRY("NOW")\par
"RTN","AHMLDOR3",342,0)\par
 S RADFDA(75.12,"+1,"_RAOIEN_",",2)=RADARRY("EXSTAT")\par
"RTN","AHMLDOR3",343,0)\par
 S RADFDA(75.12,"+1,"_RAOIEN_",",3)=RADARRY("REQPRV")\par
"RTN","AHMLDOR3",344,0)\par
 D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR3",345,0)\par
 ;\par
"RTN","AHMLDOR3",346,0)\par
 ;BL;UPDATE IMAGING LOCATION WHEN RESULTS COME IN; ISSUE 1937\par
"RTN","AHMLDOR3",347,0)\par
 S RADFDA(70.02,"+1,"_RADFN_",",4)=RADARRY("IMGLOC")   ; imaging location=>79.1\par
"RTN","AHMLDOR3",348,0)\par
 S FLAGS=""\par
"RTN","AHMLDOR3",349,0)\par
 D FILE^DIE(FLAGS,"RADFDA","ERRMSG")\par
"RTN","AHMLDOR3",350,0)\par
 I $G(DIERR) D ERR\par
"RTN","AHMLDOR3",351,0)\par
 ;\par
"RTN","AHMLDOR3",352,0)\par
END ;Check if Abnormal Alert needed then, finish cleanup    ;5329\par
"RTN","AHMLDOR3",353,0)\par
 ;\par
"RTN","AHMLDOR3",354,0)\par
 ;setup variables for Abnormal alert testing & conditional call, ;5329\par
"RTN","AHMLDOR3",355,0)\par
 N RAAB,RACNI,RAEXAM0,RARPT\par
"RTN","AHMLDOR3",356,0)\par
 S RACNI=$O(^RADPT(RADFN,"DT",RADTI,"P","B",RADARRY("CASE"),0))\par
"RTN","AHMLDOR3",357,0)\par
 S RAEXAM0=$S($D(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)):^(0),1:0)\par
"RTN","AHMLDOR3",358,0)\par
 S RARPT=RPTIEN    ;Glb Var needed by OE3, file 74 ien\par
"RTN","AHMLDOR3",359,0)\par
 I $G(RADARRY("PRIDGC"))>0 D\par
"RTN","AHMLDOR3",360,0)\par
 .S RAAB=$S($P(^RA(78.3,+RADARRY("PRIDGC"),0),U,4)="y":1,1:0)\par
"RTN","AHMLDOR3",361,0)\par
 I $G(RAAB)>0 D OE3^RAUTL00(RADFN,RADTI,RACNI,RAEXAM0)\par
"RTN","AHMLDOR3",362,0)\par
 ;\par
"RTN","AHMLDOR3",363,0)\par
 ;cleanup\par
"RTN","AHMLDOR3",364,0)\par
 K RIEN,WPACH,WPIT,WPRT,XMSG,RAOIEN,RADTE,RADFDA,RACNT,PMOD,SECDGC,PRIDGC\par
"RTN","AHMLDOR3",365,0)\par
 ;\par
"RTN","AHMLDOR3",366,0)\par
RPTQ ;\par
"RTN","AHMLDOR3",367,0)\par
 Q\par
"RTN","AHMLDOR3",368,0)\par
 ;\par
"RTN","AHMLDOR3",369,0)\par
GETDPT ; get RADTI  and DA2 for a Case# & orien\par
"RTN","AHMLDOR3",370,0)\par
 N STOP\par
"RTN","AHMLDOR3",371,0)\par
 S RADTI=0,DA2="",STOP=0,LROK=0\par
"RTN","AHMLDOR3",372,0)\par
 F  S RADTI=$O(^RADPT(RADFN,"DT",RADTI)) Q:'RADTI  D  Q:STOP\par
"RTN","AHMLDOR3",373,0)\par
 . S DA2=0,DA2=$O(^RADPT(RADFN,"DT",RADTI,"P",DA2))\par
"RTN","AHMLDOR3",374,0)\par
 . I RADARRY("CASE")=+^RADPT(RADFN,"DT",RADTI,"P",DA2,0),$P(^RADPT(RADFN,"DT",RADTI,"P",DA2,0),"^",11)=RAOIEN S STOP=1,LROK=1\par
"RTN","AHMLDOR3",375,0)\par
 ; sub-sub files\par
"RTN","AHMLDOR3",376,0)\par
 ;F I=1:1 Q:'$D(SECRES(I))  D  ; secondary interpreting resident=>200\par
"RTN","AHMLDOR3",377,0)\par
 ;. K RADFDA,ERRMSG\par
"RTN","AHMLDOR3",378,0)\par
 ;F I=1:1 Q:'$D(SECSTF(I))  D  ; secondary interpreting staff=>200\par
"RTN","AHMLDOR3",379,0)\par
 ;. K RADFDA,ERRMSG\par
"RTN","AHMLDOR3",380,0)\par
 ;. S RADFDA(70.11,"+1,"_DA2_","_RADTI_","_RADFN_",",.01)=SECSTF(I)\par
"RTN","AHMLDOR3",381,0)\par
 ;. D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR3",382,0)\par
 Q:'$D(SECDGC)\par
"RTN","AHMLDOR3",383,0)\par
 F I=1:1 Q:'$D(SECDGC(I))  D  ; secondary diagnosis code=>78.3\par
"RTN","AHMLDOR3",384,0)\par
 .K RADFDA,ERRMSG\par
"RTN","AHMLDOR3",385,0)\par
 .S RADFDA(70.14,"+1,"_DA2_","_RADTI_","_RADFN_",",.01)=SECDGC(I)\par
"RTN","AHMLDOR3",386,0)\par
 .D UPDATE^DIE("S","RADFDA","","ERRMSG")\par
"RTN","AHMLDOR3",387,0)\par
 Q\par
"RTN","AHMLDOR3",388,0)\par
 ;\par
"RTN","AHMLDOR3",389,0)\par
ERR ; return errors from filer\par
"RTN","AHMLDOR3",390,0)\par
 S ERROR=1\par
"RTN","AHMLDOR3",391,0)\par
 ;I $G(DEBUG) D DGERR^JVDG2("JVDGF",DBCNT,.XMSG,"F") ; debug log\par
"RTN","AHMLDOR3",392,0)\par
 N XO,XF,XL S XO="" F  S XO=$O(ERRMSG("DIERR",XO)) Q:'XO  D\par
"RTN","AHMLDOR3",393,0)\par
 . S XF=$G(ERRMSG("DIERR",XO,"PARAM","FIELD")),XL=$G(ERRMSG("DIERR",XO,"PARAM","FILE")) Q:((XF="")!(XL=""))\par
"RTN","AHMLDOR3",394,0)\par
 . S XF=$$DDLBL(XL,XF)\par
"RTN","AHMLDOR3",395,0)\par
 . S RACNT=RACNT+1,RAOROUT(RACNT)=XF_": "_$G(XMSG("DIERR",XO,"TEXT",1))\par
"RTN","AHMLDOR3",396,0)\par
 ;\par
"RTN","AHMLDOR3",397,0)\par
 K DIERR,ERRMSG\par
"RTN","AHMLDOR3",398,0)\par
 Q\par
"RTN","AHMLDOR3",399,0)\par
 ;\par
"RTN","AHMLDOR3",400,0)\par
DDLBL(FILE,FLD) ; return field name. (This entry point copied from JVDG, since we're in a separate package.)\par
"RTN","AHMLDOR3",401,0)\par
 ; Input:\par
"RTN","AHMLDOR3",402,0)\par
 ;    FILE=file#\par
"RTN","AHMLDOR3",403,0)\par
 ;    FLD=Field number\par
"RTN","AHMLDOR3",404,0)\par
 ;  Returns\par
"RTN","AHMLDOR3",405,0)\par
 ;    field's Label\par
"RTN","AHMLDOR3",406,0)\par
 I $G(FILE)=""!($G(FLD)="") Q ""\par
"RTN","AHMLDOR3",407,0)\par
 N FDA\par
"RTN","AHMLDOR3",408,0)\par
 D FIELD^DID(FILE,FLD,"","LABEL","FDA","")\par
"RTN","AHMLDOR3",409,0)\par
 Q $G(FDA("LABEL"))\par
"RTN","AHMLDOR3",410,0)\par
 ;\par
"RTN","AHMLDOR3",411,0)\par
RPTERR ;Saves previous text fields to subfile #74.06 to trigger the Amended \par
"RTN","AHMLDOR3",412,0)\par
 ;report headings.  4839.\par
"RTN","AHMLDOR3",413,0)\par
 ;\par
"RTN","AHMLDOR3",414,0)\par
 N QQ,CH,RT,IT,ECNT\par
"RTN","AHMLDOR3",415,0)\par
 M CH=^RARPT(RPTIEN,"H") K CH(0)\par
"RTN","AHMLDOR3",416,0)\par
 M RT=^RARPT(RPTIEN,"R") K RT(0)\par
"RTN","AHMLDOR3",417,0)\par
 M IT=^RARPT(RPTIEN,"I") K IT(0)\par
"RTN","AHMLDOR3",418,0)\par
 ;build Tmp report with old values for #74.06\par
"RTN","AHMLDOR3",419,0)\par
 S ECNT=1\par
"RTN","AHMLDOR3",420,0)\par
 S ^TMP($J,"RA AUTOE",ECNT)="** DOD incoming Radiology Results event **"\par
"RTN","AHMLDOR3",421,0)\par
 S ECNT=ECNT+1,^TMP($J,"RA AUTOE",ECNT)=""\par
"RTN","AHMLDOR3",422,0)\par
 I $D(CH) D\par
"RTN","AHMLDOR3",423,0)\par
 . S ECNT=ECNT+1,^TMP($J,"RA AUTOE",ECNT)="  Additional Clinical History:"\par
"RTN","AHMLDOR3",424,0)\par
 . F QQ=0:0 S QQ=$O(CH(QQ)) Q:'QQ  D\par
"RTN","AHMLDOR3",425,0)\par
 . . S ECNT=ECNT+1,^TMP($J,"RA AUTOE",ECNT)=CH(QQ,0)\par
"RTN","AHMLDOR3",426,0)\par
 I $D(RT) D\par
"RTN","AHMLDOR3",427,0)\par
 . S ECNT=ECNT+1,^TMP($J,"RA AUTOE",ECNT)="  Report:"\par
"RTN","AHMLDOR3",428,0)\par
 . F QQ=0:0 S QQ=$O(RT(QQ)) Q:'QQ  D\par
"RTN","AHMLDOR3",429,0)\par
 . . S ECNT=ECNT+1,^TMP($J,"RA AUTOE",ECNT)=RT(QQ,0)\par
"RTN","AHMLDOR3",430,0)\par
 I $D(IT) D\par
"RTN","AHMLDOR3",431,0)\par
 . S ECNT=ECNT+1,^TMP($J,"RA AUTOE",ECNT)="  Impression:"\par
"RTN","AHMLDOR3",432,0)\par
 . F QQ=0:0 S QQ=$O(IT(QQ)) Q:'QQ  D\par
"RTN","AHMLDOR3",433,0)\par
 . . S ECNT=ECNT+1,^TMP($J,"RA AUTOE",ECNT)=IT(QQ,0)\par
"RTN","AHMLDOR3",434,0)\par
 D EN1^RARTE3(RPTIEN)    ;call to legacy to file ERR nodes in TMP\par
"RTN","AHMLDOR3",435,0)\par
 Q\par
"RTN","AHMLDOR3",436,0)\par
 ;\par
"VER")\par
8.0^22.0\par
**END**\par
**END**\par
}
 